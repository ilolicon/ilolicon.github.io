<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Kubernetes, also known as K8s, is an open-source system for automating deployment, scaling, and management of containerized applications."><title>Kubernetes</title><link rel=canonical href=https://ilolicon.github.io/p/kubernetes/><link rel=stylesheet href=/scss/style.min.abbd69b2908fdfcd5179898beaafd374514a86538d81639ddd2c58c06ae54e40.css><meta property="og:title" content="Kubernetes"><meta property="og:description" content="Kubernetes, also known as K8s, is an open-source system for automating deployment, scaling, and management of containerized applications."><meta property="og:url" content="https://ilolicon.github.io/p/kubernetes/"><meta property="og:site_name" content="ilolicon's Blog"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="Cloud Native"><meta property="article:tag" content="Kubernetes"><meta property="article:tag" content="Pod"><meta property="article:tag" content="Service"><meta property="article:tag" content="Kubeadm"><meta property="article:published_time" content="2020-12-20T14:21:14+08:00"><meta property="article:modified_time" content="2020-12-20T14:21:14+08:00"><meta name=twitter:title content="Kubernetes"><meta name=twitter:description content="Kubernetes, also known as K8s, is an open-source system for automating deployment, scaling, and management of containerized applications."><link rel="shortcut icon" href=/img/favicon.ico></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=åˆ‡æ¢èœå•>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu96a5ab8e0364e843af4687201b687892_162934_300x0_resize_box_3.png width=300 height=300 class=site-logo loading=lazy alt=Avatar></a>
<span class=emoji>ğŸ¥</span></figure><div class=site-meta><h1 class=site-name><a href=/>ilolicon's Blog</a></h1><h2 class=site-description>Keep Calm and Carry On.</h2></div></header><ol class=social-menu><li><a href=https://github.com/ilolicon target=_blank title=GitHub rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://twitter.com target=_blank title=Twitter rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg><span>Home</span></a></li><li><a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg><span>Archives</span></a></li><li><a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg><span>Search</span></a></li><li><a href=/links/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg><span>Links</span></a></li><div class=menu-bottom-section><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>æš—è‰²æ¨¡å¼</span></li></div></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">ç›®å½•</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#å®¹å™¨ç¼–æ’>å®¹å™¨ç¼–æ’</a></li><li><a href=#æ¦‚è¿°>æ¦‚è¿°</a></li><li><a href=#ç»„ä»¶>ç»„ä»¶</a></li><li><a href=#é›†ç¾¤å®‰è£…>é›†ç¾¤å®‰è£…</a><ol><li><a href=#äºŒè¿›åˆ¶å®‰è£…>äºŒè¿›åˆ¶å®‰è£…</a></li><li><a href=#kubeadmå®‰è£…>kubeadmå®‰è£…</a><ol><li><a href=#ä¸»æœºç¯å¢ƒé¢„è®¾>ä¸»æœºç¯å¢ƒé¢„è®¾</a></li><li><a href=#æµ‹è¯•ç¯å¢ƒè¯´æ˜>æµ‹è¯•ç¯å¢ƒè¯´æ˜</a></li><li><a href=#å®‰è£…å®¹å™¨è¿è¡Œæ—¶>å®‰è£…å®¹å™¨è¿è¡Œæ—¶</a></li><li><a href=#å®‰è£…kubeletkubeadmkubectl>å®‰è£…kubelet/kubeadm/kubectl</a></li><li><a href=#æ•´åˆkubeletå’Œcri-dockerd>æ•´åˆkubeletå’Œcri-dockerd</a></li><li><a href=#åˆå§‹åŒ–ç¬¬ä¸€ä¸ªä¸»èŠ‚ç‚¹>åˆå§‹åŒ–ç¬¬ä¸€ä¸ªä¸»èŠ‚ç‚¹</a></li><li><a href=#åˆå§‹åŒ–å®Œæˆåçš„æ“ä½œæ­¥éª¤>åˆå§‹åŒ–å®Œæˆåçš„æ“ä½œæ­¥éª¤</a></li></ol></li></ol></li><li><a href=#é…ç½®å¯¹å¤šé›†ç¾¤çš„è®¿é—®>é…ç½®å¯¹å¤šé›†ç¾¤çš„è®¿é—®</a></li><li><a href=#èµ„æºæ¸…å•å®šä¹‰>èµ„æºæ¸…å•å®šä¹‰</a><ol><li><a href=#pod>Pod</a><ol><li><a href=#è‡ªä¸»å¼pod>è‡ªä¸»å¼Pod</a></li><li><a href=#podèµ„æº>Podèµ„æº</a></li><li><a href=#podç”Ÿå‘½å‘¨æœŸ>Podç”Ÿå‘½å‘¨æœŸ</a></li><li><a href=#åˆå§‹åŒ–å®¹å™¨>åˆå§‹åŒ–å®¹å™¨</a></li><li><a href=#podå®¹å™¨æ¢é’ˆç±»å‹>Podå®¹å™¨æ¢é’ˆç±»å‹</a></li><li><a href=#podæ§åˆ¶å™¨>Podæ§åˆ¶å™¨</a></li></ol></li><li><a href=#service>Service</a><ol><li><a href=#serviceä»£ç†>Serviceä»£ç†</a></li><li><a href=#serviceç±»å‹>Serviceç±»å‹</a></li><li><a href=#headless-servicesæ— å¤´service>Headless Services(æ— å¤´Service)</a></li><li><a href=#æµé‡ç­–ç•¥>æµé‡ç­–ç•¥</a></li><li><a href=#ä¼šè¯äº²å’Œæ€§>ä¼šè¯äº²å’Œæ€§</a></li></ol></li><li><a href=#ingress>Ingress</a></li><li><a href=#å­˜å‚¨>å­˜å‚¨</a><ol><li><a href=#configmap>configMap</a></li><li><a href=#secret>Secret</a></li><li><a href=#downwardapi>downwardAPI</a></li><li><a href=#volume>Volume</a></li><li><a href=#pvpvc>PV/PVC</a></li><li><a href=#ç¤ºä¾‹>ç¤ºä¾‹</a></li><li><a href=#storageclass>StorageClass</a></li></ol></li></ol></li><li><a href=#statefulsetæ§åˆ¶å™¨>StatefulSetæ§åˆ¶å™¨</a></li><li><a href=#è°ƒåº¦å™¨>è°ƒåº¦å™¨</a><ol><li><a href=#æ¦‚å¿µ>æ¦‚å¿µ</a><ol><li><a href=#è‡ªå®šä¹‰è°ƒåº¦å™¨ç¤ºä¾‹>è‡ªå®šä¹‰è°ƒåº¦å™¨ç¤ºä¾‹</a></li><li><a href=#è°ƒåº¦è¿‡ç¨‹>è°ƒåº¦è¿‡ç¨‹</a></li></ol></li><li><a href=#äº²å’Œæ€§>äº²å’Œæ€§</a><ol><li><a href=#èŠ‚ç‚¹äº²å’Œæ€§>èŠ‚ç‚¹äº²å’Œæ€§</a></li><li><a href=#podé—´äº²å’Œæ€§ä¸åäº²å’Œæ€§>Podé—´äº²å’Œæ€§ä¸åäº²å’Œæ€§</a></li><li><a href=#æ€»ç»“>æ€»ç»“</a></li></ol></li><li><a href=#å®¹å¿ä¸æ±¡ç‚¹>å®¹å¿ä¸æ±¡ç‚¹</a><ol><li><a href=#ç»„æˆ>ç»„æˆ</a></li><li><a href=#è®¾ç½®å’Œå»é™¤>è®¾ç½®å’Œå»é™¤</a></li><li><a href=#å®¹å¿>å®¹å¿</a></li></ol></li><li><a href=#å›ºå®šèŠ‚ç‚¹è°ƒåº¦>å›ºå®šèŠ‚ç‚¹è°ƒåº¦</a><ol><li><a href=#æŒ‡å®šèŠ‚ç‚¹è°ƒåº¦>æŒ‡å®šèŠ‚ç‚¹è°ƒåº¦</a></li><li><a href=#æŒ‡å®šèŠ‚ç‚¹æ ‡ç­¾è°ƒåº¦>æŒ‡å®šèŠ‚ç‚¹æ ‡ç­¾è°ƒåº¦</a></li></ol></li></ol></li><li><a href=#è®¤è¯åŠserviceaccount>è®¤è¯åŠServiceAccount</a><ol><li><a href=#è®¤è¯æˆæƒ>è®¤è¯æˆæƒ</a></li><li><a href=#serviceaccount>ServiceAccount</a></li><li><a href=#rbacæˆæƒ>RBACæˆæƒ</a></li></ol></li><li><a href=#é…ç½®ç®¡ç†>é…ç½®ç®¡ç†</a><ol><li><a href=#kustomize>Kustomize</a></li><li><a href=#helm>Helm</a><ol><li><a href=#æ¨¡ç‰ˆdebug>æ¨¡ç‰ˆdebug</a></li></ol></li></ol></li><li><a href=#é›†ç¾¤ç›‘æ§>é›†ç¾¤ç›‘æ§</a><ol><li><a href=#æ‰‹åŠ¨å®‰è£…prometheus>æ‰‹åŠ¨å®‰è£…Prometheus</a></li><li><a href=#ç›‘æ§é›†ç¾¤åº”ç”¨>ç›‘æ§é›†ç¾¤åº”ç”¨</a></li><li><a href=#ç›‘æ§é›†ç¾¤èŠ‚ç‚¹>ç›‘æ§é›†ç¾¤èŠ‚ç‚¹</a><ol><li><a href=#éƒ¨ç½²node-exporter>éƒ¨ç½²node-exporter</a></li><li><a href=#é…ç½®åŸºäºkubernetesçš„è‡ªåŠ¨å‘ç°>é…ç½®åŸºäºKubernetesçš„è‡ªåŠ¨å‘ç°</a></li></ol></li><li><a href=#ç›‘æ§é›†ç¾¤å¸¸ç”¨èµ„æºå¯¹è±¡>ç›‘æ§é›†ç¾¤å¸¸ç”¨èµ„æºå¯¹è±¡</a><ol><li><a href=#å®¹å™¨ç›‘æ§>å®¹å™¨ç›‘æ§</a></li><li><a href=#apiserverç›‘æ§>apiserverç›‘æ§</a></li><li><a href=#serviceç›‘æ§>Serviceç›‘æ§</a></li><li><a href=#kube-state-metrics>kube-state-metrics</a></li></ol></li><li><a href=#grafanaçš„å®‰è£…ä½¿ç”¨>Grafanaçš„å®‰è£…ä½¿ç”¨</a></li><li><a href=#alertmanger>Alertmanger</a></li><li><a href=#prometheus-operator>Prometheus Operator</a><ol><li><a href=#operatoræ¨¡å¼>Operatoræ¨¡å¼</a></li><li><a href=#ä»‹ç»>ä»‹ç»</a></li><li><a href=#é€šè¿‡prometheus-operatorå®‰è£…>é€šè¿‡prometheus-operatorå®‰è£…</a></li><li><a href=#é€šè¿‡kube-prometheuså®‰è£…>é€šè¿‡kube-prometheuså®‰è£…</a></li></ol></li></ol></li><li><a href=#reference>Reference</a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/cloudnative/ style=background-color:#2a9d8f;color:#fff>CloudNative</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/kubernetes/>Kubernetes</a></h2><h3 class=article-subtitle>Kubernetes, also known as K8s, is an open-source system for automating deployment, scaling, and management of containerized applications.</h3></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>Dec 20, 2020</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>é˜…è¯»æ—¶é•¿: 46 åˆ†é’Ÿ</time></div></footer></div></header><section class=article-content><p><a class=link href=https://kubernetes.io/zh/docs/home/ target=_blank rel=noopener><img src=https://img.shields.io/badge/Kubernetes-README-356DE3 loading=lazy alt="kubernetes readme"></a></p><p><a class=link href=https://kubernetes.io/ target=_blank rel=noopener><img src=/p/kubernetes/icons/kubernetes.svg loading=lazy alt=kubernetes></a></p><p><code>Container Evolution</code></p><p><img src=/p/kubernetes/icons/container_evolution.svg loading=lazy alt=container_evolution></p><h2 id=å®¹å™¨ç¼–æ’>å®¹å™¨ç¼–æ’</h2><ul><li><code>ansible/saltstack</code> <strong>ä¼ ç»Ÿåº”ç”¨</strong>ç¼–æ’å·¥å…·</li><li><code>docker</code><ul><li><code>docker compose</code> dockerå•æœºç¼–æ’</li><li><code>docker swarm</code> dockerä¸»æœºåŠ å…¥docker swarmèµ„æºæ± </li><li><code>docker machine</code> å®Œæˆdockerä¸»æœºåŠ å…¥docker swarmèµ„æºæ± çš„å…ˆå†³æ¡ä»¶/é¢„å¤„ç†å·¥å…·</li></ul></li><li><code>mesos(idc os) + marathon</code> é¢å‘å®¹å™¨ç¼–æ’çš„æ¡†æ¶</li><li><code>kubernetes(borg)</code><ul><li>è‡ªåŠ¨è£…ç®±(åŸºäºä¾èµ– è‡ªåŠ¨å®Œæˆå®¹å™¨éƒ¨ç½² ä¸å½±å“å…¶å¯ç”¨æ€§)</li><li>è‡ªæˆ‘ä¿®å¤</li><li>æ°´å¹³æ‰©å±•</li><li>æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡</li><li>è‡ªåŠ¨å‘å¸ƒå’Œå›æ»š</li><li>å¯†é’¥å’Œé…ç½®ç®¡ç†</li><li>å­˜å‚¨ç¼–æ’</li><li>ä»»åŠ¡æ‰¹é‡å¤„ç†è¿è¡Œ</li></ul></li></ul><h2 id=æ¦‚è¿°>æ¦‚è¿°</h2><p><a class=link href=https://kubernetes.io/zh-cn/docs/concepts/overview/ target=_blank rel=noopener>æ¦‚è¿°</a></p><h2 id=ç»„ä»¶>ç»„ä»¶</h2><p><a class=link href=https://kubernetes.io/zh-cn/docs/concepts/overview/components/ target=_blank rel=noopener>Kubernetesç»„ä»¶</a></p><h2 id=é›†ç¾¤å®‰è£…>é›†ç¾¤å®‰è£…</h2><h3 id=äºŒè¿›åˆ¶å®‰è£…>äºŒè¿›åˆ¶å®‰è£…</h3><p><a class=link href=https://github.com/easzlab/kubeasz target=_blank rel=noopener>å‚è€ƒkubeaszé¡¹ç›®</a></p><h3 id=kubeadmå®‰è£…>kubeadmå®‰è£…</h3><p><a class=link href=https://kubernetes.io/zh-cn/docs/setup/production-environment/tools/kubeadm/ target=_blank rel=noopener>ä½¿ç”¨kubeadmå¼•å¯¼é›†ç¾¤</a></p><ul><li>å›¾ä¸­dockerç»„ä»¶å¯ä»¥æ›¿æ¢ä¸ºå…¶ä»–å®¹å™¨è¿è¡Œæ—¶ç»„ä»¶(<a class=link href=https://kubernetes.io/zh-cn/docs/concepts/architecture/cri/ target=_blank rel=noopener>CRI</a>)</li><li>å‚è€ƒï¼š<a class=link href=https://kubernetes.io/zh-cn/blog/2022/02/17/dockershim-faq/ target=_blank rel=noopener>ç§»é™¤Dockershimçš„å¸¸è§é—®é¢˜</a></li></ul><p><img src=/p/kubernetes/icons/structure.png width=600 height=498 srcset="/p/kubernetes/icons/structure_hu12b93151174b3e04ef92f8cdd319b528_196054_480x0_resize_box_3.png 480w, /p/kubernetes/icons/structure_hu12b93151174b3e04ef92f8cdd319b528_196054_1024x0_resize_box_3.png 1024w" loading=lazy alt=structure class=gallery-image data-flex-grow=120 data-flex-basis=289px></p><ul><li><a class=link href=https://kubernetes.io/zh-cn/docs/concepts/extend-kubernetes/compute-storage-net/network-plugins/ target=_blank rel=noopener>CNI</a>ä»¥<a class=link href=https://github.com/flannel-io/flannel target=_blank rel=noopener>flannel</a>ä¸ºä¾‹</li></ul><p><img src=/p/kubernetes/icons/k8s-network-structure02.png width=2418 height=1128 srcset="/p/kubernetes/icons/k8s-network-structure02_hu86518e8c49d554475a7b0c3fae4a2e9e_2485545_480x0_resize_box_3.png 480w, /p/kubernetes/icons/k8s-network-structure02_hu86518e8c49d554475a7b0c3fae4a2e9e_2485545_1024x0_resize_box_3.png 1024w" loading=lazy alt=structure02 class=gallery-image data-flex-grow=214 data-flex-basis=514px></p><h4 id=ä¸»æœºç¯å¢ƒé¢„è®¾>ä¸»æœºç¯å¢ƒé¢„è®¾</h4><ul><li>OS: Ubuntu 22.04 LTS</li><li>Kubernetes: v1.29.13</li><li>Container Runtime(äºŒé€‰ä¸€å³å¯)<ul><li>containerd<ul><li>å®˜æ–¹ä»“åº“containerd</li><li>æˆ–Dockerç¤¾åŒºæä¾›çš„containerd.io</li></ul></li><li>DockerCE-27.5.0 å’Œ <a class=link href=https://github.com/Mirantis/cri-dockerd target=_blank rel=noopener>cri-dockerd-0.3.16</a></li></ul></li></ul><h4 id=æµ‹è¯•ç¯å¢ƒè¯´æ˜>æµ‹è¯•ç¯å¢ƒè¯´æ˜</h4><ul><li>1master/2+node ä¹Ÿå¯ä»¥å¤šmaster æ ¹æ®è‡ªå·±ç¯å¢ƒå®‰æ’</li><li>é›†ç¾¤èŠ‚ç‚¹éœ€è¦åšæ—¶é—´åŒæ­¥</li><li>ç¦ç”¨swap<ul><li>swapoff -a</li><li>systemctl &ndash;type swap</li><li>systemctl mask SWAP_DEV</li></ul></li><li>ç¦ç”¨é»˜è®¤é…ç½®çš„iptables</li><li>åŠ è½½br_netfilteræ¨¡å—<ul><li>modprobe br_netfilter</li><li>å†™å…¥/etc/modules(å¼€æœºå¯åŠ¨)</li></ul></li></ul><h4 id=å®‰è£…å®¹å™¨è¿è¡Œæ—¶>å®‰è£…å®¹å™¨è¿è¡Œæ—¶</h4><h5 id=dockercri-docekrd>docker+cri-docekrd</h5><ul><li>å®‰è£…docker-ce</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>apt -y install apt-transport-https ca-certificates curl software-properties-common
</span></span><span class=line><span class=cl>curl -fsSL http://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg <span class=p>|</span> apt-key add -
</span></span><span class=line><span class=cl>add-apt-repository <span class=s2>&#34;deb [arch=amd64] http://mirrors.aliyun.com/docker-ce/linux/ubuntu </span><span class=k>$(</span>lsb_release -cs<span class=k>)</span><span class=s2> stable&#34;</span>
</span></span><span class=line><span class=cl>apt update
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># å®‰è£…docker-ce</span>
</span></span><span class=line><span class=cl>apt -y install docker-ce
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># è¿›è¡Œå®Œä¸‹é¢é…ç½®å é‡å¯æœåŠ¡</span>
</span></span><span class=line><span class=cl>systemctl restart docker
</span></span><span class=line><span class=cl>ststemctl <span class=nb>enable</span> docker
</span></span></code></pre></td></tr></table></div></div><ul><li>dockeré…ç½®<ul><li>kubeletéœ€è¦è®©dockerå®¹å™¨å¼•æ“ä½¿ç”¨systemdä½œä¸ºCGroupçš„é©±åŠ¨ å…¶é»˜è®¤å€¼ä¸ºcgroupfs</li><li>æˆ‘ä»¬è¿˜éœ€è¦ç¼–è¾‘dockerçš„é…ç½®æ–‡ä»¶/etc/docker/daemon.json å‚è€ƒä¸‹é¢é…ç½®</li><li>å…¶ä¸­çš„registry-mirrorsç”¨äºæŒ‡æ˜ä½¿ç”¨çš„é•œåƒåŠ é€ŸæœåŠ¡ å‚è€ƒ<a class=link href=https://isedu.top/index.php/archives/225/ target=_blank rel=noopener>å›½å†…æ— æ³•ä¸‹è½½Dockeré•œåƒçš„å¤šç§è§£å†³æ–¹æ¡ˆ</a></li><li>æç¤º: è‡ªKubernetes v1.22ç‰ˆæœ¬å¼€å§‹ æœªæ˜ç¡®è®¾ç½®kubeletçš„cgroup driveræ—¶ åˆ™é»˜è®¤å³ä¼šå°†å…¶è®¾ç½®ä¸ºsystemd</li></ul></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl><span class=nt>&#34;registry-mirrors&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;https://dockerpull.cn&#34;</span>
</span></span><span class=line><span class=cl><span class=p>],</span>
</span></span><span class=line><span class=cl><span class=nt>&#34;exec-opts&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;native.cgroupdriver=systemd&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl><span class=nt>&#34;log-driver&#34;</span><span class=p>:</span> <span class=s2>&#34;json-file&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=nt>&#34;log-opts&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;max-size&#34;</span><span class=p>:</span> <span class=s2>&#34;200m&#34;</span>
</span></span><span class=line><span class=cl><span class=p>},</span>
</span></span><span class=line><span class=cl><span class=nt>&#34;storage-driver&#34;</span><span class=p>:</span> <span class=s2>&#34;overlay2&#34;</span>  
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>ä¸ºdockerè®¾ç½®ä»£ç†(å¯é€‰)<ul><li>Kubeadméƒ¨ç½²Kubernetesé›†ç¾¤çš„è¿‡ç¨‹ä¸­ é»˜è®¤ä½¿ç”¨Googleçš„RegistryæœåŠ¡registry.k8s.ioä¸Šçš„é•œåƒ</li><li>ä¾‹å¦‚<code>registry.k8s.io/kube-apiserver</code>ç­‰ ä½†å›½å†…éƒ¨åˆ†ç”¨æˆ·å¯èƒ½æ— æ³•è®¿é—®åˆ°è¯¥æœåŠ¡</li><li>æˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨å›½å†…çš„é•œåƒæœåŠ¡æ¥è§£å†³è¿™ä¸ªé—®é¢˜ ä¾‹å¦‚<code>registry.aliyuncs.com/google_containers</code></li><li>è‹¥é€‰æ‹©ä½¿ç”¨å›½å†…çš„é•œåƒæœåŠ¡ åˆ™é…ç½®ä»£ç†æœåŠ¡çš„æ­¥éª¤ä¸ºå¯é€‰</li><li>è®¾ç½®ä»£ç†é…ç½® ç¼–è¾‘/lib/systemd/system/docker.service</li></ul></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># é‡è¦æç¤º: </span>
</span></span><span class=line><span class=cl>  <span class=c1># èŠ‚ç‚¹ç½‘ç»œ(ä¾‹å¦‚æœ¬ç¤ºä¾‹ä¸­ä½¿ç”¨çš„192.168.0.0/16)</span>
</span></span><span class=line><span class=cl>  <span class=c1># Podç½‘ç»œ(ä¾‹å¦‚æœ¬ç¤ºä¾‹ä¸­ä½¿ç”¨çš„10.244.0.0/16)</span>
</span></span><span class=line><span class=cl>  <span class=c1># Serviceç½‘ç»œ(ä¾‹å¦‚æœ¬ç¤ºä¾‹ä¸­ä½¿ç”¨çš„10.96.0.0/12)ä»¥åŠ127ç½‘ç»œç­‰æœ¬åœ°ä½¿ç”¨çš„ç½‘ç»œ</span>
</span></span><span class=line><span class=cl>  <span class=c1># å¿…é¡»æ˜ç¡®å®šä¹‰ä¸ºä¸ä½¿ç”¨æ‰€é…ç½®çš„ä»£ç† å¦åˆ™å°†å¾ˆæœ‰å¯èƒ½å¸¦æ¥æ— æ³•é¢„çŸ¥çš„æœ¬åœ°ç½‘ç»œé€šä¿¡æ•…éšœ</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># è¯·å°†ä¸‹é¢é…ç½®æ®µä¸­çš„ $PROXY_SERVER_IP æ›¿æ¢ä¸ºä½ çš„ä»£ç†æœåŠ¡å™¨åœ°å€</span>
</span></span><span class=line><span class=cl><span class=c1># å°†$PROXY_PORT æ›¿æ¢ä¸ºä½ çš„ä»£ç†æœæ‰€ç›‘å¬çš„ç«¯å£</span>
</span></span><span class=line><span class=cl><span class=c1># å¦å¤–è¿˜è¦æ³¨æ„æ‰€ä½¿ç”¨çš„åè®®httpæ˜¯å¦åŒä»£ç†æœåŠ¡å™¨æä¾›æœåŠ¡çš„åè®®ç›¸åŒ¹é… å¦‚æœ‰å¿…è¦ è¯·è‡ªè¡Œä¿®æ”¹ä¸ºhttps</span>
</span></span><span class=line><span class=cl><span class=nv>Environment</span><span class=o>=</span><span class=s2>&#34;HTTP_PROXY=http://</span><span class=nv>$PROXY_SERVER_IP</span><span class=s2>:</span><span class=nv>$PROXY_PORT</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>Environment</span><span class=o>=</span><span class=s2>&#34;HTTPS_PROXY=http://</span><span class=nv>$PROXY_SERVER_IP</span><span class=s2>:</span><span class=nv>$PROXY_PORT</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>Environment</span><span class=o>=</span><span class=s2>&#34;NO_PROXY=127.0.0.0/8,172.17.0.0/16,172.29.0.0/16,10.244.0.0/16,192.168.0.0/16,10.96.0.0/12,magedu.com,cluster.local&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ä¿®æ”¹å®Œé…ç½®é‡å¯æœåŠ¡</span>
</span></span><span class=line><span class=cl>systemctl daemon-reload
</span></span><span class=line><span class=cl>systemctl restart docker
</span></span></code></pre></td></tr></table></div></div><ul><li>å®‰è£…cri-dockerd<ul><li>ç›´æ¥å»å¯¹åº”çš„<a class=link href=https://github.com/Mirantis/cri-dockerd target=_blank rel=noopener>Github</a>é¡¹ç›®ä¸‹è½½å¯¹åº”çš„debåŒ…å®‰è£…</li></ul></li></ul><h5 id=containerd>containerd</h5><ul><li>å®‰è£…å®¹å™¨è¿è¡Œæ—¶containerd<ul><li>Ubuntu 2204ä¸Šå®‰è£…Containerdæœ‰ä¸¤ç§é€‰æ‹©<ul><li>Ubuntuç³»ç»Ÿå®˜æ–¹ç¨‹åºåŒ…ä»“åº“ä¸­çš„containerd</li><li>Dockerç¤¾åŒºæä¾›çš„<code>containerd.io</code>(æœ¬æ–‡é€‰æ‹©è¯¥ç§æ–¹å¼)</li></ul></li><li>å®‰è£…å¹¶å¯åŠ¨containerd.io</li></ul></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># ç”Ÿæˆcontainerd.ioç›¸å…³ç¨‹åºåŒ…çš„ä»“åº“ è¿™é‡Œä»¥é˜¿é‡Œäº‘çš„é•œåƒæœåŠ¡å™¨ä¸ºä¾‹</span>
</span></span><span class=line><span class=cl>apt -y install apt-transport-https ca-certificates curl software-properties-common
</span></span><span class=line><span class=cl>curl -fsSL http://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg <span class=p>|</span> apt-key add -
</span></span><span class=line><span class=cl>add-apt-repository <span class=s2>&#34;deb [arch=amd64] http://mirrors.aliyun.com/docker-ce/linux/ubuntu </span><span class=k>$(</span>lsb_release -cs<span class=k>)</span><span class=s2> stable&#34;</span>
</span></span><span class=line><span class=cl>apt update
</span></span><span class=line><span class=cl>apt-get -y install containerd.io
</span></span></code></pre></td></tr></table></div></div><ul><li>é…ç½®<code>containerd.io</code><ul><li>è¿è¡Œå¦‚ä¸‹å‘½ä»¤æ‰“å°å¹¶ä¿å­˜å¦‚ä¸‹é…ç½®</li></ul></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>mkdir /etc/containerd
</span></span><span class=line><span class=cl>containerd config default &gt; /etc/containerd/config.toml
</span></span></code></pre></td></tr></table></div></div><ul><li>ç¼–è¾‘ç”Ÿæˆçš„é…ç½®æ–‡ä»¶ å®Œæˆå¦‚ä¸‹å‡ é¡¹ç›¸å…³çš„é…ç½®</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 1. ä¿®æ”¹containerdä½¿ç”¨SystemdCgroup</span>
</span></span><span class=line><span class=cl><span class=o>[</span>plugins.<span class=s2>&#34;io.containerd.grpc.v1.cri&#34;</span>.containerd.runtimes.runc<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=o>[</span>plugins.<span class=s2>&#34;io.containerd.grpc.v1.cri&#34;</span>.containerd.runtimes.runc.options<span class=o>]</span>
</span></span><span class=line><span class=cl>  <span class=nv>SystemdCgroup</span> <span class=o>=</span> <span class=nb>true</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. é…ç½®Containerdä½¿ç”¨å›½å†…Mirrorç«™ç‚¹ä¸Šçš„pauseé•œåƒåŠæŒ‡å®šçš„ç‰ˆæœ¬</span>
</span></span><span class=line><span class=cl><span class=o>[</span>plugins.<span class=s2>&#34;io.containerd.grpc.v1.cri&#34;</span><span class=o>]</span>
</span></span><span class=line><span class=cl><span class=nv>sandbox_image</span> <span class=o>=</span> <span class=s2>&#34;registry.aliyuncs.com/google_containers/pause:3.9&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 3. é…ç½®Containerdä½¿ç”¨å›½å†…çš„ImageåŠ é€ŸæœåŠ¡ ä»¥åŠ é€ŸImageè·å–</span>
</span></span><span class=line><span class=cl><span class=o>[</span>plugins.<span class=s2>&#34;io.containerd.grpc.v1.cri&#34;</span>.registry<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=o>[</span>plugins.<span class=s2>&#34;io.containerd.grpc.v1.cri&#34;</span>.registry.mirrors<span class=o>]</span>
</span></span><span class=line><span class=cl>  <span class=o>[</span>plugins.<span class=s2>&#34;io.containerd.grpc.v1.cri&#34;</span>.registry.mirrors.<span class=s2>&#34;docker.io&#34;</span><span class=o>]</span>
</span></span><span class=line><span class=cl>    <span class=nv>endpoint</span> <span class=o>=</span> <span class=o>[</span><span class=s2>&#34;https://docker.mirrors.ustc.edu.cn&#34;</span>, <span class=s2>&#34;https://registry.docker-cn.com&#34;</span><span class=o>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>plugins.<span class=s2>&#34;io.containerd.grpc.v1.cri&#34;</span>.registry.mirrors.<span class=s2>&#34;registry.k8s.io&#34;</span><span class=o>]</span>
</span></span><span class=line><span class=cl><span class=nv>endpoint</span> <span class=o>=</span> <span class=o>[</span><span class=s2>&#34;https://registry.aliyuncs.com/google_containers&#34;</span><span class=o>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 4. é…ç½®Containerdä½¿ç”¨ç§æœ‰é•œåƒä»“åº“ ä¸å­˜åœ¨è¦ä½¿ç”¨çš„ç§æœ‰ImageRegistryæ—¶ æœ¬æ­¥éª¤å¯çœç•¥</span>
</span></span><span class=line><span class=cl><span class=o>[</span>plugins.<span class=s2>&#34;io.containerd.grpc.v1.cri&#34;</span>.registry<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=o>[</span>plugins.<span class=s2>&#34;io.containerd.grpc.v1.cri&#34;</span>.registry.mirrors<span class=o>]</span>
</span></span><span class=line><span class=cl>  <span class=o>[</span>plugins.<span class=s2>&#34;io.containerd.grpc.v1.cri&#34;</span>.registry.mirrors.<span class=s2>&#34;registry.minho.com&#34;</span><span class=o>]</span>
</span></span><span class=line><span class=cl>    <span class=nv>endpoint</span> <span class=o>=</span> <span class=o>[</span><span class=s2>&#34;https://registry.minho.com&#34;</span><span class=o>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 5. é…ç½®ç§æœ‰é•œåƒä»“åº“è·³è¿‡tlséªŒè¯ è‹¥ç§æœ‰ImageRegistryèƒ½æ­£å¸¸è¿›è¡Œtlsè®¤è¯ åˆ™æœ¬æ­¥éª¤å¯çœç•¥</span>
</span></span><span class=line><span class=cl><span class=o>[</span>plugins.<span class=s2>&#34;io.containerd.grpc.v1.cri&#34;</span>.registry.configs<span class=o>]</span>
</span></span><span class=line><span class=cl>  <span class=o>[</span>plugins.<span class=s2>&#34;io.containerd.grpc.v1.cri&#34;</span>.registry.configs.<span class=s2>&#34;registry.minho.com&#34;</span>.tls<span class=o>]</span>
</span></span><span class=line><span class=cl>    <span class=nv>insecure_skip_verify</span> <span class=o>=</span> <span class=nb>true</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 6. é‡å¯æœåŠ¡</span>
</span></span><span class=line><span class=cl>systemctl restart containerd
</span></span></code></pre></td></tr></table></div></div><ul><li>é…ç½®crictlå®¢æˆ·ç«¯<ul><li>å®‰è£…containerd.ioæ—¶ ä¼šè‡ªåŠ¨å®‰è£…å‘½ä»¤è¡Œå®¢æˆ·ç«¯å·¥å…·crictl</li><li>è¯¥å®¢æˆ·ç«¯é€šå¸¸éœ€è¦é€šè¿‡æ­£ç¡®çš„unix sockæ–‡ä»¶æ‰èƒ½æ¥å…¥åˆ°containerdæœåŠ¡</li><li>ç¼–è¾‘é…ç½®æ–‡ä»¶/etc/crictl.yaml æ·»åŠ å¦‚ä¸‹å†…å®¹å³å¯</li><li>éšåå³å¯æ­£å¸¸ä½¿ç”¨crictlç¨‹åºç®¡ç†Image/Containerå’ŒPodç­‰å¯¹è±¡</li><li>å¦å¤–containerd.ioè¿˜æœ‰å¦ä¸€ä¸ªåä¸ºctrçš„å®¢æˆ·ç«¯ç¨‹åºå¯ä»¥ä½¿ç”¨ å…¶åŠŸèƒ½ä¹Ÿæ›´ä¸ºä¸°å¯Œ</li></ul></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>runtime-endpoint: unix:///run/containerd/containerd.sock
</span></span><span class=line><span class=cl>image-endpoint: unix:///run/containerd/containerd.sock
</span></span><span class=line><span class=cl>timeout: <span class=m>10</span>
</span></span><span class=line><span class=cl>debug: <span class=nb>true</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=å®‰è£…kubeletkubeadmkubectl>å®‰è£…kubelet/kubeadm/kubectl</h4><ul><li>è‡ªv1.28ç‰ˆæœ¬å¼€å§‹ Kuberneteså®˜æ–¹å˜æ›´äº†ä»“åº“çš„å­˜å‚¨è·¯å¾„åŠä½¿ç”¨æ–¹å¼(ä¸åŒçš„ç‰ˆæœ¬å°†ä¼šä½¿ç”¨ä¸åŒçš„ä»“åº“) å¹¶æä¾›äº†å‘åå…¼å®¹è‡³v1.24ç‰ˆæœ¬</li><li>å› æ­¤ å¯¹äºv1.24åŠä¹‹åçš„ç‰ˆæœ¬æ¥è¯´ å¯ä»¥ä½¿ç”¨å¦‚ä¸‹æœ‰åˆ«äºä¼ ç»Ÿé…ç½®çš„æ–¹å¼æ¥å®‰è£…ç›¸å…³çš„ç¨‹åºåŒ…</li><li>ä»¥æœ¬ç¤ºä¾‹ä¸­è¦å®‰è£…çš„v1.29ç‰ˆæœ¬ä¸ºä¾‹æ¥è¯´ é…ç½®è¦ä½¿ç”¨çš„ç¨‹åºåŒ…ä»“åº“ éœ€è¦ä½¿ç”¨çš„å‘½ä»¤å¦‚ä¸‹</li><li>å¦‚è‹¥éœ€è¦å®‰è£…å…¶å®ƒç‰ˆæœ¬ åˆ™å°†ä¸‹é¢å‘½ä»¤ä¸­çš„ç‰ˆæœ¬å·<code>v1.29</code>äºˆä»¥æ›¿æ¢å³å¯</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>apt-get update <span class=o>&amp;&amp;</span> apt-get install -y apt-transport-https
</span></span><span class=line><span class=cl>curl -fsSL https://mirrors.aliyun.com/kubernetes-new/core/stable/v1.29/deb/Release.key <span class=p>|</span>    gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://mirrors.aliyun.com/kubernetes-new/core/stable/v1.29/deb/ /&#34;</span> <span class=p>|</span>    tee /etc/apt/sources.list.d/kubernetes.list
</span></span><span class=line><span class=cl>apt-get update
</span></span><span class=line><span class=cl>apt-get install -y kubelet kubeadm kubectl
</span></span></code></pre></td></tr></table></div></div><ul><li>å®‰è£…å®Œæˆå è¦ç¡®ä¿kubeadmç­‰ç¨‹åºæ–‡ä»¶çš„ç‰ˆæœ¬</li><li>è¿™å°†ä¹Ÿæ˜¯åé¢åˆå§‹åŒ–Kubernetesé›†ç¾¤æ—¶éœ€è¦æ˜ç¡®æŒ‡å®šçš„ç‰ˆæœ¬å·</li></ul><h4 id=æ•´åˆkubeletå’Œcri-dockerd>æ•´åˆkubeletå’Œcri-dockerd</h4><ul><li>ä»…æ”¯æŒCRIè§„èŒƒçš„kubeletéœ€è¦ç»ç”±éµå¾ªè¯¥è§„èŒƒçš„cri-dockerdå®Œæˆä¸docker-ceçš„æ•´åˆ</li><li>è¯¥æ­¥éª¤ä»…ä½¿ç”¨docker-ceå’Œcri-dockerdè¿è¡Œæ—¶çš„åœºæ™¯ä¸­éœ€è¦é…ç½®</li></ul><h5 id=é…ç½®cri-dockerd>é…ç½®cri-dockerd</h5><ul><li>é…ç½®cri-dockerd ç¡®ä¿å…¶èƒ½å¤Ÿæ­£ç¡®åŠ è½½åˆ°CNIæ’ä»¶</li><li>ç¼–è¾‘<code>/usr/lib/systemd/system/cri-docker.service</code>æ–‡ä»¶ ç¡®ä¿å…¶[Service]é…ç½®æ®µä¸­çš„ExecStartçš„å€¼ç±»ä¼¼å¦‚ä¸‹å†…å®¹</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>ExecStart</span><span class=o>=</span>/usr/bin/cri-dockerd --container-runtime-endpoint fd:// --network-plugin<span class=o>=</span>cni --cni-bin-dir<span class=o>=</span>/opt/cni/bin --cni-cache-dir<span class=o>=</span>/var/lib/cni/cache --cni-conf-dir<span class=o>=</span>/etc/cni/net.d --pod-infra-container-image<span class=o>=</span>registry.aliyuncs.com/google_containers/pause:3.9
</span></span></code></pre></td></tr></table></div></div><ul><li>éœ€è¦æ·»åŠ çš„å„é…ç½®å‚æ•°(å„å‚æ•°çš„å€¼è¦ä¸ç³»ç»Ÿéƒ¨ç½²çš„CNIæ’ä»¶çš„å®é™…è·¯å¾„ç›¸å¯¹åº”)<ul><li><code>--network-plugin</code> æŒ‡å®šç½‘ç»œæ’ä»¶è§„èŒƒçš„ç±»å‹ è¿™é‡Œè¦ä½¿ç”¨CNI</li><li><code>--cni-bin-dir</code> æŒ‡å®šCNIæ’ä»¶äºŒè¿›åˆ¶ç¨‹åºæ–‡ä»¶çš„æœç´¢ç›®å½•</li><li><code>--cni-cache-dir</code> CNIæ’ä»¶ä½¿ç”¨çš„ç¼“å­˜ç›®å½•</li><li><code>--cni-conf-dir</code> CNIæ’ä»¶åŠ è½½é…ç½®æ–‡ä»¶çš„ç›®å½•</li><li><code>--pod-infra-container-image</code> Podä¸­çš„puaseå®¹å™¨è¦ä½¿ç”¨çš„Image é»˜è®¤ä¸ºregistry.k8s.ioä¸Šçš„pauseä»“åº“ä¸­çš„é•œåƒ ä¸èƒ½ç›´æ¥è·å–åˆ°è¯¥Imageæ—¶ è¦æ˜ç¡®æŒ‡å®šä¸ºä»æŒ‡å®šçš„ä½ç½®åŠ è½½ ä¾‹å¦‚<code>registry.aliyuncs.com/google_containers/pause:3.9</code></li><li>é…ç½®å®Œæˆåé‡å¯æœåŠ¡<code>systemctl restart cri-docker</code></li></ul></li></ul><h5 id=é…ç½®kubelet>é…ç½®kubelet</h5><ul><li>é…ç½®kubelet ä¸ºå…¶æŒ‡å®šcri-dockerdåœ¨æœ¬åœ°æ‰“å¼€çš„Unix Sockæ–‡ä»¶çš„è·¯å¾„</li><li>è¯¥è·¯å¾„ä¸€èˆ¬é»˜è®¤ä¸º<code>/run/cri-dockerd.sock</code> ç¼–è¾‘æ–‡ä»¶/etc/sysconfig/kubelet ä¸ºå…¶æ·»åŠ å¦‚ä¸‹æŒ‡å®šå‚æ•°<ul><li>è‹¥/etc/sysconfigç›®å½•ä¸å­˜åœ¨ åˆ™éœ€è¦å…ˆåˆ›å»ºè¯¥ç›®å½•</li><li><code>KUBELET_KUBEADM_ARGS="--container-runtime=remote --container-runtime-endpoint=/run/cri-dockerd.sock"</code></li></ul></li></ul><h4 id=åˆå§‹åŒ–ç¬¬ä¸€ä¸ªä¸»èŠ‚ç‚¹>åˆå§‹åŒ–ç¬¬ä¸€ä¸ªä¸»èŠ‚ç‚¹</h4><ul><li>è¯¥æ­¥éª¤å¼€å§‹å°è¯•æ„å»ºKubernetesé›†ç¾¤çš„masterèŠ‚ç‚¹ é…ç½®å®Œæˆå å„workerèŠ‚ç‚¹ç›´æ¥åŠ å…¥åˆ°é›†ç¾¤ä¸­çš„å³å¯</li><li>ç”±äºkubeadméƒ¨ç½²çš„Kubernetesé›†ç¾¤ä¸Š é›†ç¾¤æ ¸å¿ƒç»„ä»¶kube-apiserverã€kube-controller-managerã€kube-schedulerå’Œetcdç­‰å‡ä¼šä»¥é™æ€Podçš„å½¢å¼è¿è¡Œ å®ƒä»¬æ‰€ä¾èµ–çš„é•œåƒæ–‡ä»¶é»˜è®¤æ¥è‡ªäºregistry.k8s.ioè¿™ä¸€RegistryæœåŠ¡ä¹‹ä¸Š</li><li>ä½†æˆ‘ä»¬æ— æ³•ç›´æ¥è®¿é—®è¯¥æœåŠ¡ å¸¸ç”¨çš„è§£å†³åŠæ³•æœ‰å¦‚ä¸‹ä¸¤ç§<ul><li>ä½¿ç”¨èƒ½å¤Ÿåˆ°è¾¾è¯¥æœåŠ¡çš„ä»£ç†æœåŠ¡</li><li>ä½¿ç”¨å›½å†…çš„é•œåƒæœåŠ¡å™¨ä¸Šçš„æœåŠ¡ ä¾‹å¦‚<code>registry.aliyuncs.com/google_containers</code>ç­‰</li></ul></li></ul><h5 id=åˆå§‹åŒ–masterèŠ‚ç‚¹>åˆå§‹åŒ–masterèŠ‚ç‚¹</h5><ul><li>åœ¨è¿è¡Œåˆå§‹åŒ–å‘½ä»¤ä¹‹å‰å…ˆè¿è¡Œå¦‚ä¸‹å‘½ä»¤å•ç‹¬è·å–ç›¸å…³çš„é•œåƒæ–‡ä»¶ è€Œåå†è¿è¡Œåé¢çš„<code>kubeadm init</code>å‘½ä»¤ ä»¥ä¾¿äºè§‚å¯Ÿåˆ°é•œåƒæ–‡ä»¶çš„ä¸‹è½½è¿‡ç¨‹</li><li>è‹¥æ‚¨é€‰æ‹©ä½¿ç”¨çš„æ˜¯docker-ceå’Œcri-dockerdè¿™ä¸€å®¹å™¨è¿è¡Œæ—¶ç¯å¢ƒ æœ¬æ–‡åç»­å†…å®¹ä¸­ä½¿ç”¨çš„kubeadmå‘½ä»¤ éƒ½éœ€è¦é¢å¤–æ·»åŠ <code>--cri-socket=unix:///var/run/cri-dockerd.sock</code>é€‰é¡¹ ä»¥æ˜ç¡®æŒ‡å®šå…¶æ‰€è¦å…³è”çš„å®¹å™¨è¿è¡Œæ—¶</li><li>è¿™æ˜¯å› ä¸ºdocker-ceå’Œcri-dockerdéƒ½æä¾›unix sockç±»å‹çš„socketåœ°å€ è¿™ä¼šå¯¼è‡´kubeadmåœ¨è‡ªåŠ¨æ‰«æå’ŒåŠ è½½è¯¥ç±»æ–‡ä»¶æ—¶æ— æ³•è‡ªåŠ¨åˆ¤å®šè¦ä½¿ç”¨å“ªä¸ªæ–‡ä»¶ è€Œä½¿ç”¨containerd.ioè¿è¡Œæ—¶ åˆ™ä¸å­˜åœ¨è¯¥ç±»é—®é¢˜</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># ä¸‹é¢çš„å‘½ä»¤ä¼šåˆ—å‡ºç±»ä¼¼å¦‚ä¸‹çš„Imageä¿¡æ¯ ç”±å¦‚ä¸‹çš„å‘½ä»¤ç»“æœå¯ä»¥çœ‹å‡º </span>
</span></span><span class=line><span class=cl><span class=c1># ç›¸å…³çš„Imageéƒ½æ¥è‡ªäºregistry.k8s.io è¯¥æœåŠ¡ä¸Šçš„Imageé€šå¸¸éœ€è¦å€ŸåŠ©äºä»£ç†æœåŠ¡æ‰èƒ½è®¿é—®åˆ°</span>
</span></span><span class=line><span class=cl>root@k8s-master01:~# kubeadm config images list
</span></span><span class=line><span class=cl>registry.k8s.io/kube-apiserver:v1.29.13
</span></span><span class=line><span class=cl>registry.k8s.io/kube-controller-manager:v1.29.13
</span></span><span class=line><span class=cl>registry.k8s.io/kube-scheduler:v1.29.13
</span></span><span class=line><span class=cl>registry.k8s.io/kube-proxy:v1.29.13
</span></span><span class=line><span class=cl>registry.k8s.io/coredns/coredns:v1.11.1
</span></span><span class=line><span class=cl>registry.k8s.io/pause:3.9
</span></span><span class=line><span class=cl>registry.k8s.io/etcd:3.5.16-0
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># è‹¥éœ€è¦ä»å›½å†…çš„Mirrorç«™ç‚¹ä¸‹è½½Image </span>
</span></span><span class=line><span class=cl><span class=c1># è¿˜éœ€è¦åœ¨å‘½ä»¤ä¸Šä½¿ç”¨--image-repositoryé€‰é¡¹æ¥æŒ‡å®šMirrorç«™ç‚¹çš„ç›¸å…³URL</span>
</span></span><span class=line><span class=cl><span class=c1># ä¾‹å¦‚ ä¸‹é¢çš„å‘½ä»¤ä¸­ä½¿ç”¨äº†è¯¥é€‰é¡¹å°†Image RegistryæŒ‡å‘å›½å†…å¯ç”¨çš„Aliyunçš„é•œåƒæœåŠ¡ </span>
</span></span><span class=line><span class=cl><span class=c1># å…¶å‘½ä»¤ç»“æœæ˜¾ç¤ºçš„å„Imageä¹Ÿé™„å¸¦äº†ç›¸å…³çš„URL</span>
</span></span><span class=line><span class=cl>root@k8s-master01:~# kubeadm config images list --image-repository<span class=o>=</span>registry.aliyuncs.com/google_containers
</span></span><span class=line><span class=cl>registry.aliyuncs.com/google_containers/kube-apiserver:v1.29.13
</span></span><span class=line><span class=cl>registry.aliyuncs.com/google_containers/kube-controller-manager:v1.29.13
</span></span><span class=line><span class=cl>registry.aliyuncs.com/google_containers/kube-scheduler:v1.29.13
</span></span><span class=line><span class=cl>registry.aliyuncs.com/google_containers/kube-proxy:v1.29.13
</span></span><span class=line><span class=cl>registry.aliyuncs.com/google_containers/coredns:v1.11.1
</span></span><span class=line><span class=cl>registry.aliyuncs.com/google_containers/pause:3.9
</span></span><span class=line><span class=cl>registry.aliyuncs.com/google_containers/etcd:3.5.16-0
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># è¿è¡Œä¸‹é¢çš„å‘½ä»¤å³å¯ä¸‹è½½éœ€è¦ç”¨åˆ°çš„å„Image</span>
</span></span><span class=line><span class=cl><span class=c1># éœ€è¦æ³¨æ„çš„æ˜¯ å¦‚æœéœ€è¦ä»å›½å†…çš„Mirrorç«™ç‚¹ä¸‹è½½Image</span>
</span></span><span class=line><span class=cl><span class=c1># åŒæ ·éœ€è¦åœ¨å‘½ä»¤ä¸Šä½¿ç”¨--image-repositoryé€‰é¡¹æ¥æŒ‡å®šMirrorç«™ç‚¹çš„ç›¸å…³URL</span>
</span></span><span class=line><span class=cl>kubeadm config images pull --image-repository<span class=o>=</span>registry.aliyuncs.com/google_containers
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>---
</span></span><span class=line><span class=cl><span class=o>[</span>config/images<span class=o>]</span> Pulled registry.aliyuncs.com/google_containers/kube-apiserver:v1.29.13
</span></span><span class=line><span class=cl><span class=o>[</span>config/images<span class=o>]</span> Pulled registry.aliyuncs.com/google_containers/kube-controller-manager:v1.29.13
</span></span><span class=line><span class=cl><span class=o>[</span>config/images<span class=o>]</span> Pulled registry.aliyuncs.com/google_containers/kube-scheduler:v1.29.13
</span></span><span class=line><span class=cl><span class=o>[</span>config/images<span class=o>]</span> Pulled registry.aliyuncs.com/google_containers/kube-proxy:v1.29.13
</span></span><span class=line><span class=cl><span class=o>[</span>config/images<span class=o>]</span> Pulled registry.aliyuncs.com/google_containers/coredns:v1.11.1
</span></span><span class=line><span class=cl><span class=o>[</span>config/images<span class=o>]</span> Pulled registry.aliyuncs.com/google_containers/pause:3.9
</span></span><span class=line><span class=cl><span class=o>[</span>config/images<span class=o>]</span> Pulled registry.aliyuncs.com/google_containers/etcd:3.5.16-0
</span></span></code></pre></td></tr></table></div></div><ul><li>è€Œåå³å¯è¿›è¡ŒmasterèŠ‚ç‚¹åˆå§‹åŒ–</li><li>kubeadm initå‘½ä»¤æ”¯æŒä¸¤ç§åˆå§‹åŒ–æ–¹å¼<ul><li>ä¸€æ˜¯é€šè¿‡å‘½ä»¤è¡Œé€‰é¡¹ä¼ é€’å…³é”®çš„éƒ¨ç½²è®¾å®š</li><li>å¦ä¸€ä¸ªæ˜¯åŸºäºyamlæ ¼å¼çš„ä¸“ç”¨é…ç½®æ–‡ä»¶(å»ºè®®)</li><li>åä¸€ç§å…è®¸ç”¨æˆ·è‡ªå®šä¹‰å„ä¸ªéƒ¨ç½²å‚æ•° åœ¨é…ç½®ä¸Šæ›´ä¸ºçµæ´»å’Œä¾¿æ· ä¸‹é¢åˆ†åˆ«ç»™å‡ºäº†ä¸¤ç§å®ç°æ–¹å¼çš„é…ç½®æ­¥éª¤ å»ºè®®è¯»è€…é‡‡ç”¨ç¬¬äºŒç§æ–¹å¼è¿›è¡Œã€‚</li></ul></li></ul><h6 id=æ–¹å¼1>æ–¹å¼1</h6><ul><li>è¿è¡Œå¦‚ä¸‹å‘½ä»¤å®Œæˆk8s-master01èŠ‚ç‚¹çš„åˆå§‹åŒ–</li><li>éœ€è¦æ³¨æ„çš„æ˜¯ è‹¥ä½¿ç”¨docker-ceå’Œcri-dockerdè¿è¡Œæ—¶ åˆ™è¿˜è¦åœ¨å¦‚ä¸‹å‘½ä»¤ä¸Šæ˜ç¡®é…ç½®ä½¿ç”¨<code>--cri-socket=unix:///run/cri-dockerd.sock</code>é€‰é¡¹</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubeadm init <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --control-plane-endpoint<span class=o>=</span><span class=s2>&#34;k8s-master01.minho.com&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --kubernetes-version<span class=o>=</span>v1.29.13 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --pod-network-cidr<span class=o>=</span>10.244.0.0/16 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --service-cidr<span class=o>=</span>10.96.0.0/12 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --token-ttl<span class=o>=</span><span class=m>0</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --upload-certs <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --cri-socket<span class=o>=</span>unix:///run/cri-dockerd.sock
</span></span></code></pre></td></tr></table></div></div><ul><li>å„é€‰é¡¹å«ä¹‰<ul><li><code>--image-repository</code> æŒ‡å®šè¦ä½¿ç”¨çš„é•œåƒä»“åº“ é»˜è®¤ä¸º<code>registry.k8s.io</code></li><li><code>--kubernetes-version</code> kubernetesç¨‹åºç»„ä»¶çš„ç‰ˆæœ¬å· å®ƒå¿…é¡»è¦ä¸å®‰è£…çš„kubeletç¨‹åºåŒ…çš„ç‰ˆæœ¬å·ç›¸åŒ</li><li><code>--control-plane-endpoint</code> æ§åˆ¶å¹³é¢çš„å›ºå®šè®¿é—®ç«¯ç‚¹ å¯ä»¥æ˜¯IPåœ°å€æˆ–DNSåç§° ä¼šè¢«ç”¨äºé›†ç¾¤ç®¡ç†å‘˜åŠé›†ç¾¤ç»„ä»¶çš„kubeconfigé…ç½®æ–‡ä»¶çš„API Serverçš„è®¿é—®åœ°å€ å•æ§åˆ¶å¹³é¢éƒ¨ç½²æ—¶å¯ä»¥ä¸ä½¿ç”¨è¯¥é€‰é¡¹</li><li><code>--pod-network-cidr</code> Podç½‘ç»œçš„åœ°å€èŒƒå›´ å…¶å€¼ä¸ºCIDRæ ¼å¼çš„ç½‘ç»œåœ°å€ é€šå¸¸Flannelç½‘ç»œæ’ä»¶çš„é»˜è®¤ä¸º10.244.0.0/16 Calicoæ’ä»¶çš„é»˜è®¤å€¼ä¸º192.168.0.0/16 è€ŒCiliumçš„é»˜è®¤å€¼ä¸º10.0.0.0/8</li><li><code>--service-cidr</code> Serviceçš„ç½‘ç»œåœ°å€èŒƒå›´ å…¶å€¼ä¸ºCIDRæ ¼å¼çš„ç½‘ç»œåœ°å€ kubeadmä½¿ç”¨çš„é»˜è®¤ä¸º10.96.0.0/12 é€šå¸¸ ä»…åœ¨ä½¿ç”¨Flannelä¸€ç±»çš„ç½‘ç»œæ’ä»¶éœ€è¦æ‰‹åŠ¨æŒ‡å®šè¯¥åœ°å€</li><li><code>--apiserver-advertise-address</code> apiserveré€šå‘Šç»™å…¶ä»–ç»„ä»¶çš„IPåœ°å€ ä¸€èˆ¬åº”è¯¥ä¸ºMasterèŠ‚ç‚¹çš„ç”¨äºé›†ç¾¤å†…éƒ¨é€šä¿¡çš„IPåœ°å€ 0.0.0.0è¡¨ç¤ºèŠ‚ç‚¹ä¸Šæ‰€æœ‰å¯ç”¨åœ°å€</li><li><code>--token-ttl</code> å…±äº«ä»¤ç‰Œ(token)çš„è¿‡æœŸæ—¶é•¿ é»˜è®¤ä¸º24å°æ—¶ 0è¡¨ç¤ºæ°¸ä¸è¿‡æœŸ ä¸ºé˜²æ­¢ä¸å®‰å…¨å­˜å‚¨ç­‰åŸå› å¯¼è‡´çš„ä»¤ç‰Œæ³„éœ²å±åŠé›†ç¾¤å®‰å…¨ å»ºè®®ä¸ºå…¶è®¾å®šè¿‡æœŸæ—¶é•¿ æœªè®¾å®šè¯¥é€‰é¡¹æ—¶ åœ¨tokenè¿‡æœŸå è‹¥æœŸæœ›å†å‘é›†ç¾¤ä¸­åŠ å…¥å…¶å®ƒèŠ‚ç‚¹ å¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤é‡æ–°åˆ›å»ºtoken å¹¶ç”ŸæˆèŠ‚ç‚¹åŠ å…¥å‘½ä»¤<ul><li><code>kubeadm token create --print-join-command</code></li></ul></li><li>æç¤ºï¼šæ— æ³•è®¿é—®<code>registry.k8s.io</code>æ—¶ åŒæ ·å¯ä»¥åœ¨ä¸Šé¢çš„å‘½ä»¤ä¸­ä½¿ç”¨<code>--image-repository=registry.aliyuncs.com/google_containers</code>é€‰é¡¹ ä»¥ä¾¿ä»å›½å†…çš„é•œåƒæœåŠ¡ä¸­è·å–å„Image</li><li>æ³¨æ„ï¼šè‹¥å„èŠ‚ç‚¹æœªç¦ç”¨Swapè®¾å¤‡ è¿˜éœ€è¦é™„åŠ é€‰é¡¹<code>--ignore-preflight-errors=Swap</code> ä»è€Œè®©kubeadmå¿½ç•¥è¯¥é”™è¯¯è®¾å®š</li></ul></li></ul><h6 id=æ–¹å¼äºŒ>æ–¹å¼äºŒ</h6><ul><li>kubeadmä¹Ÿå¯é€šè¿‡é…ç½®æ–‡ä»¶åŠ è½½é…ç½® ä»¥å®šåˆ¶æ›´ä¸°å¯Œçš„éƒ¨ç½²é€‰é¡¹ è·å–å†…ç½®çš„åˆå§‹é…ç½®æ–‡ä»¶çš„å‘½ä»¤</li><li><code>kubeadm config print init-defaults</code></li><li>ä¸‹é¢çš„é…ç½®ç¤ºä¾‹ æ˜¯ä»¥ä¸Šé¢å‘½ä»¤çš„è¾“å‡ºç»“æœä¸ºæ¡†æ¶è¿›è¡Œä¿®æ”¹çš„ å®ƒæ˜ç¡®å®šä¹‰äº†kubeProxyçš„æ¨¡å¼ä¸ºipvs å¹¶æ”¯æŒé€šè¿‡ä¿®æ”¹imageRepositoryçš„å€¼ä¿®æ”¹è·å–ç³»ç»Ÿé•œåƒæ—¶ä½¿ç”¨çš„é•œåƒä»“åº“</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>kubeadm.k8s.io/v1beta3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>bootstrapTokens</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>groups</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>system:bootstrappers:kubeadm:default-node-token</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>token</span><span class=p>:</span><span class=w> </span><span class=l>minho.comc4mu9kzd5q7ur</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>ttl</span><span class=p>:</span><span class=w> </span><span class=l>24h0m0s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>usages</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>signing</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>authentication</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>InitConfiguration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>localAPIEndpoint</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># è¿™é‡Œçš„åœ°å€å³ä¸ºåˆå§‹åŒ–çš„æ§åˆ¶å¹³é¢ç¬¬ä¸€ä¸ªèŠ‚ç‚¹çš„IPåœ°å€</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>advertiseAddress</span><span class=p>:</span><span class=w> </span><span class=m>172.29.7.1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>bindPort</span><span class=p>:</span><span class=w> </span><span class=m>6443</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>nodeRegistration</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># æ³¨æ„ ä½¿ç”¨docker-ceå’Œcri-dockerdæ—¶ è¦å¯ç”¨å¦‚ä¸‹é…ç½®çš„cri socketæ–‡ä»¶çš„è·¯å¾„ </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># criSocket: unix:///run/cri-dockerd.sock</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>IfNotPresent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># ç¬¬ä¸€ä¸ªæ§åˆ¶å¹³é¢èŠ‚ç‚¹çš„ä¸»æœºåç§°</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>k8s-master01.minho.com</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>taints</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>effect</span><span class=p>:</span><span class=w> </span><span class=l>NoSchedule</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>node-role.kubernetes.io/master</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>effect</span><span class=p>:</span><span class=w> </span><span class=l>NoSchedule</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>node-role.kubernetes.io/control-plane</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiServer</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>timeoutForControlPlane</span><span class=p>:</span><span class=w> </span><span class=l>4m0s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># å°†ä¸‹é¢é…ç½®ä¸­çš„certSANSåˆ—è¡¨ä¸­çš„å€¼ ä¿®æ”¹ä¸ºå®¢æˆ·ç«¯æ¥å…¥API Serveræ—¶å¯èƒ½ä¼šä½¿ç”¨çš„å„ç±»ç›®æ ‡åœ°å€</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>certSANs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>kubeapi.minho.com</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=m>172.29.7.1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=m>172.29.7.2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=m>172.29.7.3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=m>172.29.7.253</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>kubeadm.k8s.io/v1beta3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># æ§åˆ¶å¹³é¢çš„æ¥å…¥ç«¯ç‚¹ æˆ‘ä»¬è¿™é‡Œé€‰æ‹©é€‚é…åˆ°kubeapi.minho.comè¿™ä¸€åŸŸåä¸Š</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>controlPlaneEndpoint</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;kubeapi.minho.com:6443&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>certificatesDir</span><span class=p>:</span><span class=w> </span><span class=l>/etc/kubernetes/pki</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>clusterName</span><span class=p>:</span><span class=w> </span><span class=l>kubernetes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>controllerManager</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>dns</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>etcd</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>local</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>dataDir</span><span class=p>:</span><span class=w> </span><span class=l>/var/lib/etcd</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>imageRepository</span><span class=p>:</span><span class=w> </span><span class=l>registry.aliyuncs.com/google_containers</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterConfiguration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kubernetesVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1.29.2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>networking</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># é›†ç¾¤è¦ä½¿ç”¨çš„åŸŸå é»˜è®¤ä¸ºcluster.local</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>dnsDomain</span><span class=p>:</span><span class=w> </span><span class=l>cluster.local</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># serviceç½‘ç»œçš„åœ°å€</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>serviceSubnet</span><span class=p>:</span><span class=w> </span><span class=m>10.96.0.0</span><span class=l>/12</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># podç½‘ç»œçš„åœ°å€ flannelç½‘ç»œæ’ä»¶é»˜è®¤ä½¿ç”¨10.244.0.0/16</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>podSubnet</span><span class=p>:</span><span class=w> </span><span class=m>10.244.0.0</span><span class=l>/16</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>scheduler</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>kubeproxy.config.k8s.io/v1alpha1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>KubeProxyConfiguration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># ç”¨äºé…ç½®kube-proxyä¸Šä¸ºServiceæŒ‡å®šçš„ä»£ç†æ¨¡å¼ é»˜è®¤ä¸ºiptables</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>mode</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;ipvs&#34;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>å°†ä¸Šé¢çš„å†…å®¹ä¿å­˜äºé…ç½®æ–‡ä»¶ä¸­ ä¾‹å¦‚kubeadm-config.yaml</li><li>è€Œåæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤å³èƒ½å®ç°ç±»ä¼¼å‰ä¸€ç§åˆå§‹åŒ–æ–¹å¼ä¸­çš„é›†ç¾¤åˆå§‹é…ç½® ä½†è¿™é‡Œå°†Serviceçš„ä»£ç†æ¨¡å¼è®¾å®šä¸ºipvs</li><li><code>kubeadm init --config kubeadm-config.yaml --upload-certs</code></li></ul><h4 id=åˆå§‹åŒ–å®Œæˆåçš„æ“ä½œæ­¥éª¤>åˆå§‹åŒ–å®Œæˆåçš„æ“ä½œæ­¥éª¤</h4><ul><li>å¯¹äºKubernetesç³»ç»Ÿçš„æ–°ç”¨æˆ·æ¥è¯´ æ— è®ºä½¿ç”¨ä¸Šè¿°å“ªç§æ–¹æ³• å‘½ä»¤è¿è¡Œç»“æŸå è¯·è®°å½•æœ€åçš„kubeadm joinå‘½ä»¤è¾“å‡ºçš„æœ€åæç¤ºçš„æ“ä½œæ­¥éª¤</li><li>ä¸‹é¢çš„å†…å®¹æ˜¯éœ€è¦ç”¨æˆ·è®°å½•çš„ä¸€ä¸ªå‘½ä»¤è¾“å‡ºç¤ºä¾‹ å®ƒæç¤ºäº†åç»­éœ€è¦çš„æ“ä½œæ­¥éª¤</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>Your Kubernetes control-plane has initialized successfully!
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>To start using your cluster, you need to run the following as a regular user:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  mkdir -p <span class=nv>$HOME</span>/.kube
</span></span><span class=line><span class=cl>  sudo cp -i /etc/kubernetes/admin.conf <span class=nv>$HOME</span>/.kube/config
</span></span><span class=line><span class=cl>  sudo chown <span class=k>$(</span>id -u<span class=k>)</span>:<span class=k>$(</span>id -g<span class=k>)</span> <span class=nv>$HOME</span>/.kube/config
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Alternatively, <span class=k>if</span> you are the root user, you can run:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nb>export</span> <span class=nv>KUBECONFIG</span><span class=o>=</span>/etc/kubernetes/admin.conf
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>You should now deploy a pod network to the cluster.
</span></span><span class=line><span class=cl>Run <span class=s2>&#34;kubectl apply -f [podnetwork].yaml&#34;</span> with one of the options listed at:
</span></span><span class=line><span class=cl>  https://kubernetes.io/docs/concepts/cluster-administration/addons/
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>You can now join any number of the control-plane node running the following <span class=nb>command</span> on each as root:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  kubeadm join k8s-master01.minho.com:6443 --token tkzmlw.406h8d9g8x9sf8z1 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --discovery-token-ca-cert-hash sha256:a32fe9b88096c3c0c22570a486302f58d3c479a8f1ccaf74b8fa4538a1a9d904 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --control-plane --certificate-key 502f1f1c87aea5a99dea3ee197878159f06a1f4178a8e7610ed228e6629a9414 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --cri-socket<span class=o>=</span>unix:///run/cri-dockerd.sock
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Please note that the certificate-key gives access to cluster sensitive data, keep it secret!
</span></span><span class=line><span class=cl>As a safeguard, uploaded-certs will be deleted in two hours<span class=p>;</span> If necessary, you can use
</span></span><span class=line><span class=cl><span class=s2>&#34;kubeadm init phase upload-certs --upload-certs&#34;</span> to reload certs afterward.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Then you can join any number of worker nodes by running the following on each as root:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>kubeadm join k8s-master01.minho.com:6443 --token tkzmlw.406h8d9g8x9sf8z1 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --discovery-token-ca-cert-hash sha256:a32fe9b88096c3c0c22570a486302f58d3c479a8f1ccaf74b8fa4538a1a9d904 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --cri-socket<span class=o>=</span>unix:///run/cri-dockerd.sock
</span></span></code></pre></td></tr></table></div></div><ul><li><code>kubeadm init</code>å‘½ä»¤å®Œæ•´å‚è€ƒæŒ‡å—è¯·ç§»æ­¥<a class=link href=https://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm-init/ target=_blank rel=noopener>å®˜æ–¹æ–‡æ¡£</a></li></ul><h5 id=è®¾å®škubectl>è®¾å®škubectl</h5><ul><li>kubectlæ˜¯kube-apiserverçš„å‘½ä»¤è¡Œå®¢æˆ·ç«¯ç¨‹åº å®ç°äº†é™¤ç³»ç»Ÿéƒ¨ç½²ä¹‹å¤–çš„å‡ ä¹å…¨éƒ¨çš„ç®¡ç†æ“ä½œ æ˜¯kubernetesç®¡ç†å‘˜ä½¿ç”¨æœ€å¤šçš„å‘½ä»¤ä¹‹ä¸€</li><li>kubectléœ€ç»ç”±API serverè®¤è¯åŠæˆæƒåæ–¹èƒ½æ‰§è¡Œç›¸åº”çš„ç®¡ç†æ“ä½œ kubeadméƒ¨ç½²çš„é›†ç¾¤ä¸ºå…¶ç”Ÿæˆäº†ä¸€ä¸ªå…·æœ‰ç®¡ç†å‘˜æƒé™çš„è®¤è¯é…ç½®æ–‡ä»¶/etc/kubernetes/admin.conf</li><li>å®ƒå¯ç”±kubectlé€šè¿‡é»˜è®¤çš„<code>$HOME/.kube/config</code>çš„è·¯å¾„è¿›è¡ŒåŠ è½½ å½“ç„¶ ç”¨æˆ·ä¹Ÿå¯åœ¨kubectlå‘½ä»¤ä¸Šä½¿ç”¨&ndash;kubeconfigé€‰é¡¹æŒ‡å®šä¸€ä¸ªåˆ«çš„ä½ç½®</li><li>ä¸‹é¢å¤åˆ¶è®¤è¯ä¸ºKubernetesç³»ç»Ÿç®¡ç†å‘˜çš„é…ç½®æ–‡ä»¶è‡³ç›®æ ‡ç”¨æˆ·(ä¾‹å¦‚å½“å‰ç”¨æˆ·root)çš„å®¶ç›®å½•ä¸‹<ul><li><code>mkdir ~/.kube</code> && <code>cp /etc/kubernetes/admin.conf ~/.kube/config</code></li></ul></li></ul><h5 id=éƒ¨ç½²ç½‘ç»œæ’ä»¶>éƒ¨ç½²ç½‘ç»œæ’ä»¶</h5><ul><li>Kubernetesç³»ç»Ÿä¸ŠPodç½‘ç»œçš„å®ç°ä¾èµ–äºç¬¬ä¸‰æ–¹æ’ä»¶è¿›è¡Œ è¿™ç±»æ’ä»¶æœ‰è¿‘æ•°åç§ä¹‹å¤š è¾ƒä¸ºè‘—åçš„æœ‰flannelã€calicoã€canalå’Œkube-routerç­‰ ç®€å•æ˜“ç”¨çš„å®ç°ä¸ºCoreOSæä¾›çš„flannelé¡¹ç›®</li><li>ä¸‹é¢çš„å‘½ä»¤ç”¨äºåœ¨çº¿éƒ¨ç½²flannelè‡³Kubernetesç³»ç»Ÿä¹‹ä¸Š æˆ‘ä»¬éœ€è¦åœ¨åˆå§‹åŒ–çš„ç¬¬ä¸€ä¸ªmasterèŠ‚ç‚¹k8s-master01ä¸Šè¿è¡Œå¦‚ä¸‹å‘½ä»¤ ä»¥å®Œæˆéƒ¨ç½²</li><li><code>kubectl apply -f https://github.com/flannel-io/flannel/releases/latest/download/kube-flannel.yml</code></li><li>è€Œåä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ç¡®è®¤å…¶è¾“å‡ºç»“æœä¸­Podçš„çŠ¶æ€ä¸º<code>Running</code> ç±»ä¼¼å¦‚ä¸‹å‘½ä»¤åŠå…¶è¾“å…¥çš„ç»“æœæ‰€ç¤º</li><li><code>kubectl get pods -n kube-flannel</code></li></ul><h5 id=éªŒè¯masterèŠ‚ç‚¹å·²ç»å°±ç»ª>éªŒè¯masterèŠ‚ç‚¹å·²ç»å°±ç»ª</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl get nodes
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ä¸Šè¿°å‘½ä»¤åº”è¯¥ä¼šå¾—åˆ°ç±»ä¼¼å¦‚ä¸‹è¾“å‡º è¿™è¡¨ç¤ºk8s-master01èŠ‚ç‚¹å·²ç»å°±ç»ª</span>
</span></span><span class=line><span class=cl>NAME                     STATUS   ROLES           AGE     VERSION
</span></span><span class=line><span class=cl>k8s-master01.minho.com   Ready    control-plane   5d22h   v1.29.12
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># è‹¥å‡†å¤‡æœ‰å…¶å®ƒçš„masterèŠ‚ç‚¹ ä»¥æ„å»ºé«˜å¯ç”¨çš„æ§åˆ¶å¹³é¢</span>
</span></span><span class=line><span class=cl><span class=c1># å¯æŒ‰ç…§åˆå§‹åŒ–æ§åˆ¶å¹³é¢ç¬¬ä¸€ä¸ªèŠ‚ç‚¹æ—¶è¾“å‡ºçš„ä¿¡æ¯ åœ¨é¢å¤–çš„masterèŠ‚ç‚¹ä¸Šè¿è¡Œæ·»åŠ å‘½ä»¤ ä»¥å®Œæˆæ§åˆ¶å¹³é¢å…¶å®ƒèŠ‚ç‚¹çš„æ·»åŠ </span>
</span></span><span class=line><span class=cl><span class=c1># ç›¸å…³çš„å‘½ä»¤æ˜¯å½¢å¦‚ä¸‹åœ¨çš„ç›¸å…³ä¿¡æ¯</span>
</span></span><span class=line><span class=cl>kubeadm join k8s-master01.minho.com:6443 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --token tkzmlw.406h8d9g8x9sf8z1 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --discovery-token-ca-cert-hash sha256:a32fe9b88096c3c0c22570a486302f58d3c479a8f1ccaf74b8fa4538a1a9d904 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --control-plane --certificate-key 502f1f1c87aea5a99dea3ee197878159f06a1f4178a8e7610ed228e6629a9414 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --cri-socket<span class=o>=</span>unix:///run/cri-dockerd.sock
</span></span></code></pre></td></tr></table></div></div><h5 id=æ·»åŠ èŠ‚ç‚¹åˆ°é›†ç¾¤ä¸­>æ·»åŠ èŠ‚ç‚¹åˆ°é›†ç¾¤ä¸­</h5><ul><li><p>ä¸‹é¢çš„ä¸¤ä¸ªæ­¥éª¤ éœ€è¦åˆ†åˆ«åœ¨k8s-node01ã€k8s-node02å’Œk8s-node03ä¸Šå„è‡ªå®Œæˆ</p><ul><li>è‹¥æœªç¦ç”¨Swapè®¾å¤‡ ç¼–è¾‘kubeletçš„é…ç½®æ–‡ä»¶/etc/default/kubelet è®¾ç½®å…¶å¿½ç•¥Swapå¯ç”¨çš„çŠ¶æ€é”™è¯¯<ul><li>å†…å®¹å¦‚ä¸‹ï¼šKUBELET_EXTRA_ARGS="&ndash;fail-swap-on=false"</li></ul></li><li>å°†èŠ‚ç‚¹åŠ å…¥ç¬¬äºŒæ­¥ä¸­åˆ›å»ºçš„masterçš„é›†ç¾¤ä¸­ è¦ä½¿ç”¨ä¸»èŠ‚ç‚¹åˆå§‹åŒ–è¿‡ç¨‹ä¸­è®°å½•çš„kubeadm joinå‘½ä»¤<ul><li>å†æ¬¡æç¤º è‹¥ä½¿ç”¨docker-ceå’Œcri-dockerdè¿è¡Œæ—¶ç¯å¢ƒ åˆ™éœ€è¦åœ¨å¦‚ä¸‹å‘½ä»¤ä¸­é¢å¤–æ·»åŠ <code>--cri-socket=unix:///run/cri-dockerd.sock</code>é€‰é¡¹</li></ul></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubeadm join k8s-master01.minho.com:6443 --token tkzmlw.406h8d9g8x9sf8z1 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --discovery-token-ca-cert-hash sha256:a32fe9b88096c3c0c22570a486302f58d3c479a8f1ccaf74b8fa4538a1a9d904 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --cri-socket<span class=o>=</span>unix:///run/cri-dockerd.sock
</span></span></code></pre></td></tr></table></div></div></li></ul><h5 id=éªŒè¯èŠ‚ç‚¹æ·»åŠ ç»“æœ>éªŒè¯èŠ‚ç‚¹æ·»åŠ ç»“æœ</h5><ul><li>åœ¨æ¯ä¸ªèŠ‚ç‚¹æ·»åŠ å®Œæˆå å³å¯é€šè¿‡kubectléªŒè¯æ·»åŠ ç»“æœ</li><li>ä¸‹é¢çš„å‘½ä»¤åŠå…¶è¾“å‡ºæ˜¯åœ¨æ‰€æœ‰çš„ä¸‰ä¸ªèŠ‚ç‚¹å‡æ·»åŠ å®Œæˆåè¿è¡Œçš„ å…¶è¾“å‡ºç»“æœè¡¨æ˜ä¸‰ä¸ªWorker Nodeå·²ç»å‡†å¤‡å°±ç»ª</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>root@k8s-master01:~# kubectl get nodes
</span></span><span class=line><span class=cl>NAME                     STATUS   ROLES           AGE     VERSION
</span></span><span class=line><span class=cl>k8s-master01.minho.com   Ready    control-plane   5d22h   v1.29.12
</span></span><span class=line><span class=cl>k8s-node01.minho.com     Ready    &lt;none&gt;          5d22h   v1.29.12
</span></span><span class=line><span class=cl>k8s-node02.minho.com     Ready    &lt;none&gt;          5d22h   v1.29.12
</span></span><span class=line><span class=cl>k8s-node03.minho.com     Ready    &lt;none&gt;          5d22h   v1.29.12
</span></span></code></pre></td></tr></table></div></div><h5 id=æµ‹è¯•åº”ç”¨ç¼–æ’åŠæœåŠ¡è®¿é—®>æµ‹è¯•åº”ç”¨ç¼–æ’åŠæœåŠ¡è®¿é—®</h5><ul><li>åˆ°æ­¤ä¸ºæ­¢ ä¸€ä¸ªmaster/ä¸‰ä¸ªworkerçš„kubernetesé›†ç¾¤åŸºç¡€è®¾æ–½å·²ç»éƒ¨ç½²å®Œæˆ ç”¨æˆ·éšåå³å¯æµ‹è¯•å…¶æ ¸å¿ƒåŠŸèƒ½</li><li>ä¾‹å¦‚ ä¸‹é¢çš„å‘½ä»¤å¯å°†demoappä»¥Podçš„å½¢å¼ç¼–æ’è¿è¡Œäºé›†ç¾¤ä¹‹ä¸Š å¹¶é€šè¿‡åœ¨é›†ç¾¤å¤–éƒ¨è¿›è¡Œè®¿é—®</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl create deployment demoapp --image<span class=o>=</span>ikubernetes/demoapp:v1.0 --replicas<span class=o>=</span><span class=m>3</span>
</span></span><span class=line><span class=cl>kubectl create service nodeport demoapp --tcp<span class=o>=</span>80:80
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># è€Œå ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤äº†è§£Serviceå¯¹è±¡demoappä½¿ç”¨çš„NodePort ä»¥ä¾¿äºåœ¨é›†ç¾¤å¤–éƒ¨è¿›è¡Œè®¿é—®</span>
</span></span><span class=line><span class=cl>root@k8s-master01:~# kubectl get svc -l <span class=nv>app</span><span class=o>=</span>demoapp
</span></span><span class=line><span class=cl>NAME     TYPE       CLUSTER-IP     EXTERNAL-IP   PORT<span class=o>(</span>S<span class=o>)</span>       AGE
</span></span><span class=line><span class=cl>demoapp   NodePort   10.100.84.12   &lt;none&gt;       80:30622/TCP   2s
</span></span></code></pre></td></tr></table></div></div><ul><li>demoappæ˜¯ä¸€ä¸ªwebåº”ç”¨ å› æ­¤ ç”¨æˆ·å¯ä»¥äºé›†ç¾¤å¤–éƒ¨é€šè¿‡<code>http://NodeIP:30622</code>è¿™ä¸ªURLè®¿é—®demoappä¸Šçš„åº”ç”¨</li><li>æˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨Kubernetesé›†ç¾¤ä¸Šå¯åŠ¨ä¸€ä¸ªä¸´æ—¶çš„å®¢æˆ·ç«¯ å¯¹demoappæœåŠ¡å‘èµ·è®¿é—®æµ‹è¯•</li><li><code>kubectl run client-$RANDOM --image=ikubernetes/admin-box:v1.2 --rm --restart=Never -it --command -- /bin/bash</code></li><li>è€Œå åœ¨æ‰“å¼€çš„äº¤äº’å¼æ¥å£ä¸­ è¿è¡Œå¦‚ä¸‹å‘½ä»¤ å¯¹demoapp.default.svcæœåŠ¡å‘èµ·è®¿é—®è¯·æ±‚ éªŒè¯å…¶è´Ÿè½½å‡è¡¡çš„æ•ˆæœ</li><li><code>root@client-3021 ~# while true; do curl demoapp.default.svc; sleep 1; done</code></li><li>æ¸…ç†éƒ¨ç½²çš„æµ‹è¯•åº”ç”¨<ul><li><code>kubectl delete deployments/demoapp services/demoapp</code></li></ul></li></ul><h5 id=éƒ¨ç½²add-onså¯é€‰æ­¥éª¤>éƒ¨ç½²Add-ons(å¯é€‰æ­¥éª¤)</h5><ul><li>MetalLB</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># å®‰è£…metalLB</span>
</span></span><span class=line><span class=cl>kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.14.9/config/manifests/metallb-native.yaml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># é…ç½®åœ°å€æ± </span>
</span></span><span class=line><span class=cl><span class=c1># IPAddressPool: ç”¨æ¥å®šä¹‰å¯åˆ†é…çš„IPèŒƒå›´</span>
</span></span><span class=line><span class=cl><span class=c1># L2Advertisement: åœ¨Layer2æ¨¡å¼ä¸‹é€šè¿‡ARPå¹¿æ’­æ¥æ‰¿è¯ºè¿™äº›IP</span>
</span></span><span class=line><span class=cl>apiVersion: metallb.io/v1beta1
</span></span><span class=line><span class=cl>kind: IPAddressPool
</span></span><span class=line><span class=cl>metadata:
</span></span><span class=line><span class=cl>  name: default-pool
</span></span><span class=line><span class=cl>  namespace: metallb-system
</span></span><span class=line><span class=cl>spec:
</span></span><span class=line><span class=cl>  addresses:
</span></span><span class=line><span class=cl>    - 192.168.1.240-192.168.1.250
</span></span><span class=line><span class=cl>---
</span></span><span class=line><span class=cl>apiVersion: metallb.io/v1beta1
</span></span><span class=line><span class=cl>kind: L2Advertisement
</span></span><span class=line><span class=cl>metadata:
</span></span><span class=line><span class=cl>  name: l2-adv
</span></span><span class=line><span class=cl>  namespace: metallb-system
</span></span><span class=line><span class=cl>spec:
</span></span><span class=line><span class=cl>  ipAddressPools:
</span></span><span class=line><span class=cl>  - default-pool
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># æ¥ä¸‹æ¥å°±å¯ä»¥åˆ›å»ºLoadBalancerç±»å‹çš„Serviceä½¿ç”¨</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>Ingress Nginx</li><li>Metrics Server</li><li>Kuboard</li></ul><h2 id=é…ç½®å¯¹å¤šé›†ç¾¤çš„è®¿é—®>é…ç½®å¯¹å¤šé›†ç¾¤çš„è®¿é—®</h2><p><a class=link href=https://kubernetes.io/zh-cn/docs/tasks/access-application-cluster/configure-access-multiple-clusters/ target=_blank rel=noopener>é…ç½®å¯¹å¤šé›†ç¾¤çš„è®¿é—®</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># æ·»åŠ é›†ç¾¤ä¿¡æ¯</span>
</span></span><span class=line><span class=cl>kubectl config --kubeconfig<span class=o>=</span>config-demo set-cluster development --server<span class=o>=</span>https://1.2.3.4 --certificate-authority<span class=o>=</span>fake-ca-file
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># æ·»åŠ ç”¨æˆ·ä¿¡æ¯</span>
</span></span><span class=line><span class=cl>kubectl config --kubeconfig<span class=o>=</span>config-demo set-credentials developer --client-certificate<span class=o>=</span>fake-cert-file --client-key<span class=o>=</span>fake-key-seefile
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># æ·»åŠ ä¸Šä¸‹æ–‡</span>
</span></span><span class=line><span class=cl>kubectl config --kubeconfig<span class=o>=</span>config-demo set-context dev-frontend --cluster<span class=o>=</span>development --namespace<span class=o>=</span>frontend --user<span class=o>=</span>developer
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># æŸ¥çœ‹é…ç½®æ–‡ä»¶è¯¦æƒ…</span>
</span></span><span class=line><span class=cl><span class=c1># ç›´æ¥æ‰“å¼€æ–‡ä»¶æˆ–ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤</span>
</span></span><span class=line><span class=cl>kubectl config --kubeconfig<span class=o>=</span>config-demo view
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># è®¾ç½®å½“å‰ä¸Šä¸‹æ–‡</span>
</span></span><span class=line><span class=cl>kubectl config --kubeconfig<span class=o>=</span>config-demo use-context dev-frontend
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ä½¿ç”¨--minifyå‚æ•° æ¥æŸ¥çœ‹ä¸å½“å‰ä¸Šä¸‹æ–‡ç›¸å…³è”çš„é…ç½®ä¿¡æ¯</span>
</span></span><span class=line><span class=cl>kubectl config --kubeconfig<span class=o>=</span>config-demo view --minify
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># è®¾ç½® KUBECONFIG ç¯å¢ƒå˜é‡</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>KUBECONFIG</span><span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>KUBECONFIG</span><span class=si>}</span><span class=s2>:config-demo:config-demo-2&#34;</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=èµ„æºæ¸…å•å®šä¹‰>èµ„æºæ¸…å•å®šä¹‰</h2><ul><li><p>åˆ›å»ºèµ„æºçš„æ–¹æ³•</p><ul><li><p>apiserverä»…æ¥æ”¶jsonæ ¼å¼çš„èµ„æºå®šä¹‰</p></li><li><p>yamlæ ¼å¼æä¾›é…ç½®æ¸…å• apiserverå¯è‡ªåŠ¨å°†å…¶è½¬æ¢ä¸ºjsonæ ¼å¼ è€Œåå†æäº¤</p></li></ul></li><li><p>å¤§éƒ¨åˆ†èµ„æºçš„é…ç½®æ¸…å• ä¸»è¦éƒ½æœ‰äº”ä¸ªä¸»è¦çš„éƒ¨åˆ†ç»„æˆ</p><ul><li><p>apiversion</p><ul><li><code>kubectl api-versions</code> # æ‰€å±APIç¾¤ç»„</li><li>æ ‡è¯†æ–¹å¼: <code>group/version</code> çœç•¥ç»„ååˆ™ä¸ºcore group</li></ul></li><li><p>kind: èµ„æºç±»åˆ«</p></li><li><p>metadata: å…ƒæ•°æ®</p><ul><li>name: åŒä¸€ç±»åˆ«ä¸­ nameéœ€è¦å”¯ä¸€</li><li>namespace: æ‰€å±k8sçš„å“ªä¸ªåç§°ç©ºé—´</li><li>labels</li><li>annotations</li><li>æ¯ä¸ªèµ„æºçš„å¼•ç”¨PATH<ul><li><code>/api/${GROUP/VERSION}/namespace/${NAMESPACE}/${TYPE}/${NAME}</code></li></ul></li></ul></li><li><p>spec(é‡è¦): å®šä¹‰ç”¨æˆ·æœŸæœ›çš„çŠ¶æ€ disired state</p></li><li><p>status: å½“å‰çŠ¶æ€ current state æœ¬å­—æ®µç”±Kubernetesé›†ç¾¤ç»´æŠ¤</p></li></ul></li><li><p>å­—æ®µå¤ªå¤š å¯ä»¥å€ŸåŠ©<code>kubectl explain --help</code>å‘½ä»¤æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯</p><ul><li>kubectl explain pod</li><li>kubectl explain pod.metadata</li></ul></li></ul><h3 id=pod>Pod</h3><p><a class=link href=https://kubernetes.io/zh-cn/docs/concepts/workloads/pods/ target=_blank rel=noopener>pods</a></p><h4 id=è‡ªä¸»å¼pod>è‡ªä¸»å¼Pod</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>pod-demo</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>myapp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>tier</span><span class=p>:</span><span class=w> </span><span class=l>frontend</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>myapp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>nginx:alpine</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>busybox</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>busybox:latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>command</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=s2>&#34;/bin/sh&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=s2>&#34;-c&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=s2>&#34;sleep 3600&#34;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=podèµ„æº>Podèµ„æº</h4><ul><li><p>spec.containers &lt;[]object></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># kubectl explain pod.spec.containers</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>&lt;string&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>&lt;string&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>&lt;string&gt; </span><span class=w> </span><span class=c># Always Never IfNotPresent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=l>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># ä¿®æ”¹é•œåƒä¸­çš„é»˜è®¤åº”ç”¨</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>command/args</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>https://kubernetes.io/docs/tasks/inject-data-application/define-command-argument-container/</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></li><li><p>æ ‡ç­¾</p><ul><li>key = value<ul><li>key: å­—æ¯ æ•°å­— _ - .</li><li>value: å¯ä»¥ä¸ºç©º åªèƒ½å­—æ¯æˆ–æ•°å­—å¼€å¤´åŠç»“å°¾</li></ul></li></ul></li><li><p>æ ‡ç­¾é€‰æ‹©å™¨</p><ul><li>ç­‰å€¼å…³ç³»: =ã€==ã€!=(ä¸ç­‰äºä¼šç­›é€‰å‡ºä¸å…·æœ‰è¯¥æ ‡ç­¾çš„èµ„æº)</li><li>é›†åˆå…³ç³»<ul><li>KEY in (VALUE1,VALUE2,&mldr;)</li><li>KEY notin (VALUE1,VALUE2,&mldr;)</li><li>KEY # å­˜åœ¨è¿™ä¸ªKEYå°±è¡Œ</li><li>!KEY # ä¸å­˜åœ¨æ­¤é”®çš„èµ„æº</li></ul></li></ul></li><li><p>è®¸å¤šèµ„æºæ”¯æŒå†…åµŒå­—æ®µæ¥ä½¿ç”¨æ ‡ç­¾é€‰æ‹©å™¨</p><ul><li>matchLabels: ç›´æ¥ç»™å®šé”®å€¼</li><li>matchExpressions: åŸºäºç»™å®šçš„è¡¨è¾¾å¼æ¥å®šä¹‰ä½¿ç”¨æ ‡ç­¾é€‰æ‹©å™¨<ul><li>key: &ldquo;KEY&rdquo;, operator: &ldquo;OPERATOR&rdquo;, values: [VAL1,VAL2,VAL3,&mldr;]</li><li>æ“ä½œç¬¦<ul><li>Inã€NotIn: valueså­—æ®µçš„å€¼å¿…é¡»ä¸ºéç©ºåˆ—è¡¨</li><li>Existsã€NotExists: valueså­—æ®µçš„å€¼å¿…é¡»ä¸ºç©ºåˆ—è¡¨</li></ul></li></ul></li></ul></li><li><p>spec.nodeSelector &lt;map[striong]string></p><ul><li>èŠ‚ç‚¹æ ‡ç­¾é€‰æ‹©å™¨</li></ul></li><li><p>spec.nodeName <code>&lt;string></code> # ç›´æ¥æŒ‡å®šè¿è¡Œnode</p></li><li><p>annotations</p><ul><li>ä¸labelä¸åŒçš„åœ°æ–¹åœ¨äº å®ƒä¸èƒ½ç”¨äºæŒ‘é€‰èµ„æºå¯¹è±¡ ä»…ç”¨äºä¸ºå¯¹è±¡æä¾›<strong>å…ƒæ•°æ®</strong></li><li>æ²¡æœ‰é”®é•¿åº¦/å€¼é•¿åº¦é™åˆ¶</li></ul></li><li><p>spec.restartPolicy</p><ul><li>é‡å¯ç­–ç•¥: One of Always, OnFailure, Never. Default to Always</li></ul></li></ul><h4 id=podç”Ÿå‘½å‘¨æœŸ>Podç”Ÿå‘½å‘¨æœŸ</h4><p><a class=link href=https://kubernetes.io/zh-cn/docs/concepts/workloads/pods/pod-lifecycle/ target=_blank rel=noopener>pod-lifecycle</a></p><ul><li><p>çŠ¶æ€</p><ul><li>Pending # è°ƒåº¦å°šæœªå®Œæˆ</li><li>Running # è¿è¡ŒçŠ¶æ€</li><li>Failed</li><li>Succeeded</li><li>Unknown</li><li>&mldr;</li></ul></li><li><p>Podç”Ÿå‘½å‘¨æœŸä¸­çš„é‡è¦è¡Œä¸º</p><ul><li>åˆå§‹åŒ–å®¹å™¨<ul><li>æŒ‰é¡ºåºåŒæ­¥æ‰§è¡Œ</li><li>æ‰§è¡ŒæˆåŠŸæ‰ä¼šç»§ç»­æ‰§è¡Œä¸‹ä¸€ä¸ª</li><li>è‹¥æŸä¸€ä¸ªæ‰§è¡Œå¤±è´¥ ä¼šå…¨éƒ¨é‡æ–°æ‰§è¡Œ</li><li>åˆå§‹åŒ–å®¹å™¨å…·æœ‰é˜»å¡çš„ç‰¹æ€§ åˆå§‹åŒ–å®¹å™¨ä¸æ‰§è¡Œå®Œæˆ åˆ™é˜»å¡ç€ä¸»å®¹å™¨çš„å¯åŠ¨</li></ul></li><li>å®¹å™¨æ¢æµ‹(è‡ªå®šä¹‰å‘½ä»¤/TCPå¥—æ¥å­—å‘è¯·æ±‚/HTTPåº”ç”¨å±‚è¯·æ±‚)<ul><li>start probe: å¯åŠ¨æ¢æµ‹</li><li>liveness probe: æ¢æµ‹å®¹å™¨æ˜¯å¦å­˜æ´»</li><li>readiness probe: æ¢æµ‹å®¹å™¨æ˜¯å¦å‡†å¤‡å°±ç»ª èƒ½å¯¹å¤–æä¾›æœåŠ¡</li></ul></li><li>é’©å­<ul><li>post start<ul><li>å¯åŠ¨åé’©å­ åœ¨åˆå§‹åŒ–å®¹å™¨æ‰§è¡Œå®Œæˆ å¼€å§‹åˆå§‹åŒ–ä¸»å®¹å™¨æ—¶ å°±ä¼šå¯åŠ¨</li><li>æ‰€ä»¥ å¹¶ä¸ä¿è¯åœ¨ä¸»å®¹å™¨å¯åŠ¨å‘½ä»¤æ‰§è¡Œå®Œæˆåå†æ‰§è¡Œ</li><li>æœ‰å¯èƒ½å¯åŠ¨å‘½ä»¤è€—æ—¶è¾ƒä¹… ä½†æ˜¯post starté’©å­å·²ç»æ‰§è¡Œå®Œæˆ</li></ul></li><li>pre stop<ul><li>åœæ­¢å‰é’©å­</li></ul></li></ul></li></ul></li><li><p>preStopé’©å­å»¶ä¼¸</p><ul><li>åœ¨k8sä¸­ ç†æƒ³çš„çŠ¶æ€æ˜¯podä¼˜é›…é‡Šæ”¾ ä½†å¹¶ä¸æ˜¯æ¯ä¸€ä¸ªpodéƒ½ä¼šå¦‚æ­¤é¡ºåˆ©<ul><li>podå¡æ­» å¤„ç†ä¸äº†ä¼˜é›…é€€å‡ºçš„å‘½ä»¤æˆ–æ“ä½œ</li><li>ä¼˜é›…é€€å‡ºçš„é€»è¾‘æœ‰bug é™·å…¥æ­»å¾ªç¯</li><li>ä»£ç é—®é¢˜ å¯¼è‡´æ‰§è¡Œçš„å‘½ä»¤æ²¡æœ‰æ•ˆæœ</li></ul></li><li>å¯¹äºä»¥ä¸Šé—®é¢˜ k8sçš„ç»ˆæ­¢æµç¨‹ä¸­è¿˜æœ‰ä¸€ä¸ª æœ€å¤šå¯ä»¥å®¹å¿çš„æ—¶é—´" å³<code>grace period</code></li><li>åœ¨<code>pod.spec.termiationGracePeriodSeconds</code>å­—æ®µå®šä¹‰ é»˜è®¤å€¼ä¸º30s</li><li>å½“æˆ‘ä»¬æ‰§è¡Œ<code>kubelet delete</code>çš„æ—¶å€™ ä¹Ÿå¯ä»¥åŠ ä¸Š<code>--grace-period</code>å‚æ•°æ˜¾ç¤ºæŒ‡å®šä¸€ä¸ªä¼˜é›…é€€å‡ºæ—¶é—´æ¥è¦†ç›–podä¸­çš„é…ç½®</li><li>å¦‚æœæˆ‘ä»¬é…ç½®çš„<code>grace period</code>è¶…è¿‡æ—¶é—´ä¹‹å k8så°±åªèƒ½å¼ºåˆ¶kill pod</li><li>å€¼å¾—æ³¨æ„çš„æ˜¯ è¿™ä¸preStop hookå’ŒSIGTERMä¿¡å·å¹¶è¡Œå‘ç”Ÿ k8sä¸ä¼šç­‰å¾…preStop hookçš„å®Œæˆ å¦‚æœä½ çš„åº”ç”¨ç¨‹åºå®Œæˆå…³é—­å¹¶åœ¨<code>terminationGracePeriod</code>å®Œæˆä¹‹å‰é€€å‡º k8sä¼šç«‹å³è¿›å…¥ä¸‹ä¸€æ­¥</li></ul><p><img src=/p/kubernetes/icons/pod-lifecycle.png width=1699 height=1081 srcset="/p/kubernetes/icons/pod-lifecycle_hu2bfece0da84b3c986dc09776ada24d78_200404_480x0_resize_box_3.png 480w, /p/kubernetes/icons/pod-lifecycle_hu2bfece0da84b3c986dc09776ada24d78_200404_1024x0_resize_box_3.png 1024w" loading=lazy alt=pod-lifecycle class=gallery-image data-flex-grow=157 data-flex-basis=377px></p></li></ul><h4 id=åˆå§‹åŒ–å®¹å™¨>åˆå§‹åŒ–å®¹å™¨</h4><p><a class=link href=https://kubernetes.io/zh-cn/docs/concepts/workloads/pods/init-containers/ target=_blank rel=noopener>init-cotainers</a></p><ul><li>initå®¹å™¨ä¸æ™®é€šå®¹å™¨éå¸¸åƒ é™¤ä»¥ä¸‹2ç‚¹<ul><li>initå®¹å™¨æ€»æ˜¯è¿è¡Œåˆ°æˆåŠŸå®Œæˆä¸ºæ­¢</li><li>æ¯ä¸ªinitå®¹å™¨éƒ½å¿…é¡»åœ¨ä¸‹ä¸€ä¸ªinitå®¹å™¨å¯åŠ¨ä¹‹å‰æˆåŠŸå®Œæˆ</li></ul></li><li>å¦‚æœPodçš„initå®¹å™¨å¤±è´¥ Kubernetesä¼šä¸æ–­çš„é‡å¯è¯¥PodçŸ¥é“initå®¹å™¨æˆåŠŸä¸ºæ­¢</li><li>ç„¶å å¦‚æœPodå¯¹åº”çš„<code>restartPolicy</code>ä¸ºNever å®ƒä¸ä¼šé‡æ–°å¯åŠ¨</li><li>initCä¸åº”ç”¨å®¹å™¨å…·å¤‡ä¸åŒçš„é•œåƒ å¯ä»¥æŠŠä¸€äº›å±é™©çš„å·¥å…·æ”¾ç½®åœ¨initCä¸­ è¿›è¡Œä½¿ç”¨</li><li>initCå¤šä¸ªä¹‹é—´æ—¶çº¿å½¢å¯åŠ¨çš„ æ‰€ä»¥å¯ä»¥åšä¸€äº›å»¶è¿Ÿæ€§çš„æ“ä½œ</li><li>initCä¸æ”¯æŒ<code>lifeycle</code> <code>æ¢é’ˆ</code> å…¶ä»–ä¸åº”ç”¨å®¹å™¨æ— å¼‚</li></ul><h5 id=å®éªŒ>å®éªŒ</h5><ul><li>ä¸‹é¢çš„ä¾‹å­å®šä¹‰äº†ä¸€ä¸ªå…·æœ‰2ä¸ªInitå®¹å™¨çš„ç®€å•Pod<ul><li>ç¬¬ä¸€ä¸ªç­‰å¾…myserviceå¯åŠ¨</li><li>ç¬¬äºŒä¸ªç­‰å¾…mydbå¯åŠ¨</li><li>ä¸€æ—¦è¿™ä¸¤ä¸ªInitå®¹å™¨éƒ½å¯åŠ¨å®Œæˆ Podå°†å¯åŠ¨specèŠ‚ä¸­çš„åº”ç”¨å®¹å™¨</li></ul></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>initc-1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>initc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>myapp-container</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>busybox</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>command</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=s2>&#34;sh&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=s2>&#34;-c&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=s2>&#34;echo The app is running &amp;&amp; sleep 3600&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>initContainers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>init-myservice</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>busybox</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>command</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=s2>&#34;sh&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=s2>&#34;-c&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=s2>&#34;until nslookup myservice; do echo waiting for myservice; sleep 2; done;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>init-mydb</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>wangyanglinux/tools:busybox</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>command</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=s2>&#34;sh&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=s2>&#34;-c&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=s2>&#34;until nslookup mydb; do echo waiting for mydb; sleep2; done;&#34;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># kubectl apply -f initc.yaml</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># æŸ¥çœ‹å®¹å™¨çŠ¶æ€å¯ä»¥çœ‹åˆ° ç›®å‰å¡åœ¨Inité˜¶æ®µ ç­‰å¾…2ä¸ªåˆå§‹åŒ–å®¹å™¨çš„æˆåŠŸé€€å‡º</span>
</span></span><span class=line><span class=cl><span class=c1># kubectl get -f initc.yaml</span>
</span></span><span class=line><span class=cl>NAME      READY   STATUS     RESTARTS   AGE
</span></span><span class=line><span class=cl>initc-1   0/1     Init:0/2   <span class=m>0</span>          35m
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># æŸ¥çœ‹å®¹å™¨æ—¥å¿—çœ‹åˆ° åº”ç”¨å®¹å™¨åœ¨ç­‰å¾…åˆå§‹åŒ– å› ä¸ºåˆå§‹åŒ–å®¹å™¨é˜»å¡äº†åº”ç”¨å®¹å™¨</span>
</span></span><span class=line><span class=cl><span class=c1># kubectl logs -f initc-1</span>
</span></span><span class=line><span class=cl>Defaulted container <span class=s2>&#34;myapp-container&#34;</span> out of: myapp-container, init-myservice <span class=o>(</span>init<span class=o>)</span>, init-mydb <span class=o>(</span>init<span class=o>)</span>
</span></span><span class=line><span class=cl>Error from server <span class=o>(</span>BadRequest<span class=o>)</span>: container <span class=s2>&#34;myapp-container&#34;</span> in pod <span class=s2>&#34;initc-1&#34;</span> is waiting to start: PodInitializing
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ä¹Ÿå¯ä»¥å•ç‹¬æŸ¥çœ‹åˆå§‹åŒ–å®¹å™¨çš„æ—¥å¿—</span>
</span></span><span class=line><span class=cl><span class=c1># kubectl logs -f initc-1 -c init-myservice</span>
</span></span><span class=line><span class=cl>Server: 10.96.0.10
</span></span><span class=line><span class=cl>Address: 10.96.0.10:53
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>** server can not find myservice.default.svc.cluster.local: NXDOMAIN
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>waiting <span class=k>for</span> myservice
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ç¬¬äºŒä¸ªåˆå§‹åŒ–å®¹å™¨ä¹Ÿè¢«é˜»å¡</span>
</span></span><span class=line><span class=cl><span class=c1># kubectl logs -f initc-1 -c init-db</span>
</span></span><span class=line><span class=cl>Error from server <span class=o>(</span>BadRequest<span class=o>)</span>: container <span class=s2>&#34;init-mydb&#34;</span> in pod <span class=s2>&#34;initc-1&#34;</span> is waiting to start: PodInitializing
</span></span></code></pre></td></tr></table></div></div><ul><li>å¢åŠ å¯¹åº”serviceå åˆ™initå®¹å™¨æˆåŠŸæ‰§è¡Œ åº”ç”¨å®¹å™¨æ­£å¸¸åˆå§‹åŒ–</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>myservice</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>TCP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=m>9376</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mydb</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>TCP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=m>9377</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=podå®¹å™¨æ¢é’ˆç±»å‹>Podå®¹å™¨æ¢é’ˆç±»å‹</h4><p><a class=link href=https://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/ target=_blank rel=noopener>é…ç½®æ¢é’ˆ</a></p><p><code>kubectl explain pod.spec.containers.livenessProbe</code>
<code>kubectl explain pod.spec.containers.readinessProbe</code></p><ul><li>exec Action</li><li>httpGet Action</li><li>tcpSocket Action</li></ul><h4 id=podæ§åˆ¶å™¨>Podæ§åˆ¶å™¨</h4><p><a class=link href=https://kubernetes.io/zh-cn/docs/concepts/architecture/controller/ target=_blank rel=noopener>æ§åˆ¶å™¨</a>
<a class=link href=https://kubernetes.io/zh-cn/docs/concepts/workloads/controllers/ target=_blank rel=noopener>å·¥ä½œè´Ÿè½½ç®¡ç†</a></p><ul><li><p>ReplicaSet</p><ul><li>Kubectl explain replicaset</li><li>ç”¨æˆ·æœŸæœ›å‰¯æœ¬æ•° æ ‡ç­¾é€‰æ‹©å™¨ Podèµ„æºæ¨¡ç‰ˆ</li><li>ä¸å»ºè®®ç›´æ¥ä½¿ç”¨ReplicaSet</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ReplicaSet</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>myapp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>myapp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>release</span><span class=p>:</span><span class=w> </span><span class=l>canary</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>myapp-pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>myapp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>release</span><span class=p>:</span><span class=w> </span><span class=l>canary</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>environment</span><span class=p>:</span><span class=w> </span><span class=l>qa</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>myapp-container</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>nginx:alpine</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>http</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></li><li><p>Deployment</p><ul><li>æ„å»ºåœ¨ReplicaSetä¹‹ä¸Š è€ŒéPod<ul><li>å®ç°æ»šåŠ¨æ›´æ–°(å¤šå‡ºæˆ–å°‘äºNä¸ªå‰¯æœ¬ æ§åˆ¶æ›´æ–°ç²’åº¦)ã€å›æ»š</li><li>é€šå¸¸ç®¡ç†10ä¸ªå†å²ç‰ˆæœ¬(ReplicaSet)</li></ul></li><li>ç®¡ç†æ— çŠ¶æ€åº”ç”¨æœ€å¥½çš„æ§åˆ¶å™¨</li><li>æ— çŠ¶æ€(åªå…³æ³¨ç¾¤ä½“ã€ä¸å…³æ³¨ä¸ªä½“)ã€æŒç»­è¿è¡Œåº”ç”¨</li><li>å£°æ˜å¼ç®¡ç†(å³å¯ä»¥åˆ›å»º ä¹Ÿå¯ä»¥æ›´æ–° <code>kubectl apply -f deployment.yaml</code>)</li><li><code>kubectl rollout history</code> æŸ¥çœ‹æ»šåŠ¨å†å²</li><li><code>kubectl rollout --help</code> æŸ¥çœ‹rolloutæ‰€æœ‰å­å‘½åå¸®åŠ©<ul><li>æ³¨æ„ï¼š<code>kubectl rollout restart deployment/abc</code> # é‡å¯Pod å®é™…æ˜¯æ»šåŠ¨æ›´æ–° åˆ æ‰é‡å»ºæ–°çš„Pod</li></ul></li></ul></li></ul><p><img src=/p/kubernetes/icons/deployment-update.png width=1728 height=566 srcset="/p/kubernetes/icons/deployment-update_hu1b11393a4a96395d8bc44f2effe78eee_1490645_480x0_resize_box_3.png 480w, /p/kubernetes/icons/deployment-update_hu1b11393a4a96395d8bc44f2effe78eee_1490645_1024x0_resize_box_3.png 1024w" loading=lazy alt=deployment-update class=gallery-image data-flex-grow=305 data-flex-basis=732px></p><ul><li><p>DaemonSet</p><ul><li><code>kubectl explain deployment.spec.strategy.rollingUpdate</code> # æ»šåŠ¨æ›´æ–°ç­–ç•¥</li><li>ç¡®ä¿é›†ç¾¤ä¸­çš„æ¯ä¸€ä¸ªèŠ‚ç‚¹(æˆ–éƒ¨åˆ†æ»¡è¶³æ¡ä»¶çš„èŠ‚ç‚¹)ç²¾ç¡®è¿è¡Œä¸€ä¸ªPodå‰¯æœ¬</li><li>é€šå¸¸ç”¨äºä¸€äº›ç³»ç»Ÿçº§çš„åå°ä»»åŠ¡</li><li>æ— çŠ¶æ€ã€æŒç»­è¿è¡Œåº”ç”¨</li></ul></li><li><p>Job</p><ul><li>åªåšä¸€æ¬¡ åªè¦å®Œæˆå°±æ­£å¸¸é€€å‡º æ²¡å®Œæˆæ‰è¿›è¡Œé‡æ„</li><li>æ‰§è¡Œä¸€æ¬¡æ€§çš„ä½œä¸š</li><li>ä¸éœ€è¦æŒç»­åœ¨åå°è¿è¡Œ æ‰§è¡Œå®Œæˆå°±é€€å‡º</li></ul></li><li><p>Cronjob</p><ul><li>å‘¨æœŸæ€§Job</li></ul></li><li><p>StatefulSet</p><ul><li>ç®¡ç†æœ‰çŠ¶æ€åº”ç”¨</li><li>æ¯ä¸€ä¸ªpodå‰¯æœ¬å•ç‹¬ç®¡ç† æ‹¥æœ‰è‡ªå·±ç‹¬æœ‰çš„æ ‡è¯†å’Œç‹¬æœ‰çš„æ•°æ®é›†</li></ul></li><li><p>TPR: Third Party Resources 1.2+ - 1.7</p></li><li><p>CDE: Custom Defined Resources 1.8+</p></li><li><p>Operator</p></li></ul><h3 id=service>Service</h3><h4 id=serviceä»£ç†>Serviceä»£ç†</h4><p><a class=link href=https://kubernetes.io/zh-cn/docs/concepts/services-networking/service/ target=_blank rel=noopener>services-networking</a></p><ul><li>userspace<ul><li>kube-proxyä¼šç›‘è§†Kubernetesæ§åˆ¶å¹³é¢å¯¹Serviceå¯¹è±¡å’ŒEndpointså¯¹è±¡çš„æ·»åŠ å’Œç§»é™¤æ“ä½œ</li><li>å¯¹æ¯ä¸ªServiceå®ƒä¼šåœ¨æœ¬åœ°Nodeä¸Šæ‰“å¼€ä¸€ä¸ªç«¯å£(éšæœºé€‰æ‹©) ä»»ä½•è¿æ¥åˆ°<strong>ä»£ç†ç«¯å£</strong>çš„è¯·æ±‚ éƒ½ä¼šè¢«ä»£ç†åˆ°Serviceçš„åç«¯<code>Pods</code>ä¸­çš„æŸä¸ªä¸Šé¢<ul><li>ä½¿ç”¨å“ªä¸ªåç«¯Podæ˜¯ kube-proxy åŸºäº<code>SessionAffinity</code>æ¥ç¡®å®šçš„</li></ul></li><li>æœ€å å®ƒé…ç½® iptables è§„åˆ™ æ•è·åˆ°è¾¾è¯¥ Service çš„<code>clusterIP</code>(æ˜¯è™šæ‹Ÿ IP)å’Œ<code>Port</code>çš„è¯·æ±‚ å¹¶é‡å®šå‘åˆ°ä»£ç†ç«¯å£ ä»£ç†ç«¯å£å†ä»£ç†è¯·æ±‚åˆ°åç«¯Pod<ul><li>é»˜è®¤æƒ…å†µä¸‹ ç”¨æˆ·ç©ºé—´æ¨¡å¼ä¸‹çš„kube-proxyé€šè¿‡è½®è½¬ç®—æ³•é€‰æ‹©åç«¯</li></ul></li><li>æµé‡æ¥å›åœ¨å†…æ ¸å’Œç”¨æˆ·ç©ºé—´åˆ‡æ¢ æ•ˆç‡è¾ƒä½</li></ul></li></ul><p><img src=/p/kubernetes/icons/services-userspace-overview.svg loading=lazy alt=services-userspace-overview></p><ul><li>iptables<ul><li><p><code>kube-proxy</code>ä¼šç›‘è§†Kubernetesæ§åˆ¶èŠ‚ç‚¹å¯¹Serviceå¯¹è±¡å’ŒEndpointså¯¹è±¡çš„æ·»åŠ å’Œç§»é™¤</p></li><li><p>å¯¹æ¯ä¸ªService å®ƒä¼šé…ç½®iptablesè§„åˆ™ ä»è€Œæ•è·åˆ°è¾¾è¯¥Serviceçš„<code>clusterIP</code>å’Œç«¯å£çš„è¯·æ±‚ è¿›è€Œå°†è¯·æ±‚é‡å®šå‘åˆ° Service çš„ä¸€ç»„åç«¯ä¸­çš„æŸä¸ªPodä¸Šé¢</p></li><li><p>å¯¹äºæ¯ä¸ªEndpointså¯¹è±¡ å®ƒä¹Ÿä¼šé…ç½®iptablesè§„åˆ™ è¿™ä¸ªè§„åˆ™ä¼šé€‰æ‹©ä¸€ä¸ªåç«¯ç»„åˆ</p><ul><li>é»˜è®¤çš„ç­–ç•¥æ˜¯ kube-proxyåœ¨iptablesæ¨¡å¼ä¸‹éšæœºé€‰æ‹©ä¸€ä¸ªåç«¯</li></ul></li><li><p>ä½¿ç”¨iptableså¤„ç†æµé‡å…·æœ‰è¾ƒä½çš„ç³»ç»Ÿå¼€é”€ å› ä¸ºæµé‡ç”±Linux netfilterå¤„ç† è€Œæ— éœ€åœ¨ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´ä¹‹é—´åˆ‡æ¢ è¿™ç§æ–¹æ³•ä¹Ÿå¯èƒ½æ›´å¯é </p></li><li><p>å¦‚æœkube-proxyåœ¨iptablesæ¨¡å¼ä¸‹è¿è¡Œ å¹¶ä¸”æ‰€é€‰çš„ç¬¬ä¸€ä¸ª Pod æ²¡æœ‰å“åº” åˆ™è¿æ¥å¤±è´¥</p><ul><li>è¿™ä¸ç”¨æˆ·ç©ºé—´æ¨¡å¼ä¸åŒ: åœ¨è¿™ç§æƒ…å†µä¸‹ kube-proxyå°†æ£€æµ‹åˆ°ä¸ç¬¬ä¸€ä¸ªPodçš„è¿æ¥å·²å¤±è´¥ å¹¶ä¼šè‡ªåŠ¨ä½¿ç”¨å…¶ä»–åç«¯Pod é‡è¯•</li><li>å¯ä»¥ä½¿ç”¨Pod<a class=link href=https://kubernetes.io/zh-cn/docs/concepts/workloads/pods/pod-lifecycle/#container-probes target=_blank rel=noopener>å°±ç»ªæ¢æµ‹å™¨</a> éªŒè¯åç«¯Podå¯ä»¥æ­£å¸¸å·¥ä½œ ä»¥ä¾¿iptablesæ¨¡å¼ä¸‹çš„kube-proxyä»…çœ‹åˆ°æµ‹è¯•æ­£å¸¸çš„åç«¯ é¿å…å°†æµé‡é€šè¿‡kube-proxyå‘é€åˆ°å·²çŸ¥å·²å¤±è´¥çš„ Pod</li></ul></li></ul></li></ul><p><img src=/p/kubernetes/icons/services-iptables-overview.svg loading=lazy alt=services-iptables-overview></p><ul><li>ipvs<ul><li><p>ç‰¹æ€§çŠ¶æ€ï¼š Kubernetes v1.11 [stable]</p></li><li><p>åœ¨<code>ipvs</code>æ¨¡å¼ä¸‹ kube-proxyç›‘è§†KubernetesæœåŠ¡å’Œç«¯ç‚¹ è°ƒç”¨<code>netlink</code>æ¥å£åˆ›å»ºç›¸åº”çš„IPVSè§„åˆ™ å¹¶å®šæœŸå°†IPVSè§„åˆ™ä¸KubernetesæœåŠ¡å’Œç«¯ç‚¹åŒæ­¥ è¯¥æ§åˆ¶å¾ªç¯å¯ç¡®ä¿ IPVS çŠ¶æ€ä¸æ‰€éœ€çŠ¶æ€åŒ¹é…</p></li><li><p>è®¿é—®æœåŠ¡æ—¶ IPVSå°†æµé‡å®šå‘åˆ°åç«¯Podä¹‹ä¸€</p></li><li><p>IPVSä»£ç†æ¨¡å¼åŸºäºç±»ä¼¼äºiptablesæ¨¡å¼çš„netfilteræŒ‚é’©å‡½æ•° ä½†æ˜¯ä½¿ç”¨å“ˆå¸Œè¡¨ä½œä¸ºåŸºç¡€æ•°æ®ç»“æ„ å¹¶ä¸”åœ¨å†…æ ¸ç©ºé—´ä¸­å·¥ä½œ</p><ul><li>è¿™æ„å‘³ç€ ä¸iptablesæ¨¡å¼ä¸‹çš„kube-proxyç›¸æ¯” IPVSæ¨¡å¼ä¸‹çš„kube-proxyé‡å®šå‘é€šä¿¡çš„å»¶è¿Ÿè¦çŸ­ å¹¶ä¸”åœ¨åŒæ­¥ä»£ç†è§„åˆ™æ—¶å…·æœ‰æ›´å¥½çš„æ€§èƒ½</li><li>ä¸å…¶ä»–ä»£ç†æ¨¡å¼ç›¸æ¯” IPVSæ¨¡å¼è¿˜æ”¯æŒæ›´é«˜çš„ç½‘ç»œæµé‡ååé‡</li></ul></li><li><p>IPVSæä¾›äº†æ›´å¤šé€‰é¡¹æ¥å¹³è¡¡åç«¯Podçš„æµé‡</p><ul><li><code>rr</code>: è½®è¯¢(Round-Robin)</li><li><code>lc</code>: æœ€å°‘é“¾æ¥(Least Connection) å³æ‰“å¼€é“¾æ¥æ•°é‡æœ€å°‘è€…ä¼˜å…ˆ</li><li><code>dh</code>: ç›®æ ‡åœ°å€å“ˆå¸Œ(Destination Hashing)</li><li><code>sh</code>: æºåœ°å€å“ˆå¸Œ(Source Hashing)</li><li><code>sed</code>: æœ€çŸ­é¢„æœŸå»¶è¿Ÿ(Shortest Expected Delay)</li><li><code>nq</code>: ä»ä¸æ’é˜Ÿ(Never Queue)</li></ul></li><li><p>å¤‡æ³¨</p><ul><li>è¦åœ¨IPVSæ¨¡å¼ä¸‹è¿è¡Œkube-proxyå¿…é¡»åœ¨å¯åŠ¨kube-proxyä¹‹å‰ä½¿IPVSåœ¨èŠ‚ç‚¹ä¸Šå¯ç”¨</li><li>å½“kube-proxyä»¥IPVSä»£ç†æ¨¡å¼å¯åŠ¨æ—¶ å®ƒå°†éªŒè¯IPVSå†…æ ¸æ¨¡å—æ˜¯å¦å¯ç”¨<ul><li>å¦‚æœæœªæ£€æµ‹åˆ°IPVSå†…æ ¸æ¨¡å— åˆ™kube-proxyå°†é€€å›åˆ°ä»¥iptablesä»£ç†æ¨¡å¼è¿è¡Œ</li></ul></li></ul></li></ul></li></ul><p><img src=/p/kubernetes/icons/services-ipvs-overview.svg loading=lazy alt=services-ipvs-overview></p><h4 id=serviceç±»å‹>Serviceç±»å‹</h4><ul><li>ClusterIP: é€šè¿‡é›†ç¾¤çš„å†…éƒ¨IPæš´éœ²æœåŠ¡ é€‰æ‹©è¯¥å€¼æ—¶æœåŠ¡åªèƒ½å¤Ÿåœ¨é›†ç¾¤å†…éƒ¨è®¿é—® è¿™ä¹Ÿæ˜¯é»˜è®¤çš„<code>ServiceType</code></li><li><a class=link href=https://kubernetes.io/zh-cn/docs/concepts/services-networking/service/#type-nodeport target=_blank rel=noopener>NodePort</a>: é€šè¿‡æ¯ä¸ªèŠ‚ç‚¹ä¸Šçš„IPå’Œé™æ€ç«¯å£(NodePort)æš´éœ²æœåŠ¡ NodePortæœåŠ¡ä¼šè·¯ç”±åˆ°è‡ªåŠ¨åˆ›å»ºçš„ClusterIPæœåŠ¡<ul><li>é€šè¿‡è¯·æ±‚ <code>&lt;èŠ‚ç‚¹IP>:&lt;èŠ‚ç‚¹ç«¯å£></code> ä½ å¯ä»¥ä»é›†ç¾¤çš„å¤–éƒ¨è®¿é—®ä¸€ä¸ªNodePortæœåŠ¡</li><li>Client -> NodeIP:NodePort -> ClusterIP:ServicePort -> PodIP:containerPort</li><li>ä¸ºé¿å…å•Nodeå‹åŠ›è¿‡å¤§ ä¼šåœ¨å¤–é¢å†åŠ ä¸€å±‚è´Ÿè½½å‡è¡¡<ul><li>å…¬æœ‰äº‘ç¯å¢ƒ: LBaaS(å‚è€ƒä¸‹é¢LoadBalancerç±»å‹)</li></ul></li></ul></li><li><a class=link href=https://kubernetes.io/zh-cn/docs/concepts/services-networking/service/#loadbalancer target=_blank rel=noopener>LoadBalancer</a>: ä½¿ç”¨äº‘æä¾›å•†çš„è´Ÿè½½å‡è¡¡å™¨å‘å¤–éƒ¨æš´éœ²æœåŠ¡ å¤–éƒ¨è´Ÿè½½å‡è¡¡å™¨å¯ä»¥å°†æµé‡è·¯ç”±åˆ°è‡ªåŠ¨åˆ›å»ºçš„NodePortæœåŠ¡å’ŒClusterIPæœåŠ¡ä¸Š</li><li><a class=link href=https://kubernetes.io/zh-cn/docs/concepts/services-networking/service/#externalname target=_blank rel=noopener>ExternalName</a>: é€šè¿‡è¿”å›CNAMEå’Œå¯¹åº”å€¼ å¯ä»¥å°†æœåŠ¡æ˜ å°„åˆ°externalNameå­—æ®µçš„å†…å®¹(ä¾‹å¦‚<code>foo.bar.example.com</code>) æ— éœ€åˆ›å»ºä»»ä½•ç±»å‹ä»£ç†<ul><li>FQDN(CoreDNS å†…éƒ¨è§£æ)<ul><li>CNAME -> FQDN(å¤–éƒ¨çœŸæ­£çš„FQDN )</li></ul></li></ul></li></ul><h4 id=headless-servicesæ— å¤´service>Headless Services(æ— å¤´Service)</h4><ul><li>æœ‰æ—¶ä¸éœ€è¦æˆ–ä¸æƒ³è¦è´Ÿè½½å‡è¡¡ ä»¥åŠå•ç‹¬çš„Service IP é‡åˆ°è¿™ç§æƒ…å†µ å¯ä»¥é€šè¿‡æŒ‡å®šCluster IP(<code>spec.clusterIP</code>)çš„å€¼ä¸º <code>"None"</code>æ¥åˆ›å»º <code>Headless</code> Service</li><li>ä½ å¯ä»¥ä½¿ç”¨ä¸€ä¸ªæ— å¤´Serviceä¸å…¶ä»–æœåŠ¡å‘ç°æœºåˆ¶è¿›è¡Œæ¥å£ è€Œä¸å¿…ä¸Kubernetesçš„å®ç°æ†ç»‘åœ¨ä¸€èµ·</li><li>å¯¹äºæ— å¤´<code>Services</code>å¹¶ä¸ä¼šåˆ†é…Cluster IP kube-proxyä¸ä¼šå¤„ç†å®ƒä»¬ è€Œä¸”å¹³å°ä¹Ÿä¸ä¼šä¸ºå®ƒä»¬è¿›è¡Œè´Ÿè½½å‡è¡¡å’Œè·¯ç”± DNSå¦‚ä½•å®ç°è‡ªåŠ¨é…ç½® ä¾èµ–äºServiceæ˜¯å¦å®šä¹‰äº†é€‰æ‹©ç®—ç¬¦</li><li>æ— å¤´Serviceå…è®¸å®¢æˆ·ç«¯ç›´æ¥è¿æ¥åˆ°å®ƒæ‰€åå¥½çš„ä»»ä¸€Pod æ— å¤´Serviceä¸ä½¿ç”¨è™šæ‹ŸIPåœ°å€å’Œä»£ç†é…ç½®è·¯ç”±å’Œæ•°æ®åŒ…è½¬å‘ ç›¸å æ— å¤´Serviceé€šè¿‡å†…éƒ¨DNSè®°å½•æŠ¥å‘Šå„ä¸ªPodçš„ç«¯ç‚¹IPåœ°å€ è¿™äº›DNSè®°å½•æ˜¯ç”±é›†ç¾¤çš„DNSæœåŠ¡æ‰€æä¾› è¦å®šä¹‰æ— å¤´ Service ä½ éœ€è¦å°†<code>.spec.type</code>è®¾ç½®ä¸ºClusterIP(è¿™ä¹Ÿæ˜¯typeçš„é»˜è®¤å€¼) å¹¶è¿›ä¸€æ­¥å°†<code>.spec.clusterIP</code>è®¾ç½®ä¸º None</li></ul><h4 id=æµé‡ç­–ç•¥>æµé‡ç­–ç•¥</h4><p><a class=link href=https://kubernetes.io/zh-cn/docs/reference/networking/virtual-ips/#traffic-policies target=_blank rel=noopener>traffic-policies</a></p><ul><li><p>ä½ å¯ä»¥è®¾ç½®<code>.spec.internalTrafficPolicy</code>å’Œ<code>.spec.externalTrafficPolicy</code>å­—æ®µæ¥æ§åˆ¶kuberneteså¦‚ä½•å°†æµé‡è·¯ç”±åˆ°å¥åº·(&ldquo;å°±ç»ª&rdquo;)çš„åç«¯</p></li><li><p>å†…éƒ¨æµé‡ç­–ç•¥</p><ul><li>ç‰¹æ€§çŠ¶æ€ï¼š Kubernetes v1.26 [stable]</li><li>ä½ å¯ä»¥è®¾ç½®<code>.spec.internalTrafficPolicy</code>å­—æ®µæ¥æ§åˆ¶æ¥è‡ªå†…éƒ¨æºçš„æµé‡å¦‚ä½•è¢«è·¯ç”± æœ‰æ•ˆå€¼ä¸º<code>Cluster</code>å’Œ<code>Local</code></li><li>å°†å­—æ®µè®¾ç½®ä¸º<code>Cluster</code>ä¼šå°†å†…éƒ¨æµé‡è·¯ç”±åˆ°æ‰€æœ‰å‡†å¤‡å°±ç»ªçš„ç«¯ç‚¹</li><li>å°†å­—æ®µè®¾ç½®ä¸º<code>Local</code>ä»…ä¼šå°†æµé‡è·¯ç”±åˆ°æœ¬åœ°èŠ‚ç‚¹å‡†å¤‡å°±ç»ªçš„ç«¯ç‚¹</li><li>å¦‚æœæµé‡ç­–ç•¥ä¸º<code>Local</code>ä½†æ²¡æœ‰æœ¬åœ°èŠ‚ç‚¹ç«¯ç‚¹ é‚£ä¹ˆkube-proxyä¼š<strong>ä¸¢å¼ƒ</strong>è¯¥æµé‡</li></ul></li><li><p>å¤–éƒ¨æµé‡ç­–ç•¥</p><ul><li>ä½ å¯ä»¥è®¾ç½®<code>.spec.externalTrafficPolicy</code>å­—æ®µæ¥æ§åˆ¶ä»å¤–éƒ¨æºè·¯ç”±çš„æµé‡ æœ‰æ•ˆå€¼ä¸º<code>Cluster</code>å’Œ<code>Local</code></li><li>å°†å­—æ®µè®¾ç½®ä¸º<code>Cluster</code>ä¼šå°†å¤–éƒ¨æµé‡è·¯ç”±åˆ°æ‰€æœ‰å‡†å¤‡å°±ç»ªçš„ç«¯ç‚¹</li><li>å°†å­—æ®µè®¾ç½®ä¸º<code>Local</code>ä»…ä¼šå°†æµé‡è·¯ç”±åˆ°æœ¬åœ°èŠ‚ç‚¹ä¸Šå‡†å¤‡å°±ç»ªçš„ç«¯ç‚¹</li><li>å¦‚æœæµé‡ç­–ç•¥ä¸º<code>Local</code>å¹¶ä¸”æ²¡æœ‰æœ¬åœ°èŠ‚ç‚¹ç«¯ç‚¹ é‚£ä¹ˆkube-proxyä¸ä¼šè½¬å‘ä¸ç›¸å…³Serviceç›¸å…³çš„ä»»ä½•æµé‡</li></ul></li></ul><h4 id=ä¼šè¯äº²å’Œæ€§>ä¼šè¯äº²å’Œæ€§</h4><p><a class=link href=https://kubernetes.io/zh-cn/docs/reference/networking/virtual-ips/#session-affinity target=_blank rel=noopener>session-affinity</a></p><ul><li>åœ¨è¿™äº›ä»£ç†æ¨¡å‹ä¸­ ç»‘å®šåˆ°<code>Service IP:Port</code>çš„æµé‡è¢«ä»£ç†åˆ°åˆé€‚çš„åç«¯ å®¢æˆ·ç«¯ä¸éœ€è¦çŸ¥é“ä»»ä½•å…³äºKubernetesã€Serviceæˆ–Podçš„ä¿¡æ¯</li><li>å¦‚æœè¦ç¡®ä¿æ¥è‡ªç‰¹å®šå®¢æˆ·ç«¯çš„è¿æ¥æ¯æ¬¡éƒ½ä¼ é€’ç»™åŒä¸€ä¸ªPod ä½ å¯ä»¥é€šè¿‡è®¾ç½®Serviceçš„ <code>.spec.sessionAffinity</code>ä¸º<code>ClientIP</code>æ¥è®¾ç½®åŸºäºå®¢æˆ·ç«¯IPåœ°å€çš„ä¼šè¯äº²å’Œæ€§</li><li>é»˜è®¤ä¸º<code>None</code></li></ul><h5 id=ä¼šè¯ç²˜æ€§è¶…æ—¶>ä¼šè¯ç²˜æ€§è¶…æ—¶</h5><ul><li>ä½ è¿˜å¯ä»¥é€šè¿‡è®¾ç½®Serviceçš„<code>.spec.sessionAffinityConfig.clientIP.timeoutSeconds</code>æ¥è®¾ç½®æœ€å¤§ä¼šè¯ç²˜æ€§æ—¶é—´</li><li>é»˜è®¤å€¼ä¸º10800 å³3å°æ—¶</li><li>è¯´æ˜ï¼šåœ¨Windowsä¸Šä¸æ”¯æŒä¸ºServiceè®¾ç½®æœ€å¤§ä¼šè¯ç²˜æ€§æ—¶é—´</li></ul><h3 id=ingress>Ingress</h3><p><img src=/p/kubernetes/icons/ingress-flow.png width=1182 height=886 srcset="/p/kubernetes/icons/ingress-flow_hu9c99a0266fa357bab5ac86316de97a76_1018969_480x0_resize_box_3.png 480w, /p/kubernetes/icons/ingress-flow_hu9c99a0266fa357bab5ac86316de97a76_1018969_1024x0_resize_box_3.png 1024w" loading=lazy alt=ingress-flow class=gallery-image data-flex-grow=133 data-flex-basis=320px></p><p><a class=link href=https://kubernetes.io/zh-cn/docs/concepts/services-networking/ingress/ target=_blank rel=noopener>ingress</a></p><ul><li>Serviceå¯¹åç«¯ç‰¹å®šç±»å‹Podåˆ†ç±»(label selector)</li><li>IngressåŸºäºä¸Šé¢çš„åˆ†ç±»è¯†åˆ«åç«¯Pod å¹¶ç”Ÿæˆé…ç½®ä¿¡æ¯æ³¨å…¥åˆ°nginx(éœ€è¦é‡è½½é…ç½®)/envoy/traefikç­‰</li></ul><p><a class=link href=https://kubernetes.io/zh-cn/docs/concepts/services-networking/ingress-controllers/ target=_blank rel=noopener>ingress-controllers</a></p><h3 id=å­˜å‚¨>å­˜å‚¨</h3><p><a class=link href=https://kubernetes.io/zh-cn/docs/concepts/storage/ target=_blank rel=noopener>kubernetes-storage</a></p><p><code>kubectl explain pods.spec.volumes</code></p><ul><li>emptyDir # ä¸´æ—¶ç›®å½• éšpodåˆ é™¤è€Œæ¶ˆå¤±(ç”Ÿå‘½å‘¨æœŸåŒpod)<ul><li>gitRepo(cloneåˆ°æœºå™¨ ä¿®æ”¹ä¸ä¼šåŒæ­¥ éœ€è¦åŒæ­¥å¯ä»¥è‡ªå·±å†åšä¸€ä¸ªsidecar)</li></ul></li><li>hostPath # å®¿ä¸»æœºè·¯å¾„</li><li>SAN(iSCSI&mldr;)ã€NAS(nfsã€cifs&mldr;)</li><li>åˆ†å¸ƒå¼å­˜å‚¨<ul><li>glusterfsã€rdbã€cephfs</li></ul></li><li>äº‘å­˜å‚¨<ul><li>EBSã€Azure Disk&mldr;</li></ul></li></ul><hr><ul><li>å­˜å‚¨å„ç±»ç‰¹æ€§<ul><li>å…ƒæ•°æ®<ul><li>configMap: ç”¨äºä¿å­˜é…ç½®æ•°æ®(æ˜æ–‡)</li><li>secret: ç”¨äºä¿å­˜æ•æ„Ÿæ•°æ®(ç¼–ç )</li><li>downwardAPI: å®¹å™¨åœ¨è¿è¡Œæ—¶ä»KubernetesAPIæœåŠ¡å™¨è·å–æœ‰å…³å®ƒä»¬è‡ªèº«çš„ä¿¡æ¯</li></ul></li><li>çœŸå®æ•°æ®<ul><li>volume: ç”¨äºå­˜å‚¨ä¸´æ—¶æˆ–è€…æŒä¹…æ€§æ•°æ®</li><li>persistentVolume: ç”³è¯·åˆ¶çš„æŒä¹…åŒ–å­˜å‚¨</li></ul></li></ul></li></ul><h4 id=configmap>configMap</h4><ul><li>configMapæ˜¯ä¸€ç§ API å¯¹è±¡ ç”¨æ¥å°†éæœºå¯†æ€§çš„æ•°æ®ä¿å­˜åˆ°é”®å€¼å¯¹ä¸­</li><li>ä½¿ç”¨æ—¶<a class=link href=https://kubernetes.io/docs/concepts/workloads/pods/pod-overview/ target=_blank rel=noopener>Pods</a>å¯ä»¥å°†å…¶ç”¨ä½œç¯å¢ƒå˜é‡ã€å‘½ä»¤è¡Œå‚æ•°æˆ–è€…å­˜å‚¨å·ä¸­çš„é…ç½®æ–‡ä»¶</li><li>configMapå°†ä½ çš„ç¯å¢ƒé…ç½®ä¿¡æ¯å’Œ<a class=link href="https://kubernetes.io/zh-cn/docs/reference/glossary/?all=true#term-image" target=_blank rel=noopener>å®¹å™¨é•œåƒ</a>è§£è€¦ ä¾¿äºåº”ç”¨é…ç½®çš„ä¿®æ”¹</li></ul><h5 id=å®¹å™¨åŒ–é…ç½®åº”ç”¨æ–¹å¼>å®¹å™¨åŒ–é…ç½®åº”ç”¨æ–¹å¼</h5><ul><li>è‡ªå®šä¹‰å‘½ä»¤è¡Œå‚æ•°<ul><li>args: []</li></ul></li><li>æŠŠé…ç½®æ–‡ä»¶ç›´æ¥æ‰“åŒ…è‡³é•œåƒ</li><li>ç¯å¢ƒå˜é‡<ul><li>CloudNativeçš„åº”ç”¨ç¨‹åºä¸€èˆ¬å¯ç›´æ¥é€šè¿‡ç¯å¢ƒå˜é‡åŠ è½½é…ç½®</li><li>é€šè¿‡entrypointè„šæœ¬æ¥é¢„å¤„ç†å˜é‡ä¸ºé…ç½®æ–‡ä»¶ä¸­çš„é…ç½®ä¿¡æ¯</li></ul></li><li>å­˜å‚¨å·</li></ul><h5 id=åŸºäºç›®å½•åˆ›å»º>åŸºäºç›®å½•åˆ›å»º</h5><ul><li>æ–‡ä»¶å‡†å¤‡ éƒ½æ”¾åˆ°åŒä¸€ä¸ªç›®å½•ä¸‹</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># game.properties</span>
</span></span><span class=line><span class=cl><span class=nv>enemies</span><span class=o>=</span>aliens
</span></span><span class=line><span class=cl><span class=nv>lives</span><span class=o>=</span><span class=m>3</span>
</span></span><span class=line><span class=cl>enemies.cheat<span class=o>=</span><span class=nb>true</span>
</span></span><span class=line><span class=cl>enemies.cheat.level<span class=o>=</span>noGoodRotten
</span></span><span class=line><span class=cl>secret.code.passphrase<span class=o>=</span>UUDDLRLRBABAS
</span></span><span class=line><span class=cl>secret.code.allowed<span class=o>=</span><span class=nb>true</span>
</span></span><span class=line><span class=cl>secret.code.lives<span class=o>=</span><span class=m>30</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ui.properties</span>
</span></span><span class=line><span class=cl>color.good<span class=o>=</span>purple
</span></span><span class=line><span class=cl>color.bad<span class=o>=</span>yellow
</span></span><span class=line><span class=cl>allow.textmode<span class=o>=</span><span class=nb>true</span>
</span></span><span class=line><span class=cl>how.nice.to.look<span class=o>=</span>fairlyNice
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># game-env-file.properties</span>
</span></span><span class=line><span class=cl><span class=nv>enemies</span><span class=o>=</span>aliens
</span></span><span class=line><span class=cl><span class=nv>lives</span><span class=o>=</span><span class=m>3</span>
</span></span><span class=line><span class=cl><span class=nv>allowed</span><span class=o>=</span><span class=s2>&#34;true&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># This comment and the empty line above it are ignored</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>ä»ç›®å½•åˆ›å»º</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># ä»configMapç›®å½•åˆ›å»º</span>
</span></span><span class=line><span class=cl>kubectl create configmap game-config --from-file<span class=o>=</span>configMap/
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># æŸ¥çœ‹å†…å®¹</span>
</span></span><span class=line><span class=cl>kubectl describe  configmaps game-config
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># kubectl get configmaps game-config -o yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>game.properties</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    enemies=aliens
</span></span></span><span class=line><span class=cl><span class=sd>    lives=3
</span></span></span><span class=line><span class=cl><span class=sd>    enemies.cheat=true
</span></span></span><span class=line><span class=cl><span class=sd>    enemies.cheat.level=noGoodRotten
</span></span></span><span class=line><span class=cl><span class=sd>    secret.code.passphrase=UUDDLRLRBABAS
</span></span></span><span class=line><span class=cl><span class=sd>    secret.code.allowed=true
</span></span></span><span class=line><span class=cl><span class=sd>    secret.code.lives=30</span><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ui.properties</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    color.good=purple
</span></span></span><span class=line><span class=cl><span class=sd>    color.bad=yellow
</span></span></span><span class=line><span class=cl><span class=sd>    allow.textmode=true
</span></span></span><span class=line><span class=cl><span class=sd>    how.nice.to.look=fairlyNice</span><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ConfigMap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>creationTimestamp</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;2025-05-06T11:17:42Z&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>game-config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resourceVersion</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;15745032&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>uid</span><span class=p>:</span><span class=w> </span><span class=l>339da6be-8725-4c71-895d-33b6b29937c1</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=åŸºäºæ–‡ä»¶åˆ›å»º>åŸºäºæ–‡ä»¶åˆ›å»º</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># ä½ å¯ä»¥ä½¿ç”¨ kubectl create configmap åŸºäºå•ä¸ªæ–‡ä»¶æˆ–å¤šä¸ªæ–‡ä»¶åˆ›å»º ConfigMap</span>
</span></span><span class=line><span class=cl>kubectl create configmap game-config-2 --from-file<span class=o>=</span>configMap/game.properties
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ä½ å¯ä»¥å¤šæ¬¡ä½¿ç”¨ --from-file å‚æ•° ä»å¤šä¸ªæ•°æ®æºåˆ›å»º ConfigMap</span>
</span></span><span class=line><span class=cl>kubectl create  configmap game-config-2 --from-file<span class=o>=</span>configMap/game.properties --from-file<span class=o>=</span>configMap/ui.properties
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># ä½¿ç”¨ --from-env-file é€‰é¡¹åŸºäº env æ–‡ä»¶åˆ›å»º ConfigMap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># Env æ–‡ä»¶åŒ…å«ç¯å¢ƒå˜é‡åˆ—è¡¨ å…¶ä¸­é€‚ç”¨ä»¥ä¸‹è¯­æ³•è§„åˆ™:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#   Env æ–‡ä»¶ä¸­çš„æ¯ä¸€è¡Œå¿…é¡»ä¸º VAR=VAL æ ¼å¼</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#   ä»¥ï¼ƒå¼€å¤´çš„è¡Œ(å³æ³¨é‡Š)å°†è¢«å¿½ç•¥</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#   ç©ºè¡Œå°†è¢«å¿½ç•¥</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#   å¼•å·ä¸ä¼šè¢«ç‰¹æ®Šå¤„ç†(å³å®ƒä»¬å°†æˆä¸º ConfigMap å€¼çš„ä¸€éƒ¨åˆ†)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># kubectl create configmap game-config-env-file --from-env-file=configMap/game-env-file.properties</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>allowed</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;&#34;true&#34;&#39;</span><span class=w>  </span><span class=c># å¼•å·ä¸ä¼šè¢«ç‰¹æ®Šå¤„ç†</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>enemies</span><span class=p>:</span><span class=w> </span><span class=l>aliens</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>lives</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;3&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ConfigMap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>creationTimestamp</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;2025-05-06T11:31:12Z&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>game-config-env-file</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resourceVersion</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;15746741&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>uid</span><span class=p>:</span><span class=w> </span><span class=l>a01e6c70-2f32-4e3f-814b-72bbf45d79d2</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># ä» Kubernetes 1.23 ç‰ˆæœ¬å¼€å§‹ kubectl æ”¯æŒå¤šæ¬¡æŒ‡å®š --from-env-file å‚æ•°æ¥ä»å¤šä¸ªæ•°æ®æºåˆ›å»º ConfigMap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># kubectl create configmap config-multi-env-files --from-env-file=configMap/game-env-file.properties --from-env-file=configMap/ui-env-file.properties</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>allowed</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;&#34;true&#34;&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>color</span><span class=p>:</span><span class=w> </span><span class=l>purple</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>enemies</span><span class=p>:</span><span class=w> </span><span class=l>aliens</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>how</span><span class=p>:</span><span class=w> </span><span class=l>fairlyNice</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>lives</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;3&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>textmode</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;true&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ConfigMap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>creationTimestamp</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;2025-05-06T11:36:40Z&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>config-multi-env-files</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resourceVersion</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;15747431&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>uid</span><span class=p>:</span><span class=w> </span><span class=l>194d9181-713a-4cc8-8218-ad4c5900f77b</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=å®šä¹‰ä»æ–‡ä»¶åˆ›å»ºæ—¶è¦ä½¿ç”¨çš„é”®>å®šä¹‰ä»æ–‡ä»¶åˆ›å»ºæ—¶è¦ä½¿ç”¨çš„é”®</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl create configmap game-config-3 --from-file<span class=o>=</span>&lt;æˆ‘çš„é”®å&gt;<span class=o>=</span>&lt;æ–‡ä»¶è·¯å¾„&gt;
</span></span></code></pre></td></tr></table></div></div><h5 id=æ ¹æ®å­—é¢å€¼åˆ›å»º>æ ¹æ®å­—é¢å€¼åˆ›å»º</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># ä½ å¯ä»¥å°† kubectl create configmap ä¸ --from-literal å‚æ•°ä¸€èµ·ä½¿ç”¨ é€šè¿‡å‘½ä»¤è¡Œå®šä¹‰æ–‡å­—å€¼</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># ä½ å¯ä»¥ä¼ å…¥å¤šä¸ªé”®å€¼å¯¹ å‘½ä»¤è¡Œä¸­æä¾›çš„æ¯å¯¹é”®å€¼åœ¨ ConfigMap çš„ data éƒ¨åˆ†ä¸­å‡è¡¨ç¤ºä¸ºå•ç‹¬çš„æ¡ç›®</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># kubectl create configmap special-config --from-literal=special.how=very --from-literal=special.type=charm</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>special.how</span><span class=p>:</span><span class=w> </span><span class=l>very</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>special.type</span><span class=p>:</span><span class=w> </span><span class=l>charm</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ConfigMap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>creationTimestamp</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;2025-05-06T11:44:19Z&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>special-config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resourceVersion</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;15748397&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>uid</span><span class=p>:</span><span class=w> </span><span class=l>6952c791-32e6-4905-a45c-c6a1433779ff</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=åœ¨podä¸­ä½¿ç”¨configmapå®šä¹‰çš„ç¯å¢ƒå˜é‡>åœ¨Podä¸­ä½¿ç”¨ConfigMapå®šä¹‰çš„ç¯å¢ƒå˜é‡</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># configmap.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ConfigMap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>special-config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>special.how</span><span class=p>:</span><span class=w> </span><span class=l>very</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ConfigMap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>env-config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>log_level</span><span class=p>:</span><span class=w> </span><span class=l>INFO</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># pod-configmap-env-variable.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>dapi-test-pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>test-container</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>ilolicon/demoapp:v1.0.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=w> </span><span class=s2>&#34;/bin/sh&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;-c&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;env&#34;</span><span class=w> </span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>SPECIAL_LEVEL_KEY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>configMapKeyRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>special-config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>special.how</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>LOG_LEVEL</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>configMapKeyRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>env-config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>log_level</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>restartPolicy</span><span class=p>:</span><span class=w> </span><span class=l>Never</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=å°†configmapä¸­çš„æ‰€æœ‰é”®å€¼å¯¹é…ç½®ä¸ºå®¹å™¨ç¯å¢ƒå˜é‡>å°†ConfigMapä¸­çš„æ‰€æœ‰é”®å€¼å¯¹é…ç½®ä¸ºå®¹å™¨ç¯å¢ƒå˜é‡</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># configmap.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># åŒ…å«å¤šä¸ªé”®å€¼å¯¹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ConfigMap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>special-config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>SPECIAL_LEVEL</span><span class=p>:</span><span class=w> </span><span class=l>very</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>SPECIAL_TYPE</span><span class=p>:</span><span class=w> </span><span class=l>charm</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># pod.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>dapi-test-pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>test-container</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>ilolicon/demoapp:v1.0.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=w> </span><span class=s2>&#34;/bin/sh&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;-c&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;env&#34;</span><span class=w> </span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>envFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>configMapRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>special-config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>restartPolicy</span><span class=p>:</span><span class=w> </span><span class=l>Never</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=åœ¨podå‘½ä»¤ä¸­ä½¿ç”¨configmapå®šä¹‰çš„ç¯å¢ƒå˜é‡>åœ¨Podå‘½ä»¤ä¸­ä½¿ç”¨ConfigMapå®šä¹‰çš„ç¯å¢ƒå˜é‡</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># pod.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>dapi-test-pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>test-container</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>ilolicon/demoapp:v1.0.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=w> </span><span class=s2>&#34;/bin/echo&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;$(SPECIAL_LEVEL_KEY) $(SPECIAL_TYPE_KEY)&#34;</span><span class=w> </span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>SPECIAL_LEVEL_KEY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>configMapKeyRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>special-config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>SPECIAL_LEVEL</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>SPECIAL_TYPE_KEY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>configMapKeyRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>special-config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>SPECIAL_TYPE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>restartPolicy</span><span class=p>:</span><span class=w> </span><span class=l>Never</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=å°†configmapæ•°æ®æ·»åŠ åˆ°ä¸€ä¸ªå·ä¸­>å°†ConfigMapæ•°æ®æ·»åŠ åˆ°ä¸€ä¸ªå·ä¸­</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c>#  pod.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>dapi-test-pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>test-container</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>ilolicon/demoapp:v1.0.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=w> </span><span class=s2>&#34;/bin/sh&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;-c&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;ls /etc/config/ &amp;&amp; sleep 3600&#34;</span><span class=w> </span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># å¦‚æœè¯¥å®¹å™¨é•œåƒçš„ /etc/config ç›®å½•ä¸­æœ‰ä¸€äº›æ–‡ä»¶ å·æŒ‚è½½å°†ä½¿è¯¥é•œåƒä¸­çš„è¿™äº›æ–‡ä»¶æ— æ³•è®¿é—®</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>config-volume</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/etc/config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>config-volume</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>configMap</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c># æä¾›åŒ…å«è¦æ·»åŠ åˆ°å®¹å™¨ä¸­çš„æ–‡ä»¶çš„ ConfigMap çš„åç§°</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>special-config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>restartPolicy</span><span class=p>:</span><span class=w> </span><span class=l>Never</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=çƒ­æ›´æ–°>çƒ­æ›´æ–°</h5><ul><li>å½“å·²æŒ‚è½½çš„ ConfigMap è¢«æ›´æ–°æ—¶ æ‰€æŠ•å°„çš„å†…å®¹æœ€ç»ˆä¹Ÿä¼šè¢«æ›´æ–° è¿™é€‚ç”¨äº Pod å¯åŠ¨åå¯é€‰å¼•ç”¨çš„ ConfigMap é‡æ–°å‡ºç°çš„æƒ…å†µ</li><li>æ›´æ–° ConfigMap ç›®å‰å¹¶ä¸ä¼šè§¦å‘ç›¸å…³Podçš„æ»šåŠ¨æ›´æ–°(å¯¹äºä¸èƒ½è‡ªåŠ¨çƒ­æ›´æ–°çš„åº”ç”¨ç¨‹åºæ¥è¯´ åˆ™éœ€è¦é‡æ–°éƒ¨ç½²è·å–æœ€æ–°é…ç½®) å¯ä»¥é€šè¿‡ä¿®æ”¹Podçš„annotations çš„æ–¹å¼å¼ºåˆ¶è§¦å‘æ»šåŠ¨æ›´æ–°<ul><li><code>kubectl patch deployment &lt;your's deployment> --patch '{"spec":{"template":{"metadata":{"annotations":{"version/config":"6666666"}}}}}'</code></li></ul></li><li>æ›´æ–° ConfigMap å<ul><li>ä½¿ç”¨è¯¥ConfigMapæŒ‚è½½çš„Envä¸ä¼šåŒæ­¥æ›´æ–°</li><li>ä½¿ç”¨è¯¥ConfigMapæŒ‚è½½çš„volumeä¸­çš„æ•°æ®éœ€è¦ä¸€æ®µæ—¶é—´æ‰èƒ½åŒæ­¥æ›´æ–°<ul><li>ä»ConfigMapæ›´æ–°åˆ°æ–°é”®æ˜ å°„åˆ°Podçš„æ€»å»¶è¿Ÿå¯èƒ½ä¸ kubelet åŒæ­¥å‘¨æœŸ(é»˜è®¤ä¸º1åˆ†é’Ÿ) + kubelet ä¸­ ConfigMap ç¼“å­˜çš„ TTL (é»˜è®¤ä¸º1åˆ†é’Ÿ)ä¸€æ ·é•¿ ä½ å¯ä»¥é€šè¿‡æ›´æ–° Pod çš„ä¸€ä¸ªæ³¨è§£æ¥è§¦å‘ç«‹å³åˆ·æ–°</li></ul></li></ul></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># demoapp-configmap.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># configmapæ›´æ–°å </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#   1. å¦‚æœdemoappä¸æ”¯æŒè‡ªåŠ¨æ›´æ–°é…ç½® åˆ™éœ€è¦é‡æ–°é‡æ–°è§¦å‘æ»šåŠ¨æ›´æ–° é‡æ–°è§¦å‘æ–¹å¼ï¼šæ›´æ–°podæ³¨è§£å®ç°</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#   2. å¦‚æœdemoappæ”¯æŒè‡ªåŠ¨æ›´æ–°é…ç½® åˆ™å®æ—¶ç”Ÿæ•ˆ æ— éœ€é‡æ–°å‘å¸ƒåº”ç”¨</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>config.yaml</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    log_level: debug</span><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ConfigMap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>demoapp-config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># demoapp-hot-update-deployment.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>demoapp-hot-update</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>demoapp-hot-update</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>demoapp-hot-update</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>demoapp-hot-update</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>ilolicon/demoapp:v1.0.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>Always</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>demoapp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>config-volume</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/opt/demoapp/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>config-volume</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>configMap</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>demoapp-config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>demoapp-hot-update</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>demoapp-hot-update</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>TCP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=ä¸å¯æ”¹å˜>ä¸å¯æ”¹å˜</h5><ul><li>ç‰¹æ€§çŠ¶æ€ï¼š<code>Kubernetes v1.21 [stable]</code></li><li>Kubernetesç‰¹æ€§<code>Immutable</code> Secretå’ŒConfigMapæä¾›äº†ä¸€ç§å°†å„ä¸ªSecretå’ŒConfigMapè®¾ç½®ä¸ºä¸å¯å˜æ›´çš„é€‰é¡¹</li><li>å¯¹äºå¤§é‡ä½¿ç”¨ConfigMapçš„é›†ç¾¤(è‡³å°‘æœ‰æ•°ä¸‡ä¸ªå„ä¸ç›¸åŒçš„ConfigMapç»™PodæŒ‚è½½)è€Œè¨€ ç¦æ­¢æ›´æ”¹ConfigMapçš„æ•°æ®æœ‰ä»¥ä¸‹å¥½å¤„<ul><li>ä¿æŠ¤åº”ç”¨ ä½¿ä¹‹å…å—æ„å¤–(ä¸æƒ³è¦çš„)æ›´æ–°æ‰€å¸¦æ¥çš„è´Ÿé¢å½±å“</li><li>é€šè¿‡å¤§å¹…é™ä½å¯¹kube-apiserverçš„å‹åŠ›æå‡é›†ç¾¤æ€§èƒ½ è¿™æ˜¯å› ä¸ºç³»ç»Ÿä¼šå…³é—­å¯¹å·²æ ‡è®°ä¸ºä¸å¯å˜æ›´çš„ConfigMapçš„ç›‘è§†æ“ä½œ</li></ul></li><li>ä½ å¯ä»¥é€šè¿‡å°†<code>immutable</code>å­—æ®µè®¾ç½®ä¸º<code>true</code>åˆ›å»ºä¸å¯å˜æ›´çš„ConfigMap</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ConfigMap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=l>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=l>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>immutable</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>ä¸€æ—¦æŸConfigMapè¢«æ ‡è®°ä¸ºä¸å¯å˜æ›´ åˆ™<strong>æ— æ³•</strong>é€†è½¬è¿™ä¸€å˜åŒ– ä¹Ÿæ— æ³•æ›´æ”¹dataæˆ–binaryDataå­—æ®µçš„å†…å®¹</li><li>ä½ åªèƒ½åˆ é™¤å¹¶é‡å»ºConfigMap å› ä¸ºç°æœ‰çš„Podä¼šç»´æŠ¤ä¸€ä¸ªå·²è¢«åˆ é™¤çš„ConfigMapçš„æŒ‚è½½ç‚¹ å»ºè®®é‡æ–°åˆ›å»ºè¿™äº›Pods</li></ul><h5 id=é™åˆ¶>é™åˆ¶</h5><ul><li>åœ¨<code>Pod</code>è§„çº¦ä¸­å¼•ç”¨æŸä¸ª<code>ConfigMap</code>ä¹‹å‰ å¿…é¡»å…ˆåˆ›å»ºè¿™ä¸ªå¯¹è±¡ æˆ–è€…åœ¨<code>Pod</code>è§„çº¦ä¸­å°†<code>ConfigMap</code>æ ‡è®°ä¸º<code>optional</code> å¦‚æœæ‰€å¼•ç”¨çš„<code>ConfigMap</code>ä¸å­˜åœ¨ å¹¶ä¸”æ²¡æœ‰å°†åº”ç”¨æ ‡è®°ä¸º<code>optional</code> åˆ™<code>Pod</code>å°†æ— æ³•å¯åŠ¨ åŒæ · å¼•ç”¨<code>ConfigMap</code>ä¸­ä¸å­˜åœ¨çš„ä¸»é”®ä¹Ÿä¼šä»¤<code>Pod</code>æ— æ³•å¯åŠ¨ é™¤éä½ å°†<code>Configmap</code>æ ‡è®°ä¸º<code>optional</code></li><li>å¦‚æœä½ ä½¿ç”¨<code>envFrom</code>æ¥åŸºäº<code>ConfigMap</code>å®šä¹‰ç¯å¢ƒå˜é‡ é‚£ä¹ˆæ— æ•ˆçš„é”®å°†è¢«å¿½ç•¥ <code>Pod</code>å¯ä»¥è¢«å¯åŠ¨ ä½†æ— æ•ˆåç§°å°†è¢«è®°å½•åœ¨äº‹ä»¶æ—¥å¿—ä¸­<code>InvalidVariableNames</code> æ—¥å¿—æ¶ˆæ¯åˆ—å‡ºäº†æ¯ä¸ªè¢«è·³è¿‡çš„é”®</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># kubectl get events</span>
</span></span><span class=line><span class=cl>LASTSEEN FIRSTSEEN COUNT NAME          KIND  SUBOBJECT  TYPE      REASON                            SOURCE                MESSAGE
</span></span><span class=line><span class=cl>0s       0s        <span class=m>1</span>     dapi-test-pod Pod              Warning   InvalidEnvironmentVariableNames   <span class=o>{</span>kubelet, 127.0.0.1<span class=o>}</span>  Keys <span class=o>[</span>1badkey, 2alsobad<span class=o>]</span> from the EnvFrom configMap default/myconfig were skipped since they are considered invalid environment variable names.
</span></span></code></pre></td></tr></table></div></div><ul><li>ConfigMapä½äºç¡®å®šçš„åå­—ç©ºé—´ä¸­ æ¯ä¸ª<code>ConfigMap</code>åªèƒ½è¢«åŒä¸€åå­—ç©ºé—´ä¸­çš„<code>Pod</code>å¼•ç”¨</li><li>ä½ ä¸èƒ½å°†<code>ConfigMap</code>ç”¨äºé™æ€<code>Pod</code> å› ä¸º<code>Kubernetes</code>ä¸æ”¯æŒè¿™ç§ç”¨æ³•</li></ul><h4 id=secret>Secret</h4><ul><li>Secretæ˜¯ä¸€ç§åŒ…å«å°‘é‡æ•æ„Ÿä¿¡æ¯ä¾‹å¦‚å¯†ç ã€OAUTHä»¤ç‰Œæˆ–SSHå¯†é’¥çš„å¯¹è±¡ è¿™æ ·çš„ä¿¡æ¯å¯èƒ½ä¼šè¢«æ”¾åœ¨<a class=link href=https://kubernetes.io/docs/concepts/workloads/pods/pod-overview/ target=_blank rel=noopener>Pod</a>è§„çº¦ä¸­æˆ–è€…é•œåƒä¸­</li><li>ä½¿ç”¨Secretæ„å‘³ç€ä½ ä¸éœ€è¦åœ¨åº”ç”¨ç¨‹åºä»£ç ä¸­åŒ…å«æœºå¯†æ•°æ®</li><li>Secretç±»ä¼¼äº<a class=link href=https://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/configure-pod-configmap/ target=_blank rel=noopener>ConfigMap</a>ä½†ä¸“é—¨ç”¨äºä¿å­˜æ•æ„Ÿæ•°æ®</li></ul><h5 id=ç‰¹æ€§>ç‰¹æ€§</h5><ul><li>Kubernetesé€šè¿‡ä»…ä»…å°†Secretåˆ†å‘åˆ°éœ€è¦è®¿é—®Secretçš„Podæ‰€åœ¨æœºå™¨èŠ‚ç‚¹æ¥ä¿éšœå…¶å®‰å…¨æ€§</li><li>Secretåªä¼šå­˜å‚¨åœ¨å‡ ç‚¹çš„å†…å­˜ä¸­ æ°¸ä¸å†™å…¥ç‰©ç†å­˜å‚¨ è¿™æ ·ä»èŠ‚ç‚¹åˆ é™¤secretæ—¶å°±ä¸éœ€è¦æ“¦é™¤ç£ç›˜æ•°æ®</li><li>ä»Kunernetes1.7ç‰ˆæœ¬å¼€å§‹ etcdä¼šä»¥åŠ å¯†å½¢å¼å­˜å‚¨Secret ä¸€å®šç¨‹åº¦çš„ä¿è¯äº†Secretçš„å®‰å…¨æ€§</li></ul><h5 id=ç±»å‹>ç±»å‹</h5><ul><li>åˆ›å»ºSecretæ—¶ ä½ å¯ä»¥ä½¿ç”¨Secretèµ„æºçš„<code>type</code>å­—æ®µæˆ–è€…ä¸å…¶ç­‰ä»·çš„kubectlå‘½ä»¤è¡Œå‚æ•°(å¦‚æœæœ‰çš„è¯)ä¸ºå…¶è®¾ç½®ç±»å‹</li><li>Secretç±»å‹æœ‰åŠ©äºå¯¹Secretæ•°æ®è¿›è¡Œç¼–ç¨‹å¤„ç†</li><li>Kubernetesæä¾›è‹¥å¹²ç§å†…ç½®çš„ç±»å‹ ç”¨äºä¸€äº›å¸¸è§çš„ä½¿ç”¨åœºæ™¯ é’ˆå¯¹è¿™äº›ç±»å‹ Kubernetesæ‰€æ‰§è¡Œçš„åˆæ³•æ€§æ£€æŸ¥æ“ä½œä»¥åŠå¯¹å…¶æ‰€å®æ–½çš„é™åˆ¶å„ä¸ç›¸åŒ</li></ul><div class=table-wrapper><table><thead><tr><th>å†…ç½®ç±»å‹</th><th>ç”¨æ³•</th></tr></thead><tbody><tr><td>Opaque</td><td>ç”¨æˆ·å®šä¹‰çš„ä»»æ„æ•°æ®</td></tr><tr><td>kubernetes.io/service-account-token</td><td>æœåŠ¡è´¦å·ä»¤ç‰Œ</td></tr><tr><td>kubernetes.io/dockercfg</td><td>~/.dockercfg æ–‡ä»¶çš„åºåˆ—åŒ–å½¢å¼</td></tr><tr><td>kubernetes.io/dockerconfigjson</td><td>~/.docker/config.json æ–‡ä»¶çš„åºåˆ—åŒ–å½¢å¼</td></tr><tr><td>kubernetes.io/basic-auth</td><td>ç”¨äºåŸºæœ¬èº«ä»½è®¤è¯çš„å‡­æ®</td></tr><tr><td>kubernetes.io/ssh-auth</td><td>ç”¨äº SSH èº«ä»½è®¤è¯çš„å‡­æ®</td></tr><tr><td>kubernetes.io/tls</td><td>ç”¨äº TLS å®¢æˆ·ç«¯æˆ–è€…æœåŠ¡å™¨ç«¯çš„æ•°æ®</td></tr><tr><td>bootstrap.kubernetes.io/token</td><td>å¯åŠ¨å¼•å¯¼ä»¤ç‰Œæ•°æ®</td></tr></tbody></table></div><h5 id=opaque>Opaque</h5><ul><li>å½“ä½ æœªåœ¨Secretæ¸…å•ä¸­æ˜¾å¼æŒ‡å®šç±»å‹æ—¶ é»˜è®¤çš„Secretç±»å‹æ˜¯Opaque</li><li>å½“ä½ ä½¿ç”¨kubectlæ¥åˆ›å»ºä¸€ä¸ªSecretæ—¶ ä½ å¿…é¡»ä½¿ç”¨genericå­å‘½ä»¤æ¥æ ‡æ˜è¦åˆ›å»ºçš„æ˜¯ä¸€ä¸ªOpaqueç±»å‹çš„Secret</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl create secret generic empty-secret
</span></span><span class=line><span class=cl>kubectl get secret empty-secret
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># è¾“å‡º</span>
</span></span><span class=line><span class=cl><span class=c1># DATAåˆ—æ˜¾ç¤ºSecretä¸­ä¿å­˜çš„æ•°æ®æ¡ç›®ä¸ªæ•° åœ¨è¿™ä¸ªä¾‹å­ä¸­ 0æ„å‘³ç€ä½ åˆšåˆšåˆ›å»ºäº†ä¸€ä¸ªç©ºçš„Secret</span>
</span></span><span class=line><span class=cl>NAME           TYPE     DATA   AGE
</span></span><span class=line><span class=cl>empty-secret   Opaque   <span class=m>0</span>      22h
</span></span></code></pre></td></tr></table></div></div><ul><li>Yamlèµ„æºæ¸…å•åˆ›å»º</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Secret</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mysecret</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Opaque</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># å€¼ç»è¿‡base64ç¼–ç </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>username</span><span class=p>:</span><span class=w> </span><span class=l>dXNlcm5hbWU=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=l>cGFzc3dvcmQ=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># kubectl get secret mysecret -o yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=l>cGFzc3dvcmQ=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>username</span><span class=p>:</span><span class=w> </span><span class=l>dXNlcm5hbWU=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Secret</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>annotations</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>kubectl.kubernetes.io/last-applied-configuration</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>      {&#34;apiVersion&#34;:&#34;v1&#34;,&#34;data&#34;:{&#34;password&#34;:&#34;cGFzc3dvcmQ=&#34;,&#34;username&#34;:&#34;dXNlcm5hbWU=&#34;},&#34;kind&#34;:&#34;Secret&#34;,&#34;metadata&#34;:{&#34;annotations&#34;:{},&#34;name&#34;:&#34;mysecret&#34;,&#34;namespace&#34;:&#34;default&#34;}}</span><span class=w>      
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>creationTimestamp</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;2025-05-10T11:39:15Z&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mysecret</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resourceVersion</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;16477137&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>uid</span><span class=p>:</span><span class=w> </span><span class=l>6b70696f-dcd4-4b7d-a37e-8d1891b75077</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Opaque</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=podä¸­ä½¿ç”¨secretçš„æ•°æ®å®šä¹‰ç¯å¢ƒå˜é‡>Podä¸­ä½¿ç”¨Secretçš„æ•°æ®å®šä¹‰ç¯å¢ƒå˜é‡</h5><ul><li>å¦‚æœå®¹å™¨å·²ç»ä½¿ç”¨äº†åœ¨ç¯å¢ƒå˜é‡ä¸­çš„Secret é™¤éå®¹å™¨é‡æ–°å¯åŠ¨ å¦åˆ™å®¹å™¨å°†æ— æ³•æ„ŸçŸ¥åˆ°Secretçš„æ›´æ–°</li><li>æœ‰ç¬¬ä¸‰æ–¹è§£å†³æ–¹æ¡ˆå¯ä»¥åœ¨Secretæ”¹å˜æ—¶è§¦å‘å®¹å™¨é‡å¯</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># pod.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>envvars-multiple-secrets</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>envars-test-container</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>ilolicon/demoapp:v1.0.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>APP_USERNAME</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>secretKeyRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mysecret</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>username</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>APP_PASSWORD</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>secretKeyRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mysecret</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>password</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># kubectl exec -it pods/envvars-multiple-secrets -- printenv | grep ^APP_</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># æ ¹æ®ç»“æœå‘ç° secretä½¿ç”¨æ—¶ä¼šè‡ªåŠ¨è§£ç </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>APP_USERNAME=username</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>APP_PASSWORD=password</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=secret-volume>Secret volume</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>secret-volume</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>secret-volume-pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>volumes-secret</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>secret</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>secretName</span><span class=p>:</span><span class=w> </span><span class=l>mysecret</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>ilolicon/demoapp:v1.0.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>demoapp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>volumes-secret</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/data&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># kubectl exec -it pods/secret-volume-pod -- cat -n /data/{username,password}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># /data ä¸‹é¢æœ‰2ä¸ªæ–‡ä»¶ usernameå’Œpassword</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=m>1</span><span class=w> </span><span class=l>username</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=m>2</span><span class=w> </span><span class=l>password</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># æŒ‚è½½æŒ‡å®škeyåŠæŒ‡å®šç›®å½•</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>volumes-secret</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>secret</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>secretName</span><span class=p>:</span><span class=w> </span><span class=l>mysecret</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>items</span><span class=p>:</span><span class=w>  </span><span class=c># æœªåšè½¯è¿æ¥ æ— æ³•çƒ­æ›´æ–°</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>username</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>my-group/my-username</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># è¿›å®¹å™¨æŸ¥çœ‹å†…å®¹ cat /data/my-group/my-username</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>username</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=ä¸ºsecreté”®è®¾ç½®posixæƒé™>ä¸ºSecreté”®è®¾ç½®POSIXæƒé™</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>volumes-secret</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>secret</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>secretName</span><span class=p>:</span><span class=w> </span><span class=l>mysecret</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>defaultMode</span><span class=p>:</span><span class=w> </span><span class=m>0644</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>è¯´æ˜<ul><li>å¦‚æœä½¿ç”¨JSONå®šä¹‰Podæˆ–Podæ¨¡æ¿ è¯·æ³¨æ„JSONè§„èŒƒä¸æ”¯æŒæ•°å­—çš„å…«è¿›åˆ¶å½¢å¼</li><li>å› ä¸ºJSONå°†0400è§†ä¸ºåè¿›åˆ¶çš„å€¼400 åœ¨JSONä¸­ è¦æ”¹ä¸ºä½¿ç”¨åè¿›åˆ¶çš„defaultMode</li><li>å¦‚æœä½ æ­£åœ¨ç¼–å†™YAML åˆ™å¯ä»¥ç”¨å…«è¿›åˆ¶ç¼–å†™defaultMode</li></ul></li></ul><h5 id=çƒ­æ›´æ–°-1>çƒ­æ›´æ–°</h5><ul><li>ENV/æŒ‚è½½å­è·¯å¾„ éƒ½ä¸èƒ½è‡ªåŠ¨æ›´æ–°<ul><li>é™¤éå®¹å™¨é‡å¯ ç¬¬ä¸‰æ–¹æ–¹æ¡ˆå¯ä»¥ç›‘è§†Secretæ”¹å˜æ—¶ è‡ªåŠ¨è§¦å‘å®¹å™¨é‡å¯</li></ul></li><li>å½“å·ä¸­åŒ…å«æ¥è‡ªSecretçš„æ•°æ® è€Œå¯¹åº”çš„Secretè¢«æ›´æ–° Kubernetesä¼šè·Ÿè¸ªåˆ°è¿™ä¸€æ“ä½œå¹¶æ›´æ–°å·ä¸­çš„æ•°æ® æ›´æ–°çš„æ–¹å¼æ˜¯ä¿è¯æœ€ç»ˆä¸€è‡´æ€§</li></ul><h5 id=ä¸å¯æ”¹å˜-1>ä¸å¯æ”¹å˜</h5><ul><li>ç‰¹æ€§çŠ¶æ€ï¼š<code>Kubernetes v1.21 [stable]</code></li><li>Kuberneteså…è®¸ä½ å°†ç‰¹å®šçš„Secret(å’ŒConfigMap)æ ‡è®°ä¸ºä¸å¯æ›´æ”¹<code>Immutable</code> ç¦æ­¢æ›´æ”¹ç°æœ‰Secretçš„æ•°æ®æœ‰ä¸‹åˆ—å¥½å¤„<ul><li>é˜²æ­¢æ„å¤–(æˆ–éé¢„æœŸçš„)æ›´æ–°å¯¼è‡´åº”ç”¨ç¨‹åºä¸­æ–­</li><li>(å¯¹äºå¤§é‡ä½¿ç”¨Secretçš„é›†ç¾¤è€Œè¨€ è‡³å°‘æ•°ä¸‡ä¸ªä¸åŒçš„Secretä¾›PodæŒ‚è½½) é€šè¿‡å°†Secretæ ‡è®°ä¸ºä¸å¯å˜ å¯ä»¥æå¤§é™ä½kube-apiserverçš„è´Ÿè½½ æå‡é›†ç¾¤æ€§èƒ½ kubeletä¸éœ€è¦ç›‘è§†é‚£äº›è¢«æ ‡è®°ä¸ºä¸å¯æ›´æ”¹çš„Secret</li></ul></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># ä½ ä¹Ÿå¯ä»¥æ›´æ”¹ç°æœ‰çš„Secret ä»¤å…¶ä¸å¯æ›´æ”¹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Secret</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=l>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=l>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>immutable</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=downwardapi>downwardAPI</h4><ul><li><code>downwardAPI</code>å·ç”¨äºä¸ºåº”ç”¨æä¾›<strong>downwardAPIæ•°æ®</strong> åœ¨è¿™ç±»å·ä¸­ æ‰€å…¬å¼€çš„æ•°æ®ä»¥çº¯æ–‡æœ¬æ ¼å¼çš„åªè¯»æ–‡ä»¶å½¢å¼å­˜åœ¨<ul><li>downwardAPIæ•°æ®: å°†Podå’Œå®¹å™¨å­—æ®µå€¼æš´éœ²ç»™å®¹å™¨ä¸­è¿è¡Œçš„ä»£ç çš„æœºåˆ¶</li></ul></li><li>downwardAPIæ˜¯kubernetesä¸­çš„ä¸€ä¸ªåŠŸèƒ½ å®ƒå…è®¸å®¹å™¨åœ¨è¿è¡Œæ—¶ä»kubernetesAPIæœåŠ¡å™¨è·å–æœ‰å…³å®ƒä»¬è‡ªèº«çš„ä¿¡æ¯</li><li>è¿™äº›ä¿¡æ¯å¯ä»¥ä½œä¸ºå®¹å™¨å†…éƒ¨çš„ç¯å¢ƒå˜é‡æˆ–æ–‡ä»¶æ³¨å…¥åˆ°å®¹å™¨ä¸­ ä»¥ä¾¿å®¹å™¨å¯ä»¥è·å–æœ‰å…³å…¶è¿è¡Œç¯å¢ƒçš„å„ç§ä¿¡æ¯ å¦‚Podåç§°/å‘½åç©ºé—´/æ ‡ç­¾ç­‰<ul><li>æä¾›å®¹å™¨å…ƒæ•°æ®</li><li>åŠ¨æ€é…ç½®</li><li>ä¸Kubernetesç¯å¢ƒé›†æˆ</li></ul></li><li>ä¹Ÿå¯ä»¥æ³¨å…¥env æˆ–ä½¿ç”¨volumeæŒ‚è½½<ul><li>volumeä¼˜åŠ¿<ul><li>ä¼šä¿æŒçƒ­æ›´æ–°ç‰¹æ€§</li><li>ä¼ é€’ä¸€ä¸ªå®¹å™¨çš„èµ„æºåˆ°å¦ä¸€ä¸ªå®¹å™¨ä¸­</li></ul></li></ul></li></ul><h5 id=æ‰©å±•>æ‰©å±•</h5><ul><li>downwardAPIæä¾›äº†ä¸€ç§ç®€å•çš„æ–¹å¼ å°†podå’Œå®¹å™¨çš„å…ƒæ•°æ®ä¼ é€’ç»™å®ƒä»¬å†…éƒ¨è¿è¡Œçš„è¿›ç¨‹</li><li>ä½†è¿™ç§æ–¹å¼å…¶å®ä»…ä»…å¯ä»¥æš´éœ²ä¸€ä¸ªpodè‡ªèº«çš„å…ƒæ•°æ®ä¼ é€’ç»™åœ¨å®ƒä»¬å†…éƒ¨è¿è¡Œçš„è¿›ç¨‹</li><li>è¿™ç§æ–¹å¼ä»…ä»…å¯ä»¥æš´éœ²ä¸€ä¸ªpodè‡ªèº«çš„å…ƒæ•°æ® è€Œä¸”åªå¯ä»¥æš´éœ²éƒ¨åˆ†å…ƒæ•°æ®</li><li>è¿˜æœ‰å¦ä¸€ç§æ–¹å¼ ä»APIæœåŠ¡å™¨è·å–</li></ul><p><img src=/icons/downwardAPI-ext.png loading=lazy alt=downwardAPI-ext></p><ul><li>Kubetneres APIæ–‡æ¡£</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># kubectl proxy --port=8080</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># è·å–swagger-uié…ç½®</span>
</span></span><span class=line><span class=cl>curl http://127.0.0.1:8080/openapi/v2 &gt; k8s-swagger.json
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ç²˜è´´è‡³swaggeråœ¨çº¿UI</span>
</span></span><span class=line><span class=cl>https://editor.swagger.io/
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># æˆ–runæœ¬åœ°swagger-uiæœåŠ¡å™¨</span>
</span></span><span class=line><span class=cl>docker run --rm -d -p 80:8080 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -e <span class=nv>SWAGGER_JSON</span><span class=o>=</span>/k8s-swagger.json <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -v <span class=k>$(</span><span class=nb>pwd</span><span class=k>)</span>/k8s-swagger.json <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  swaggerapi/swagger-ui
</span></span></code></pre></td></tr></table></div></div><h4 id=volume>Volume</h4><ul><li><a class=link href=https://kubernetes.io/zh-cn/docs/concepts/storage/volumes/ target=_blank rel=noopener>æ•°æ®çš„æŒä¹…åŒ–æ–¹æ¡ˆ</a></li><li>å®¹å™¨ç£ç›˜ä¸Šçš„æ–‡ä»¶çš„ç”Ÿå‘½å‘¨æœŸæ˜¯çŸ­æš‚çš„ è¿™å°±ä½¿å¾—åœ¨å®¹å™¨ä¸­è¿è¡Œé‡è¦åº”ç”¨æ—¶ä¼šå‡ºç°ä¸€äº›é—®é¢˜<ul><li>é¦–å…ˆ å½“å®¹å™¨å´©æºƒæ—¶ kubeletä¼šé‡å¯å®ƒ ä½†æ˜¯å®¹å™¨ä¸­çš„æ–‡ä»¶å°†ä¸¢å¤± å®¹å™¨ä»¥å¹²å‡€çš„çŠ¶æ€(é•œåƒæœ€åˆçš„çŠ¶æ€)é‡æ–°å¯åŠ¨</li><li>å…¶æ¬¡ åœ¨Podä¸­åŒæ—¶è¿è¡Œå¤šä¸ªå®¹å™¨æ—¶ è¿™äº›å®¹å™¨ä¹‹é—´é€šå¸¸éœ€è¦å…±äº«æ–‡ä»¶</li></ul></li><li>Kubernetesä¸­çš„<code>Volume</code>æŠ½è±¡ å°±å¾ˆå¥½çš„è§£å†³äº†è¿™äº›é—®é¢˜ éƒ¨åˆ†æœ€æ–°ç‰ˆå·²å¯ç”¨ å‚è€ƒæœ€æ–°å®˜æ–¹æ–‡æ¡£æè¿°<ul><li>awsElasticBlockStore</li><li>azureDisk</li><li>cephfs</li><li>configMap</li><li>downwardAPI</li><li>emptyDir</li><li>gitRepo</li><li>glusterfs</li><li>hostPath</li><li>nfs</li><li>persistentVolumeClaim</li><li>secret</li><li>&mldr;</li></ul></li></ul><h5 id=emptydir>emptyDir</h5><ul><li>å¯¹äºå®šä¹‰äº†emptyDirå·çš„Pod åœ¨Podè¢«æŒ‡æ´¾åˆ°æŸèŠ‚ç‚¹æ—¶æ­¤å·ä¼šè¢«åˆ›å»º</li><li>å°±åƒå…¶åç§°æ‰€è¡¨ç¤ºçš„é‚£æ ·emptyDirå·æœ€åˆæ˜¯ç©ºçš„</li><li>å°½ç®¡Podä¸­çš„å®¹å™¨æŒ‚è½½emptyDirå·çš„è·¯å¾„å¯èƒ½ç›¸åŒä¹Ÿå¯èƒ½ä¸åŒ ä½†è¿™äº›å®¹å™¨éƒ½å¯ä»¥è¯»å†™emptyDirå·ä¸­ç›¸åŒçš„æ–‡ä»¶</li><li>å½“Podå› ä¸ºæŸäº›åŸå› è¢«ä»èŠ‚ç‚¹ä¸Šåˆ é™¤æ—¶ emptyDirå·ä¸­çš„æ•°æ®ä¹Ÿä¼šè¢«æ°¸ä¹…åˆ é™¤</li></ul><blockquote><p><strong>è¯´æ˜:</strong>
å®¹å™¨å´©æºƒå¹¶ä¸ä¼šå¯¼è‡´Podè¢«ä»èŠ‚ç‚¹ä¸Šç§»é™¤ å› æ­¤å®¹å™¨å´©æºƒæœŸé—´emptyDirå·ä¸­çš„æ•°æ®æ˜¯å®‰å…¨çš„</p></blockquote><ul><li>emptyDirçš„ä¸€äº›ç”¨é€”ï¼š<ul><li>ç¼“å­˜ç©ºé—´ ä¾‹å¦‚åŸºäºç£ç›˜çš„å½’å¹¶æ’åº</li><li>ä¸ºè€—æ—¶è¾ƒé•¿çš„è®¡ç®—ä»»åŠ¡æä¾›æ£€æŸ¥ç‚¹ ä»¥ï¥¥ä»»åŠ¡èƒ½æ–¹ï¥¥åœ°ä»å´©æºƒå‰çŠ¶æ€æ¢å¤æ‰§ï¨ˆ</li><li>åœ¨WebæœåŠ¡å™¨å®¹å™¨æœåŠ¡æ•°æ®æ—¶ ä¿å­˜å†…å®¹ç®¡ç†å™¨å®¹å™¨è·å–çš„æ–‡ä»¶</li></ul></li></ul><h5 id=hostpath>hostPath</h5><ul><li><code>hostPath</code>å·èƒ½å°†ä¸»æœºèŠ‚ç‚¹æ–‡ä»¶ç³»ç»Ÿä¸Šçš„æ–‡ä»¶æˆ–ç›®å½•æŒ‚è½½åˆ°ä½ çš„Podä¸­ è™½ç„¶è¿™ä¸æ˜¯å¤§å¤šæ•°Podéœ€è¦çš„ ä½†æ˜¯å®ƒä¸ºä¸€äº›åº”ç”¨æä¾›äº†å¼ºå¤§çš„é€ƒç”Ÿèˆ±</li><li>ç”¨é€”<ul><li>è¿è¡Œä¸€ä¸ªéœ€è¦è®¿é—®èŠ‚ç‚¹çº§ç³»ç»Ÿç»„ä»¶çš„å®¹å™¨<ul><li>è¿è¡Œéœ€è¦ä½ è®¿é—®Dockerå†…éƒ¨çš„å®¹å™¨ ä½¿ç”¨<code>/var/lib/docker</code>çš„<code>hostPath</code></li><li>åœ¨å®¹å™¨ä¸­è¿è¡ŒcAdvisor ä½¿ç”¨<code>/dev/cgroups</code>çš„<code>hostPath</code></li><li>ä¾‹å¦‚ä¸€ä¸ªå°†ç³»ç»Ÿæ—¥å¿—ä¼ è¾“åˆ°é›†ä¸­ä½ç½®çš„å®¹å™¨ ä½¿ç”¨åªè¯»æŒ‚è½½<code>/var/log</code>æ¥è®¿é—®è¿™äº›æ—¥å¿—</li></ul></li><li>è®©å­˜å‚¨åœ¨ä¸»æœºç³»ç»Ÿä¸Šçš„é…ç½®æ–‡ä»¶å¯ä»¥è¢«é™æ€Podä»¥åªè¯»æ–¹å¼è®¿é—® ä¸æ™®é€šPodä¸åŒ é™æ€Podæ— æ³•è®¿é—®ConfigMap<ul><li>é™æ€Pod(Static Pod): æ˜¯ç”±ç‰¹å®šèŠ‚ç‚¹ä¸Šçš„kubeletå®ˆæŠ¤è¿›ç¨‹ç›´æ¥ç®¡ç†çš„Pod(/etc/kubernetes/manifests)</li><li>å®ƒå¹¶ä¸ç»è¿‡å¸¸è§„çš„ APIServer -> ControllerManager -> kubeletçš„æ§åˆ¶é“¾è·¯</li></ul></li></ul></li></ul><blockquote><p>è­¦å‘Šï¼š
ä½¿ç”¨<code>hostPath</code>ç±»å‹çš„å·å­˜åœ¨è®¸å¤šå®‰å…¨é£é™© å¦‚æœå¯ä»¥ ä½ åº”è¯¥å°½é‡é¿å…ä½¿ç”¨<code>hostPath</code>å· ä¾‹å¦‚ ä½ å¯ä»¥æ”¹ä¸ºå®šä¹‰å¹¶ä½¿ç”¨ local PersistentVolume</p><p>å¦‚æœä½ é€šè¿‡å‡†å…¥æ—¶çš„éªŒè¯æ¥é™åˆ¶å¯¹èŠ‚ç‚¹ä¸Šç‰¹å®šç›®å½•çš„è®¿é—® è¿™ç§é™åˆ¶åªæœ‰åœ¨ä½ é¢å¤–è¦æ±‚æ‰€æœ‰<code>hostPath</code>å·çš„æŒ‚è½½éƒ½æ˜¯åªè¯»çš„æƒ…å†µä¸‹æ‰æœ‰æ•ˆ å¦‚æœä½ å…è®¸ä¸å—ä¿¡ä»»çš„<code>Pod</code>ä»¥è¯»å†™æ–¹å¼æŒ‚è½½ä»»æ„ä¸»æœºè·¯å¾„ åˆ™è¯¥<code>Pod</code>ä¸­çš„å®¹å™¨å¯èƒ½ä¼šç ´åå¯è¯»å†™ä¸»æœºæŒ‚è½½å·çš„å®‰å…¨æ€§</p><p>æ— è®º<code>hostPath</code>å·æ˜¯ä»¥åªè¯»è¿˜æ˜¯è¯»å†™æ–¹å¼æŒ‚è½½ ä½¿ç”¨æ—¶éƒ½éœ€è¦å°å¿ƒ è¿™æ˜¯å› ä¸ºï¼š</p><ul><li>è®¿é—®ä¸»æœºæ–‡ä»¶ç³»ç»Ÿå¯èƒ½ä¼šæš´éœ²ç‰¹æƒç³»ç»Ÿå‡­è¯(ä¾‹å¦‚kubeletçš„å‡­è¯)æˆ–ç‰¹æƒAPI(ä¾‹å¦‚å®¹å™¨è¿è¡Œæ—¶å¥—æ¥å­—) è¿™äº›å¯ä»¥è¢«ç”¨äºå®¹å™¨é€ƒé€¸æˆ–æ”»å‡»é›†ç¾¤çš„å…¶ä»–éƒ¨åˆ†</li><li>å…·æœ‰ç›¸åŒé…ç½®çš„Pod(ä¾‹å¦‚åŸºäºPodTemplateåˆ›å»ºçš„Pod)å¯èƒ½ä¼šç”±äºèŠ‚ç‚¹ä¸Šçš„æ–‡ä»¶ä¸åŒè€Œåœ¨ä¸åŒèŠ‚ç‚¹ä¸Šè¡¨ç°å‡ºä¸åŒçš„è¡Œä¸º</li><li><code>hostPath</code>å·çš„ç”¨é‡ä¸ä¼šè¢«è§†ä¸ºä¸´æ—¶å­˜å‚¨ç”¨é‡ ä½ éœ€è¦è‡ªå·±ç›‘æ§ç£ç›˜ä½¿ç”¨æƒ…å†µ å› ä¸ºè¿‡å¤šçš„<code>hostPath</code>ç£ç›˜ä½¿ç”¨é‡ä¼šå¯¼è‡´èŠ‚ç‚¹ä¸Šçš„ç£ç›˜å‹åŠ›</li></ul></blockquote><h6 id=hostpathå·ç±»å‹>hostPathå·ç±»å‹</h6><div class=table-wrapper><table><thead><tr><th>å–å€¼</th><th>è¡Œä¸º</th></tr></thead><tbody><tr><td>""</td><td>ç©ºå­—ç¬¦ä¸²(é»˜è®¤)ç”¨äºå‘åå…¼å®¹ è¿™æ„å‘³ç€åœ¨å®‰è£…<code>hostPath</code>å·ä¹‹å‰ä¸ä¼šæ‰§è¡Œä»»ä½•æ£€æŸ¥</td></tr><tr><td>DirectoryOrCreate</td><td>å¦‚æœåœ¨ç»™å®šè·¯å¾„ä¸Šä»€ä¹ˆéƒ½ä¸å­˜åœ¨ é‚£ä¹ˆå°†æ ¹æ®éœ€è¦åˆ›å»ºç©ºç›®å½• æƒé™è®¾ç½®ä¸º0755 å…·æœ‰ä¸kubeletç›¸åŒçš„ç»„å’Œå±ä¸»ä¿¡æ¯</td></tr><tr><td>Directory</td><td>åœ¨ç»™å®šï¤·å¾„ä¸Šå¿…é¡»å­˜åœ¨çš„ç›®å½•</td></tr><tr><td>FileOrCreate</td><td>å¦‚æœåœ¨ç»™å®šè·¯å¾„ä¸Šä»€ä¹ˆéƒ½ä¸å­˜åœ¨ é‚£ä¹ˆå°†åœ¨é‚£é‡Œæ ¹æ®éœ€è¦åˆ›å»ºç©ºæ–‡ä»¶ æƒé™è®¾ç½®ä¸º0644 å…·æœ‰ä¸kubeletç›¸åŒçš„ç»„å’Œæ‰€æœ‰æƒ</td></tr><tr><td>File</td><td>åœ¨ç»™å®šè·¯å¾„ä¸Šå¿…é¡»å­˜åœ¨çš„æ–‡ä»¶</td></tr><tr><td>Socket</td><td>åœ¨ç»™å®šè·¯å¾„ä¸Šå¿…é¡»å­˜åœ¨çš„UNIXå¥—æ¥å­—</td></tr><tr><td>CharDevice</td><td><strong>(ä»…LinuxèŠ‚ç‚¹)</strong> åœ¨ç»™å®šè·¯å¾„ä¸Šå¿…é¡»å­˜åœ¨çš„å­—ç¬¦è®¾å¤‡</td></tr><tr><td>BlockDevice</td><td><strong>(ä»…LinuxèŠ‚ç‚¹)</strong> åœ¨ç»™å®šè·¯å¾„ä¸Šå¿…é¡»å­˜åœ¨çš„å—è®¾å¤‡</td></tr></tbody></table></div><h6 id=æ³¨æ„>æ³¨æ„</h6><ul><li><code>FileOrCreate</code>æ¨¡å¼ä¸ä¼šåˆ›å»ºæ–‡ä»¶çš„çˆ¶ç›®å½• å¦‚æœæŒ‚è½½æ–‡ä»¶çš„çˆ¶ç›®å½•ä¸å­˜åœ¨ Podå°†å¯åŠ¨å¤±è´¥ ä¸ºäº†ç¡®ä¿è¿™ç§æ¨¡å¼æ­£å¸¸å·¥ä½œ ä½ å¯ä»¥å°è¯•åˆ†åˆ«æŒ‚è½½ç›®å½•å’Œæ–‡ä»¶</li><li>å½“KubernetesæŒ‰ç…§è®¡åˆ’æ·»åŠ èµ„æºæ„ŸçŸ¥è°ƒåº¦æ—¶ å°†æ— æ³•è€ƒè™‘<code>hostPath</code>ä½¿ç”¨çš„èµ„æº</li><li>åº•å±‚ä¸»æœºä¸Šåˆ›å»ºçš„æŸäº›æ–‡ä»¶æˆ–ç›®å½•åªèƒ½ç”±<code>root</code>ç”¨æˆ·è®¿é—® æ­¤æ—¶ ä½ éœ€è¦åœ¨ç‰¹æƒå®¹å™¨ä¸­ä»¥<code>root</code>èº«ä»½è¿è¡Œè¿›ç¨‹ æˆ–è€…ä¿®æ”¹ä¸»æœºä¸Šçš„æ–‡ä»¶æƒé™ ä»¥ä¾¿èƒ½å¤Ÿä»<code>hostPath</code>å·è¯»å–æ•°æ®(æˆ–å°†æ•°æ®å†™å…¥åˆ°<code>hostPath</code>å·)</li></ul><h4 id=pvpvc>PV/PVC</h4><p><img src=/p/kubernetes/icons/pvc.png width=2308 height=1179 srcset="/p/kubernetes/icons/pvc_hu6506faa16d4cf2c7f542f2e52c106e00_156879_480x0_resize_box_3.png 480w, /p/kubernetes/icons/pvc_hu6506faa16d4cf2c7f542f2e52c106e00_156879_1024x0_resize_box_3.png 1024w" loading=lazy alt=pvc class=gallery-image data-flex-grow=195 data-flex-basis=469px></p><ul><li>å­˜å‚¨çš„ç®¡ç†æ˜¯ä¸€ä¸ªä¸è®¡ç®—å®ä¾‹çš„ç®¡ç†å®Œå…¨ä¸åŒçš„é—®é¢˜ PersistentVolumeå­ç³»ç»Ÿä¸ºç”¨æˆ·å’Œç®¡ç†å‘˜æä¾›äº†ä¸€ç»„API å°†å­˜å‚¨å¦‚ä½•åˆ¶å¤‡çš„ç»†èŠ‚ä»å…¶å¦‚ä½•è¢«ä½¿ç”¨ä¸­æŠ½è±¡å‡ºæ¥</li><li>ä¸ºäº†å®ç°è¿™ç‚¹ Kuberneteså¼•å…¥äº†ä¸¤ä¸ªå¿ƒçš„APIèµ„æº<ul><li>PersistentVolume</li><li>PersistentVolumeClaim</li></ul></li><li><strong>æŒä¹…å·(PersistentVolume PV)</strong><ul><li>æ˜¯é›†ç¾¤ä¸­çš„ä¸€å—å­˜å‚¨ å¯ä»¥ç”±ç®¡ç†å‘˜äº‹å…ˆåˆ¶å¤‡ æˆ–è€…ä½¿ç”¨å­˜å‚¨ç±»(Storage Class)æ¥åŠ¨æ€åˆ¶å¤‡</li><li>æŒä¹…å·æ˜¯é›†ç¾¤çº§åˆ«çš„èµ„æº å°±åƒèŠ‚ç‚¹ä¹Ÿæ˜¯é›†ç¾¤èµ„æºä¸€æ ·</li><li>PVæŒä¹…å·å’Œæ™®é€šçš„Volumeä¸€æ · ä¹Ÿæ˜¯ä½¿ç”¨å·æ’ä»¶æ¥å®ç°çš„ åªæ˜¯å®ƒä»¬æ‹¥æœ‰ç‹¬ç«‹äºä»»ä½•ä½¿ç”¨PVçš„Podçš„ç”Ÿå‘½å‘¨æœŸ</li><li>æ­¤APIå¯¹è±¡ä¸­è®°è¿°äº†å­˜å‚¨çš„å®ç°ç»†èŠ‚ æ— è®ºå…¶èƒŒåæ˜¯NFSã€iSCSIè¿˜æ˜¯ç‰¹å®šäºäº‘å¹³å°çš„å­˜å‚¨ç³»ç»Ÿ</li></ul></li><li><strong>æŒä¹…å·å£°æ˜(PersistentVolumeClaim PVC)</strong><ul><li>è¡¨è¾¾çš„æ˜¯ç”¨æˆ·å¯¹å­˜å‚¨çš„è¯·æ±‚ æ¦‚å¿µä¸Šä¸Podç±»ä¼¼</li><li>Podä¼šè€—ç”¨èŠ‚ç‚¹èµ„æº è€ŒPVCç”³é¢†ä¼šè€—ç”¨PVèµ„æº</li><li>Podå¯ä»¥è¯·æ±‚ç‰¹å®šæ•°é‡çš„èµ„æº(CPUå’Œå†…å­˜) åŒæ ·PVCç”³é¢†ä¹Ÿå¯ä»¥è¯·æ±‚ç‰¹å®šçš„å¤§å°å’Œè®¿é—®æ¨¡å¼<ul><li>ä¾‹å¦‚ å¯ä»¥æŒ‚è½½ä¸ºReadWriteOnceã€ReadOnlyManyã€ReadWriteManyæˆ–ReadWriteOncePod</li></ul></li></ul></li></ul><h5 id=å…³è”æ¡ä»¶>å…³è”æ¡ä»¶</h5><ul><li>å®¹é‡: PVçš„å€¼ä¸å°äºPVCè¦æ±‚ å¯ä»¥å¤§äº æœ€å¥½ä¸€è‡´</li><li>è¯»å†™ç­–ç•¥(è®¿é—®æ¨¡å¼)ï¼šå®Œå…¨åŒ¹é…<ul><li>å•èŠ‚ç‚¹è¯»å†™ï¼šReadWriteOnce / RWO</li><li>å¤šèŠ‚ç‚¹åªè¯»ï¼šReadOnlyMany / ROX</li><li>å¤šèŠ‚ç‚¹è¯»å†™ï¼šReadWriteMany / RWX</li><li>ReadWriteOncePod / RWOP: v1.29[stable]<ul><li>å·å¯ä»¥è¢«å•ä¸ªPodä»¥è¯»å†™æ–¹å¼æŒ‚è½½</li><li>å¦‚æœä½ æƒ³ç¡®ä¿æ•´ä¸ªé›†ç¾¤ä¸­åªæœ‰ä¸€ä¸ªPodå¯ä»¥è¯»å–æˆ–å†™å…¥è¯¥PVC ä½¿ç”¨è¯¥æ–¹å¼</li></ul></li></ul></li><li>å­˜å‚¨ç±»ï¼šPVçš„ç±»ä¸PVCçš„ç±»å¿…é¡»ä¸€è‡´ ä¸å­˜åœ¨åŒ…å®¹é™çº§å…³ç³»</li></ul><h5 id=å›æ”¶ç­–ç•¥reclaiming>å›æ”¶ç­–ç•¥(Reclaiming)</h5><ul><li>å½“ç”¨æˆ·ä¸å†ä½¿ç”¨å…¶å­˜å‚¨å·æ—¶ ä»–ä»¬å¯ä»¥ä»APIä¸­å°†PVCå¯¹è±¡åˆ é™¤ ä»è€Œå…è®¸è¯¥èµ„æºè¢«å›æ”¶å†åˆ©ç”¨</li><li>PersistentVolumeå¯¹è±¡çš„å›æ”¶ç­–ç•¥å‘Šè¯‰é›†ç¾¤ å½“å…¶è¢«ä»ç”³é¢†ä¸­é‡Šæ”¾æ—¶å¦‚ä½•å¤„ç†è¯¥æ•°æ®å·</li><li>ç›®å‰ æ•°æ®å·å¯ä»¥è¢«Retained(ä¿ç•™) Recycled(å›æ”¶) Deleted(åˆ é™¤)</li></ul><hr><ul><li><p><strong>ä¿ç•™(Retain)</strong></p><ul><li>å›æ”¶ç­–ç•¥<code>Retain</code>ä½¿å¾—ç”¨æˆ·å¯ä»¥æ‰‹åŠ¨å›æ”¶èµ„æº</li><li>å½“PersistentVolumeClaimå¯¹è±¡è¢«åˆ é™¤æ—¶ PersistentVolumeå·ä»ç„¶å­˜åœ¨ å¯¹åº”çš„æ•°æ®å·è¢«è§†ä¸º"å·²é‡Šæ”¾(released)"</li><li>ç”±äºå·ä¸Šä»ç„¶å­˜åœ¨è¿™å‰ä¸€ç”³é¢†äººçš„æ•°æ® è¯¥å·è¿˜ä¸èƒ½ç”¨äºå…¶ä»–ç”³é¢† ç®¡ç†å‘˜å¯ä»¥é€šè¿‡ä¸‹é¢çš„æ­¥éª¤æ¥æ‰‹åŠ¨å›æ”¶è¯¥å·ï¼š<ul><li>åˆ é™¤PersistentVolumeå¯¹è±¡ ä¸ä¹‹ç›¸å…³çš„ã€ä½äºå¤–éƒ¨åŸºç¡€è®¾æ–½ä¸­çš„å­˜å‚¨èµ„äº§åœ¨PVåˆ é™¤ä¹‹åä»ç„¶å­˜åœ¨</li><li>æ ¹æ®æƒ…å†µ æ‰‹åŠ¨æ¸…é™¤æ‰€å…³è”çš„å­˜å‚¨èµ„äº§ä¸Šçš„æ•°æ®</li><li>æ‰‹åŠ¨åˆ é™¤æ‰€å…³è”çš„å­˜å‚¨èµ„äº§</li></ul></li><li>å¦‚æœä½ å¸Œæœ›é‡ç”¨è¯¥å­˜å‚¨èµ„äº§ å¯ä»¥åŸºäºå­˜å‚¨èµ„äº§çš„å®šä¹‰åˆ›å»ºæ–°çš„PersistentVolumeå·å¯¹è±¡</li></ul></li><li><p><strong>åˆ é™¤(Delete)</strong></p><ul><li>å¯¹äºæ”¯æŒ<code>Delete</code>å›æ”¶ç­–ç•¥çš„å·æ’ä»¶ åˆ é™¤åŠ¨ä½œä¼šå°†PersistentVolumeå¯¹è±¡ä»Kubernetesä¸­ç§»é™¤ åŒæ—¶ä¹Ÿä¼šä»å¤–éƒ¨åŸºç¡€è®¾æ–½ä¸­ç§»é™¤æ‰€å…³è”çš„å­˜å‚¨èµ„äº§</li><li>åŠ¨æ€åˆ¶å¤‡çš„å·ä¼šç»§æ‰¿<a class=link href=https://kubernetes.io/zh-cn/docs/concepts/storage/persistent-volumes/#reclaim-policy target=_blank rel=noopener>å…¶StorageClassä¸­è®¾ç½®çš„å›æ”¶ç­–ç•¥</a> è¯¥ç­–ç•¥é»˜è®¤ä¸ºDelete</li><li>ç®¡ç†å‘˜éœ€è¦æ ¹æ®ç”¨æˆ·çš„æœŸæœ›æ¥é…ç½®StorageClass å¦åˆ™PVå·è¢«åˆ›å»ºä¹‹åå¿…é¡»è¦è¢«ç¼–è¾‘æˆ–è€…ä¿®è¡¥ å‚é˜…<a class=link href=https://kubernetes.io/zh-cn/docs/tasks/administer-cluster/change-pv-reclaim-policy/ target=_blank rel=noopener>æ›´æ”¹PVå·çš„å›æ”¶ç­–ç•¥</a></li></ul></li><li><p><strong>å›æ”¶(Recyle)</strong></p><ul><li><strong>è­¦å‘Š</strong>: å›æ”¶ç­–ç•¥<code>Recycle</code>å·²è¢«åºŸå¼ƒ å–è€Œä»£ä¹‹çš„å»ºè®®æ–¹æ¡ˆæ˜¯ä½¿ç”¨åŠ¨æ€åˆ¶å¤‡</li><li>å¦‚æœåº•å±‚çš„å·æ’ä»¶æ”¯æŒ å›æ”¶ç­–ç•¥<code>Recycle</code>ä¼šåœ¨å·ä¸Šæ‰§è¡Œä¸€äº›åŸºæœ¬çš„æ“¦é™¤(<code>rm -rf /thevolume/*</code>)æ“ä½œ ä¹‹åå…è®¸è¯¥å·ç”¨äºæ–°PVCç”³é¢†</li></ul></li></ul><h5 id=å·é˜¶æ®µçŠ¶æ€>å·é˜¶æ®µ(çŠ¶æ€)</h5><p>æ¯ä¸ªæŒä¹…å·ä¼šå¤„äºä»¥ä¸‹é˜¶æ®µ(Phase)ä¹‹ä¸€ï¼š</p><ul><li><strong>Available</strong> å·æ˜¯ä¸€ä¸ªç©ºé—²èµ„æº å°šæœªç»‘å®šåˆ°ä»»ä½•ç”³é¢†</li><li><strong>Bound</strong> è¯¥å·å·²ç»ç»‘å®šåˆ°æŸç”³é¢†</li><li><strong>Released</strong> æ‰€ç»‘å®šçš„ç”³é¢†å·²è¢«åˆ é™¤ ä½†æ˜¯å…³è”å­˜å‚¨èµ„æºå°šæœªè¢«é›†ç¾¤å›æ”¶</li><li><strong>Failed</strong> å·çš„è‡ªåŠ¨å›æ”¶æ“ä½œå¤±è´¥</li></ul><p>ä½ å¯ä»¥ä½¿ç”¨<code>kubectl describe persistentvolume &lt;name></code>æŸ¥çœ‹å·²ç»‘å®šåˆ°PVçš„PVCçš„åç§°</p><h5 id=pvcä¿æŠ¤>PVCä¿æŠ¤</h5><ul><li>PVCä¿æŠ¤çš„ç›®çš„æ˜¯ç¡®ä¿ç”±Podæ­£åœ¨ä½¿ç”¨çš„PVCä¸ä¼šä»ç³»ç»Ÿä¸­ç§»é™¤ å› ä¸ºå¦‚æœè¢«ç§»é™¤çš„è¯å¯èƒ½å¯¼è‡´æ•°æ®ä¸¢å¤±</li><li>æ³¨æ„ï¼šå½“PodçŠ¶æ€ä¸º<code>Pending</code>å¹¶ä¸”Podå·²ç»åˆ†é…ç»™èŠ‚ç‚¹ æˆ–Podä¸º<code>Running</code>çŠ¶æ€æ—¶ PVCå¤„äºæ´»åŠ¨çŠ¶æ€</li><li>å½“å¯ç”¨PVCä¿æŠ¤åŠŸèƒ½æ—¶ å¦‚æœç”¨æˆ·åˆ é™¤äº†ä¸€ä¸ªPodæ­£åœ¨ä½¿ç”¨çš„PVC åˆ™è¯¥PVCä¸ä¼šè¢«ç«‹å³åˆ é™¤ PVCçš„åˆ é™¤å°†è¢«æ¨è¿Ÿ ç›´åˆ°PVCä¸å†è¢«ä»»ä½•çš„Podä½¿ç”¨</li></ul><h4 id=ç¤ºä¾‹>ç¤ºä¾‹</h4><p><a class=link href=https://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/configure-persistent-volume-storage/ target=_blank rel=noopener>é…ç½®Podä»¥ä½¿ç”¨PersistentVolumeä½œä¸ºå­˜å‚¨</a></p><h4 id=storageclass>StorageClass</h4><ul><li><p>å­˜å‚¨è®¾å¤‡éœ€æ”¯æŒRESTfulé£æ ¼çš„åˆ›å»ºè¯·æ±‚</p></li><li><p>æ ¹æ®è¯·æ±‚åŠ¨æ€åˆ›å»ºPV</p></li><li><p><a class=link href=https://github.com/kubernetes-sigs/nfs-subdir-external-provisioner target=_blank rel=noopener>nfs-subdir-external-provisioner</a></p></li><li><p>éƒ¨ç½²NFSæœåŠ¡å™¨</p></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>apt-get upate
</span></span><span class=line><span class=cl>apt install -y nfs-kernerl-server
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>mkdir /nfs/data
</span></span><span class=line><span class=cl>chown nobody -R /nfs
</span></span><span class=line><span class=cl>/etc/exports
</span></span><span class=line><span class=cl>  /nfs/data *<span class=o>(</span>rw,sync,no_subtree_check<span class=o>)</span>
</span></span><span class=line><span class=cl>systemctl restart nfs-server
</span></span><span class=line><span class=cl>showmount -e 192.168.56.75
</span></span></code></pre></td></tr></table></div></div><ul><li>éƒ¨ç½²nfs-client-provisioner</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nfs-client-provisioner</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>nfs-storageclass</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>nfs-client-provisioner</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>strategy</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Recreate</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>nfs-client-provisioner</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>serviceAccountName</span><span class=p>:</span><span class=w> </span><span class=l>nfs-client-provisioner</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nfs-client-provisioner</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>eipwork/nfs-subdir-external-provisioner:v4.0.2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nfs-client-root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/persistentvolumes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>PROVISIONER_NAME</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=l>k8s-sigs.io/nfs-subdir-external-provisioner</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>NFS_SERVER</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=m>192.168.56.75</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>NFS_PATH</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=l>/nfs/data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nfs-client-root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>nfs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c># server: &lt;YOUR NFS SERVER HOSTNAME&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>server</span><span class=p>:</span><span class=w> </span><span class=m>192.168.56.75</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c># share nfs path</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/nfs/data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ServiceAccount</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nfs-client-provisioner</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>nfs-storageclass</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRole</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nfs-client-provisioner-runner</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>apiGroups</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;&#39;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;nodes&#39;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>verbs</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;get&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;list&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;watch&#39;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>apiGroups</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;&#39;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;persistentvolumes&#39;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>verbs</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;get&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;list&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;watch&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;create&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;delete&#39;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>apiGroups</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;&#39;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;persistentvolumeclaims&#39;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>verbs</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;get&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;list&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;watch&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;update&#39;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>apiGroups</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;storage.k8s.io&#39;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;storageclasses&#39;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>verbs</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;get&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;list&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;watch&#39;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>apiGroups</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;&#39;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;events&#39;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>verbs</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;create&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;update&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;patch&#39;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRoleBinding</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>run-nfs-client-provisioner</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>subjects</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ServiceAccount</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nfs-client-provisioner</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># replace with namespace where provisioner is deployed</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>nfs-storageclass</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>roleRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRole</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nfs-client-provisioner-runner</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Role</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>leader-locking-nfs-client-provisioner</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># replace with namespace where provisioner is deployed</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>nfs-storageclass</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>apiGroups</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;&#39;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;endpoints&#39;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>verbs</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;get&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;list&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;watch&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;create&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;update&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;patch&#39;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>RoleBinding</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>leader-locking-nfs-client-provisioner</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># replace with namespace where provisioner is deployed</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>nfs-storageclass</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>subjects</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ServiceAccount</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nfs-client-provisioner</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># replace with namespace where provisioner is deployed</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>nfs-storageclass</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>roleRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Role</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>leader-locking-nfs-client-provisioner</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>storage.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>StorageClass</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nfs-client</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>nfs-storageclass</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>provisioner</span><span class=p>:</span><span class=w> </span><span class=l>k8s-sigs.io/nfs-subdir-external-provisioner</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>parameters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>pathPattern</span><span class=p>:</span><span class=w> </span><span class=l>${.PVC.namespace}/${.PVC.name}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>onDelete</span><span class=p>:</span><span class=w> </span><span class=l>delete</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>æµ‹è¯•</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># test-pod.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>PersistentVolumeClaim</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>test-claim</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>accessModes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>ReadWriteMany</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>storage</span><span class=p>:</span><span class=w> </span><span class=l>1Mi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>storageClassName</span><span class=p>:</span><span class=w> </span><span class=l>nfs-client</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>test-pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>test-pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>ilolicon/demoapp:v1.0.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nfs-pvc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/opt/demoapp/nfsdata</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>restartPolicy</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;Never&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nfs-pvc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>persistentVolumeClaim</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>claimName</span><span class=p>:</span><span class=w> </span><span class=l>test-claim</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=statefulsetæ§åˆ¶å™¨>StatefulSetæ§åˆ¶å™¨</h2><ul><li><p>CoreOS Operator</p></li><li><p>cattle/pet # ä¸€ä¸ªå…³æ³¨ç¾¤ä½“ ä¸€ä¸ªå…³æ³¨ä¸ªä½“(å’Œæ— çŠ¶æ€åº”ç”¨çš„åŒºåˆ«)</p></li><li><p>PetSet(1.3) -> StatefulSet(1.5+)</p></li><li><p>StatefulSetä¸»è¦ç”¨äºç®¡ç†æœ‰ä»¥ä¸‹ç‰¹æ€§çš„åº”ç”¨ç¨‹åº</p><ul><li>ç¨³å®šä¸”å”¯ä¸€çš„ç½‘ç»œæ ‡è¯†ç¬¦</li><li>ç¨³å®šä¸”æŒä¹…çš„å­˜å‚¨</li><li>æœ‰åºã€å¹³æ»‘çš„éƒ¨ç½²å’Œæ‰©å±•</li><li>æœ‰åºã€å¹³æ»‘çš„ç»ˆæ­¢å’Œåˆ é™¤</li><li>æœ‰åºçš„æ»šåŠ¨æ›´æ–°</li></ul></li><li><p>ä¸€èˆ¬æ¥è¯´ ä¸€ä¸ªå…¸å‹çš„StatefulSetç”±ä¸‰ä¸ªç»„ä»¶ç»„æˆ</p><ul><li>handless service # æ— å¤´æœåŠ¡ ç¡®ä¿åç§°å”¯ä¸€</li><li>StatefulSet # æ§åˆ¶å™¨</li><li>volumeClaimTemplate # å­˜å‚¨å·ç”³è¯·æ¨¡ç‰ˆ(ä¸èƒ½ä½¿ç”¨åŒä¸€å­˜å‚¨å· podæ¨¡ç‰ˆåˆ›å»ºçš„å­˜å‚¨å·éƒ½æ˜¯ä¸€æ ·çš„ æ‰€ä»¥éœ€è¦å·ç”³è¯·æ¨¡ç‰ˆ)</li></ul></li><li><p><code>kubelet explain sts.spec.updateStrategy.rollingUpdate</code></p><ul><li>partition &lt;inter> # æ§åˆ¶æ›´æ–°çš„Pod</li><li>partition: N # å¤§äºç­‰äºç¼–å·Nçš„Podå°†è¢«æ›´æ–° é»˜è®¤å€¼: 0</li></ul></li><li><p>ç¤ºä¾‹</p></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># åˆ›å»ºPV</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>PersistentVolume</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nfspv1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>capacity</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>storage</span><span class=p>:</span><span class=w> </span><span class=l>1Gi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>accessModes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>ReadWriteOnce</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>persistentVolumeReclaimPolicy</span><span class=p>:</span><span class=w> </span><span class=l>Recycle</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>storageClassName</span><span class=p>:</span><span class=w> </span><span class=l>nfs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>nfs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/nfs/pv1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>server</span><span class=p>:</span><span class=w> </span><span class=m>192.168.56.75</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># statefulset</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>myapp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>myapp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>web</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># æ— å¤´æœåŠ¡ è®¿é—®: &lt;podName&gt;.&lt;svcName&gt;.default.svc.cluster.local å¯è®¿é—®åˆ°å…·ä½“podåœ°å€</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>clusterIP</span><span class=p>:</span><span class=w> </span><span class=l>None</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>myapp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>StatefulSet</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>web</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>myapp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>serviceName</span><span class=p>:</span><span class=w> </span><span class=l>myapp</span><span class=w> </span><span class=c># kubectl explain statefulsets.apps.spec.serviceName</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>myapp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>myapp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>ilolicon/demoapp:v1.0.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>web</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/opt/demoapp/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>volumeClaimTemplates</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>accessModes</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;ReadWriteOnce&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>storageClassName</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;nfs&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>storage</span><span class=p>:</span><span class=w> </span><span class=l>1Gi</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=è°ƒåº¦å™¨>è°ƒåº¦å™¨</h2><h3 id=æ¦‚å¿µ>æ¦‚å¿µ</h3><p><a class=link href=https://kubernetes.io/zh-cn/docs/concepts/scheduling-eviction/kube-scheduler/ target=_blank rel=noopener>kubernetesè°ƒåº¦å™¨</a></p><p><a class=link href=https://kubernetes.io/zh-cn/docs/concepts/workloads/pods/pod-qos/ target=_blank rel=noopener>Pod QoSç±»</a></p><p><a class=link href=https://kubernetes.io/zh-cn/docs/concepts/configuration/manage-resources-containers/ target=_blank rel=noopener>ä¸ºPodå’Œå®¹å™¨ç®¡ç†èµ„æº</a></p><ul><li>kube-scheduleræ˜¯kubernetesçš„è°ƒåº¦å™¨ ä¸»è¦ä»»åŠ¡æ˜¯æŠŠå®šä¹‰çš„Podåˆ†é…åˆ°é›†ç¾¤çš„èŠ‚ç‚¹ä¸Š</li></ul><p><img src=/icons/kube-scheduler.png loading=lazy alt=kube-scheduler></p><ul><li>scheduleræ˜¯ä½œä¸ºå•ç‹¬çš„ç¨‹åºè¿è¡Œçš„ å¯åŠ¨ä¹‹åä¼šä¸€è‡´ç›‘å¬API Server è·å–<code>PodSpec.NodeName</code>ä¸ºç©ºçš„pod å¯¹æ¯ä¸ªPodéƒ½ä¼šåˆ›å»ºä¸€ä¸ªbinding è¡¨æ˜è¯¥podåº”è¯¥æ”¾åˆ°å“ªä¸ªèŠ‚ç‚¹ä¸Š</li><li>éœ€è¦è€ƒè™‘çš„é—®é¢˜<ul><li>å…¬å¹³ï¼šå¦‚ä½•ä¿è¯æ¯ä¸ªèŠ‚ç‚¹éƒ½èƒ½è¢«åˆ†é…èµ„æº</li><li>èµ„æºé«˜æ•ˆåˆ©ç”¨ï¼šé›†ç¾¤æ‰€æœ‰èµ„æºæœ€å¤§åŒ–è¢«ä½¿ç”¨</li><li>æ•ˆç‡ï¼šè°ƒåº¦çš„æ€§èƒ½è¦å¥½ èƒ½å¤Ÿå°½å¿«åœ°å¯¹å¤§æ‰¹é‡çš„podå®Œæˆè°ƒåº¦å·¥ä½œ</li><li>çµæ´»ï¼šå…è®¸ç”¨æˆ·æ ¹æ®è‡ªå·±çš„éœ€æ±‚æ§åˆ¶è°ƒåº¦çš„é€»è¾‘</li></ul></li><li>é™¤æ¥kuberneresè‡ªå¸¦çš„è°ƒåº¦å™¨ ä½ ä¹Ÿå¯ä»¥ç¼–å†™è‡ªå·±çš„è°ƒåº¦å™¨ é€šè¿‡<code>spec.schedulerName</code>å‚æ•°æŒ‡å®šè°ƒåº¦å™¨çš„åå­— å¯ä»¥ä¸ºpodé€‰æ‹©æŸä¸ªè°ƒåº¦å™¨è¿›è¡Œè°ƒåº¦</li></ul><h4 id=è‡ªå®šä¹‰è°ƒåº¦å™¨ç¤ºä¾‹>è‡ªå®šä¹‰è°ƒåº¦å™¨ç¤ºä¾‹</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>demoapp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>demoapp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>schedulerName</span><span class=p>:</span><span class=w> </span><span class=l>my-scheduler </span><span class=w> </span><span class=c># æŒ‡å®šè‡ªå®šä¹‰è°ƒåº¦å™¨</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>pod-with-custom-scheduler</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>iamge</span><span class=p>:</span><span class=w> </span><span class=l>ilolicon/demoapp:v1.0.0</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># åœ¨ kubernetes Master èŠ‚ç‚¹å¼€å¯ apiServer çš„ä»£ç†</span>
</span></span><span class=line><span class=cl>kubectl proxy --port<span class=o>=</span><span class=m>8001</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#!/bin/bash</span>
</span></span><span class=line><span class=cl><span class=c1># my-scheduler.sh</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>SERVER</span><span class=o>=</span><span class=s1>&#39;localhost:8001&#39;</span>
</span></span><span class=line><span class=cl><span class=k>while</span> true<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>do</span>
</span></span><span class=line><span class=cl> Â  Â for PODNAME in <span class=k>$(</span>kubectl --server <span class=nv>$SERVER</span> get pods -o json <span class=p>|</span> jq <span class=s1>&#39;.items[] | 
</span></span></span><span class=line><span class=cl><span class=s1>select(.spec.schedulerName ==&#34;my-scheduler&#34;) | select(.spec.nodeName == null) | 
</span></span></span><span class=line><span class=cl><span class=s1>.metadata.name&#39;</span> <span class=p>|</span> tr -d <span class=s1>&#39;&#34;&#39;</span><span class=k>)</span>
</span></span><span class=line><span class=cl> Â  Â do
</span></span><span class=line><span class=cl> Â  Â  Â  Â NODES<span class=o>=(</span><span class=k>$(</span>kubectl --server <span class=nv>$SERVER</span> get nodes -o json <span class=p>|</span> jq 
</span></span><span class=line><span class=cl><span class=s1>&#39;.items[].metadata.name&#39;</span> <span class=p>|</span> tr -d <span class=s1>&#39;&#34;&#39;</span><span class=k>)</span><span class=o>)</span>
</span></span><span class=line><span class=cl> Â  Â  Â  Â NUMNODES<span class=o>=</span><span class=si>${#</span><span class=nv>NODES</span><span class=p>[@]</span><span class=si>}</span>
</span></span><span class=line><span class=cl> Â  Â  Â  Â CHOSEN<span class=o>=</span><span class=si>${</span><span class=nv>NODES</span><span class=p>[</span>$<span class=p>[ </span><span class=nv>$RANDOM</span><span class=p> % </span><span class=nv>$NUMNODES</span><span class=p>]]</span><span class=si>}</span>
</span></span><span class=line><span class=cl> Â  Â  Â  Â curl --header <span class=s2>&#34;Content-Type:application/json&#34;</span> --request POST --data
</span></span><span class=line><span class=cl><span class=s1>&#39;{&#34;apiVersion&#34;:&#34;v1&#34;,&#34;kind&#34;:&#34;Binding&#34;,&#34;metadata&#34;: {&#34;name&#34;:&#34;&#39;</span><span class=nv>$PODNAME</span><span class=s1>&#39;&#34;},&#34;target&#34;: 
</span></span></span><span class=line><span class=cl><span class=s1>{&#34;apiVersion&#34;:&#34;v1&#34;,&#34;kind&#34;: &#34;Node&#34;, &#34;name&#34;: &#34;&#39;</span><span class=nv>$CHOSEN</span><span class=s1>&#39;&#34;}}&#39;</span>
</span></span><span class=line><span class=cl>http://<span class=nv>$SERVER</span>/api/v1/namespaces/default/pods/<span class=nv>$PODNAME</span>/binding/
</span></span><span class=line><span class=cl> Â  Â  Â  Â echo <span class=s2>&#34;Assigned </span><span class=nv>$PODNAME</span><span class=s2> to </span><span class=nv>$CHOSEN</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl> Â  Â done
</span></span><span class=line><span class=cl> Â  Â sleep <span class=m>1</span>
</span></span><span class=line><span class=cl><span class=k>done</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=è°ƒåº¦è¿‡ç¨‹>è°ƒåº¦è¿‡ç¨‹</h4><ul><li>è°ƒåº¦å™¨åˆ†ä¸ºå‡ ä¸ªéƒ¨åˆ†<ul><li>é¦–å…ˆæ˜¯è¿‡æ»¤æ‰ä¸æ»¡è¶³æ¡ä»¶çš„èŠ‚ç‚¹ è¿™ä¸ªè¿‡ç¨‹ç§°ä¸º<strong>é¢„é€‰</strong>(è¿‡æ»¤)</li><li>ç„¶åé€šè¿‡å¯¹èŠ‚ç‚¹æŒ‰ç…§ä¼˜å…ˆçº§æ’åº è¿™ä¸ªæ˜¯<strong>ä¼˜é€‰</strong>(æ‰“åˆ†)</li><li>æœ€åä»ä¸­é€‰æ‹©ä¼˜å…ˆçº§æœ€é«˜çš„èŠ‚ç‚¹ å¦‚æœä¸­é—´ä»»ä½•ä¸€æ­¥éª¤æœ‰é”™è¯¯ å°±ç›´æ¥è¿”å›é”™è¯¯</li></ul></li><li>é¢„é€‰<ul><li>PodFitsResources: èŠ‚ç‚¹ä¸Šå‰©ä½™çš„èµ„æºæ˜¯å¦å¤§äºpodè¯·æ±‚çš„èµ„æº</li><li>PodFitsHost: å¦‚æœpodæŒ‡å®šæ¥NodeName æ£€æŸ¥èŠ‚ç‚¹åç§°æ˜¯å¦å’ŒNodeNameåŒ¹é…</li><li>PodFitsHostPorts: èŠ‚ç‚¹ä¸Šå·²ç»ä½¿ç”¨çš„portæ˜¯å¦å’Œpodç”³è¯·çš„portå†²çª</li><li>PodSelectorMatches: è¿‡æ»¤æ‰å’ŒpodæŒ‡å®šçš„labelä¸åŒ¹é…çš„èŠ‚ç‚¹</li><li>NoDiskConflict: å·²ç»mountçš„volumeå’ŒpodæŒ‡å®šçš„volumeä¸å†²çª é™¤éå®ƒä»¬éƒ½æ˜¯åªè¯»</li></ul></li><li>ä¼˜é€‰<ul><li>å¦‚æœåœ¨<code>é¢„é€‰</code>è¿‡ç¨‹ä¸­æ²¡æœ‰åˆé€‚çš„èŠ‚ç‚¹ podä¼šä¸€ç›´åœ¨<code>pending</code>çŠ¶æ€ ä¸æ–­é‡è¯•è°ƒåº¦ ç›´åˆ°æœ‰èŠ‚ç‚¹æ»¡è¶³æ¡ä»¶</li><li>ç»è¿‡è¿™ä¸ªæ­¥éª¤ å¦‚æœæœ‰å¤šä¸ªèŠ‚ç‚¹æ»¡è¶³æ¡ä»¶ å°±ç»§ç»­<code>ä¼˜å…ˆ</code>è¿‡ç¨‹ æŒ‰ç…§ä¼˜å…ˆçº§å¤§å°å¯¹èŠ‚ç‚¹æ’åº</li><li>ä¼˜å…ˆçº§ç”±ä¸€ç³»åˆ—é”®å€¼å¯¹ç»„æˆ é”®æ˜¯è¯¥ä¼˜å…ˆçº§é¡¹çš„åç§° å€¼æ˜¯å®ƒçš„æƒé‡ è¿™å…ˆä¼˜å…ˆçº§é€‰é¡¹åŒ…æ‹¬<ul><li>LeastRequestedPriority: é€šè¿‡è®¡ç®—CPUå’ŒMemoryçš„ä½¿ç”¨ç‡æ¥å†³å®šæƒé‡ ä½¿ç”¨ç‡è¶Šä½æƒé‡è¶Šé«˜ æ¢å¥è¯è¯´ è¿™ä¸ªä¼˜å…ˆçº§æŒ‡æ ‡å€¾å‘äºèµ„æºä½¿ç”¨æ¯”ä¾‹æ›´ä½çš„èŠ‚ç‚¹</li><li>BalancedResourceAllocation: èŠ‚ç‚¹ä¸ŠCPUå’ŒMemoryä½¿ç”¨ç‡è¶Šæ¥è¿‘ æƒé‡è¶Šé«˜ è¿™ä¸ªåº”è¯¥å’Œä¸Šé¢çš„ä¸€èµ·ä½¿ç”¨ ä¸åº”è¯¥å•ç‹¬ä½¿ç”¨</li><li>ImageLocalityPriority: å€¾å‘äºå·²ç»æœ‰è¦ä½¿ç”¨é•œåƒçš„èŠ‚ç‚¹ é•œåƒæ€»å¤§å°å€¼è¶Šå¤§ æƒé‡è¶Šé«˜</li></ul></li></ul></li></ul><h3 id=äº²å’Œæ€§>äº²å’Œæ€§</h3><h4 id=èŠ‚ç‚¹äº²å’Œæ€§>èŠ‚ç‚¹äº²å’Œæ€§</h4><ul><li>èŠ‚ç‚¹äº²å’Œæ€§æ¦‚å¿µä¸Šç±»ä¼¼äº<code>nodeSelector</code> å®ƒä½¿ä½ å¯ä»¥æ ¹æ®èŠ‚ç‚¹ä¸Šçš„æ ‡ç­¾æ¥çº¦æŸPodå¯ä»¥è°ƒåº¦åˆ°å“ªäº›èŠ‚ç‚¹ä¸Š èŠ‚ç‚¹äº²å’Œæ€§æœ‰ä¸¤ç§<ul><li><code>requiredDuringSchedulingIgnoredDuringExecution</code>ï¼šè°ƒåº¦å™¨åªæœ‰åœ¨è§„åˆ™è¢«æ»¡è¶³çš„æ—¶å€™æ‰èƒ½æ‰§è¡Œè°ƒåº¦ æ­¤åŠŸèƒ½ç±»ä¼¼äº<code>nodeSelector</code> ä½†å…¶è¯­æ³•è¡¨è¾¾èƒ½åŠ›æ›´å¼º</li><li><code>preferredDuringSchedulingIgnoredDuringExecution</code>ï¼šè°ƒåº¦å™¨ä¼šå°è¯•å¯»æ‰¾æ»¡è¶³å¯¹åº”è§„åˆ™çš„èŠ‚ç‚¹ å¦‚æœæ‰¾ä¸åˆ°åŒ¹é…çš„èŠ‚ç‚¹ è°ƒåº¦å™¨ä»ç„¶ä¼šè°ƒåº¦è¯¥Pod</li></ul></li></ul><blockquote><p>è¯´æ˜ï¼šåœ¨ä¸Šè¿°ç±»å‹ä¸­ <code>IgnoredDuringExecution</code>æ„å‘³ç€å¦‚æœèŠ‚ç‚¹æ ‡ç­¾åœ¨Kubernetesè°ƒåº¦Podåå‘ç”Ÿäº†å˜æ›´ Pod ä»å°†ç»§ç»­è¿è¡Œ</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>with-node-affinity</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>affinity</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>nodeAffinity</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>requiredDuringSchedulingIgnoredDuringExecution</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>nodeSelectorTerms</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>matchExpressions</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>topology.kubernetes.io/zone</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=l>In</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>values</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=l>antarctica-east1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=l>antarctica-west1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>preferredDuringSchedulingIgnoredDuringExecution</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>weight</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>preference</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>matchExpressions</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>another-node-label-key</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=l>In</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>values</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=l>another-node-label-value</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>with-node-affinity</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>registry.k8s.io/pause:2.0</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>ä¸Šè¿°ç¤ºä¾‹å«ä¹‰ï¼š<ul><li>èŠ‚ç‚¹<strong>å¿…é¡»</strong>åŒ…å«ä¸€ä¸ªé”®åä¸º<code>topology.kubernetes.io/zone</code>çš„æ ‡ç­¾ å¹¶ä¸”è¯¥æ ‡ç­¾çš„å–å€¼<strong>å¿…é¡»</strong>ä¸º <code>antarctica-east1</code> æˆ– <code>antarctica-west1</code></li><li>èŠ‚ç‚¹<strong>æœ€å¥½</strong>å…·æœ‰ä¸€ä¸ªé”®åä¸º<code>another-node-label-key</code>ä¸”å–å€¼ä¸º<code>another-node-label-value</code>çš„æ ‡ç­¾</li></ul></li><li><code>operator</code>å­—æ®µ<a class=link href=https://kubernetes.io/zh-cn/docs/concepts/scheduling-eviction/assign-pod-node/#operators target=_blank rel=noopener>æ“ä½œç¬¦</a><ul><li>In</li><li>NotIn</li><li>Exists</li><li>DoesNotExist</li><li>Gt</li><li>Lt</li></ul></li><li><code>NotIn</code>å’Œ<code>DoesNotExist</code>å¯ç”¨æ¥å®ç°èŠ‚ç‚¹åäº²å’Œæ€§è¡Œä¸º ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨èŠ‚ç‚¹æ±¡ç‚¹å°†Podä»ç‰¹å®šèŠ‚ç‚¹é©±é€</li></ul><h4 id=podé—´äº²å’Œæ€§ä¸åäº²å’Œæ€§>Podé—´äº²å’Œæ€§ä¸åäº²å’Œæ€§</h4><ul><li>Podé—´äº²å’Œæ€§ä¸åäº²å’Œæ€§ä½¿ä½ å¯ä»¥åŸºäºå·²ç»åœ¨èŠ‚ç‚¹ä¸Šè¿è¡Œçš„Podçš„æ ‡ç­¾æ¥çº¦æŸPodå¯ä»¥è°ƒåº¦åˆ°çš„èŠ‚ç‚¹ è€Œä¸æ˜¯åŸºäºèŠ‚ç‚¹ä¸Šçš„æ ‡ç­¾</li><li>Podé—´äº²å’Œæ€§ä¸åäº²å’Œæ€§çš„è§„åˆ™æ ¼å¼ä¸º"å¦‚æœXä¸Šå·²ç»è¿è¡Œäº†ä¸€ä¸ªæˆ–å¤šä¸ªæ»¡è¶³è§„åˆ™Yçš„Pod åˆ™è¿™ä¸ªPodåº”è¯¥(æˆ–è€…åœ¨åäº²å’Œæ€§çš„æƒ…å†µä¸‹ä¸åº”è¯¥)è¿è¡Œåœ¨Xä¸Š"<ul><li>è¿™é‡Œçš„Xå¯ä»¥æ˜¯èŠ‚ç‚¹ã€æœºæ¶ã€äº‘æä¾›å•†å¯ç”¨åŒºæˆ–åœ°ç†åŒºåŸŸæˆ–ç±»ä¼¼çš„æ‹“æ‰‘åŸŸ</li><li>Yåˆ™æ˜¯Kuberneteså°è¯•æ»¡è¶³çš„è§„åˆ™</li></ul></li><li>ä½ é€šè¿‡æ ‡ç­¾é€‰æ‹©ç®—ç¬¦çš„å½¢å¼æ¥è¡¨è¾¾è§„åˆ™(Y) å¹¶å¯æ ¹æ®éœ€è¦æŒ‡å®šé€‰å…³è”çš„åå­—ç©ºé—´åˆ—è¡¨ Podåœ¨Kubernetesä¸­æ˜¯åå­—ç©ºé—´ä½œç”¨åŸŸçš„å¯¹è±¡ å› æ­¤Podçš„æ ‡ç­¾ä¹Ÿéšå¼åœ°å…·æœ‰åå­—ç©ºé—´å±æ€§ é’ˆå¯¹Podæ ‡ç­¾çš„æ‰€æœ‰æ ‡ç­¾é€‰æ‹©ç®—ç¬¦éƒ½è¦æŒ‡å®šåå­—ç©ºé—´ Kubernetesä¼šåœ¨æŒ‡å®šçš„åå­—ç©ºé—´å†…å¯»æ‰¾æ ‡ç­¾</li><li>ä½ ä¼šé€šè¿‡<code>topologyKey</code>æ¥è¡¨è¾¾æ‹“æ‰‘åŸŸ(X)çš„æ¦‚å¿µ å…¶å–å€¼æ˜¯ç³»ç»Ÿç”¨æ¥æ ‡ç¤ºåŸŸçš„èŠ‚ç‚¹æ ‡ç­¾é”® ç›¸å…³ç¤ºä¾‹å¯å‚è§å¸¸ç”¨æ ‡ç­¾ã€æ³¨è§£å’Œæ±¡ç‚¹</li></ul><blockquote><p>è¯´æ˜ï¼š
Podé—´äº²å’Œæ€§å’Œåäº²å’Œæ€§éƒ½éœ€è¦ç›¸å½“çš„è®¡ç®—é‡ å› æ­¤ä¼šåœ¨å¤§è§„æ¨¡é›†ç¾¤ä¸­æ˜¾è‘—é™ä½è°ƒåº¦é€Ÿåº¦ æˆ‘ä»¬ä¸å»ºè®®åœ¨åŒ…å«æ•°ç™¾ä¸ªèŠ‚ç‚¹çš„é›†ç¾¤ä¸­ä½¿ç”¨è¿™ç±»è®¾ç½®</p><p>è¯´æ˜ï¼š
Podåäº²å’Œæ€§éœ€è¦èŠ‚ç‚¹ä¸Šå­˜åœ¨ä¸€è‡´æ€§çš„æ ‡ç­¾ æ¢è¨€ä¹‹ é›†ç¾¤ä¸­æ¯ä¸ªèŠ‚ç‚¹éƒ½å¿…é¡»æ‹¥æœ‰ä¸<code>topologyKey</code>åŒ¹é…çš„æ ‡ç­¾ å¦‚æœæŸäº›æˆ–è€…æ‰€æœ‰èŠ‚ç‚¹ä¸Šä¸å­˜åœ¨æ‰€æŒ‡å®šçš„<code>topologyKey</code>æ ‡ç­¾ è°ƒåº¦è¡Œä¸ºå¯èƒ½ä¸é¢„æœŸçš„ä¸åŒ</p></blockquote><h4 id=æ€»ç»“>æ€»ç»“</h4><div class=table-wrapper><table><thead><tr><th>è°ƒåº¦ç­–ç•¥</th><th>åŒ¹é…æ ‡ç­¾</th><th>æ“ä½œç¬¦</th><th>æ‹“æ‰‘åŸŸæ”¯æŒ</th><th>è°ƒåº¦ç›®æ ‡</th></tr></thead><tbody><tr><td>nodeAffinity</td><td>ä¸»æœº</td><td>In/NotIn/Exists/DoesNotExist/Gt/Lt</td><td>å¦</td><td>æŒ‡å®šä¸»æœº</td></tr><tr><td>podAffinity</td><td>POD</td><td>In/NotIn/Exists/DoesNotExist</td><td>æ˜¯</td><td>PODä¸æŒ‡å®šPODåŒä¸€æ‹“æ‰‘åŸŸ</td></tr><tr><td>podAnitAffinity</td><td>POD</td><td>In/NotIn/Exists/DoesNotExist</td><td>æ˜¯</td><td>PODä¸æŒ‡å®šPODä¸åœ¨åŒä¸€æ‹“æ‰‘åŸŸ</td></tr></tbody></table></div><h3 id=å®¹å¿ä¸æ±¡ç‚¹>å®¹å¿ä¸æ±¡ç‚¹</h3><ul><li><a class=link href=https://kubernetes.io/zh-cn/docs/concepts/scheduling-eviction/assign-pod-node/#affinity-and-anti-affinity target=_blank rel=noopener>èŠ‚ç‚¹äº²å’Œæ€§</a>æ˜¯Podçš„ä¸€ç§å±æ€§ å®ƒä½¿Podè¢«å¸å¼•åˆ°ä¸€ç±»ç‰¹å®šçš„èŠ‚ç‚¹(è¿™å¯èƒ½å‡ºäºä¸€ç§åå¥½ ä¹Ÿå¯èƒ½æ˜¯ç¡¬æ€§è¦æ±‚) **æ±¡ç‚¹(Taint)**åˆ™ç›¸åâ€”â€”å®ƒä½¿èŠ‚ç‚¹èƒ½å¤Ÿæ’æ–¥ä¸€ç±»ç‰¹å®šçš„Pod</li><li><strong>å®¹å¿åº¦Toleration</strong> æ˜¯åº”ç”¨äºPodä¸Šçš„ å®¹å¿åº¦å…è®¸è°ƒåº¦å™¨è°ƒåº¦å¸¦æœ‰å¯¹åº”æ±¡ç‚¹çš„Pod å®¹å¿åº¦å…è®¸è°ƒåº¦ä½†å¹¶ä¸ä¿è¯è°ƒåº¦ï¼šä½œä¸ºå…¶åŠŸèƒ½çš„ä¸€éƒ¨åˆ† è°ƒåº¦å™¨ä¹Ÿä¼šè¯„ä¼°å…¶ä»–å‚æ•°</li><li>æ±¡ç‚¹å’Œå®¹å¿åº¦(Toleration)ç›¸äº’é…åˆ å¯ä»¥ç”¨æ¥é¿å…Podè¢«åˆ†é…åˆ°ä¸åˆé€‚çš„èŠ‚ç‚¹ä¸Š æ¯ä¸ªèŠ‚ç‚¹ä¸Šéƒ½å¯ä»¥åº”ç”¨ä¸€ä¸ªæˆ–å¤šä¸ªæ±¡ç‚¹ è¿™è¡¨ç¤ºå¯¹äºé‚£äº›ä¸èƒ½å®¹å¿è¿™äº›æ±¡ç‚¹çš„Pod æ˜¯ä¸ä¼šè¢«è¯¥èŠ‚ç‚¹æ¥å—çš„</li></ul><h4 id=ç»„æˆ>ç»„æˆ</h4><p><code>key=value:effect</code></p><ul><li>æ¯ä¸ªæ±¡ç‚¹æœ‰ä¸€ä¸ªkeyå’Œvalueä½œä¸ºæ±¡ç‚¹çš„æ ‡ç­¾ å…¶ä¸­valueå¯ä»¥ä¸ºç©º effectæè¿°æ±¡ç‚¹çš„ä½œç”¨</li><li>å½“å‰çš„taint effectæ”¯æŒå¦‚ä¸‹ä¸‰ä¸ªé€‰é¡¹<ul><li>NoSchedule: è¡¨ç¤ºk8så°†<strong>ä¸ä¼š</strong>å°†Podè°ƒåº¦åˆ°å…·æœ‰è¯¥æ±¡ç‚¹çš„Nodeä¸Š</li><li>PreferNoSchedule: è¡¨ç¤ºk8så°†<strong>å°½é‡é¿å…</strong>å°†Podè°ƒåº¦åˆ°å…·æœ‰è¯¥æ±¡ç‚¹çš„Nodeä¸Š</li><li>NoExecute: è¡¨ç¤ºk8så°†ä¸ä¼šå°†Podè°ƒåº¦åˆ°å…·æœ‰è¯¥æ±¡ç‚¹çš„Nodeä¸Š åŒæ—¶ä¼šå°†Nodeä¸Šå·²ç»å­˜åœ¨çš„Pod<strong>é©±é€</strong>å‡ºå»</li></ul></li></ul><h4 id=è®¾ç½®å’Œå»é™¤>è®¾ç½®å’Œå»é™¤</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># ç»™èŠ‚ç‚¹å¢åŠ ä¸€ä¸ªæ±¡ç‚¹</span>
</span></span><span class=line><span class=cl>kubectl taint nodes node1 <span class=nv>key1</span><span class=o>=</span>value1:NoSchedule
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># èŠ‚ç‚¹è¯´æ˜ä¸­ æŸ¥æ‰¾Taintså­—æ®µ</span>
</span></span><span class=line><span class=cl>kubectl describe pod pod-name
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ç§»é™¤ä¸Šè¿°æ±¡ç‚¹</span>
</span></span><span class=line><span class=cl>kubectl taint nodes node1 <span class=nv>key1</span><span class=o>=</span>value1:NoSchedule-
</span></span></code></pre></td></tr></table></div></div><h4 id=å®¹å¿>å®¹å¿</h4><ul><li>è®¾ç½®é‡Œæ±¡ç‚¹çš„Node å°†æ ¹æ®taintçš„effect: <code>NoSchedule</code> <code>PreferNoSchedule</code> <code>NoExecute</code>å’ŒPodä¹‹é—´äº§ç”Ÿäº’æ–¥çš„å…³ç³» Podå°†åœ¨ä¸€å®šç¨‹åº¦ä¸Šä¸ä¼šè¢«è°ƒåº¦åˆ°Nodeä¸Š</li><li>ä½†æˆ‘ä»¬å¯ä»¥åœ¨Podä¸Šè®¾ç½®å®¹å¿(Toleration) æ„æ€æ˜¯è®¾ç½®é‡Œå®¹å¿çš„Podå°†å¯ä»¥å®¹å¿æ±¡ç‚¹çš„å­˜åœ¨ å¯ä»¥è¢«è°ƒåº¦åˆ°å­˜åœ¨æ±¡ç‚¹çš„Nodeä¸Š</li></ul><h5 id=å®¹å¿è®¾ç½®æ–¹å¼>å®¹å¿è®¾ç½®æ–¹å¼</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>tolerations</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;key1&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Equal&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;value1&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>effect</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;NoSchedule&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>tolerations</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;key1&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Equal&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;value1&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>effect</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;NoExecute&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tolerationSeconds</span><span class=p>:</span><span class=w> </span><span class=m>3600</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># tolerationSeconds: è¿™è¡¨ç¤ºå¦‚æœè¿™ä¸ªPodæ­£åœ¨è¿è¡Œ åŒæ—¶ä¸€ä¸ªåŒ¹é…çš„æ±¡ç‚¹è¢«æ·»åŠ åˆ°å…¶æ‰€åœ¨çš„èŠ‚ç‚¹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># é‚£ä¹ˆPodè¿˜å°†ç»§ç»­åœ¨èŠ‚ç‚¹ä¸Šè¿è¡Œ3600ç§’ ç„¶åè¢«é©±é€ </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># å¦‚æœåœ¨æ­¤ä¹‹å‰ä¸Šè¿°æ±¡ç‚¹è¢«åˆ é™¤äº† åˆ™Podä¸ä¼šè¢«é©±é€</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=å®¹å¿çš„ç‰¹æ®Šç±»å‹>å®¹å¿çš„ç‰¹æ®Šç±»å‹</h5><ul><li><code>operator</code>çš„é»˜è®¤æ˜¯<code>Equal</code></li><li>ä¸€ä¸ªå®¹å¿åº¦å’Œä¸€ä¸ªæ±¡ç‚¹ç›¸<strong>åŒ¹é…</strong>æ˜¯æŒ‡å®ƒä»¬æœ‰ä¸€æ ·çš„é”®åå’Œæ•ˆæœ å¹¶ä¸”<ul><li>å¦‚æœ<code>operator</code>æ˜¯<code>Exists</code> æ­¤æ—¶å®¹å¿åº¦ä¸èƒ½æŒ‡å®š<code>value</code> æˆ–è€…</li><li>å¦‚æœ<code>operator</code>æ˜¯<code>Equal</code> åˆ™å®ƒä»¬çš„å€¼åº”è¯¥ç›¸ç­‰</li></ul></li></ul><hr><ul><li><p>ç‰¹æ®Šç±»å‹</p><ul><li>å½“ä¸æŒ‡å®švalueæ—¶ è¡¨ç¤ºå®¹å¿æ‰€æœ‰çš„æ±¡ç‚¹value</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;key2&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Exists&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>effect</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;NoSchedule&#34;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>å½“ä¸æŒ‡å®škeyå€¼æ—¶ è¡¨ç¤ºå®¹å¿æ‰€æœ‰çš„æ±¡ç‚¹key</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>tolerations</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Exists&#34;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>å½“ä¸æŒ‡å®šeffectå€¼æ—¶ è¡¨ç¤ºå®¹å¿æ‰€æœ‰çš„æ±¡ç‚¹ä½œç”¨</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>tolerations</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;key&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Exists&#34;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>æœ‰å¤šä¸ªmasterå­˜åœ¨æ—¶ é˜²æ­¢èµ„æºæµªè´¹ å¯ä»¥å¦‚ä¸‹è®¾ç½®</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl taint nodes Node-Name node-role.kubernetes.io/master<span class=o>=</span>:PreferNoSchedule
</span></span></code></pre></td></tr></table></div></div></li></ul><h5 id=åŸºäºæ±¡ç‚¹çš„é©±é€>åŸºäºæ±¡ç‚¹çš„é©±é€</h5><ul><li>å½“æŸç§æ¡ä»¶ä¸ºçœŸæ—¶ èŠ‚ç‚¹æ§åˆ¶å™¨ä¼šè‡ªåŠ¨ç»™èŠ‚ç‚¹æ·»åŠ ä¸€ä¸ªæ±¡ç‚¹ å½“å‰å†…ç½®çš„æ±¡ç‚¹åŒ…æ‹¬ï¼š<ul><li><code>node.kubernetes.io/not-ready</code>ï¼šèŠ‚ç‚¹æœªå‡†å¤‡å¥½ è¿™ç›¸å½“äºèŠ‚ç‚¹çŠ¶å†µ<code>Ready</code>çš„å€¼ä¸º"<code>False</code>"</li><li><code>node.kubernetes.io/unreachable</code>ï¼šèŠ‚ç‚¹æ§åˆ¶å™¨è®¿é—®ä¸åˆ°èŠ‚ç‚¹ è¿™ç›¸å½“äºèŠ‚ç‚¹çŠ¶å†µ<code>Ready</code>çš„å€¼ä¸º &ldquo;<code>Unknown</code>&rdquo;</li><li><code>node.kubernetes.io/memory-pressure</code>ï¼šèŠ‚ç‚¹å­˜åœ¨å†…å­˜å‹åŠ›</li><li><code>node.kubernetes.io/disk-pressure</code>ï¼šèŠ‚ç‚¹å­˜åœ¨ç£ç›˜å‹åŠ›</li><li><code>node.kubernetes.io/pid-pressure</code>ï¼šèŠ‚ç‚¹çš„<code>PID</code>å‹åŠ›</li><li><code>node.kubernetes.io/network-unavailable</code>ï¼šèŠ‚ç‚¹ç½‘ç»œä¸å¯ç”¨</li><li><code>node.kubernetes.io/unschedulable</code>ï¼šèŠ‚ç‚¹ä¸å¯è°ƒåº¦</li><li><code>node.cloudprovider.kubernetes.io/uninitialized</code>ï¼šå¦‚æœ<code>kubelet</code>å¯åŠ¨æ—¶æŒ‡å®šäº†ä¸€ä¸ª"å¤–éƒ¨"äº‘å¹³å°é©±åŠ¨ å®ƒå°†ç»™å½“å‰èŠ‚ç‚¹æ·»åŠ ä¸€ä¸ªæ±¡ç‚¹å°†å…¶æ ‡å¿—ä¸ºä¸å¯ç”¨ åœ¨<code>cloud-controller-manager</code>çš„ä¸€ä¸ªæ§åˆ¶å™¨åˆå§‹åŒ–è¿™ä¸ªèŠ‚ç‚¹å kubeletå°†åˆ é™¤è¿™ä¸ªæ±¡ç‚¹</li></ul></li><li>åœ¨èŠ‚ç‚¹è¢«æ’ç©ºæ—¶ èŠ‚ç‚¹æ§åˆ¶å™¨æˆ–è€…kubeletä¼šæ·»åŠ å¸¦æœ‰<code>NoExecute</code>æ•ˆæœçš„ç›¸å…³æ±¡ç‚¹ æ­¤æ•ˆæœè¢«é»˜è®¤æ·»åŠ åˆ°<code>node.kubernetes.io/not-ready</code>å’Œ<code>node.kubernetes.io/unreachable</code>æ±¡ç‚¹ä¸­ å¦‚æœå¼‚å¸¸çŠ¶æ€æ¢å¤æ­£å¸¸ kubeletæˆ–èŠ‚ç‚¹æ§åˆ¶å™¨èƒ½å¤Ÿç§»é™¤ç›¸å…³çš„æ±¡ç‚¹</li><li>åœ¨æŸäº›æƒ…å†µä¸‹ å½“èŠ‚ç‚¹ä¸å¯è¾¾æ—¶ APIæœåŠ¡å™¨æ— æ³•ä¸èŠ‚ç‚¹ä¸Šçš„<code>kubelet</code>è¿›è¡Œé€šä¿¡ åœ¨ä¸APIæœåŠ¡å™¨çš„é€šä¿¡è¢«é‡æ–°å»ºç«‹ä¹‹å‰ åˆ é™¤Podçš„å†³å®šæ— æ³•ä¼ é€’åˆ°kubelet åŒæ—¶ è¢«è°ƒåº¦è¿›è¡Œåˆ é™¤çš„é‚£äº›Podå¯èƒ½ä¼šç»§ç»­è¿è¡Œåœ¨åˆ†åŒºåçš„èŠ‚ç‚¹ä¸Š</li></ul><h3 id=å›ºå®šèŠ‚ç‚¹è°ƒåº¦>å›ºå®šèŠ‚ç‚¹è°ƒåº¦</h3><h4 id=æŒ‡å®šèŠ‚ç‚¹è°ƒåº¦>æŒ‡å®šèŠ‚ç‚¹è°ƒåº¦</h4><ul><li><code>pod.spec.nodeName</code>å°†Podç›´æ¥è°ƒåº¦åˆ°æŒ‡å®šçš„NodeèŠ‚ç‚¹ä¸Š ä¼šè·³è¿‡Schedulerçš„è°ƒåº¦ç­–ç•¥ è¯¥åŒ¹é…è§„åˆ™æ—¶å¼ºåˆ¶åŒ¹é…<ul><li>å¦‚æœ<code>nodeName</code>å­—æ®µä¸ä¸ºç©º è°ƒåº¦å™¨ä¼šå¿½ç•¥è¯¥Pod è€ŒæŒ‡å®šèŠ‚ç‚¹ä¸Šçš„kubeletä¼šå°è¯•å°†Podæ”¾åˆ°è¯¥èŠ‚ç‚¹ä¸Š</li><li>ä½¿ç”¨<code>nodeName</code>è§„åˆ™çš„ä¼˜å…ˆçº§ä¼šé«˜äºä½¿ç”¨<code>nodeSelector</code>æˆ–äº²å’Œæ€§ä¸éäº²å’Œæ€§çš„è§„åˆ™</li><li>å±€é™æ€§<ul><li>å¦‚æœæ‰€æŒ‡ä»£çš„èŠ‚ç‚¹ä¸å­˜åœ¨ åˆ™Podæ— æ³•è¿è¡Œ è€Œä¸”åœ¨æŸäº›æƒ…å†µä¸‹å¯èƒ½ä¼šè¢«è‡ªåŠ¨åˆ é™¤</li><li>å¦‚æœæ‰€æŒ‡ä»£çš„èŠ‚ç‚¹æ— æ³•æä¾›ç”¨æ¥è¿è¡ŒPodæ‰€éœ€çš„èµ„æº Podä¼šå¤±è´¥ è€Œå…¶å¤±è´¥åŸå› ä¸­ä¼šç»™å‡ºæ˜¯å¦å› ä¸ºå†…å­˜æˆ–CPUä¸è¶³è€Œé€ æˆæ— æ³•è¿è¡Œ</li><li>åœ¨äº‘ç¯å¢ƒä¸­çš„èŠ‚ç‚¹åç§°å¹¶ä¸æ€»æ˜¯å¯é¢„æµ‹çš„ ä¹Ÿä¸æ€»æ˜¯ç¨³å®šçš„</li></ul></li></ul></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>nodeName</span><span class=p>:</span><span class=w> </span><span class=l>kube-01</span><span class=w> </span><span class=c># è¯¥Podåªèƒ½è¿è¡Œåœ¨èŠ‚ç‚¹kube-01ä¸Š</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=æŒ‡å®šèŠ‚ç‚¹æ ‡ç­¾è°ƒåº¦>æŒ‡å®šèŠ‚ç‚¹æ ‡ç­¾è°ƒåº¦</h4><p><a class=link href=https://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/assign-pods-nodes/ target=_blank rel=noopener>å°†Podåˆ†é…ç»™èŠ‚ç‚¹</a></p><p><a class=link href=https://kubernetes.io/zh-cn/docs/concepts/overview/working-with-objects/labels/ target=_blank rel=noopener>æ ‡ç­¾å’Œé€‰æ‹©è¿ç®—ç¬¦</a></p><ul><li><code>po.spec.nodeSelector</code>é€šè¿‡kubernetesçš„label-selectoræœºåˆ¶é€‰æ‹©èŠ‚ç‚¹ ç”±è°ƒåº¦å™¨ç­–ç•¥åŒ¹é…label è€Œåè°ƒåº¦Podåˆ°ç›®æ ‡èŠ‚ç‚¹ è¯¥åŒ¹é…è§„åˆ™å±äº<strong>å¼ºåˆ¶çº¦æŸ</strong></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># åˆ—å‡ºé›†ç¾¤èŠ‚ç‚¹åŠæ ‡ç­¾</span>
</span></span><span class=line><span class=cl>kubectl get nodes --show-labels
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ç»™èŠ‚ç‚¹æ·»åŠ æ ‡ç­¾</span>
</span></span><span class=line><span class=cl>kubectl label nodes &lt;node-name&gt; <span class=nv>disktype</span><span class=o>=</span>ssd
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># æŸ¥æ‰¾å¯¹åº”æ ‡ç­¾node</span>
</span></span><span class=line><span class=cl>kubectl get nodes -l <span class=nv>disktype</span><span class=o>=</span>ssd
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>env</span><span class=p>:</span><span class=w> </span><span class=l>test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>IfNotPresent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>nodeSelector</span><span class=p>:</span><span class=w>  </span><span class=c># è¯¥Podä¼šè°ƒåº¦åˆ°å…·æœ‰ä¸‹é¢æ ‡ç­¾çš„èŠ‚ç‚¹ä¸Š</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>disktype</span><span class=p>:</span><span class=w> </span><span class=l>ssd</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=è®¤è¯åŠserviceaccount>è®¤è¯åŠServiceAccount</h2><h3 id=è®¤è¯æˆæƒ>è®¤è¯æˆæƒ</h3><ul><li>è®¤è¯(æ”¯æŒå¤šç§è®¤è¯æ–¹å¼) # è®¤è¯æ’ä»¶<ul><li>ä»¤ç‰Œè®¤è¯ bearer token</li><li>sslè®¤è¯(ç¡®è®¤æœåŠ¡ç«¯/å®¢æˆ·ç«¯èº«ä»½) åŒå‘è¯ä¹¦è®¤è¯(https)</li><li>&mldr;</li></ul></li><li>æˆæƒæ£€æŸ¥(æƒé™) # æˆæƒæ’ä»¶<ul><li>RBAC # kubeadméƒ¨ç½²çš„é›†ç¾¤å¼ºåˆ¶å¼€å¯RBAC</li><li>&mldr;</li></ul></li><li>å‡†å…¥æ§åˆ¶(å…³è”çš„å…¶ä»–èµ„æºæˆ–æ“ä½œ æ˜¯å¦æœ‰æƒé™ è¿›ä¸€æ­¥è¡¥å……æˆæƒæœºåˆ¶)</li><li>API Serveréœ€è¦ä¿¡æ¯å»è¯†åˆ«å®¢æˆ·ç«¯çš„æ“ä½œ<ul><li>user: username + uid</li><li>group</li><li>extra</li><li>API(è¯·æ±‚çš„Kubernetes API)<ul><li>Request Path<ul><li><code>kubectl proxy --port=8080</code></li><li><code>curl http://localhost:8080/api/v1/namespaces</code></li><li><code>curl http://localhost:8080/apis/apps/v1/namespaces/default/deployments/myapp-deploy/</code></li></ul></li><li>HTTP request verb<ul><li>GET POST PUT DELETE</li><li>get list create update patch watch proxy redirect delete deletecollection</li></ul></li><li>Resources</li><li>SubResources</li><li>Namespace</li><li>API Group</li></ul></li></ul></li></ul><h3 id=serviceaccount>ServiceAccount</h3><ul><li>è®¿é—®APIServerçš„ä¸¤ç§å®¢æˆ·ç«¯<ul><li>kubectl/dashborad é›†ç¾¤å¤–éƒ¨å®¢æˆ·ç«¯(userAccount)</li><li>pod é›†ç¾¤å†…éƒ¨å®¢æˆ·ç«¯(serviceAccount)<ul><li><code>kubectl explain pods.spec.serviceAccountName</code></li></ul></li></ul></li><li>kubeconfig<ul><li><code>kubectl config view</code></li></ul></li></ul><h3 id=rbacæˆæƒ>RBACæˆæƒ</h3><ul><li>æˆæƒæ’ä»¶<ul><li>Node</li><li>ABAC(<em>Attribute-based access control</em>)</li><li>RBAC(<em>Role-based access contro</em>)</li><li>Webhook</li></ul></li></ul><p><img src=/p/kubernetes/icons/k8s-RBAC.png width=1364 height=768 srcset="/p/kubernetes/icons/k8s-RBAC_hu93382d84de46ca6bdd4d6c35df8f4890_1483186_480x0_resize_box_3.png 480w, /p/kubernetes/icons/k8s-RBAC_hu93382d84de46ca6bdd4d6c35df8f4890_1483186_1024x0_resize_box_3.png 1024w" loading=lazy alt=k8s-RBAC class=gallery-image data-flex-grow=177 data-flex-basis=426px></p><ul><li>K8S-RBAC<ul><li>role<ul><li>operations</li><li>objects</li></ul></li><li>rolebinding<ul><li>user account OR service account</li><li>role</li></ul></li><li><code>kubectl create role pods-reader --verb=get,list,watch --resource=pods --dry-run -o yaml</code></li></ul></li></ul><p><img src=/p/kubernetes/icons/role-binding.png width=1498 height=1096 srcset="/p/kubernetes/icons/role-binding_hue49744d6898b8c4106d004f8692e3f91_1070895_480x0_resize_box_3.png 480w, /p/kubernetes/icons/role-binding_hue49744d6898b8c4106d004f8692e3f91_1070895_1024x0_resize_box_3.png 1024w" loading=lazy alt=role-binding class=gallery-image data-flex-grow=136 data-flex-basis=328px></p><h2 id=é…ç½®ç®¡ç†>é…ç½®ç®¡ç†</h2><h3 id=kustomize>Kustomize</h3><p><a class=link href=https://kustomize.io/ target=_blank rel=noopener>kustomize</a></p><h3 id=helm>Helm</h3><p><a class=link href=https://helm.sh/zh/docs/ target=_blank rel=noopener>helm</a></p><h4 id=æ¨¡ç‰ˆdebug>æ¨¡ç‰ˆdebug</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=p>{{</span><span class=o>-</span> <span class=err>$</span><span class=nx>commonValues</span> <span class=o>:=</span> <span class=nx>mustDeepCopy</span> <span class=p>.</span><span class=nx>Values</span><span class=p>.</span><span class=nx>common</span> <span class=o>-</span><span class=p>}}</span>
</span></span><span class=line><span class=cl><span class=p>{{</span> <span class=nf>fail</span> <span class=p>(</span><span class=nx>printf</span> <span class=s>&#34;commonValues:%v\n&#34;</span> <span class=p>(</span><span class=nx>toYaml</span> <span class=p>.</span><span class=nx>Values</span> <span class=p>|</span> <span class=nx>nindent</span> <span class=mi>2</span> <span class=p>))</span> <span class=p>}}</span>  <span class=c1>// æ ¼å¼åŒ–æ‰“å°å¯¹åº”å€¼ æ–¹ä¾¿debug
</span></span></span></code></pre></td></tr></table></div></div><h2 id=é›†ç¾¤ç›‘æ§>é›†ç¾¤ç›‘æ§</h2><ul><li>ä¹¦ç±æ¨è äº†è§£Googleè¿ç»´çš„ç§˜å¯† <a class=link href=https://lewlh.github.io/2020/07/18/SRE-Google%E8%BF%90%E7%BB%B4%E8%A7%A3%E5%AF%86/ target=_blank rel=noopener>SRE: Googleè¿ç»´è§£å¯†</a></li><li>èµ„æºç›‘æ§æ–¹æ¡ˆ Prometheus æ— å¯æŒ‘å‰”çš„é€‰æ‹© éœ€å‰ç½®Prometheusç›¸å…³çŸ¥è¯†</li><li>Kubernetesé›†ç¾¤çš„ç›‘æ§æ–¹æ¡ˆä¸»è¦æœ‰ä»¥ä¸‹å‡ ç§æ–¹æ¡ˆ<ul><li>Heapster: å·²åºŸå¼ƒ ä½¿ç”¨metrics-serverä»£æ›¿</li><li>cAdvisor: <a class=link href=https://github.com/google/cadvisor target=_blank rel=noopener>cAdvisor</a>æ˜¯Googleå¼€æºçš„å®¹å™¨èµ„æºç›‘æ§å’Œæ€§èƒ½åˆ†æå·¥å…·<ul><li>å®ƒæ˜¯ä¸“é—¨ä¸ºå®¹å™¨è€Œç”Ÿçš„ æœ¬èº«ä¹Ÿæ”¯æŒDocker</li><li>åœ¨Kubernetesä¸­ æˆ‘ä»¬ä¸éœ€è¦å•ç‹¬å»å®‰è£… cAdvisorä½œä¸ºkubectlå†…ç½®çš„ä¸€éƒ¨åˆ†ç¨‹åº å¯ä»¥ç›´æ¥ä½¿ç”¨</li></ul></li><li>kube-state-metrics: <a class=link href=https://github.com/kubernetes/kube-state-metrics target=_blank rel=noopener>kube-state-metrics</a>é€šè¿‡ç›‘å¬API Serverç”Ÿæˆæœ‰å…³èµ„æºå¯¹è±¡çš„çŠ¶æ€æŒ‡æ ‡<ul><li>æ¯”å¦‚: Deploymentã€Nodeã€Pod éœ€è¦æ³¨æ„çš„æ˜¯ kube-state-metricsåªæ˜¯ç®€å•æä¾›ä¸€ä¸ªmetricsæ•°æ® å¹¶ä¸ä¼šå­˜å‚¨è¿™äº›æŒ‡æ ‡æ•°æ®</li><li>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨Prometheusæ¥æŠ“å–è¿™äº›æ•°æ®ç„¶åå­˜å‚¨</li></ul></li><li>metrics-server: metrics-serverä¹Ÿæ˜¯ä¸€ä¸ªé›†ç¾¤èŒƒå›´å†…çš„èµ„æºæ•°æ®èšåˆå·¥å…· æ˜¯Headsterçš„æ›¿ä»£<ul><li>åŒæ ·çš„ metrics-serverä¹Ÿåªæ˜¯æ˜¾ç¤ºæ•°æ® å¹¶ä¸æä¾›æ•°æ®å­˜å‚¨æœåŠ¡</li></ul></li></ul></li><li>kube-state-metrics å’Œ metrics-serverçš„åŒºåˆ«ï¼š<ul><li>kube-state-metricsä¸»è¦å…³æ³¨çš„æ˜¯ä¸šåŠ¡ç›¸å…³çš„ä¸€äº›å…ƒæ•°æ® æ¯”å¦‚ Deploymentã€Podã€å‰¯æœ¬çŠ¶æ€ç­‰</li><li>metrics-serverä¸»è¦å…³æ³¨çš„æ˜¯<a class=link href=https://github.com/kubernetes/design-proposals-archive/blob/main/instrumentation/resource-metrics-api.md target=_blank rel=noopener>èµ„æºåº¦é‡API</a>çš„å®ç° æ¯”å¦‚ CPUã€å†…å­˜ã€æ–‡ä»¶æè¿°ç¬¦ã€è¯·æ±‚å»¶æ—¶ç­‰æŒ‡æ ‡</li></ul></li></ul><h3 id=æ‰‹åŠ¨å®‰è£…prometheus>æ‰‹åŠ¨å®‰è£…Prometheus</h3><ul><li>èµ„æºæ¸…å•æ–‡ä»¶</li><li><code>kubectl apply -f prometheus.yaml</code></li><li>å› ä¸ºæ˜¯ä»¥NodePortæš´éœ²çš„æœåŠ¡ ç›´æ¥è®¿é—® <code>http://ä»»æ„èŠ‚ç‚¹IP:&lt;NodePort></code> å°±èƒ½çœ‹åˆ°ç†Ÿæ‚‰çš„Prometheus UI</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># kubectl create ns kube-ops</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># æš‚æ—¶åªé…ç½®å¯¹proemtheusçš„ç›‘æ§</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ConfigMap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>prometheus-config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>kube-ops</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>prometheus.yaml</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    global:
</span></span></span><span class=line><span class=cl><span class=sd>      scrape_interval: 15s
</span></span></span><span class=line><span class=cl><span class=sd>      evaluation_interval: 15s
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    scrape_configs:
</span></span></span><span class=line><span class=cl><span class=sd>      - job_name: &#39;prometheus&#39;
</span></span></span><span class=line><span class=cl><span class=sd>        static_configs:
</span></span></span><span class=line><span class=cl><span class=sd>          - targets: [&#39;localhost:9090&#39;]</span><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># PVC for prometheus ä½¿ç”¨NFSæ¼”ç¤º</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>PersistentVolumeClaim</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>kube-ops</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>storageClassName</span><span class=p>:</span><span class=w> </span><span class=l>nfs-client</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>accessModes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>ReadWriteMany</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>storage</span><span class=p>:</span><span class=w> </span><span class=l>10Gi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># åˆ›å»ºServiceAccount</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ServiceAccount</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>kube-ops</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># åˆ›å»ºCllusterRole</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRole</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>apiGroups</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=s2>&#34;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>nodes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>services</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>endpoints</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>pods</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>nodes/proxy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>verbs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>get</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>list</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>watch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>apiGroups</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=s2>&#34;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>configmaps</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>nodes/metrics</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>verbs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>get</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>nonResourceURLs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>/metrics</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>verbs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>get</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># åˆ›å»ºClusterRoleBinding</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRoleBinding</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>roleRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRole</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>subjects</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ServiceAccount</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>kube-ops</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># åˆ›å»ºDeployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>kube-ops</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>serviceAccountName</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>prom/prometheus:v2.46.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>command</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>/bin/prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- --<span class=l>config.file=/etc/prometheus/prometheus.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- --<span class=l>storage.tsdb.path=/prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- --<span class=l>storage.tsdb.retention.time=24h</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- --<span class=l>web.enable-admin-api</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- --<span class=l>web.enable-lifecycle</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>9090</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>TCP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>http</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>prometheus-config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/etc/prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>prometheus-storage</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=c># åªæŒ‚è½½å·ä¸­çš„ä¸€ä¸ªå­ç›®å½•æˆ–å­è·¯å¾„åˆ°å®¹å™¨ä¸­ è€Œä¸æ˜¯æŒ‚è½½æ•´ä¸ªå·</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=c># 1. é¿å…æ•°æ®æ±¡æŸ“</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=c># 2. å¤šå®¹å™¨å…±äº«åŒä¸€ä¸ªPVC</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=c># 3. æ•°æ®éš”ç¦»</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>subPath</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>100m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>512Mi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>limits</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>100m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>512Mi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>securityContext</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>runAsUser</span><span class=p>:</span><span class=w> </span><span class=m>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>prometheus-config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>configMap</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>prometheus-config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>prometheus-storage</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>persistentVolumeClaim</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>claimName</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># åˆ›å»ºService</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>kube-ops</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>NodePort</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>http</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>9090</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=m>9090</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>nodePort</span><span class=p>:</span><span class=w> </span><span class=m>30000</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=ç›‘æ§é›†ç¾¤åº”ç”¨>ç›‘æ§é›†ç¾¤åº”ç”¨</h3><ul><li>å†…ç½®æŒ‡æ ‡æ¥å£ ç›´æ¥é…ç½®é™æ€é…ç½®serviceåœ°å€çš„å†…ç½®æŒ‡æ ‡æ¥å£</li><li>æœªå†…ç½®æŒ‡æ ‡æ¥å£ ç›´æ¥é…ç½®å¯¹åº”exporterçš„serviceåœ°å€çš„æŒ‡æ ‡æ¥å£</li></ul><h3 id=ç›‘æ§é›†ç¾¤èŠ‚ç‚¹>ç›‘æ§é›†ç¾¤èŠ‚ç‚¹</h3><ul><li>ç›‘æ§èŠ‚ç‚¹å·²æœ‰éå¸¸å¤šçš„æˆç†Ÿæ–¹æ¡ˆ æ¯”å¦‚ï¼šNagios Zabbix ç”šè‡³è‡ªå·±æ”¶é›†æ•°æ®ä¹Ÿå¯ä»¥</li><li>Kubernetesä¸­ æˆ‘ä»¬é€šè¿‡<a class=link href=https://github.com/prometheus/node_exporter target=_blank rel=noopener>node_exporter</a>æ¥è·å–èŠ‚ç‚¹æŒ‡æ ‡<ul><li>node_exporterç”¨äºé‡‡é›†æœåŠ¡å™¨èŠ‚ç‚¹çš„å„ç§è¿è¡ŒæŒ‡æ ‡ åŒ…æ‹¬ï¼šconntrack cpu diskstats filesystem loadavg memeinfo netstatç­‰</li><li>è¯¦ç»†å†…å®¹å‚è€ƒå®˜æ–¹repoæ–‡æ¡£</li></ul></li></ul><h4 id=éƒ¨ç½²node-exporter>éƒ¨ç½²node-exporter</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># éƒ¨ç½²node-exporterçš„èµ„æºæ¸…å•æ–‡ä»¶</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># æ³¨æ„äº‹é¡¹ï¼šç”±äºæˆ‘ä»¬è¦è·å–åˆ°çš„æ•°æ®æ˜¯ä¸»æœºçš„ç›‘æ§æŒ‡æ ‡æ•°æ® è€Œnode-exporteræ˜¯è¿è¡Œåœ¨å®¹å™¨ä¸­çš„ æ‰€æœ‰åœ¨Podä¸­éœ€è¦é…ç½®ä¸€äº›Podçš„å®‰å…¨ç­–ç•¥</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#   hostPID: true å…è®¸å®¹å™¨è®¿é—®ä¸»æœºçš„PIDå‘½åç©ºé—´</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#   hostIPC: true å…è®¸å®¹å™¨è®¿é—®ä¸»æœºçš„IPCå‘½åç©ºé—´</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#   hostNetwork: true å…è®¸å®¹å™¨ä½¿ç”¨ä¸»æœºçš„ç½‘ç»œå‘½åç©ºé—´</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># å¦å¤– æˆ‘ä»¬è¿˜å°†ä¸»æœºçš„/devã€/procã€/sysç›®å½•æŒ‚è½½åˆ°å®¹å™¨ä¸­ å› ä¸ºæˆ‘ä»¬é‡‡é›†çš„å¾ˆå¤šèŠ‚ç‚¹æ•°æ®éƒ½æ˜¯é€šè¿‡è¿™äº›ç›®å½•ä¸‹é¢çš„æ–‡ä»¶æ¥è·å–çš„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#   /proc/stat /proc/meminfo /proc/cpuinfo /proc/diskstats /proc/net/dev ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>DaemonSet</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>node-exporter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>kube-ops</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>node-exporter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>node-exporter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>node-exporter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>hostPID</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>hostIPC</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>hostNetwork</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>node-exporter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>prom/node-exporter:v1.9.1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>9100</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>200m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>securityContext</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>privileged</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- --<span class=l>path.procfs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>/host/proc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- --<span class=l>path.sysfs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>/host/sys</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- --<span class=l>collector.filesystem.ignored-mount-points</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=s2>&#34;^/(sys|proc|dev|host|etc)($|/)&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>dev</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/host/dev</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>proc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/host/proc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>sys</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/host/sys</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>rootfs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/rootfs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>tolerations</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>node-role.kubernetes.io/control-plane</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=l>Exists</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>effect</span><span class=p>:</span><span class=w> </span><span class=l>NoSchedule</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>dev</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>hostPath</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/dev</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>proc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>hostPath</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/proc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>sys</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>hostPath</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/sys</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>rootfs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>hostPath</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=é…ç½®åŸºäºkubernetesçš„è‡ªåŠ¨å‘ç°>é…ç½®åŸºäºKubernetesçš„è‡ªåŠ¨å‘ç°</h4><p><a class=link href=https://prometheus.io/docs/prometheus/2.51/configuration/configuration/#kubernetes_sd_config target=_blank rel=noopener>kubernetes_sd_config</a></p><ul><li>åœ¨Kubernetesä¸­ Prometheusé€šè¿‡ä¸Kubernetes APIé›†æˆ ç›®å‰ä¸»è¦æ”¯æŒ5ç§æœåŠ¡å‘ç°æ¨¡å¼<ul><li>node</li><li>service</li><li>pod</li><li>endpoints / endpointslice</li><li>ingress</li></ul></li><li>é€šè¿‡åˆ¶å®š<code>kubernetes_sd_config</code>çš„æ¨¡å¼ä¸º<code>node</code> Prometheuså°±ä¼šè‡ªåŠ¨ä»Kubernetesä¸­å‘ç°æ‰€æœ‰çš„nodeèŠ‚ç‚¹å¹¶ä½œä¸ºå½“å‰jobç›‘æ§çš„ç›®æ ‡å®ä¾‹ å‘ç°çš„èŠ‚ç‚¹<code>/metrics</code>æ¥å£æ—¶é»˜è®¤çš„kubeletçš„HTTPæ¥å£</li><li>Promethehså»å‘ç°Nodeæ¨¡å¼çš„æœåŠ¡çš„æ—¶å€™ è®¿é—®çš„é»˜è®¤ç«¯å£æ˜¯10250(kubeletæœåŠ¡ç«¯å£) è€Œç°åœ¨è¯¥ç«¯å£ä¸‹é¢å·²ç»æ²¡æœ‰/metricsæŒ‡æ ‡æ•°æ®</li><li>å› ä¸ºä¸Šé¢é…ç½®æŒ‡å®šäº†<code>hostNetwork: true</code> æ‰€ä»¥æ¯ä¸ªèŠ‚ç‚¹éƒ½ä¼šç›‘å¬9100ç«¯å£ æˆ‘ä»¬åº”è¯¥å°†è¿™é‡Œçš„10250æ›¿æ¢ä¸º9100</li><li>å¦‚ä½•å®ç°ï¼šä½¿ç”¨Prometheusæä¾›çš„<code>relabel_configs</code>ä¸­çš„<code>replace</code>èƒ½åŠ›<ul><li>relabelå¯ä»¥åœ¨Prometheusé‡‡é›†æ•°æ®ä¹‹å‰ é€šè¿‡Targetå®ä¾‹çš„metadataä¿¡æ¯ åŠ¨æ€é‡æ–°å†™å…¥Labelçš„å€¼</li><li>é™¤æ­¤ä¹‹å¤– è¿˜èƒ½æ ¹æ®Targetå®ä¾‹çš„metadataä¿¡æ¯ é€‰æ‹©æ˜¯å¦é‡‡é›†æˆ–å¿½ç•¥è¯¥Targetå®ä¾‹/æŒ‡æ ‡</li><li>æ·»åŠ ä¸€ä¸ªactionä¸º<code>labelmap</code> æ­£åˆ™è¡¨è¾¾å¼<code>__metadata_kubernetes_node_label_(.+)</code>çš„é…ç½® è¿™é‡Œçš„æ„æ€æ˜¯è¡¨è¾¾å¼ä¸­åŒ¹é…çš„æ•°æ®ä¹Ÿæ·»åŠ åˆ°æŒ‡æ ‡æ•°æ®çš„Labelæ ‡ç­¾ä¸­å»</li><li>å¯¹äºkubernetes_sd_configä¸‹é¢å¯ç”¨çš„æ ‡ç­¾å¦‚ä¸‹ï¼š<ul><li><code>__metadata_kubernetes_node_name</code>: èŠ‚ç‚¹å¯¹è±¡çš„åç§°</li><li><code>__metadata_kubernetes_node_label</code>: èŠ‚ç‚¹å¯¹è±¡ä¸­çš„æ¯ä¸ªæ ‡ç­¾</li><li><code>__metadata_kubernetes_node_annitation</code>: æ¥è‡ªèŠ‚ç‚¹å¯¹è±¡çš„æ¯ä¸ªæ³¨è§£</li><li><code>__metadata_kubernetes_node_address</code>: æ¯ä¸ªèŠ‚ç‚¹åœ°å€ç±»å‹çš„ç¬¬ä¸€ä¸ªåœ°å€(å¦‚æœå­˜åœ¨)</li><li>æ›´å¤šç±»å‹å‚è€ƒPrometheuså®˜æ–¹æ–‡æ¡£</li></ul></li></ul></li><li>ä¿®æ”¹åçš„configmapå¦‚ä¸‹</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ConfigMap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>prometheus-config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>kube-ops</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>prometheus.yaml</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    global:
</span></span></span><span class=line><span class=cl><span class=sd>      scrape_interval: 15s
</span></span></span><span class=line><span class=cl><span class=sd>      evaluation_interval: 15s
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    scrape_configs:
</span></span></span><span class=line><span class=cl><span class=sd>    - job_name: &#39;prometheus&#39;
</span></span></span><span class=line><span class=cl><span class=sd>      static_configs:
</span></span></span><span class=line><span class=cl><span class=sd>      - targets: [&#39;localhost:9090&#39;]
</span></span></span><span class=line><span class=cl><span class=sd>      
</span></span></span><span class=line><span class=cl><span class=sd>    - job_name: &#39;kubernetes-nodes&#39;
</span></span></span><span class=line><span class=cl><span class=sd>      kubernetes_sd_configs:
</span></span></span><span class=line><span class=cl><span class=sd>      - role: node
</span></span></span><span class=line><span class=cl><span class=sd>      relabel_configs:
</span></span></span><span class=line><span class=cl><span class=sd>      - source_labels: [__address__]
</span></span></span><span class=line><span class=cl><span class=sd>        regex: &#39;(.+):10250&#39;
</span></span></span><span class=line><span class=cl><span class=sd>        replacement: &#39;${1}:9100&#39;
</span></span></span><span class=line><span class=cl><span class=sd>        target_label: __address__
</span></span></span><span class=line><span class=cl><span class=sd>        action: replace
</span></span></span><span class=line><span class=cl><span class=sd>      - action: labelmap
</span></span></span><span class=line><span class=cl><span class=sd>        regex: __meta_kubernetes_node_label_(.+)
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    # 1.11+ç‰ˆæœ¬å metricsç«¯å£ä¸º10250 éœ€è¦ä½¿ç”¨httpsåè®®è·å–æŒ‡æ ‡
</span></span></span><span class=line><span class=cl><span class=sd>    - job_name: &#39;kubernetes-kubelet&#39;
</span></span></span><span class=line><span class=cl><span class=sd>      kubernetes_sd_configs:
</span></span></span><span class=line><span class=cl><span class=sd>      - role: node
</span></span></span><span class=line><span class=cl><span class=sd>      scheme: https
</span></span></span><span class=line><span class=cl><span class=sd>      tls_config:
</span></span></span><span class=line><span class=cl><span class=sd>        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
</span></span></span><span class=line><span class=cl><span class=sd>        insecure_skip_verify: true
</span></span></span><span class=line><span class=cl><span class=sd>      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
</span></span></span><span class=line><span class=cl><span class=sd>      relabel_configs:
</span></span></span><span class=line><span class=cl><span class=sd>      - action: labelmap
</span></span></span><span class=line><span class=cl><span class=sd>        regex: __meta_kubernetes_node_label_(.+)</span><span class=w>    
</span></span></span></code></pre></td></tr></table></div></div><h3 id=ç›‘æ§é›†ç¾¤å¸¸ç”¨èµ„æºå¯¹è±¡>ç›‘æ§é›†ç¾¤å¸¸ç”¨èµ„æºå¯¹è±¡</h3><h4 id=å®¹å™¨ç›‘æ§>å®¹å™¨ç›‘æ§</h4><ul><li>è¯´åˆ°å®¹å™¨ç›‘æ§æˆ‘ä»¬è‡ªç„¶ä¼šæƒ³åˆ°cAdisor æˆ‘ä»¬å‰é¢è¯´è¿‡cAdvisorå·²ç»å†…ç½®åœ¨äº†kubeletç»„ä»¶ä¸­ æ‰€ä»¥æˆ‘ä»¬ä¸éœ€è¦å•ç‹¬å®‰è£…</li><li>cAdvisorçš„æ•°æ®è·¯å¾„ä¸º<code>/api/v1/nodes/&lt;node>/proxy/metrics</code></li><li>åŒæ · æˆ‘ä»¬ä½¿ç”¨nodeçš„æœåŠ¡å‘ç°æ¨¡å¼ å› ä¸ºæ¯ä¸€ä¸ªèŠ‚ç‚¹ä¸‹é¢éƒ½æœ‰kubelet è‡ªç„¶éƒ½æœ‰cAdvisoré‡‡é›†åˆ°çš„æ•°æ®æŒ‡æ ‡</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># prometheus configmapé…ç½®å‚è€ƒ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>job_name</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;kubernetes-cadvisor&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>kubernetes_sd_configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>role</span><span class=p>:</span><span class=w> </span><span class=l>node</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>scheme</span><span class=p>:</span><span class=w> </span><span class=l>https</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tls_config</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ca_file</span><span class=p>:</span><span class=w> </span><span class=l>/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>bearer_token_file</span><span class=p>:</span><span class=w> </span><span class=l>/var/run/secrets/kubernetes.io/serviceaccount/token</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>relabel_configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>labelmap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>regex</span><span class=p>:</span><span class=w> </span><span class=l>__meta_kubernetes_node_label_(.+)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>target_label</span><span class=p>:</span><span class=w> </span><span class=l>__address__</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>replacement</span><span class=p>:</span><span class=w> </span><span class=l>kubernetes.default.svc:443</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>source_labels</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>__meta_kubernetes_node_name]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>regex</span><span class=p>:</span><span class=w> </span><span class=l>(.+)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>target_label</span><span class=p>:</span><span class=w> </span><span class=l>__metrics_path__</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>replacement</span><span class=p>:</span><span class=w> </span><span class=l>/api/v1/nodes/${1}/proxy/metrics/cadvisor</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=apiserverç›‘æ§>apiserverç›‘æ§</h4><ul><li>apiserverä½œä¸ºKubernetesçš„æœ€æ ¸å¿ƒç»„ä»¶ å¯¹å®ƒçš„ç›‘æ§æ˜¯éå¸¸å¿…è¦çš„</li><li>å¯¹äºapiserverçš„ç›‘æ§æˆ‘ä»¬å¯ä»¥ç›´æ¥é€šè¿‡kubernetesçš„Serviceæ¥è·å–<ul><li><code>kubectl get svc kubernetes -n default</code></li></ul></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl>- <span class=nt>job_name</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;kubernetes-apiservers&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>kubernetes_sd_configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>role</span><span class=p>:</span><span class=w> </span><span class=l>endpoints</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>scheme</span><span class=p>:</span><span class=w> </span><span class=l>https </span><span class=w> </span><span class=c># httpsåè®®</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tls_config</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ca_file</span><span class=p>:</span><span class=w> </span><span class=l>/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>bearer_token_file</span><span class=p>:</span><span class=w> </span><span class=l>/var/run/secrets/kubernetes.io/serviceaccount/token</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>relabel_configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>source_labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>__meta_kubernetes_namespace</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>__meta_kubernetes_service_name</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>__meta_kubernetes_endpoint_port_name</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>keep </span><span class=w> </span><span class=c># ä½¿ç”¨endpointsçš„è‡ªåŠ¨å‘ç° ä¼šå‘ç°æ‰€æœ‰çš„endpoitnsç«¯ç‚¹ æˆ‘ä»¬åªéœ€è¦åŒ¹é…kubernetes-apiserver å…¶ä½™å…¨éƒ¨DROP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>regex</span><span class=p>:</span><span class=w> </span><span class=l>default;kubernetes;https</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li><a class=link href=https://kubernetes.io/zh-cn/docs/concepts/cluster-administration/system-metrics/ target=_blank rel=noopener>Kubernetesç³»ç»Ÿç»„ä»¶æŒ‡æ ‡</a></li><li>åº”ç”¨ä¸Šé¢é…ç½® å°±å®Œæˆäº†å¯¹Kubernetes APIServerçš„ç›‘æ§</li><li>å¦‚æœéœ€è¦ç›‘æ§å…¶ä»–ç³»ç»Ÿç»„ä»¶ æ¯”å¦‚ï¼škube-controller-managerã€kube-schedulerçš„è¯ éœ€è¦æ³¨æ„<ul><li>apiserverçš„serviceåœ¨defaultçš„namespaceä¸‹</li><li>è€Œå…¶ä½™ç»„ä»¶æœåŠ¡åœ¨kube-systemè¿™ä¸ªnamespaceä¸‹ å¦‚æœæˆ‘ä»¬æƒ³è¦ç›‘æ§è¿™äº›ç»„ä»¶ éœ€è¦æ‰‹åŠ¨åˆ›å»ºå•ç‹¬çš„Service å…¶ä¸­<ul><li>kube-scheduleçš„æŒ‡æ ‡æ•°æ®ç«¯å£ä¸º10251</li><li>kube-controller-managerå¯¹åº”çš„æŒ‡æ ‡æ•°æ®ç«¯å£ä¸º10252</li></ul></li></ul></li></ul><h4 id=serviceç›‘æ§>Serviceç›‘æ§</h4><ul><li>ä¸Šé¢çš„apiserviceå®é™…ä¸Šæ˜¯ä¸€ç§ç‰¹æ®Šçš„Service æˆ‘ä»¬å¯ä»¥é…ç½®ä¸€ä¸ªä»»åŠ¡æ¥ä¸“é—¨å‘ç°æ™®é€šç±»å‹çš„Service</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl>- <span class=nt>job_name</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;kubernetes-service-endpoints&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>kubernetes_sd_configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>role</span><span class=p>:</span><span class=w> </span><span class=l>endpoints</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>relabel_configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>source_labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>__meta_kubernetes_service_annotation_prometheus_io_scrape</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>keep</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>regex</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>source_labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>__meta_kubernetes_service_annotation_prometheus_io_scheme</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>replace</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>target_label</span><span class=p>:</span><span class=w> </span><span class=l>__scheme__</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>regex</span><span class=p>:</span><span class=w> </span><span class=l>(https?)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>source_labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>__meta_kubernetes_service_annotation_prometheus_io_path</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>replace</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>target_label</span><span class=p>:</span><span class=w> </span><span class=l>__metrics_path__</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>regex</span><span class=p>:</span><span class=w> </span><span class=l>(.+)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>source_labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>__address__</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>__meta_kubernetes_service_annotation_prometheus_io_port</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>replace</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>target_label</span><span class=p>:</span><span class=w> </span><span class=l>__address__</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>regex</span><span class=p>:</span><span class=w> </span><span class=l>([^:]+)(?::\d+)?;(\d+)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>replacement</span><span class=p>:</span><span class=w> </span><span class=l>$1:$2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>labelmap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>regex</span><span class=p>:</span><span class=w> </span><span class=l>__meta_kubernetes_service_label_(.+)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>source_labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>__meta_kubernetes_namespace</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>replace</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>target_label</span><span class=p>:</span><span class=w> </span><span class=l>kubernetes_namespace</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>source_labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>__meta_kubernetes_service_name</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>replace</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>target_label</span><span class=p>:</span><span class=w> </span><span class=l>kubernetes_name</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>éœ€è¦è¢«ç›‘æ§çš„æœåŠ¡ å¦‚æœæœ¬èº«å®ç°äº†<code>/metrics</code>æ¥å£ åˆ™å¯ä»¥æŒ‰ç…§ä¸‹é¢é…ç½®ä¿®æ”¹ä¸‹Serviceé…ç½®å³å¯è¿›è¡Œè‡ªåŠ¨å‘ç°</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>demoapp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>annotations</span><span class=p>:</span><span class=w>  </span><span class=c># åŠ ä¸Šä¸‹é¢çš„annotations åˆ™å¯ä»¥è¿›è¡Œè¯¥æœåŠ¡çš„è‡ªåŠ¨å‘ç°</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>prometheus.io/scrape</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;true&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>prometheus.io/port</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;80&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>demoapp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>TCP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=kube-state-metrics>kube-state-metrics</h4><ul><li><p>ä¸Šé¢æˆ‘ä»¬é…ç½®äº†è‡ªåŠ¨å‘ç°Service(Podä¹Ÿä¸€æ ·)çš„ç›‘æ§ ä½†æ˜¯è¿™äº›ç›‘æ§æ•°æ®éƒ½æ˜¯åº”ç”¨å†…éƒ¨çš„ç›‘æ§ éœ€è¦åº”ç”¨æœ¬èº«å†…ç½®<code>/metrics</code>æ¥å£ æˆ–è€…å¯¹åº”çš„<code>exporter</code>æ¥æš´éœ²å¯¹åº”çš„æŒ‡æ ‡æ•°æ®</p></li><li><p>ä½†æ˜¯ åœ¨Kubernetesé›†ç¾¤ä¸Šçš„Podã€DaemonSetã€Deploymentã€Jobã€Crontabç­‰å„ç§èµ„æºå¯¹è±¡çš„çŠ¶æ€ä¹Ÿéœ€è¦ç›‘æ§ è¿™ä¹Ÿååº”äº†ä½¿ç”¨è¿™äº›èµ„æºéƒ¨ç½²çš„åº”ç”¨çŠ¶æ€</p></li><li><p>å‰é¢ä»é›†ç¾¤æ‹‰å–çš„æŒ‡æ ‡(æ¥è‡ªapiserverå’Œkubeletä¸­é›†æˆçš„cAdvisor) å¹¶æ²¡æœ‰å…·ä½“çš„å„ç§èµ„æºå¯¹è±¡çš„çŠ¶æ€æŒ‡æ ‡</p></li><li><p>å¯¹äºPrometheusæ¥è¯´ å½“ç„¶æ˜¯éœ€è¦å¼•å…¥æ–°çš„exporteræ¥æš´éœ²è¿™äº›æŒ‡æ ‡ Kubernetesæä¾›äº†<a class=link href=https://github.com/kubernetes/kube-state-metrics target=_blank rel=noopener>kube-state-metrics</a>åˆ™å¯ä»¥å®ç°è¯¥ç›‘æ§éœ€æ±‚</p></li><li><p>å®‰è£…kube-state-metrics</p></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>git clone git@github.com:kubernetes/kube-state-metrics.git
</span></span><span class=line><span class=cl>kubectl apply -k examples/standard
</span></span></code></pre></td></tr></table></div></div><ul><li>ä¿®æ”¹serviceé…ç½® è‡ªåŠ¨ç›‘æ§æŒ‡æ ‡</li><li>ç›‘æ§æŒ‡æ ‡çš„ç›¸å…³æ–‡æ¡£ å‚è€ƒ<a class=link href="https://github.com/kubernetes/kube-state-metrics?tab=readme-ov-file#metrics-documentation" target=_blank rel=noopener>metics-documentation</a></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app.kubernetes.io/component</span><span class=p>:</span><span class=w> </span><span class=l>exporter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app.kubernetes.io/name</span><span class=p>:</span><span class=w> </span><span class=l>kube-state-metrics</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app.kubernetes.io/version</span><span class=p>:</span><span class=w> </span><span class=m>2.15.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>kube-state-metrics</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>kube-system</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># ä¿®æ”¹service åŠ ä¸Šè¯¥é…ç½®</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>annotations</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>prometheus.io/scrape</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;true&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>prometheus.io/port</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;8080&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>clusterIP</span><span class=p>:</span><span class=w> </span><span class=l>None</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>http-metrics</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=l>http-metrics</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>telemetry</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>8081</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=l>telemetry</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app.kubernetes.io/name</span><span class=p>:</span><span class=w> </span><span class=l>kube-state-metrics</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=grafanaçš„å®‰è£…ä½¿ç”¨>Grafanaçš„å®‰è£…ä½¿ç”¨</h3><ul><li>Prometheuså®˜æ–¹Dashboardå±•ç¤ºèƒ½åŠ›è¾ƒå¼± å±•ç¤ºæ¨èæ¥Grafana</li><li>å®‰è£…</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span><span class=lnt>90
</span><span class=lnt>91
</span><span class=lnt>92
</span><span class=lnt>93
</span><span class=lnt>94
</span><span class=lnt>95
</span><span class=lnt>96
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>grafana</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>kube-ops</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>grafana</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>revisionHistoryLimit</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>grafana</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>grafana</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>grafana</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>grafana/grafana:12.0.1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>IfNotPresent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>3000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>grafana</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>GF_SECURITY_ADMIN_USER</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=l>admin</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>GF_SECURITY_ADMIN_PASSWORD</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=l>admin9527</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>readinessProbe</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>failureThreshold</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>httpGet</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/api/health</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>3000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>scheme</span><span class=p>:</span><span class=w> </span><span class=l>HTTP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>initialDelaySeconds</span><span class=p>:</span><span class=w> </span><span class=m>60</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>periodSeconds</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>successThreshold</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>timeoutSeconds</span><span class=p>:</span><span class=w> </span><span class=m>30</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>livenessProbe</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>failureThreshold</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>httpGet</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/api/health</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>3000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>scheme</span><span class=p>:</span><span class=w> </span><span class=l>HTTP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>periodSeconds</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>successThreshold</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>timeoutSeconds</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>limits</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>100m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>256Mi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>100m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>256Mi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/var/lib/grafana</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>subPath</span><span class=p>:</span><span class=w> </span><span class=l>grafana</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>storage</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>securityContext</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>fsGroup</span><span class=p>:</span><span class=w> </span><span class=m>472</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>runAsUser</span><span class=p>:</span><span class=w> </span><span class=m>472</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>storage</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>persistentVolumeClaim</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>claimName</span><span class=p>:</span><span class=w> </span><span class=l>grafana</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>PersistentVolumeClaim</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>grafana</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>kube-ops</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>storageClassName</span><span class=p>:</span><span class=w> </span><span class=l>nfs-client</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>accessModes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>ReadWriteOnce</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>storage</span><span class=p>:</span><span class=w> </span><span class=l>1Gi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>grafana</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>kube-ops</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>grafana</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>NodePort</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>http</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>3000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=m>3000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>nodePort</span><span class=p>:</span><span class=w> </span><span class=m>30001</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>grafana</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>å¦‚æœç”±äºå·æƒé™é—®é¢˜ æ‰§è¡Œä¸‹é¢Jobä¿®æ”¹æƒé™å³å¯</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>batch/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Job</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>grafana-chown</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>kube-ops</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>restartPolicy</span><span class=p>:</span><span class=w> </span><span class=l>Never</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>grafana-chown</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;chown&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;-R&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;472:472&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;/var/lib/grafana&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>busybox</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>IfNotPresent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>storage</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>subPath</span><span class=p>:</span><span class=w> </span><span class=l>grafana</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/var/lib/grafana</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>storage</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>persistentVolumeClaim</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>claimName</span><span class=p>:</span><span class=w> </span><span class=l>grafana</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>åç»­å°±æ˜¯è¿›è¡ŒGrafanaçš„æ•°æ®æºåŠæ¨¡ç‰ˆé…ç½®ç­‰å·¥ä½œ</li></ul><h3 id=alertmanger>Alertmanger</h3><ul><li>å‡†å¤‡å‘Šè­¦åª’ä»‹ è¿™é‡Œä»¥dingding-webhooä¸ºä¾‹</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=l>git clone git@github.com:timonwong/prometheus-webhook-dingtalk.git</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>cd contrib/k8s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>kubectl apply -k .</span><span class=w> </span><span class=c># æ‰§è¡Œå‰ä¿®æ”¹ä¸ºè‡ªå·±çš„æµ‹è¯•é…ç½®</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>å‡†å¤‡alertmanageré…ç½®æ–‡ä»¶</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ConfigMap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>alertmanager-config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>kube-ops</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>config.yaml</span><span class=p>:</span><span class=w> </span><span class=p>|-</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    route:
</span></span></span><span class=line><span class=cl><span class=sd>      receiver: &#39;default&#39;
</span></span></span><span class=line><span class=cl><span class=sd>      group_wait: 30s
</span></span></span><span class=line><span class=cl><span class=sd>      group_interval: 5m
</span></span></span><span class=line><span class=cl><span class=sd>      repeat_interval: 30m
</span></span></span><span class=line><span class=cl><span class=sd>      group_by:
</span></span></span><span class=line><span class=cl><span class=sd>      - &#39;cluster&#39;
</span></span></span><span class=line><span class=cl><span class=sd>      - &#39;alertname&#39;
</span></span></span><span class=line><span class=cl><span class=sd>      routes:
</span></span></span><span class=line><span class=cl><span class=sd>      - receiver: &#39;test&#39;
</span></span></span><span class=line><span class=cl><span class=sd>        group_wait: 30s
</span></span></span><span class=line><span class=cl><span class=sd>        group_interval: 10m
</span></span></span><span class=line><span class=cl><span class=sd>        repeat_interval: 30m
</span></span></span><span class=line><span class=cl><span class=sd>        matchers:
</span></span></span><span class=line><span class=cl><span class=sd>        - severity=&#34;P0&#34;
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    receivers:
</span></span></span><span class=line><span class=cl><span class=sd>    - name: &#39;default&#39;
</span></span></span><span class=line><span class=cl><span class=sd>      webhook_configs:
</span></span></span><span class=line><span class=cl><span class=sd>      - url: &#39;http://alertmanager-webhook-dingtalk/dingtalk/webhook_mention_test/send&#39;
</span></span></span><span class=line><span class=cl><span class=sd>        send_resolved: false
</span></span></span><span class=line><span class=cl><span class=sd>    - name: &#39;test&#39;
</span></span></span><span class=line><span class=cl><span class=sd>      webhook_configs:
</span></span></span><span class=line><span class=cl><span class=sd>      - url: &#39;http://alertmanager-webhook-dingtalk/dingtalk/webhook_mention_test/send&#39;
</span></span></span><span class=line><span class=cl><span class=sd>        send_resolved: false
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    inhibit_rules:
</span></span></span><span class=line><span class=cl><span class=sd>    - source_matchers:
</span></span></span><span class=line><span class=cl><span class=sd>      - severity = &#39;P0&#39;
</span></span></span><span class=line><span class=cl><span class=sd>      target_matchers:
</span></span></span><span class=line><span class=cl><span class=sd>      - severity =~ &#39;P1|P2|P3|P4|P5&#39;
</span></span></span><span class=line><span class=cl><span class=sd>      equal:
</span></span></span><span class=line><span class=cl><span class=sd>      - &#39;alertname&#39;
</span></span></span><span class=line><span class=cl><span class=sd>      - &#39;instance&#39;
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    - source_matchers:
</span></span></span><span class=line><span class=cl><span class=sd>      - alertname = InstanceDown
</span></span></span><span class=line><span class=cl><span class=sd>      target_matchers:
</span></span></span><span class=line><span class=cl><span class=sd>      - job = node_exporter
</span></span></span><span class=line><span class=cl><span class=sd>      equal:
</span></span></span><span class=line><span class=cl><span class=sd>      - &#39;instance&#39;</span><span class=w>    
</span></span></span></code></pre></td></tr></table></div></div><ul><li>é…ç½®alertmanagerå®¹å™¨å¹¶å¯åŠ¨</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># ä¸ºäº†æ–¹ä¾¿ æˆ‘è¿™é‡Œç›´æ¥æŠŠalertmanagerå’Œprometheuséƒ¨ç½²åœ¨ä¸€èµ·</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>alertmanager</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>prom/alertmanager:v0.28.1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>IfNotPresent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- --<span class=l>config.file=/etc/alertmanager/config.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>9093</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>TCP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>http</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>alertmanager-config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/etc/alertmanager</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>100m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>512Mi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>limits</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>100m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>512Mi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>alertmanager-config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>configMap</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>alertmanager-config</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>åœ¨prometheusä¸­é…ç½®alertmanageråœ°å€</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># æ›´æ–°promtehusé…ç½®çš„configmap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>alerting</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>alertmanagers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>static_configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>targets</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>localhost:9093 </span><span class=w> </span><span class=c># åŒä¸€ä¸ªPod ç›´æ¥ä½¿ç”¨localhost</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>å‘Šè­¦æµ‹è¯•</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>rule_files</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>/etc/prometheus/rules.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># configmap æ–°å¢ä¸€ä¸ªé…ç½®é¡¹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>rules.yaml</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>  groups:
</span></span></span><span class=line><span class=cl><span class=sd>  - name: test-rules
</span></span></span><span class=line><span class=cl><span class=sd>    rules:
</span></span></span><span class=line><span class=cl><span class=sd>    - alert: NodeMemoryUsage
</span></span></span><span class=line><span class=cl><span class=sd>      expr: (node_memory_MemTotal_bytes - (node_memory_MemFree_bytes + node_memory_Buffers_bytes + node_memory_Cached_bytes)) / node_memory_MemTotal_bytes * 100 &gt; 20
</span></span></span><span class=line><span class=cl><span class=sd>      for: 2m
</span></span></span><span class=line><span class=cl><span class=sd>      labels:
</span></span></span><span class=line><span class=cl><span class=sd>        severity: P0
</span></span></span><span class=line><span class=cl><span class=sd>      annotations:
</span></span></span><span class=line><span class=cl><span class=sd>        summary: &#34;{{ $labels.instance }}: High Memory usage detected&#34;
</span></span></span><span class=line><span class=cl><span class=sd>        description: &#34;{{$labels.instance}}: Memory usage is above 20% (current value is: {{ $value }}&#34;</span><span class=w>  
</span></span></span></code></pre></td></tr></table></div></div><h3 id=prometheus-operator>Prometheus Operator</h3><ul><li>ç»è¿‡ä¸Šé¢æ‰‹åŠ¨ç¼–å†™Prometheusèµ„æºæ¸…å• æˆ‘ä»¬å®Œæˆäº†å¯¹Kubernetesç›¸å…³èµ„æºçš„ç›‘æ§ ä½†æ˜¯è¿˜æ˜¯æœ‰ä¸€äº›ç¼ºé™·</li><li>æ¯”å¦‚ï¼šPromtheusã€Alertmanagerç­‰ç»„ä»¶æœåŠ¡æœ¬èº«çš„é«˜å¯ç”¨ï¼›å½“ç„¶æˆ‘ä»¬å¯ä»¥è‡ªå·±å®ç°è¿™äº›éœ€æ±‚ æˆ‘ä»¬ä¹ŸçŸ¥é“Prometheusåœ¨ä»£ç ä¸Šå°±åŸç”Ÿæ”¯æŒKubernetes æˆ‘ä»¬å¯ä»¥é€šè¿‡æœåŠ¡å‘ç°çš„å½¢å¼æ¥è‡ªåŠ¨ç›‘æ§é›†ç¾¤</li><li>å› æ­¤ æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¦å¤–ä¸€ç§æ›´åŠ é«˜çº§çš„æ–¹å¼æ¥éƒ¨ç½²Prometheus: <a class=link href=https://github.com/prometheus-operator/prometheus-operator target=_blank rel=noopener>prometheus-operator</a></li></ul><h4 id=operatoræ¨¡å¼>Operatoræ¨¡å¼</h4><p>Operatorå‚è€ƒï¼š<a class=link href=https://kubernetes.io/zh-cn/docs/concepts/extend-kubernetes/operator/ target=_blank rel=noopener>Operatoræ¨¡å¼</a></p><h4 id=ä»‹ç»>ä»‹ç»</h4><p><img src=/p/kubernetes/icons/prometheus-operator.png width=1796 height=1046 srcset="/p/kubernetes/icons/prometheus-operator_hu52b81c9c1fbc13426c3a36dcc5039201_151171_480x0_resize_box_3.png 480w, /p/kubernetes/icons/prometheus-operator_hu52b81c9c1fbc13426c3a36dcc5039201_151171_1024x0_resize_box_3.png 1024w" loading=lazy alt=prometheus-operator-arch class=gallery-image data-flex-grow=171 data-flex-basis=412px></p><ul><li>ä¸Šå›¾æ˜¯<code>Prometheus-Operator</code>å®˜æ–¹æä¾›çš„æ¶æ„å›¾ å…¶ä¸­<code>Operator</code>æ˜¯æœ€æ ¸å¿ƒçš„éƒ¨åˆ†</li><li>ä½œä¸ºä¸€ä¸ªæ§åˆ¶å™¨ å®ƒå›å»åˆ›å»º<code>Prometheus</code>ã€<code>ServiceMonitor</code>ã€<code>Alertmanager</code>ä»¥åŠ<code>PrometheusRule</code>4ä¸ªCRDèµ„æºå¯¹è±¡ ç„¶åä¼šä¸€ç›´ç›‘æ§å¹¶ç»´æŒè¿™4ä¸ªèµ„æºå¯¹è±¡çš„çŠ¶æ€<ul><li><code>prometheus</code>èµ„æºå¯¹è±¡å°±æ˜¯ä½œä¸º<code>Prometheus Server</code>å­˜åœ¨</li><li><code>ServiceMonitor</code>å°±æ˜¯<code>exporter</code>çš„å„ç§æŠ½è±¡ <code>Prometheus</code>å°±æ˜¯é€šè¿‡<code>ServiceMonitor</code>æä¾›çš„<code>metrics</code>æ•°æ®æ¥å£å»pullæ•°æ®</li><li><code>alertmanager</code>èµ„æºå¯¹åº”<code>Alertmanager</code>çš„æŠ½è±¡</li><li><code>PrometheusRule</code>æ˜¯ç”¨æ¥è¢«<code>Prometheus</code>å®ä¾‹ä½¿ç”¨çš„æŠ¥è­¦è§„åˆ™æ–‡ä»¶</li></ul></li><li>è¿™æ · æˆ‘ä»¬è¦åœ¨é›†ç¾¤ä¸­ç›‘æ§ä»€ä¹ˆæ•°æ® å°±å˜æˆäº†ç›´æ¥å»æ“ä½œKubernetesé›†ç¾¤èµ„æºçš„å¯¹è±¡</li><li>ä¸Šå›¾ä¸­çš„Serviceå’ŒServiceMonitoréƒ½æ˜¯Kubernetesçš„èµ„æº ä¸€ä¸ªServiceMonitrorå¯ä»¥é€šè¿‡labelSelectorçš„æ–¹å¼å»åŒ¹é…ä¸€ç±»Service</li><li>Prometheusä¹Ÿå¯ä»¥é€šè¿‡labelSelectorçš„å‘æ–¹å¼å»åŒ¹é…å¤šä¸ªServiceMonitor</li></ul><h4 id=é€šè¿‡prometheus-operatorå®‰è£…>é€šè¿‡prometheus-operatorå®‰è£…</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>git clone git@github.com:prometheus-operator/prometheus-operator.git
</span></span><span class=line><span class=cl>kubectl create namespace monitoring
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># åœ¨æŒ‡å®šnamespaceå®‰è£…</span>
</span></span><span class=line><span class=cl>$ <span class=nv>NAMESPACE</span><span class=o>=</span>monitoring kustomize edit <span class=nb>set</span> namespace <span class=nv>$NAMESPACE</span> <span class=o>&amp;&amp;</span> kubectl create -k .
</span></span><span class=line><span class=cl>customresourcedefinition.apiextensions.k8s.io/alertmanagerconfigs.monitoring.coreos.com created
</span></span><span class=line><span class=cl>customresourcedefinition.apiextensions.k8s.io/alertmanagers.monitoring.coreos.com created
</span></span><span class=line><span class=cl>customresourcedefinition.apiextensions.k8s.io/podmonitors.monitoring.coreos.com created
</span></span><span class=line><span class=cl>customresourcedefinition.apiextensions.k8s.io/probes.monitoring.coreos.com created
</span></span><span class=line><span class=cl>customresourcedefinition.apiextensions.k8s.io/prometheusagents.monitoring.coreos.com created
</span></span><span class=line><span class=cl>customresourcedefinition.apiextensions.k8s.io/prometheuses.monitoring.coreos.com created
</span></span><span class=line><span class=cl>customresourcedefinition.apiextensions.k8s.io/prometheusrules.monitoring.coreos.com created
</span></span><span class=line><span class=cl>customresourcedefinition.apiextensions.k8s.io/scrapeconfigs.monitoring.coreos.com created
</span></span><span class=line><span class=cl>customresourcedefinition.apiextensions.k8s.io/servicemonitors.monitoring.coreos.com created
</span></span><span class=line><span class=cl>customresourcedefinition.apiextensions.k8s.io/thanosrulers.monitoring.coreos.com created
</span></span><span class=line><span class=cl>serviceaccount/prometheus-operator created
</span></span><span class=line><span class=cl>clusterrole.rbac.authorization.k8s.io/prometheus-operator created
</span></span><span class=line><span class=cl>clusterrolebinding.rbac.authorization.k8s.io/prometheus-operator created
</span></span><span class=line><span class=cl>service/prometheus-operator created
</span></span><span class=line><span class=cl>deployment.apps/prometheus-operator created
</span></span></code></pre></td></tr></table></div></div><ul><li>PrometheusOperatoré€šè¿‡Deploymentçš„å½¢å¼è¿›è¡Œéƒ¨ç½²</li><li>ä¸ºäº†èƒ½å¤Ÿè®©PrometheusOperatorèƒ½å¤Ÿç›‘å¬å’Œç®¡ç†Kubernetesèµ„æº åŒæ—¶ä¹Ÿåˆ›å»ºäº†å•ç‹¬çš„ServiceAccountä»¥åŠç›¸å…³æˆæƒ</li></ul><h5 id=ä½¿ç”¨operatorç®¡ç†prometheus>ä½¿ç”¨Operatorç®¡ç†Prometheus</h5><h6 id=éƒ¨ç½²prometheuså®ä¾‹>éƒ¨ç½²Prometheuså®ä¾‹</h6><ul><li>å½“é›†ç¾¤ä¸­å·²ç»å®‰è£…ProemtheusOperatorä¹‹å å¯¹äºéƒ¨ç½²PromtheusServerå®ä¾‹å˜æˆäº†å£°æ˜ä¸€ä¸ªPrometheusèµ„æº</li><li>å¦‚ä¸‹æ‰€ç¤º æˆ‘ä»¬åœ¨monitoringåç§°ç©ºé—´ä¸‹åˆ›å»ºäº†ä¸€ä¸ªPrometheuså®ä¾‹</li><li>è®¿é—®: <code>kubectl port-forward statefulsets.apps/prometheus-inst 9090:9090</code></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>monitoring.coreos.com/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>inst</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>monitoring</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>400Mi</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h6 id=éƒ¨ç½²servicemonitorå®ä¾‹>éƒ¨ç½²ServiceMonitorå®ä¾‹</h6><ul><li>è®©éƒ¨ç½²çš„Prometheusèƒ½å¤Ÿé‡‡é›†éƒ¨ç½²åœ¨Kubernetesä¸‹åº”ç”¨çš„ç›‘æ§æ•°æ®<ul><li>åœ¨åŸç”Ÿçš„Prometheusé…ç½®æ–¹å¼ä¸­ æˆ‘ä»¬åœ¨Prometheusé…ç½®æ–‡ä»¶ä¸­å®šä¹‰å•ç‹¬çš„Job åŒæ—¶ä½¿ç”¨<code>kubernetes_sd</code>å®šä¹‰æœåŠ¡çš„è‡ªåŠ¨å‘ç°</li><li>åœ¨PrometheusOperatorä¸­ åˆ™å¯ä»¥ç›´æ¥å£°æ˜ä¸€ä¸ª<code>ServiceMonitor</code>å¯¹è±¡</li></ul></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>monitoring.coreos.com/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ServiceMonitor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>demoapp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>monitoring</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>env</span><span class=p>:</span><span class=w> </span><span class=l>testing</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespaceSelector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchNames</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLables</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>demoapp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>endpoints</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=l>web  </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># å¦‚æœtargetå¯ç”¨äº†ç›‘æ§BasicAuthè®¤è¯ å®šä¹‰ServiceMonitorå¯¹è±¡æ—¶ éœ€è¦åœ¨endpointsé…ç½®ä¸­å®šä¹‰basicAuth</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>basicAuth</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>password</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>basic-auth</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>password</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>username</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>basic-auth</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>user</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># å…¶ä¸­ basicAuth ä¸­å…³è”åä¸º basic-authä¸ºSecretå¯¹è±¡ éœ€è¦ç”¨æˆ·æ‰‹åŠ¨å°†è®¤è¯ä¿¡æ¯ä¿å­˜åˆ°Secretä¸­</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>APIVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Secret</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>basic-auth</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># base64ç¼–ç åçš„å€¼</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=l>alsdhabdn==</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>user</span><span class=p>:</span><span class=w> </span><span class=l>Jadquhwe==</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Opaque</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h6 id=å…³è”prometheusä¸servicemonitor>å…³è”Prometheusä¸ServiceMonitor</h6><ul><li>Promtheusä¸ServiceMonitorä¹‹é—´çš„å…³è”å…³ç³»ä½¿ç”¨<code>servicMonitorSelector</code>å®šä¹‰ åœ¨Prometheusä¸­é€šè¿‡æ ‡ç­¾é€‰æ‹©å½“å‰éœ€è¦ç›‘æ§çš„ServiceMonitorå¯¹è±¡</li><li>ä¸ºäº†èƒ½å¤Ÿè®©Prometheuså…³è”åˆ°ServiceMonitor éœ€è¦åœ¨Promehteuså®šä¹‰ä¸­ä½¿ç”¨serviceMonitorSelector æˆ‘ä»¬å¯ä»¥é€šè¿‡æ ‡ç­¾é€‰æ‹©å½“å‰Prometheuséœ€è¦ç›‘æ§çš„ServiceMonitorå¯¹è±¡</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># æ›´æ–°promteheus crdèµ„æºæ¸…å•</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>monitoring.coreos.com/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>inst</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>monitoring</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>serviceMonitorSelector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>env</span><span class=p>:</span><span class=w> </span><span class=l>testing</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>400Mi</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>æ›´æ–°ä¸Šé¢é…ç½®é…ç½®å webç•Œé¢å¯ä»¥çœ‹åˆ°Jobé…ç½® ä½†æ˜¯Prometheusçš„Targetä¸­å¹¶æ²¡æœ‰åŒ…å«ä»»ä½•çš„ç›‘æ§å¯¹è±¡ æ­¤æ—¶Promtheus Podæœ‰æŠ¥é”™æ—¥å¿—</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>time</span><span class=o>=</span>2025-06-09T16:29:10.559Z <span class=nv>level</span><span class=o>=</span>ERROR <span class=nv>source</span><span class=o>=</span>reflector.go:166 <span class=nv>msg</span><span class=o>=</span><span class=s2>&#34;Unhandled Error&#34;</span> <span class=nv>component</span><span class=o>=</span>k8s_client_runtime <span class=nv>logger</span><span class=o>=</span>UnhandledError <span class=nv>err</span><span class=o>=</span><span class=s2>&#34;pkg/mod/k8s.io/client-go@v0.32.3/tools/cache/reflector.go:251: Failed to watch *v1.Service: failed to list *v1.Service: services is forbidden: User \&#34;system:serviceaccount:monitoring:default\&#34; cannot list resource \&#34;services\&#34; in API group \&#34;\&#34; in the namespace \&#34;default\&#34;&#34;</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>è¿™æ˜¯å› ä¸ºæˆ‘ä»¬é»˜è®¤åˆ›å»ºçš„å®ä¾‹ä½¿ç”¨çš„æ˜¯monitoringå‘½åç©ºé—´ä¸‹çš„defaultè´¦å· è¯¥è´¦å·å¹¶æ²¡æœ‰æƒé™èƒ½å¤Ÿè·å–defaultå‘½åç©ºé—´ä¸‹çš„ä»»ä½•èµ„æºä¿¡æ¯</li><li>ä¿®å¤è¯¥é—®é¢˜ æˆ‘ä»¬éœ€è¦åœ¨monitoringçš„å‘½åç©ºé—´å¸¸è§ä¸€ä¸ªæ–°çš„ServiceAccountè´¦å· å¹¶ä¸”ä¸ºè¯¥è´¦å·èµ‹äºˆç›¸åº”çš„é›†ç¾¤è®¿é—®æƒé™</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl get pods prometheus-inst-0 -o yaml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># é»˜è®¤ä½¿ç”¨çš„serviceAccount</span>
</span></span><span class=line><span class=cl>serviceAccount: default
</span></span><span class=line><span class=cl>serviceAccountName: default
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># åˆ›å»ºæ–°çš„å…·æœ‰ç›¸å…³æƒé™çš„ServiceAccount</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ServiceAccount</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>monitoring</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRole</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>apiGroups</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>nodes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>services</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>endpoints</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>pods</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>verbs</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;get&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;list&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;watch&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>apiGroups</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>configmaps</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>verbs</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;get&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>nonResourceURLs</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;/metrics&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>verbs</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;get&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRoleBinding</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>roleRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRole</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>subjects</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ServiceAccount</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>monitoring</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># åº”ç”¨ä¸Šé¢èµ„æºæ¸…å•ä¹‹å ä¿®æ”¹prometheuså®ä¾‹çš„èµ„æºæ¸…å• ä½¿ç”¨æ–°çš„ServiceAccount</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>monitoring.coreos.com/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>inst</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>monitoring</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>serviceAccountName</span><span class=p>:</span><span class=w> </span><span class=l>prometheus </span><span class=w> </span><span class=c># æ›´æ–°serviceAccount</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>serviceMonitorSelector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>env</span><span class=p>:</span><span class=w> </span><span class=l>testing</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>400Mi</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=ä½¿ç”¨operatorç®¡ç†ç›‘æ§é…ç½®>ä½¿ç”¨Operatorç®¡ç†ç›‘æ§é…ç½®</h5><h6 id=ä½¿ç”¨prometheusruleå®šä¹‰å‘Šè­¦è§„åˆ™>ä½¿ç”¨PrometheusRuleå®šä¹‰å‘Šè­¦è§„åˆ™</h6><ul><li>å¯¹äºPrometheusè€Œè¨€ åœ¨åŸç”Ÿçš„ç®¡ç†æ–¹å¼ä¸Š æˆ‘ä»¬éœ€è¦æ‰‹åŠ¨åˆ›å»ºPrometheusçš„å‘Šè­¦æ–‡ä»¶ å¹¶ä¸”é€šè¿‡åœ¨Prometheusé…ç½®ä¸­å£°æ˜å¼åŠ è½½</li><li>è€Œåœ¨PrometheusOperatorçš„æ¨¡å¼ä¸­ å‘Šè­¦è§„åˆ™é€šè¿‡å®šä¹‰å£°æ˜å¼é…ç½®åˆ›å»ºä¸€ä¸ª<code>PrometheusRule</code>èµ„æº</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>monitoring.coreos.com/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>PrometheusRule</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>prometheus</span><span class=p>:</span><span class=w> </span><span class=l>demoapp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>role</span><span class=p>:</span><span class=w> </span><span class=l>alert-rules</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>prometheus-demoapp-rules</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>groups</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>./demoapp.rules</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>alert</span><span class=p>:</span><span class=w> </span><span class=l>DemoappAlert</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>expr</span><span class=p>:</span><span class=w> </span><span class=l>demoapp_http_requests_total{handler=&#34;/metrics&#34;} &gt; 1</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>åˆ›å»º<code>PrometheusRule</code>èµ„æºå é€šè¿‡åœ¨Promtheusä¸­ä½¿ç”¨<code>ruleSelector</code>é€šè¿‡æ ‡ç­¾é€‰æ‹©éœ€è¦å…³è”çš„PrometheusRuleå³å¯</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>monitoring.coreos.com/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>inst</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>monitoring</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>serviceAccountName</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>serviceMonitorSelector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>env</span><span class=p>:</span><span class=w> </span><span class=l>testing</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ruleSelector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>role</span><span class=p>:</span><span class=w> </span><span class=l>alert-rules</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>prometheus</span><span class=p>:</span><span class=w> </span><span class=l>demoapp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>400Mi</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h6 id=ä½¿ç”¨operatorç®¡ç†alertmangerå®ä¾‹>ä½¿ç”¨Operatorç®¡ç†Alertmangerå®ä¾‹</h6><ul><li>åˆ°ç›®å‰ä¸ºæ­¢ æˆ‘ä»¬å·²ç»é€šè¿‡PrometheusOperatorçš„è‡ªå®šä¹‰èµ„æºç±»å‹ç®¡ç†äº†Prometheuså®ä¾‹ ç›‘æ§é…ç½®ä»¥åŠå‘Šè­¦è§„åˆ™ç­‰èµ„æº</li><li>é€šè¿‡PrometheusOperatorå°†åŸæœ¬æ‰‹åŠ¨ç®¡ç†çš„å·¥ä½œ å…¨éƒ¨å˜æˆäº†å£°æ˜å¼çš„ç®¡ç†æ¨¡å¼ æå¤§ç®€åŒ–äº†Kubernetesä¸‹Prometheusè¿ç»´ç®¡ç†çš„å¤æ‚åº¦</li><li>æˆ‘ä»¬ç»§ç»­ä½¿ç”¨Operatorå®šä¹‰å’Œç®¡ç†Alertmanagerç›¸å…³çš„å†…å®¹</li><li>åˆ›å»ºAlertmangerèµ„æºæ¸…å•<ul><li>é€šè¿‡replicaså¯ä»¥æ§åˆ¶Alertmanagerçš„å®ä¾‹æ•°</li><li>å½“replicaså¤§äº1æ—¶ PrometheusOperatorä¼šè‡ªåŠ¨é€šè¿‡<strong>é›†ç¾¤</strong>çš„æ–¹å¼åˆ›å»ºAlertmaager</li></ul></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>monitoring.coreos.com/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Alertmanager</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>inst</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>monitoring</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>ä¿®æ”¹Prometheusèµ„æºå®šä¹‰ é…ç½®<code>alerting</code>æŒ‡å®šä½¿ç”¨çš„Alertmanagerèµ„æºå³å¯</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>monitoring.coreos.com/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>inst</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>monitoring</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>serviceAccountName</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>serviceMonitorSelector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>env</span><span class=p>:</span><span class=w> </span><span class=l>testing</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ruleSelector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>role</span><span class=p>:</span><span class=w> </span><span class=l>alert-rules</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>prometheus</span><span class=p>:</span><span class=w> </span><span class=l>demoapp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>alerting</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>alertmanagers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>alertmanager-example</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>monitoring</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=l>web</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>400Mi</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>ç­‰å¾…Prometheusé‡æ–°åŠ è½½å æˆ‘ä»¬å¯ä»¥çœ‹åˆ°PrometheusOperatoråœ¨é…ç½®æ–‡ä»¶ä¸­æ·»åŠ äº†å¦‚ä¸‹é…ç½® é€šè¿‡æœåŠ¡å‘ç°è§„åˆ™ å°†Prometheusä¸Alertmanagerè‡ªåŠ¨å…³è”</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>alerting</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>alert_relabel_configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>separator</span><span class=p>:</span><span class=w> </span><span class=l>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>regex</span><span class=p>:</span><span class=w> </span><span class=l>prometheus_replica</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>replacement</span><span class=p>:</span><span class=w> </span><span class=l>$1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>labeldrop</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>alertmanagers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>follow_redirects</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>enable_http2</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>scheme</span><span class=p>:</span><span class=w> </span><span class=l>http</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>path_prefix</span><span class=p>:</span><span class=w> </span><span class=l>/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>timeout</span><span class=p>:</span><span class=w> </span><span class=l>10s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>api_version</span><span class=p>:</span><span class=w> </span><span class=l>v2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>relabel_configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>source_labels</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>__meta_kubernetes_service_name]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>separator</span><span class=p>:</span><span class=w> </span><span class=l>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>regex</span><span class=p>:</span><span class=w> </span><span class=l>alertmanager-example</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>replacement</span><span class=p>:</span><span class=w> </span><span class=l>$1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>keep</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>source_labels</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>__meta_kubernetes_endpoint_port_name]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>separator</span><span class=p>:</span><span class=w> </span><span class=l>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>regex</span><span class=p>:</span><span class=w> </span><span class=l>web</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>replacement</span><span class=p>:</span><span class=w> </span><span class=l>$1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>keep</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>kubernetes_sd_configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>role</span><span class=p>:</span><span class=w> </span><span class=l>endpoints</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>kubeconfig_file</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>follow_redirects</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>enable_http2</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>namespaces</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>own_namespace</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>names</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>monitoring</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=åœ¨prometheusoperatorä¸­ä½¿ç”¨è‡ªå®šä¹‰é…ç½®>åœ¨PrometheusOperatorä¸­ä½¿ç”¨è‡ªå®šä¹‰é…ç½®</h5><ul><li>åœ¨PrometheusOperatorä¸­ æˆ‘ä»¬é€šè¿‡å£°æ˜å¼åˆ›å»ºPrometheusã€ServiceMonitorç­‰è‡ªå®šä¹‰çš„èµ„æºç±»å‹æ¥è‡ªåŠ¨åŒ–éƒ¨ç½²å’Œç®¡ç†Promtehuesçš„ç›¸å…³ç»„ä»¶åŠé…ç½®</li><li>è€Œåœ¨ä¸€äº›ç‰¹æ®Šçš„æƒ…å†µä¸‹ å¯èƒ½è¿˜æ˜¯å¸Œæœ›èƒ½å¤Ÿæ‰‹åŠ¨ç®¡ç†Prometheusé…ç½®æ–‡ä»¶ è€Œéé€šè¿‡PrometheusOperatorè‡ªåŠ¨å®Œæˆ</li><li>ä¸ºä»€ä¹ˆ? å®é™…ä¸ŠPrometheusOperatorå¯¹äºJobçš„é…ç½®åªé€‚ç”¨äºåœ¨Kubernetesä¸­éƒ¨ç½²å’Œç®¡ç†çš„åº”ç”¨ç¨‹åº å¦‚æœä½ å¸Œæœ›ä½¿ç”¨Prometheusç›‘æ§ä¸€äº›å…¶ä»–çš„èµ„æº ä¾‹å¦‚ AWSæˆ–å…¶ä»–å¹³å°ä¸­çš„åŸºç¡€è®¾æ–½æˆ–åº”ç”¨ è¿™äº›å¹¶ä¸åœ¨PrometheusOperatorçš„èƒ½åŠ›èŒƒå›´ä¹‹å†…</li><li>ä¸ºäº†èƒ½å¤Ÿåœ¨é€šè¿‡PrometheusOperatoråˆ›å»ºçš„Prometheuså®ä¾‹ä¸­ä½¿ç”¨è‡ªå®šä¹‰é…ç½®æ–‡ä»¶ æˆ‘ä»¬åªèƒ½åˆ›å»ºä¸€ä¸ªä¸åŒ…å«ä»»ä½•ä¸é…ç½®æ–‡ä»¶å†…å®¹ç›¸å…³çš„Prometheuså®ä¾‹</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>monitoring.coreos.com/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>inst-cc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>monitoring</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>serviceAccountName</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>400Mi</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>å¦‚æœæŸ¥çœ‹æ–°å»ºçš„Prometheusçš„Podå®ä¾‹çš„YAMLå®šä¹‰ æˆ‘ä»¬å¯ä»¥çœ‹åˆ°Podä¸­ä¼šåŒ…å«ä¸€ä¸ªvolumeé…ç½®</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=w>  </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>secret</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>defaultMode</span><span class=p>:</span><span class=w> </span><span class=m>420</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>secretName</span><span class=p>:</span><span class=w> </span><span class=l>prometheus-inst-cc</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>Prometheusçš„é…ç½®æ–‡ä»¶å®ä¾‹ä¸Šæ˜¯ä¿å­˜åœ¨åä¸º<code>prometheus-&lt;name-of-prometheus-object></code>çš„Secretä¸­</li><li>å½“ç”¨æˆ·åˆ›å»ºçš„Prometheusä¸­å…³è”ServiceMonitorè¿™ç±»ä¼šå½±å“é…ç½®æ–‡ä»¶å†…å®¹çš„å®šä¹‰æ—¶ PromtheusOperatorä¼šè‡ªåŠ¨ç®¡ç†</li><li>è€Œå¦‚æœPrometheuså®šä¹‰ä¸­ä¸åŒ…å«ä»»ä½•ä¸é…ç½®æœ‰å…³çš„å®šä¹‰ é‚£ä¹ˆSecretçš„ç®¡ç†æƒé™å°±è½åˆ°ç”¨æˆ·è‡ªå·±æ‰‹ä¸­</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># ä½¿ç”¨è¯¥é…ç½®æ›´æ–°secretè§‚å¯Ÿæ–°å»ºPrometheuså®ä¾‹çš„é…ç½®å˜åŒ–</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># kubectl edit secret prometheus-inst-cc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>global</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>scrape_interval</span><span class=p>:</span><span class=w> </span><span class=l>10s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>scrape_timeout</span><span class=p>:</span><span class=w> </span><span class=l>10s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>evaluation_interval</span><span class=p>:</span><span class=w> </span><span class=l>10s</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=é€šè¿‡kube-prometheuså®‰è£…>é€šè¿‡kube-prometheuså®‰è£…</h4><p><a class=link href=https://prometheus-operator.dev/docs/getting-started/installation/ target=_blank rel=noopener>Install using Kube-Prometheus</a></p><h5 id=å®‰è£…>å®‰è£…</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>git clone git@github.com:prometheus-operator/kube-prometheus.git
</span></span><span class=line><span class=cl>kubectl create -f manifests/setup -f manifest  <span class=c1># ä¸æ­¢åŒ…å«æˆ‘ä»¬ä¸Šé¢æ‰‹åŠ¨åˆ›å»ºçš„ç›¸å…³èµ„æº</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># æŸ¥çœ‹éƒ¨ç½²çš„Pod</span>
</span></span><span class=line><span class=cl><span class=c1># kubectl get pods -n monitoring</span>
</span></span><span class=line><span class=cl>NAME                                   READY   STATUS    RESTARTS   AGE
</span></span><span class=line><span class=cl>alertmanager-main-0                    2/2     Running   <span class=m>0</span>          2d23h
</span></span><span class=line><span class=cl>alertmanager-main-1                    2/2     Running   <span class=m>0</span>          2d23h
</span></span><span class=line><span class=cl>alertmanager-main-2                    2/2     Running   <span class=m>0</span>          2d23h
</span></span><span class=line><span class=cl>blackbox-exporter-75c7985cb8-dq9vp     3/3     Running   <span class=m>0</span>          2d23h
</span></span><span class=line><span class=cl>grafana-664dd67585-wxrsp               1/1     Running   <span class=m>0</span>          2d23h
</span></span><span class=line><span class=cl>kube-state-metrics-75df9b9544-j9l7t    3/3     Running   <span class=m>0</span>          2d23h
</span></span><span class=line><span class=cl>node-exporter-9cflz                    2/2     Running   <span class=m>0</span>          2d23h
</span></span><span class=line><span class=cl>node-exporter-d9zkn                    2/2     Running   <span class=m>0</span>          2d23h
</span></span><span class=line><span class=cl>node-exporter-fh7sx                    2/2     Running   <span class=m>0</span>          2d23h
</span></span><span class=line><span class=cl>node-exporter-zxswn                    2/2     Running   <span class=m>0</span>          2d23h
</span></span><span class=line><span class=cl>prometheus-adapter-84c549f6b4-mwj8h    1/1     Running   <span class=m>0</span>          2d23h
</span></span><span class=line><span class=cl>prometheus-adapter-84c549f6b4-tg2sv    1/1     Running   <span class=m>0</span>          2d23h
</span></span><span class=line><span class=cl>prometheus-k8s-0                       2/2     Running   <span class=m>0</span>          2d23h
</span></span><span class=line><span class=cl>prometheus-k8s-1                       2/2     Running   <span class=m>0</span>          2d23h
</span></span><span class=line><span class=cl>prometheus-operator-6f9479b5f5-8r6sn   2/2     Running   <span class=m>0</span>          2d23h
</span></span></code></pre></td></tr></table></div></div><ul><li>ä»”ç»†è§‚å¯Ÿæˆ‘ä»¬å‘ç°<code>kube-scheduler</code> <code>kube-controller-manager</code>ä¸¤ä¸ªæœåŠ¡å®šä¹‰äº†ServiceMonior ä½†æ˜¯æ²¡æœ‰ç®¡ç†åˆ°å¯¹åº”çš„ç›‘æ§ç›®æ ‡</li><li>é˜…è¯»ServiceMonitorçš„å®šä¹‰ æˆ‘ä»¬å‘ç°åŸå› æ˜¯æˆ‘ä»¬ç³»ç»Ÿä¸­æ ¹æœ¬å°±æ²¡æœ‰å¯¹åº”çš„Service æˆ‘ä»¬æ‰‹åŠ¨åˆ›å»ºå³å¯</li><li>æœåŠ¡ç«¯å£å‚è€ƒ: <a class=link href=https://kubernetes.io/zh-cn/docs/reference/networking/ports-and-protocols/ target=_blank rel=noopener>ports-and-protocols</a></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># serviceMonitorå®šä¹‰</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># kube-controller-manager</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>monitoring.coreos.com/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ServiceMonitor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app.kubernetes.io/name</span><span class=p>:</span><span class=w> </span><span class=l>kube-controller-manager</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app.kubernetes.io/part-of</span><span class=p>:</span><span class=w> </span><span class=l>kube-prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>kube-controller-manager</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>monitoring</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>endpoints</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>jobLabel</span><span class=p>:</span><span class=w> </span><span class=l>app.kubernetes.io/name</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespaceSelector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchNames</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>kube-system</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app.kubernetes.io/name</span><span class=p>:</span><span class=w> </span><span class=l>kube-controller-manager</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># kube-scheduler</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>monitoring.coreos.com/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ServiceMonitor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app.kubernetes.io/name</span><span class=p>:</span><span class=w> </span><span class=l>kube-scheduler</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app.kubernetes.io/part-of</span><span class=p>:</span><span class=w> </span><span class=l>kube-prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>kube-scheduler</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>monitoring</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>endpoints</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>jobLabel</span><span class=p>:</span><span class=w> </span><span class=l>app.kubernetes.io/name</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespaceSelector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchNames</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>kube-system</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app.kubernetes.io/name</span><span class=p>:</span><span class=w> </span><span class=l>kube-scheduler</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>æ ¹æ®serviceMonitorå®šä¹‰ åˆ›å»ºå…·æœ‰å¯¹åº”æ ‡ç­¾çš„Serviceèµ„æº</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># é™¤äº†åˆ›å»ºService è¿˜éœ€è¦ä¿®æ”¹æœåŠ¡çš„é»˜è®¤ç›‘å¬åœ°å€ é»˜è®¤ç»‘å®š127.0.0.1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># ä¿®æ”¹: --address=127.0.0.1 -&gt; --address=0.0.0.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># kube-controller-manager</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>kube-system</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>kube-controller-manager</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app.kubernetes.io/name</span><span class=p>:</span><span class=w> </span><span class=l>kube-controller-manager</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>component</span><span class=p>:</span><span class=w> </span><span class=l>kube-controller-manager</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>https-metrics</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>10257</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=m>10257</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>TCP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># kube-scheduler</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>kube-system</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>kube-scheduler</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app.kubernetes.io/name</span><span class=p>:</span><span class=w> </span><span class=l>kube-scheduler</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>component</span><span class=p>:</span><span class=w> </span><span class=l>kube-scheduler</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>https-metrics</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>10259</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=m>10259</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>TCP</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=prometheusoperatoré«˜çº§é…ç½®>PrometheusOperatoré«˜çº§é…ç½®</h5><ul><li>ç»å¸¸ä¸Šé¢æ“ä½œä¹‹å è‡ªå¸¦ç»„ä»¶çš„ç›¸å…³ç›‘æ§éƒ½å…¨éƒ¨é…ç½®å®Œæˆ ä½†æ˜¯ å¦‚æœæˆ‘ä»¬é›†ç¾¤ä¸­æœ‰å¾ˆå¤šçš„Service/Pod æˆ‘ä»¬å°±éœ€è¦ä¸€ä¸ªä¸ªåˆ›å»ºå¯¹åº”çš„ServiceMonitorå¯¹è±¡ä¹ˆ</li><li>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ PrometheusOperatorä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ä¸ªé¢å¤–çš„æŠ“å–é…ç½®æ¥è§£å†³è¿™ä¸ªé—®é¢˜ æˆ‘ä»¬å¯ä»¥é€šè¿‡æ·»åŠ é¢å¤–çš„é…ç½®æ¥è¿›è¡ŒæœåŠ¡å‘ç°è¿›è¡Œè‡ªåŠ¨ç›‘æ§</li><li>å’Œä¹‹å‰è‡ªå®šä¹‰çš„æ–¹å¼å‘¢ä¸€æ · æˆ‘ä»¬æƒ³è¦åœ¨PrometheusOperatorä¸­å»è‡ªåŠ¨å‘ç°å…·æœ‰<code>prometheus.io/scrape=true</code>è¿™ä¸ªannotationsçš„Service ä¹‹å‰æˆ‘ä»¬å®šä¹‰çš„Prometheusé…ç½®å¦‚ä¸‹</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl>- <span class=nt>job_name</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;kubernetes-service-endpoints&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>kubernetes_sd_configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>role</span><span class=p>:</span><span class=w> </span><span class=l>endpoints</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>relabel_configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>source_labels</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>__meta_kubernetes_service_annotation_prometheus_io_scrape]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>keep</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>regex</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>source_labels</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>__meta_kubernetes_service_annotation_prometheus_io_scheme]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>replace</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>target_label</span><span class=p>:</span><span class=w> </span><span class=l>__scheme__</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>regex</span><span class=p>:</span><span class=w> </span><span class=l>(https?)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>source_labels</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>__meta_kubernetes_service_annotation_prometheus_io_path]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>replace</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>target_label</span><span class=p>:</span><span class=w> </span><span class=l>__metrics_path__</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>regex</span><span class=p>:</span><span class=w> </span><span class=l>(.+)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>source_labels</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>__address__, __meta_kubernetes_service_annotation_prometheus_io_port]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>replace</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>target_label</span><span class=p>:</span><span class=w> </span><span class=l>__address__</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>regex</span><span class=p>:</span><span class=w> </span><span class=l>([^:]+)(?::\d+)?;(\d+)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>replacement</span><span class=p>:</span><span class=w> </span><span class=l>$1:$2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>labelmap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>regex</span><span class=p>:</span><span class=w> </span><span class=l>__meta_kubernetes_service_label_(.+)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>source_labels</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>__meta_kubernetes_namespace]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>replace</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>target_label</span><span class=p>:</span><span class=w> </span><span class=l>namespace</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>source_labels</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>__meta_kubernetes_service_name]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>replace</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>target_label</span><span class=p>:</span><span class=w> </span><span class=l>service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># å·²ç”±ServiceMonitorç›‘æ§</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>source_labels</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>__meta_kubernetes_service_name]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>drop</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>regex</span><span class=p>:</span><span class=w> </span><span class=l>kube-dns</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span></code></pre></td></tr></table></div></div><ul><li>è¦æƒ³è‡ªåŠ¨å‘ç°é›†ç¾¤ä¸­çš„Service å°±éœ€è¦æˆ‘ä»¬åœ¨Serviceçš„annotationåŒºåŸŸæ·»åŠ <code>prometheus.io/scrape=true</code>çš„å£°æ˜</li><li>å°†ä¸Šé¢çš„æ–‡ä»¶ä¿å­˜ä¸ºprometheus-additional.yaml ç„¶åé€šè¿‡è¿™ä¸ªæ–‡ä»¶åˆ›å»ºä¸€ä¸ªå¯¹åº”çš„Secretå¯¹è±¡</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl create secret generic additional-configs --from-file<span class=o>=</span>manifests/prometheus-additional.yaml
</span></span><span class=line><span class=cl>secret/additional-configs created
</span></span></code></pre></td></tr></table></div></div><ul><li>åˆ›å»ºå®Œæˆå ä¼šå°†ä¸Šé¢é…ç½®ä¿¡æ¯è¿›è¡Œbase64ç¼–ç åä½œä¸ºprometheus-additional.yamlè¿™ä¸ªkeyå¯¹åº”çš„å€¼å­˜åœ¨</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl get secrets additional-configs -o yaml
</span></span><span class=line><span class=cl>data:
</span></span><span class=line><span class=cl>  prometheus-additional.yaml: LSBqb2JfbmFtZTogJ2t1YmVybmV0ZXMtc2VydmljZS1lbmRwb2ludHMnCiAga3ViZXJuZXRlc19zZF9jb25maWdzOgogIC0gcm9sZTogZW5kcG9pbnRzCiAgcmVsYWJlbF9jb25maWdzOgogIC0gc291cmNlX2xhYmVsczogW19fbWV0YV9rdWJlcm5ldGVzX3NlcnZpY2VfYW5ub3RhdGlvbl9wcm9tZXRoZXVzX2lvX3NjcmFwZV0KICAgIGFjdGlvbjoga2VlcAogICAgcmVnZXg6IHRydWUKICAtIHNvdXJjZV9sYWJlbHM6IFtfX21ldGFfa3ViZXJuZXRlc19zZXJ2aWNlX2Fubm90YXRpb25fcHJvbWV0aGV1c19pb19zY2hlbWVdCiAgICBhY3Rpb246IHJlcGxhY2UKICAgIHRhcmdldF9sYWJlbDogX19zY2hlbWVfXwogICAgcmVnZXg6IChodHRwcz8pCiAgLSBzb3VyY2VfbGFiZWxzOiBbX19tZXRhX2t1YmVybmV0ZXNfc2VydmljZV9hbm5vdGF0aW9uX3Byb21ldGhldXNfaW9fcGF0aF0KICAgIGFjdGlvbjogcmVwbGFjZQogICAgdGFyZ2V0X2xhYmVsOiBfX21ldHJpY3NfcGF0aF9fCiAgICByZWdleDogKC4rKQogIC0gc291cmNlX2xhYmVsczogW19fYWRkcmVzc19fLCBfX21ldGFfa3ViZXJuZXRlc19zZXJ2aWNlX2Fubm90YXRpb25fcHJvbWV0aGV1c19pb19wb3J0XQogICAgYWN0aW9uOiByZXBsYWNlCiAgICB0YXJnZXRfbGFiZWw6IF9fYWRkcmVzc19fCiAgICByZWdleDogKFteOl0rKSg/OjpcZCspPzsoXGQrKQogICAgcmVwbGFjZW1lbnQ6ICQxOiQyCiAgLSBhY3Rpb246IGxhYmVsbWFwCiAgICByZWdleDogX19tZXRhX2t1YmVybmV0ZXNfc2VydmljZV9sYWJlbF8oLispCiAgLSBzb3VyY2VfbGFiZWxzOiBbX19tZXRhX2t1YmVybmV0ZXNfbmFtZXNwYWNlXQogICAgYWN0aW9uOiByZXBsYWNlCiAgICB0YXJnZXRfbGFiZWw6IGt1YmVybmV0ZXNfbmFtZXNwYWNlCiAgLSBzb3VyY2VfbGFiZWxzOiBbX19tZXRhX2t1YmVybmV0ZXNfc2VydmljZV9uYW1lXQogICAgYWN0aW9uOiByZXBsYWNlCiAgICB0YXJnZXRfbGFiZWw6IGt1YmVybmV0ZXNfbmFtZQo<span class=o>=</span>
</span></span><span class=line><span class=cl>kind: Secret
</span></span><span class=line><span class=cl>metadata:
</span></span><span class=line><span class=cl>  creationTimestamp: <span class=s2>&#34;2025-06-18T07:50:33Z&#34;</span>
</span></span><span class=line><span class=cl>  name: additional-configs
</span></span><span class=line><span class=cl>  namespace: monitoring
</span></span><span class=line><span class=cl>  resourceVersion: <span class=s2>&#34;26440898&#34;</span>
</span></span><span class=line><span class=cl>  uid: 97ae179c-6516-4050-9b0a-c95596cf387e
</span></span><span class=line><span class=cl>type: Opaque
</span></span></code></pre></td></tr></table></div></div><ul><li>ç„¶åæˆ‘ä»¬åªéœ€è¦åœ¨å£°æ˜prometheusçš„èµ„æºå¯¹è±¡æ–‡ä»¶ä¸­æ·»åŠ è¿™ä¸ªé¢å¤–çš„é…ç½®å³å¯</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>monitoring.coreos.com/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app.kubernetes.io/component</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app.kubernetes.io/instance</span><span class=p>:</span><span class=w> </span><span class=l>k8s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app.kubernetes.io/name</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app.kubernetes.io/part-of</span><span class=p>:</span><span class=w> </span><span class=l>kube-prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app.kubernetes.io/version</span><span class=p>:</span><span class=w> </span><span class=m>2.54.1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>k8s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>monitoring</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>alerting</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>alertmanagers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>alertmanager-main</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>monitoring</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=l>web</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>enableFeatures</span><span class=p>:</span><span class=w> </span><span class=p>[]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>externalLabels</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>quay.io/prometheus/prometheus:v2.54.1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>nodeSelector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>kubernetes.io/os</span><span class=p>:</span><span class=w> </span><span class=l>linux</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>podMetadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app.kubernetes.io/component</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app.kubernetes.io/instance</span><span class=p>:</span><span class=w> </span><span class=l>k8s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app.kubernetes.io/name</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app.kubernetes.io/part-of</span><span class=p>:</span><span class=w> </span><span class=l>kube-prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app.kubernetes.io/version</span><span class=p>:</span><span class=w> </span><span class=m>2.54.1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>podMonitorNamespaceSelector</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>podMonitorSelector</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>probeNamespaceSelector</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>probeSelector</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>400Mi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ruleNamespaceSelector</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ruleSelector</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>scrapeConfigNamespaceSelector</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>scrapeConfigSelector</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>securityContext</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>fsGroup</span><span class=p>:</span><span class=w> </span><span class=m>2000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>runAsNonRoot</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>runAsUser</span><span class=p>:</span><span class=w> </span><span class=m>1000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>serviceAccountName</span><span class=p>:</span><span class=w> </span><span class=l>prometheus-k8s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>serviceMonitorNamespaceSelector</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>serviceMonitorSelector</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=m>2.54.1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>additionalScrapeConfigs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>additional-configs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>prometheus-additional.yaml</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>åœ¨Prometheus UIçš„é…ç½®é¡µé¢ å·²ç»çœ‹åˆ°æœ‰å¯¹åº”çš„é…ç½®ä¿¡æ¯ ä½†æ˜¯targetsé¡µé¢ä¸‹å´æ²¡æœ‰å¯¹åº”çš„ç›‘æ§ä»»åŠ¡ æŸ¥çœ‹Prometheusçš„Podæ—¥å¿—</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>ts</span><span class=o>=</span>2025-06-18T08:03:27.801Z <span class=nv>caller</span><span class=o>=</span>klog.go:116 <span class=nv>level</span><span class=o>=</span>error <span class=nv>component</span><span class=o>=</span>k8s_client_runtime <span class=nv>func</span><span class=o>=</span>ErrorDepth <span class=nv>msg</span><span class=o>=</span><span class=s2>&#34;pkg/mod/k8s.io/client-go@v0.29.3/tools/cache/reflector.go:229: Failed to watch *v1.Service: failed to list *v1.Service: services is forbidden: User \&#34;system:serviceaccount:monitoring:prometheus-k8s\&#34; cannot list resource \&#34;services\&#34; in API group \&#34;\&#34; at the cluster scope&#34;</span>
</span></span><span class=line><span class=cl>...
</span></span></code></pre></td></tr></table></div></div><ul><li>å¯ä»¥çœ‹åˆ°æœ‰å¾ˆå¤šé”™è¯¯æ—¥å¿—å‡ºç° éƒ½æ˜¯ <code>xxx is forbidden</code> è¿™è¯´æ˜æ˜¯RBACæƒé™çš„é—®é¢˜ é€šè¿‡Prometheusèµ„æºå¯¹è±¡çš„é™ªç€ä½ å¯ä»¥å€¼å¾— Promtheusç»‘å®šäº†ä¸€ä¸ªåä¸º<code>prometheus-k8s</code>çš„ServiceAccountå¯¹è±¡ è€Œè¿™ä¸ªå¯¹è±¡ç»‘å®šçš„æ˜¯ä¸€ä¸ªåä¸ºpromtheus-k8sçš„ClusterRole</li><li>æŸ¥çœ‹ClusterRoleçš„å†…å®¹ æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ˜æ˜¾æ²¡æœ‰å¯¹Serviceæˆ–è€…Podçš„listæƒé™ æˆ‘ä»¬æ·»åŠ ä¸Šå¯¹è±¡çš„æƒé™å³å¯</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRole</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>creationTimestamp</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;2025-06-13T12:48:39Z&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app.kubernetes.io/component</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app.kubernetes.io/instance</span><span class=p>:</span><span class=w> </span><span class=l>k8s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app.kubernetes.io/name</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app.kubernetes.io/part-of</span><span class=p>:</span><span class=w> </span><span class=l>kube-prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app.kubernetes.io/version</span><span class=p>:</span><span class=w> </span><span class=m>2.54.1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>prometheus-k8s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resourceVersion</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;25082977&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>uid</span><span class=p>:</span><span class=w> </span><span class=l>4cc3523b-1a2d-4682-bd6e-f23a11e661e7</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>apiGroups</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=s2>&#34;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>nodes/metrics</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>verbs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>get</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>nonResourceURLs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>/metrics</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>/metrics/slis</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>verbs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>get</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>æ›´æ–°<code>prometheus-k8s</code> ClusterRoleæƒé™</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>- apiGroups:
</span></span><span class=line><span class=cl>  - <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>  resources:
</span></span><span class=line><span class=cl>  - nodes
</span></span><span class=line><span class=cl>  - services
</span></span><span class=line><span class=cl>  - endpoints
</span></span><span class=line><span class=cl>  - pods
</span></span><span class=line><span class=cl>  - nodes/proxy
</span></span><span class=line><span class=cl>  verbs:
</span></span><span class=line><span class=cl>  - get
</span></span><span class=line><span class=cl>  - list
</span></span><span class=line><span class=cl>  - watch
</span></span><span class=line><span class=cl>- apiGroups:
</span></span><span class=line><span class=cl>  - <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>  resources:
</span></span><span class=line><span class=cl>  - configmaps
</span></span><span class=line><span class=cl>  - nodes/metrics
</span></span><span class=line><span class=cl>  verbs:
</span></span><span class=line><span class=cl>  - get
</span></span><span class=line><span class=cl>- nonResourceURLs:
</span></span><span class=line><span class=cl>  - /metrics
</span></span><span class=line><span class=cl>  verbs:
</span></span><span class=line><span class=cl>  - get
</span></span></code></pre></td></tr></table></div></div><h5 id=æ•°æ®æŒä¹…åŒ–>æ•°æ®æŒä¹…åŒ–</h5><ul><li>ç›®å‰çš„Promtheus å¦‚è£¹æˆ‘ä»¬é‡å¯Pod åˆ™ä¼šä¸¢å¤±ä¹‹å‰é‡‡é›†çš„æ•°æ® è¿™æ˜¯å› ä¸ºpromeehteusè¿™ä¸ªCRDåˆ›å»ºçš„Prometheuså¹¶æ²¡æœ‰åšæ•°æ®çš„æŒä¹…åŒ–</li><li>ç›´æ¥æŸ¥çœ‹ç”Ÿæˆçš„Prometheus Podçš„æŒ‚è½½è¯¦æƒ… æˆ‘ä»¬å‘ç°Prometheusçš„æ•°æ®ç›®å½•/promtheuså®é™…ä¸Šæ˜¯é€šè¿‡<code>emptyDir</code>è¿›è¡ŒæŒ‚è½½çš„</li><li>æˆ‘ä»¬çŸ¥é“<code>emptyDir</code>æŒ‚è½½çš„æ•°æ®çš„å£°æ˜å‘¨æœŸå’ŒPodç”Ÿå‘½å‘¨æœŸæ˜¯ä¸€è‡´çš„ å¦‚æœPodæŒ‚æ‰ æ•°æ®ä¹Ÿè·Ÿç€ä¸¢å¤±</li><li>çº¿ä¸Šçš„ç›‘æ§æ•°æ®æˆ‘ä»¬è‚¯å®šéœ€è¦åšæŒä¹…åŒ– prometheus CRDèµ„æºä¹Ÿä¸ºæˆ‘ä»¬æä¾›äº†æ•°æ®æŒä¹…åŒ–çš„é…ç½®æ–¹æ³• ç”±äºæˆ‘ä»¬çš„Prometheusæœ€ç»ˆæ˜¯é€šè¿‡Statefulsetæ§åˆ¶å™¨è¿›è¡Œéƒ¨ç½²çš„ æ‰€ä»¥æˆ‘ä»¬è¿™é‡Œéœ€è¦é€šè¿‡<code>storageclass</code>æ¥åšæ•°æ®æŒä¹…åŒ–</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=l>$ kubectl get pod prometheus-k8s-0 -o yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>...</span><span class=l>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>prometheus-k8s-db</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>...</span><span class=l>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>emptyDir</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>prometheus-k8s-db</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>è¿™é‡Œä½¿ç”¨æˆ‘æœ¬åœ°çš„nfs stroageclass åœ¨prometheus CRDèµ„æºå¯¹è±¡ä¸­æ·»åŠ å¦‚ä¸‹é…ç½®</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>storage</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>volumeClaimTemplate</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>storageClassName</span><span class=p>:</span><span class=w> </span><span class=l>nfs-client</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>storage</span><span class=p>:</span><span class=w> </span><span class=l>10Gi</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>æ›´æ–°æœåŠ¡ä¹‹å æˆ‘ä»¬æŸ¥çœ‹å¯¹åº”çš„pv/pvc/promtehus å¯ä»¥çœ‹åˆ°å·²ç»è¿›è¡Œäº†æŒä¹…åŒ–</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># POD</span>
</span></span><span class=line><span class=cl>volumes:
</span></span><span class=line><span class=cl>- name: prometheus-k8s-db
</span></span><span class=line><span class=cl>  persistentVolumeClaim:
</span></span><span class=line><span class=cl>    claimName: prometheus-k8s-db-prometheus-k8s-1
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>volumeMounts:
</span></span><span class=line><span class=cl>- mountPath: /prometheus
</span></span><span class=line><span class=cl>  name: prometheus-k8s-db
</span></span><span class=line><span class=cl>  subPath: prometheus-db
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># pv / pvc</span>
</span></span><span class=line><span class=cl>$ kubectl get pv
</span></span><span class=line><span class=cl>NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                                           STORAGECLASS   VOLUMEATTRIBUTESCLASS   REASON   AGE
</span></span><span class=line><span class=cl>pvc-c2cd37f7-9299-4c47-97a7-b841e4c28e9b   10Gi       RWO            Delete           Bound    monitoring/prometheus-k8s-db-prometheus-k8s-1   nfs-client     &lt;unset&gt;                          10m
</span></span><span class=line><span class=cl>pvc-c6177fc6-74d5-4e1f-9213-86f90757b3d2   10Gi       RWO            Delete           Bound    monitoring/prometheus-k8s-db-prometheus-k8s-0   nfs-client     &lt;unset&gt;                          10m
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ kubectl get pvc
</span></span><span class=line><span class=cl>NAME                                 STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   VOLUMEATTRIBUTESCLASS   AGE
</span></span><span class=line><span class=cl>prometheus-k8s-db-prometheus-k8s-0   Bound    pvc-c6177fc6-74d5-4e1f-9213-86f90757b3d2   10Gi       RWO            nfs-client     &lt;unset&gt;                 10m
</span></span><span class=line><span class=cl>prometheus-k8s-db-prometheus-k8s-1   Bound    pvc-c2cd37f7-9299-4c47-97a7-b841e4c28e9b   10Gi       RWO            nfs-client     &lt;unset&gt;                 10m
</span></span></code></pre></td></tr></table></div></div><h5 id=å‰¯æœ¬ä¸åˆ†ç‰‡>å‰¯æœ¬ä¸åˆ†ç‰‡</h5><ul><li>kube-prometheus é»˜è®¤å®‰è£…æ˜¯é«˜å¯ç”¨çš„2å‰¯æœ¬ å¦‚æœéœ€è¦ä¿®æ”¹ä¸ºåˆ†ç‰‡ éœ€è¦ä¿®æ”¹prometheus crdå®šä¹‰</li><li><a class=link href=https://prometheus-operator.dev/docs/platform/high-availability/ target=_blank rel=noopener>high-availability</a></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># å¯åŠ¨çš„Podæ•°é‡ä¸º replicas * shards</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>shards</span><span class=p>:</span><span class=w> </span><span class=m>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>400Mi</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=reference>Reference</h2><ul><li>ubuntu</li></ul><p><a class=link href="https://askubuntu.com/questions/428772/how-to-install-specific-version-of-some-package/428778#428778?newreg=d056242a7a0340598dd1d2d4fad63e81" target=_blank rel=noopener>apt install speciffic version</a>
<a class=link href=https://www.serverlab.ca/tutorials/containers/docker/how-to-set-the-proxy-for-docker-on-ubuntu/ target=_blank rel=noopener>set-proxy-on-ubuntu-docker</a>
<a class=link href=https://askubuntu.com/questions/2493/apt-get-or-aptitude-equivalent-to-yum-whatprovides target=_blank rel=noopener>apt-get-like-yum-whatprovides</a></p><ul><li>kubetnetes</li></ul><p><a class=link href=https://stackoverflow.com/questions/63136175/kubectl-get-componentstatus-shows-unhealthy target=_blank rel=noopener>kubectl-get-commponentstatus-shows-unhealthy</a></p></section><footer class=article-footer><section class=article-tags><a href=/tags/cloud-native/>Cloud Native</a>
<a href=/tags/kubernetes/>Kubernetes</a>
<a href=/tags/pod/>Pod</a>
<a href=/tags/service/>Service</a>
<a href=/tags/kubeadm/>Kubeadm</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>ç›¸å…³æ–‡ç« </h2><div class=related-content><div class="flex article-list--tile"><article><a href=/p/coredns/><div class=article-details><h2 class=article-title>CoreDNS</h2></div></a></article><article><a href=/p/tekton/><div class=article-details><h2 class=article-title>Tekton</h2></div></a></article><article><a href=/p/prometheus/><div class=article-details><h2 class=article-title>Prometheus</h2></div></a></article><article><a href=/p/docker/><div class=article-details><h2 class=article-title>Docker</h2></div></a></article></div></div></aside><script src=https://utteranc.es/client.js repo=ilolicon/ilolicon.github.io issue-term=pathname crossorigin=anonymous async></script><style>.utterances{max-width:unset}</style><script>let utterancesLoaded=!1;function setUtterancesTheme(e){let t=document.querySelector(".utterances iframe");t&&t.contentWindow.postMessage({type:"set-theme",theme:`github-${e}`},"https://utteranc.es")}addEventListener("message",e=>{if(e.origin!=="https://utteranc.es")return;utterancesLoaded=!0,setUtterancesTheme(document.documentElement.dataset.scheme)}),window.addEventListener("onColorSchemeChange",e=>{if(!utterancesLoaded)return;setUtterancesTheme(e.detail)})</script><footer class=site-footer><section class=copyright>&copy;
2017 -
2025 ilolicon's Blog</section><section class=powerby>VicissitudeğŸ³<br>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>ä¸»é¢˜ <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.21.0>Stack</a></b> ç”± <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> è®¾è®¡</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>