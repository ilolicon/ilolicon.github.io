<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Kubernetes, also known as K8s, is an open-source system for automating deployment, scaling, and management of containerized applications."><title>Kubernetes</title><link rel=canonical href=https://ilolicon.github.io/p/kubernetes/><link rel=stylesheet href=/scss/style.min.abbd69b2908fdfcd5179898beaafd374514a86538d81639ddd2c58c06ae54e40.css><meta property="og:title" content="Kubernetes"><meta property="og:description" content="Kubernetes, also known as K8s, is an open-source system for automating deployment, scaling, and management of containerized applications."><meta property="og:url" content="https://ilolicon.github.io/p/kubernetes/"><meta property="og:site_name" content="ilolicon's Blog"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="Cloud Native"><meta property="article:tag" content="Kubernetes"><meta property="article:tag" content="Pod"><meta property="article:tag" content="Service"><meta property="article:tag" content="Kubeadm"><meta property="article:published_time" content="2020-12-20T14:21:14+08:00"><meta property="article:modified_time" content="2020-12-20T14:21:14+08:00"><meta name=twitter:title content="Kubernetes"><meta name=twitter:description content="Kubernetes, also known as K8s, is an open-source system for automating deployment, scaling, and management of containerized applications."><link rel="shortcut icon" href=/img/favicon.ico></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切换菜单>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu96a5ab8e0364e843af4687201b687892_162934_300x0_resize_box_3.png width=300 height=300 class=site-logo loading=lazy alt=Avatar></a>
<span class=emoji>🍥</span></figure><div class=site-meta><h1 class=site-name><a href=/>ilolicon's Blog</a></h1><h2 class=site-description>Keep Calm and Carry On.</h2></div></header><ol class=social-menu><li><a href=https://github.com/ilolicon target=_blank title=GitHub rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://twitter.com target=_blank title=Twitter rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg><span>Home</span></a></li><li><a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg><span>Archives</span></a></li><li><a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg><span>Search</span></a></li><li><a href=/links/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg><span>Links</span></a></li><div class=menu-bottom-section><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>暗色模式</span></li></div></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目录</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#容器编排>容器编排</a></li><li><a href=#概述>概述</a></li><li><a href=#组件>组件</a></li><li><a href=#集群安装>集群安装</a><ol><li><a href=#二进制安装>二进制安装</a></li><li><a href=#kubeadm安装>kubeadm安装</a><ol><li><a href=#主机环境预设>主机环境预设</a></li><li><a href=#测试环境说明>测试环境说明</a></li><li><a href=#安装容器运行时>安装容器运行时</a></li><li><a href=#安装kubeletkubeadmkubectl>安装kubelet/kubeadm/kubectl</a></li><li><a href=#整合kubelet和cri-dockerd>整合kubelet和cri-dockerd</a></li><li><a href=#初始化第一个主节点>初始化第一个主节点</a></li><li><a href=#初始化完成后的操作步骤>初始化完成后的操作步骤</a></li></ol></li></ol></li><li><a href=#配置对多集群的访问>配置对多集群的访问</a></li><li><a href=#资源清单定义>资源清单定义</a><ol><li><a href=#pod>Pod</a><ol><li><a href=#自主式pod>自主式Pod</a></li><li><a href=#pod资源>Pod资源</a></li><li><a href=#pod生命周期>Pod生命周期</a></li><li><a href=#初始化容器>初始化容器</a></li><li><a href=#pod容器探针类型>Pod容器探针类型</a></li><li><a href=#pod控制器>Pod控制器</a></li></ol></li><li><a href=#service>Service</a><ol><li><a href=#service代理>Service代理</a></li><li><a href=#service类型>Service类型</a></li><li><a href=#headless-services无头service>Headless Services(无头Service)</a></li><li><a href=#流量策略>流量策略</a></li><li><a href=#会话亲和性>会话亲和性</a></li></ol></li><li><a href=#ingress>Ingress</a></li><li><a href=#存储>存储</a><ol><li><a href=#configmap>configMap</a></li><li><a href=#secret>Secret</a></li><li><a href=#downwardapi>downwardAPI</a></li><li><a href=#volume>Volume</a></li><li><a href=#pvpvc>PV/PVC</a></li><li><a href=#示例>示例</a></li><li><a href=#storageclass>StorageClass</a></li></ol></li></ol></li><li><a href=#statefulset控制器>StatefulSet控制器</a></li><li><a href=#调度器>调度器</a><ol><li><a href=#概念>概念</a><ol><li><a href=#自定义调度器示例>自定义调度器示例</a></li><li><a href=#调度过程>调度过程</a></li></ol></li><li><a href=#亲和性>亲和性</a><ol><li><a href=#节点亲和性>节点亲和性</a></li><li><a href=#pod间亲和性与反亲和性>Pod间亲和性与反亲和性</a></li><li><a href=#总结>总结</a></li></ol></li><li><a href=#容忍与污点>容忍与污点</a><ol><li><a href=#组成>组成</a></li><li><a href=#设置和去除>设置和去除</a></li><li><a href=#容忍>容忍</a></li></ol></li><li><a href=#固定节点调度>固定节点调度</a><ol><li><a href=#指定节点调度>指定节点调度</a></li><li><a href=#指定节点标签调度>指定节点标签调度</a></li></ol></li></ol></li><li><a href=#认证及serviceaccount>认证及ServiceAccount</a><ol><li><a href=#认证授权>认证授权</a></li><li><a href=#serviceaccount>ServiceAccount</a></li><li><a href=#rbac授权>RBAC授权</a></li></ol></li><li><a href=#配置管理>配置管理</a><ol><li><a href=#kustomize>Kustomize</a></li><li><a href=#helm>Helm</a><ol><li><a href=#模版debug>模版debug</a></li></ol></li></ol></li><li><a href=#集群监控>集群监控</a><ol><li><a href=#手动安装prometheus>手动安装Prometheus</a></li><li><a href=#监控集群应用>监控集群应用</a></li><li><a href=#监控集群节点>监控集群节点</a><ol><li><a href=#部署node-exporter>部署node-exporter</a></li><li><a href=#配置基于kubernetes的自动发现>配置基于Kubernetes的自动发现</a></li></ol></li><li><a href=#监控集群常用资源对象>监控集群常用资源对象</a><ol><li><a href=#容器监控>容器监控</a></li><li><a href=#apiserver监控>apiserver监控</a></li><li><a href=#service监控>Service监控</a></li><li><a href=#kube-state-metrics>kube-state-metrics</a></li></ol></li><li><a href=#grafana的安装使用>Grafana的安装使用</a></li><li><a href=#alertmanger>Alertmanger</a></li><li><a href=#prometheus-operator>Prometheus Operator</a><ol><li><a href=#operator模式>Operator模式</a></li><li><a href=#介绍>介绍</a></li><li><a href=#通过prometheus-operator安装>通过prometheus-operator安装</a></li><li><a href=#通过kube-prometheus安装>通过kube-prometheus安装</a></li></ol></li></ol></li><li><a href=#reference>Reference</a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/cloudnative/ style=background-color:#2a9d8f;color:#fff>CloudNative</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/kubernetes/>Kubernetes</a></h2><h3 class=article-subtitle>Kubernetes, also known as K8s, is an open-source system for automating deployment, scaling, and management of containerized applications.</h3></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>Dec 20, 2020</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>阅读时长: 46 分钟</time></div></footer></div></header><section class=article-content><p><a class=link href=https://kubernetes.io/zh/docs/home/ target=_blank rel=noopener><img src=https://img.shields.io/badge/Kubernetes-README-356DE3 loading=lazy alt="kubernetes readme"></a></p><p><a class=link href=https://kubernetes.io/ target=_blank rel=noopener><img src=/p/kubernetes/icons/kubernetes.svg loading=lazy alt=kubernetes></a></p><p><code>Container Evolution</code></p><p><img src=/p/kubernetes/icons/container_evolution.svg loading=lazy alt=container_evolution></p><h2 id=容器编排>容器编排</h2><ul><li><code>ansible/saltstack</code> <strong>传统应用</strong>编排工具</li><li><code>docker</code><ul><li><code>docker compose</code> docker单机编排</li><li><code>docker swarm</code> docker主机加入docker swarm资源池</li><li><code>docker machine</code> 完成docker主机加入docker swarm资源池的先决条件/预处理工具</li></ul></li><li><code>mesos(idc os) + marathon</code> 面向容器编排的框架</li><li><code>kubernetes(borg)</code><ul><li>自动装箱(基于依赖 自动完成容器部署 不影响其可用性)</li><li>自我修复</li><li>水平扩展</li><li>服务发现和负载均衡</li><li>自动发布和回滚</li><li>密钥和配置管理</li><li>存储编排</li><li>任务批量处理运行</li></ul></li></ul><h2 id=概述>概述</h2><p><a class=link href=https://kubernetes.io/zh-cn/docs/concepts/overview/ target=_blank rel=noopener>概述</a></p><h2 id=组件>组件</h2><p><a class=link href=https://kubernetes.io/zh-cn/docs/concepts/overview/components/ target=_blank rel=noopener>Kubernetes组件</a></p><h2 id=集群安装>集群安装</h2><h3 id=二进制安装>二进制安装</h3><p><a class=link href=https://github.com/easzlab/kubeasz target=_blank rel=noopener>参考kubeasz项目</a></p><h3 id=kubeadm安装>kubeadm安装</h3><p><a class=link href=https://kubernetes.io/zh-cn/docs/setup/production-environment/tools/kubeadm/ target=_blank rel=noopener>使用kubeadm引导集群</a></p><ul><li>图中docker组件可以替换为其他容器运行时组件(<a class=link href=https://kubernetes.io/zh-cn/docs/concepts/architecture/cri/ target=_blank rel=noopener>CRI</a>)</li><li>参考：<a class=link href=https://kubernetes.io/zh-cn/blog/2022/02/17/dockershim-faq/ target=_blank rel=noopener>移除Dockershim的常见问题</a></li></ul><p><img src=/p/kubernetes/icons/structure.png width=600 height=498 srcset="/p/kubernetes/icons/structure_hu12b93151174b3e04ef92f8cdd319b528_196054_480x0_resize_box_3.png 480w, /p/kubernetes/icons/structure_hu12b93151174b3e04ef92f8cdd319b528_196054_1024x0_resize_box_3.png 1024w" loading=lazy alt=structure class=gallery-image data-flex-grow=120 data-flex-basis=289px></p><ul><li><a class=link href=https://kubernetes.io/zh-cn/docs/concepts/extend-kubernetes/compute-storage-net/network-plugins/ target=_blank rel=noopener>CNI</a>以<a class=link href=https://github.com/flannel-io/flannel target=_blank rel=noopener>flannel</a>为例</li></ul><p><img src=/p/kubernetes/icons/k8s-network-structure02.png width=2418 height=1128 srcset="/p/kubernetes/icons/k8s-network-structure02_hu86518e8c49d554475a7b0c3fae4a2e9e_2485545_480x0_resize_box_3.png 480w, /p/kubernetes/icons/k8s-network-structure02_hu86518e8c49d554475a7b0c3fae4a2e9e_2485545_1024x0_resize_box_3.png 1024w" loading=lazy alt=structure02 class=gallery-image data-flex-grow=214 data-flex-basis=514px></p><h4 id=主机环境预设>主机环境预设</h4><ul><li>OS: Ubuntu 22.04 LTS</li><li>Kubernetes: v1.29.13</li><li>Container Runtime(二选一即可)<ul><li>containerd<ul><li>官方仓库containerd</li><li>或Docker社区提供的containerd.io</li></ul></li><li>DockerCE-27.5.0 和 <a class=link href=https://github.com/Mirantis/cri-dockerd target=_blank rel=noopener>cri-dockerd-0.3.16</a></li></ul></li></ul><h4 id=测试环境说明>测试环境说明</h4><ul><li>1master/2+node 也可以多master 根据自己环境安排</li><li>集群节点需要做时间同步</li><li>禁用swap<ul><li>swapoff -a</li><li>systemctl &ndash;type swap</li><li>systemctl mask SWAP_DEV</li></ul></li><li>禁用默认配置的iptables</li><li>加载br_netfilter模块<ul><li>modprobe br_netfilter</li><li>写入/etc/modules(开机启动)</li></ul></li></ul><h4 id=安装容器运行时>安装容器运行时</h4><h5 id=dockercri-docekrd>docker+cri-docekrd</h5><ul><li>安装docker-ce</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>apt -y install apt-transport-https ca-certificates curl software-properties-common
</span></span><span class=line><span class=cl>curl -fsSL http://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg <span class=p>|</span> apt-key add -
</span></span><span class=line><span class=cl>add-apt-repository <span class=s2>&#34;deb [arch=amd64] http://mirrors.aliyun.com/docker-ce/linux/ubuntu </span><span class=k>$(</span>lsb_release -cs<span class=k>)</span><span class=s2> stable&#34;</span>
</span></span><span class=line><span class=cl>apt update
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 安装docker-ce</span>
</span></span><span class=line><span class=cl>apt -y install docker-ce
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 进行完下面配置后 重启服务</span>
</span></span><span class=line><span class=cl>systemctl restart docker
</span></span><span class=line><span class=cl>ststemctl <span class=nb>enable</span> docker
</span></span></code></pre></td></tr></table></div></div><ul><li>docker配置<ul><li>kubelet需要让docker容器引擎使用systemd作为CGroup的驱动 其默认值为cgroupfs</li><li>我们还需要编辑docker的配置文件/etc/docker/daemon.json 参考下面配置</li><li>其中的registry-mirrors用于指明使用的镜像加速服务 参考<a class=link href=https://isedu.top/index.php/archives/225/ target=_blank rel=noopener>国内无法下载Docker镜像的多种解决方案</a></li><li>提示: 自Kubernetes v1.22版本开始 未明确设置kubelet的cgroup driver时 则默认即会将其设置为systemd</li></ul></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl><span class=nt>&#34;registry-mirrors&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;https://dockerpull.cn&#34;</span>
</span></span><span class=line><span class=cl><span class=p>],</span>
</span></span><span class=line><span class=cl><span class=nt>&#34;exec-opts&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;native.cgroupdriver=systemd&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl><span class=nt>&#34;log-driver&#34;</span><span class=p>:</span> <span class=s2>&#34;json-file&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=nt>&#34;log-opts&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;max-size&#34;</span><span class=p>:</span> <span class=s2>&#34;200m&#34;</span>
</span></span><span class=line><span class=cl><span class=p>},</span>
</span></span><span class=line><span class=cl><span class=nt>&#34;storage-driver&#34;</span><span class=p>:</span> <span class=s2>&#34;overlay2&#34;</span>  
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>为docker设置代理(可选)<ul><li>Kubeadm部署Kubernetes集群的过程中 默认使用Google的Registry服务registry.k8s.io上的镜像</li><li>例如<code>registry.k8s.io/kube-apiserver</code>等 但国内部分用户可能无法访问到该服务</li><li>我们也可以使用国内的镜像服务来解决这个问题 例如<code>registry.aliyuncs.com/google_containers</code></li><li>若选择使用国内的镜像服务 则配置代理服务的步骤为可选</li><li>设置代理配置 编辑/lib/systemd/system/docker.service</li></ul></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 重要提示: </span>
</span></span><span class=line><span class=cl>  <span class=c1># 节点网络(例如本示例中使用的192.168.0.0/16)</span>
</span></span><span class=line><span class=cl>  <span class=c1># Pod网络(例如本示例中使用的10.244.0.0/16)</span>
</span></span><span class=line><span class=cl>  <span class=c1># Service网络(例如本示例中使用的10.96.0.0/12)以及127网络等本地使用的网络</span>
</span></span><span class=line><span class=cl>  <span class=c1># 必须明确定义为不使用所配置的代理 否则将很有可能带来无法预知的本地网络通信故障</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 请将下面配置段中的 $PROXY_SERVER_IP 替换为你的代理服务器地址</span>
</span></span><span class=line><span class=cl><span class=c1># 将$PROXY_PORT 替换为你的代理服所监听的端口</span>
</span></span><span class=line><span class=cl><span class=c1># 另外还要注意所使用的协议http是否同代理服务器提供服务的协议相匹配 如有必要 请自行修改为https</span>
</span></span><span class=line><span class=cl><span class=nv>Environment</span><span class=o>=</span><span class=s2>&#34;HTTP_PROXY=http://</span><span class=nv>$PROXY_SERVER_IP</span><span class=s2>:</span><span class=nv>$PROXY_PORT</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>Environment</span><span class=o>=</span><span class=s2>&#34;HTTPS_PROXY=http://</span><span class=nv>$PROXY_SERVER_IP</span><span class=s2>:</span><span class=nv>$PROXY_PORT</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>Environment</span><span class=o>=</span><span class=s2>&#34;NO_PROXY=127.0.0.0/8,172.17.0.0/16,172.29.0.0/16,10.244.0.0/16,192.168.0.0/16,10.96.0.0/12,magedu.com,cluster.local&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 修改完配置重启服务</span>
</span></span><span class=line><span class=cl>systemctl daemon-reload
</span></span><span class=line><span class=cl>systemctl restart docker
</span></span></code></pre></td></tr></table></div></div><ul><li>安装cri-dockerd<ul><li>直接去对应的<a class=link href=https://github.com/Mirantis/cri-dockerd target=_blank rel=noopener>Github</a>项目下载对应的deb包安装</li></ul></li></ul><h5 id=containerd>containerd</h5><ul><li>安装容器运行时containerd<ul><li>Ubuntu 2204上安装Containerd有两种选择<ul><li>Ubuntu系统官方程序包仓库中的containerd</li><li>Docker社区提供的<code>containerd.io</code>(本文选择该种方式)</li></ul></li><li>安装并启动containerd.io</li></ul></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 生成containerd.io相关程序包的仓库 这里以阿里云的镜像服务器为例</span>
</span></span><span class=line><span class=cl>apt -y install apt-transport-https ca-certificates curl software-properties-common
</span></span><span class=line><span class=cl>curl -fsSL http://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg <span class=p>|</span> apt-key add -
</span></span><span class=line><span class=cl>add-apt-repository <span class=s2>&#34;deb [arch=amd64] http://mirrors.aliyun.com/docker-ce/linux/ubuntu </span><span class=k>$(</span>lsb_release -cs<span class=k>)</span><span class=s2> stable&#34;</span>
</span></span><span class=line><span class=cl>apt update
</span></span><span class=line><span class=cl>apt-get -y install containerd.io
</span></span></code></pre></td></tr></table></div></div><ul><li>配置<code>containerd.io</code><ul><li>运行如下命令打印并保存如下配置</li></ul></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>mkdir /etc/containerd
</span></span><span class=line><span class=cl>containerd config default &gt; /etc/containerd/config.toml
</span></span></code></pre></td></tr></table></div></div><ul><li>编辑生成的配置文件 完成如下几项相关的配置</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 1. 修改containerd使用SystemdCgroup</span>
</span></span><span class=line><span class=cl><span class=o>[</span>plugins.<span class=s2>&#34;io.containerd.grpc.v1.cri&#34;</span>.containerd.runtimes.runc<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=o>[</span>plugins.<span class=s2>&#34;io.containerd.grpc.v1.cri&#34;</span>.containerd.runtimes.runc.options<span class=o>]</span>
</span></span><span class=line><span class=cl>  <span class=nv>SystemdCgroup</span> <span class=o>=</span> <span class=nb>true</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. 配置Containerd使用国内Mirror站点上的pause镜像及指定的版本</span>
</span></span><span class=line><span class=cl><span class=o>[</span>plugins.<span class=s2>&#34;io.containerd.grpc.v1.cri&#34;</span><span class=o>]</span>
</span></span><span class=line><span class=cl><span class=nv>sandbox_image</span> <span class=o>=</span> <span class=s2>&#34;registry.aliyuncs.com/google_containers/pause:3.9&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 3. 配置Containerd使用国内的Image加速服务 以加速Image获取</span>
</span></span><span class=line><span class=cl><span class=o>[</span>plugins.<span class=s2>&#34;io.containerd.grpc.v1.cri&#34;</span>.registry<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=o>[</span>plugins.<span class=s2>&#34;io.containerd.grpc.v1.cri&#34;</span>.registry.mirrors<span class=o>]</span>
</span></span><span class=line><span class=cl>  <span class=o>[</span>plugins.<span class=s2>&#34;io.containerd.grpc.v1.cri&#34;</span>.registry.mirrors.<span class=s2>&#34;docker.io&#34;</span><span class=o>]</span>
</span></span><span class=line><span class=cl>    <span class=nv>endpoint</span> <span class=o>=</span> <span class=o>[</span><span class=s2>&#34;https://docker.mirrors.ustc.edu.cn&#34;</span>, <span class=s2>&#34;https://registry.docker-cn.com&#34;</span><span class=o>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>plugins.<span class=s2>&#34;io.containerd.grpc.v1.cri&#34;</span>.registry.mirrors.<span class=s2>&#34;registry.k8s.io&#34;</span><span class=o>]</span>
</span></span><span class=line><span class=cl><span class=nv>endpoint</span> <span class=o>=</span> <span class=o>[</span><span class=s2>&#34;https://registry.aliyuncs.com/google_containers&#34;</span><span class=o>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 4. 配置Containerd使用私有镜像仓库 不存在要使用的私有ImageRegistry时 本步骤可省略</span>
</span></span><span class=line><span class=cl><span class=o>[</span>plugins.<span class=s2>&#34;io.containerd.grpc.v1.cri&#34;</span>.registry<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=o>[</span>plugins.<span class=s2>&#34;io.containerd.grpc.v1.cri&#34;</span>.registry.mirrors<span class=o>]</span>
</span></span><span class=line><span class=cl>  <span class=o>[</span>plugins.<span class=s2>&#34;io.containerd.grpc.v1.cri&#34;</span>.registry.mirrors.<span class=s2>&#34;registry.minho.com&#34;</span><span class=o>]</span>
</span></span><span class=line><span class=cl>    <span class=nv>endpoint</span> <span class=o>=</span> <span class=o>[</span><span class=s2>&#34;https://registry.minho.com&#34;</span><span class=o>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 5. 配置私有镜像仓库跳过tls验证 若私有ImageRegistry能正常进行tls认证 则本步骤可省略</span>
</span></span><span class=line><span class=cl><span class=o>[</span>plugins.<span class=s2>&#34;io.containerd.grpc.v1.cri&#34;</span>.registry.configs<span class=o>]</span>
</span></span><span class=line><span class=cl>  <span class=o>[</span>plugins.<span class=s2>&#34;io.containerd.grpc.v1.cri&#34;</span>.registry.configs.<span class=s2>&#34;registry.minho.com&#34;</span>.tls<span class=o>]</span>
</span></span><span class=line><span class=cl>    <span class=nv>insecure_skip_verify</span> <span class=o>=</span> <span class=nb>true</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 6. 重启服务</span>
</span></span><span class=line><span class=cl>systemctl restart containerd
</span></span></code></pre></td></tr></table></div></div><ul><li>配置crictl客户端<ul><li>安装containerd.io时 会自动安装命令行客户端工具crictl</li><li>该客户端通常需要通过正确的unix sock文件才能接入到containerd服务</li><li>编辑配置文件/etc/crictl.yaml 添加如下内容即可</li><li>随后即可正常使用crictl程序管理Image/Container和Pod等对象</li><li>另外containerd.io还有另一个名为ctr的客户端程序可以使用 其功能也更为丰富</li></ul></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>runtime-endpoint: unix:///run/containerd/containerd.sock
</span></span><span class=line><span class=cl>image-endpoint: unix:///run/containerd/containerd.sock
</span></span><span class=line><span class=cl>timeout: <span class=m>10</span>
</span></span><span class=line><span class=cl>debug: <span class=nb>true</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=安装kubeletkubeadmkubectl>安装kubelet/kubeadm/kubectl</h4><ul><li>自v1.28版本开始 Kubernetes官方变更了仓库的存储路径及使用方式(不同的版本将会使用不同的仓库) 并提供了向后兼容至v1.24版本</li><li>因此 对于v1.24及之后的版本来说 可以使用如下有别于传统配置的方式来安装相关的程序包</li><li>以本示例中要安装的v1.29版本为例来说 配置要使用的程序包仓库 需要使用的命令如下</li><li>如若需要安装其它版本 则将下面命令中的版本号<code>v1.29</code>予以替换即可</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>apt-get update <span class=o>&amp;&amp;</span> apt-get install -y apt-transport-https
</span></span><span class=line><span class=cl>curl -fsSL https://mirrors.aliyun.com/kubernetes-new/core/stable/v1.29/deb/Release.key <span class=p>|</span>    gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://mirrors.aliyun.com/kubernetes-new/core/stable/v1.29/deb/ /&#34;</span> <span class=p>|</span>    tee /etc/apt/sources.list.d/kubernetes.list
</span></span><span class=line><span class=cl>apt-get update
</span></span><span class=line><span class=cl>apt-get install -y kubelet kubeadm kubectl
</span></span></code></pre></td></tr></table></div></div><ul><li>安装完成后 要确保kubeadm等程序文件的版本</li><li>这将也是后面初始化Kubernetes集群时需要明确指定的版本号</li></ul><h4 id=整合kubelet和cri-dockerd>整合kubelet和cri-dockerd</h4><ul><li>仅支持CRI规范的kubelet需要经由遵循该规范的cri-dockerd完成与docker-ce的整合</li><li>该步骤仅使用docker-ce和cri-dockerd运行时的场景中需要配置</li></ul><h5 id=配置cri-dockerd>配置cri-dockerd</h5><ul><li>配置cri-dockerd 确保其能够正确加载到CNI插件</li><li>编辑<code>/usr/lib/systemd/system/cri-docker.service</code>文件 确保其[Service]配置段中的ExecStart的值类似如下内容</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>ExecStart</span><span class=o>=</span>/usr/bin/cri-dockerd --container-runtime-endpoint fd:// --network-plugin<span class=o>=</span>cni --cni-bin-dir<span class=o>=</span>/opt/cni/bin --cni-cache-dir<span class=o>=</span>/var/lib/cni/cache --cni-conf-dir<span class=o>=</span>/etc/cni/net.d --pod-infra-container-image<span class=o>=</span>registry.aliyuncs.com/google_containers/pause:3.9
</span></span></code></pre></td></tr></table></div></div><ul><li>需要添加的各配置参数(各参数的值要与系统部署的CNI插件的实际路径相对应)<ul><li><code>--network-plugin</code> 指定网络插件规范的类型 这里要使用CNI</li><li><code>--cni-bin-dir</code> 指定CNI插件二进制程序文件的搜索目录</li><li><code>--cni-cache-dir</code> CNI插件使用的缓存目录</li><li><code>--cni-conf-dir</code> CNI插件加载配置文件的目录</li><li><code>--pod-infra-container-image</code> Pod中的puase容器要使用的Image 默认为registry.k8s.io上的pause仓库中的镜像 不能直接获取到该Image时 要明确指定为从指定的位置加载 例如<code>registry.aliyuncs.com/google_containers/pause:3.9</code></li><li>配置完成后重启服务<code>systemctl restart cri-docker</code></li></ul></li></ul><h5 id=配置kubelet>配置kubelet</h5><ul><li>配置kubelet 为其指定cri-dockerd在本地打开的Unix Sock文件的路径</li><li>该路径一般默认为<code>/run/cri-dockerd.sock</code> 编辑文件/etc/sysconfig/kubelet 为其添加如下指定参数<ul><li>若/etc/sysconfig目录不存在 则需要先创建该目录</li><li><code>KUBELET_KUBEADM_ARGS="--container-runtime=remote --container-runtime-endpoint=/run/cri-dockerd.sock"</code></li></ul></li></ul><h4 id=初始化第一个主节点>初始化第一个主节点</h4><ul><li>该步骤开始尝试构建Kubernetes集群的master节点 配置完成后 各worker节点直接加入到集群中的即可</li><li>由于kubeadm部署的Kubernetes集群上 集群核心组件kube-apiserver、kube-controller-manager、kube-scheduler和etcd等均会以静态Pod的形式运行 它们所依赖的镜像文件默认来自于registry.k8s.io这一Registry服务之上</li><li>但我们无法直接访问该服务 常用的解决办法有如下两种<ul><li>使用能够到达该服务的代理服务</li><li>使用国内的镜像服务器上的服务 例如<code>registry.aliyuncs.com/google_containers</code>等</li></ul></li></ul><h5 id=初始化master节点>初始化master节点</h5><ul><li>在运行初始化命令之前先运行如下命令单独获取相关的镜像文件 而后再运行后面的<code>kubeadm init</code>命令 以便于观察到镜像文件的下载过程</li><li>若您选择使用的是docker-ce和cri-dockerd这一容器运行时环境 本文后续内容中使用的kubeadm命令 都需要额外添加<code>--cri-socket=unix:///var/run/cri-dockerd.sock</code>选项 以明确指定其所要关联的容器运行时</li><li>这是因为docker-ce和cri-dockerd都提供unix sock类型的socket地址 这会导致kubeadm在自动扫描和加载该类文件时无法自动判定要使用哪个文件 而使用containerd.io运行时 则不存在该类问题</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 下面的命令会列出类似如下的Image信息 由如下的命令结果可以看出 </span>
</span></span><span class=line><span class=cl><span class=c1># 相关的Image都来自于registry.k8s.io 该服务上的Image通常需要借助于代理服务才能访问到</span>
</span></span><span class=line><span class=cl>root@k8s-master01:~# kubeadm config images list
</span></span><span class=line><span class=cl>registry.k8s.io/kube-apiserver:v1.29.13
</span></span><span class=line><span class=cl>registry.k8s.io/kube-controller-manager:v1.29.13
</span></span><span class=line><span class=cl>registry.k8s.io/kube-scheduler:v1.29.13
</span></span><span class=line><span class=cl>registry.k8s.io/kube-proxy:v1.29.13
</span></span><span class=line><span class=cl>registry.k8s.io/coredns/coredns:v1.11.1
</span></span><span class=line><span class=cl>registry.k8s.io/pause:3.9
</span></span><span class=line><span class=cl>registry.k8s.io/etcd:3.5.16-0
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 若需要从国内的Mirror站点下载Image </span>
</span></span><span class=line><span class=cl><span class=c1># 还需要在命令上使用--image-repository选项来指定Mirror站点的相关URL</span>
</span></span><span class=line><span class=cl><span class=c1># 例如 下面的命令中使用了该选项将Image Registry指向国内可用的Aliyun的镜像服务 </span>
</span></span><span class=line><span class=cl><span class=c1># 其命令结果显示的各Image也附带了相关的URL</span>
</span></span><span class=line><span class=cl>root@k8s-master01:~# kubeadm config images list --image-repository<span class=o>=</span>registry.aliyuncs.com/google_containers
</span></span><span class=line><span class=cl>registry.aliyuncs.com/google_containers/kube-apiserver:v1.29.13
</span></span><span class=line><span class=cl>registry.aliyuncs.com/google_containers/kube-controller-manager:v1.29.13
</span></span><span class=line><span class=cl>registry.aliyuncs.com/google_containers/kube-scheduler:v1.29.13
</span></span><span class=line><span class=cl>registry.aliyuncs.com/google_containers/kube-proxy:v1.29.13
</span></span><span class=line><span class=cl>registry.aliyuncs.com/google_containers/coredns:v1.11.1
</span></span><span class=line><span class=cl>registry.aliyuncs.com/google_containers/pause:3.9
</span></span><span class=line><span class=cl>registry.aliyuncs.com/google_containers/etcd:3.5.16-0
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 运行下面的命令即可下载需要用到的各Image</span>
</span></span><span class=line><span class=cl><span class=c1># 需要注意的是 如果需要从国内的Mirror站点下载Image</span>
</span></span><span class=line><span class=cl><span class=c1># 同样需要在命令上使用--image-repository选项来指定Mirror站点的相关URL</span>
</span></span><span class=line><span class=cl>kubeadm config images pull --image-repository<span class=o>=</span>registry.aliyuncs.com/google_containers
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>---
</span></span><span class=line><span class=cl><span class=o>[</span>config/images<span class=o>]</span> Pulled registry.aliyuncs.com/google_containers/kube-apiserver:v1.29.13
</span></span><span class=line><span class=cl><span class=o>[</span>config/images<span class=o>]</span> Pulled registry.aliyuncs.com/google_containers/kube-controller-manager:v1.29.13
</span></span><span class=line><span class=cl><span class=o>[</span>config/images<span class=o>]</span> Pulled registry.aliyuncs.com/google_containers/kube-scheduler:v1.29.13
</span></span><span class=line><span class=cl><span class=o>[</span>config/images<span class=o>]</span> Pulled registry.aliyuncs.com/google_containers/kube-proxy:v1.29.13
</span></span><span class=line><span class=cl><span class=o>[</span>config/images<span class=o>]</span> Pulled registry.aliyuncs.com/google_containers/coredns:v1.11.1
</span></span><span class=line><span class=cl><span class=o>[</span>config/images<span class=o>]</span> Pulled registry.aliyuncs.com/google_containers/pause:3.9
</span></span><span class=line><span class=cl><span class=o>[</span>config/images<span class=o>]</span> Pulled registry.aliyuncs.com/google_containers/etcd:3.5.16-0
</span></span></code></pre></td></tr></table></div></div><ul><li>而后即可进行master节点初始化</li><li>kubeadm init命令支持两种初始化方式<ul><li>一是通过命令行选项传递关键的部署设定</li><li>另一个是基于yaml格式的专用配置文件(建议)</li><li>后一种允许用户自定义各个部署参数 在配置上更为灵活和便捷 下面分别给出了两种实现方式的配置步骤 建议读者采用第二种方式进行。</li></ul></li></ul><h6 id=方式1>方式1</h6><ul><li>运行如下命令完成k8s-master01节点的初始化</li><li>需要注意的是 若使用docker-ce和cri-dockerd运行时 则还要在如下命令上明确配置使用<code>--cri-socket=unix:///run/cri-dockerd.sock</code>选项</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubeadm init <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --control-plane-endpoint<span class=o>=</span><span class=s2>&#34;k8s-master01.minho.com&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --kubernetes-version<span class=o>=</span>v1.29.13 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --pod-network-cidr<span class=o>=</span>10.244.0.0/16 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --service-cidr<span class=o>=</span>10.96.0.0/12 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --token-ttl<span class=o>=</span><span class=m>0</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --upload-certs <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --cri-socket<span class=o>=</span>unix:///run/cri-dockerd.sock
</span></span></code></pre></td></tr></table></div></div><ul><li>各选项含义<ul><li><code>--image-repository</code> 指定要使用的镜像仓库 默认为<code>registry.k8s.io</code></li><li><code>--kubernetes-version</code> kubernetes程序组件的版本号 它必须要与安装的kubelet程序包的版本号相同</li><li><code>--control-plane-endpoint</code> 控制平面的固定访问端点 可以是IP地址或DNS名称 会被用于集群管理员及集群组件的kubeconfig配置文件的API Server的访问地址 单控制平面部署时可以不使用该选项</li><li><code>--pod-network-cidr</code> Pod网络的地址范围 其值为CIDR格式的网络地址 通常Flannel网络插件的默认为10.244.0.0/16 Calico插件的默认值为192.168.0.0/16 而Cilium的默认值为10.0.0.0/8</li><li><code>--service-cidr</code> Service的网络地址范围 其值为CIDR格式的网络地址 kubeadm使用的默认为10.96.0.0/12 通常 仅在使用Flannel一类的网络插件需要手动指定该地址</li><li><code>--apiserver-advertise-address</code> apiserver通告给其他组件的IP地址 一般应该为Master节点的用于集群内部通信的IP地址 0.0.0.0表示节点上所有可用地址</li><li><code>--token-ttl</code> 共享令牌(token)的过期时长 默认为24小时 0表示永不过期 为防止不安全存储等原因导致的令牌泄露危及集群安全 建议为其设定过期时长 未设定该选项时 在token过期后 若期望再向集群中加入其它节点 可以使用如下命令重新创建token 并生成节点加入命令<ul><li><code>kubeadm token create --print-join-command</code></li></ul></li><li>提示：无法访问<code>registry.k8s.io</code>时 同样可以在上面的命令中使用<code>--image-repository=registry.aliyuncs.com/google_containers</code>选项 以便从国内的镜像服务中获取各Image</li><li>注意：若各节点未禁用Swap设备 还需要附加选项<code>--ignore-preflight-errors=Swap</code> 从而让kubeadm忽略该错误设定</li></ul></li></ul><h6 id=方式二>方式二</h6><ul><li>kubeadm也可通过配置文件加载配置 以定制更丰富的部署选项 获取内置的初始配置文件的命令</li><li><code>kubeadm config print init-defaults</code></li><li>下面的配置示例 是以上面命令的输出结果为框架进行修改的 它明确定义了kubeProxy的模式为ipvs 并支持通过修改imageRepository的值修改获取系统镜像时使用的镜像仓库</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>kubeadm.k8s.io/v1beta3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>bootstrapTokens</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>groups</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>system:bootstrappers:kubeadm:default-node-token</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>token</span><span class=p>:</span><span class=w> </span><span class=l>minho.comc4mu9kzd5q7ur</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>ttl</span><span class=p>:</span><span class=w> </span><span class=l>24h0m0s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>usages</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>signing</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>authentication</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>InitConfiguration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>localAPIEndpoint</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 这里的地址即为初始化的控制平面第一个节点的IP地址</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>advertiseAddress</span><span class=p>:</span><span class=w> </span><span class=m>172.29.7.1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>bindPort</span><span class=p>:</span><span class=w> </span><span class=m>6443</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>nodeRegistration</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 注意 使用docker-ce和cri-dockerd时 要启用如下配置的cri socket文件的路径 </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># criSocket: unix:///run/cri-dockerd.sock</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>IfNotPresent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 第一个控制平面节点的主机名称</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>k8s-master01.minho.com</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>taints</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>effect</span><span class=p>:</span><span class=w> </span><span class=l>NoSchedule</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>node-role.kubernetes.io/master</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>effect</span><span class=p>:</span><span class=w> </span><span class=l>NoSchedule</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>node-role.kubernetes.io/control-plane</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiServer</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>timeoutForControlPlane</span><span class=p>:</span><span class=w> </span><span class=l>4m0s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 将下面配置中的certSANS列表中的值 修改为客户端接入API Server时可能会使用的各类目标地址</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>certSANs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>kubeapi.minho.com</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=m>172.29.7.1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=m>172.29.7.2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=m>172.29.7.3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=m>172.29.7.253</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>kubeadm.k8s.io/v1beta3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 控制平面的接入端点 我们这里选择适配到kubeapi.minho.com这一域名上</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>controlPlaneEndpoint</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;kubeapi.minho.com:6443&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>certificatesDir</span><span class=p>:</span><span class=w> </span><span class=l>/etc/kubernetes/pki</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>clusterName</span><span class=p>:</span><span class=w> </span><span class=l>kubernetes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>controllerManager</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>dns</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>etcd</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>local</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>dataDir</span><span class=p>:</span><span class=w> </span><span class=l>/var/lib/etcd</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>imageRepository</span><span class=p>:</span><span class=w> </span><span class=l>registry.aliyuncs.com/google_containers</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterConfiguration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kubernetesVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1.29.2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>networking</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 集群要使用的域名 默认为cluster.local</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>dnsDomain</span><span class=p>:</span><span class=w> </span><span class=l>cluster.local</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># service网络的地址</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>serviceSubnet</span><span class=p>:</span><span class=w> </span><span class=m>10.96.0.0</span><span class=l>/12</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># pod网络的地址 flannel网络插件默认使用10.244.0.0/16</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>podSubnet</span><span class=p>:</span><span class=w> </span><span class=m>10.244.0.0</span><span class=l>/16</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>scheduler</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>kubeproxy.config.k8s.io/v1alpha1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>KubeProxyConfiguration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 用于配置kube-proxy上为Service指定的代理模式 默认为iptables</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>mode</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;ipvs&#34;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>将上面的内容保存于配置文件中 例如kubeadm-config.yaml</li><li>而后执行如下命令即能实现类似前一种初始化方式中的集群初始配置 但这里将Service的代理模式设定为ipvs</li><li><code>kubeadm init --config kubeadm-config.yaml --upload-certs</code></li></ul><h4 id=初始化完成后的操作步骤>初始化完成后的操作步骤</h4><ul><li>对于Kubernetes系统的新用户来说 无论使用上述哪种方法 命令运行结束后 请记录最后的kubeadm join命令输出的最后提示的操作步骤</li><li>下面的内容是需要用户记录的一个命令输出示例 它提示了后续需要的操作步骤</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>Your Kubernetes control-plane has initialized successfully!
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>To start using your cluster, you need to run the following as a regular user:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  mkdir -p <span class=nv>$HOME</span>/.kube
</span></span><span class=line><span class=cl>  sudo cp -i /etc/kubernetes/admin.conf <span class=nv>$HOME</span>/.kube/config
</span></span><span class=line><span class=cl>  sudo chown <span class=k>$(</span>id -u<span class=k>)</span>:<span class=k>$(</span>id -g<span class=k>)</span> <span class=nv>$HOME</span>/.kube/config
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Alternatively, <span class=k>if</span> you are the root user, you can run:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nb>export</span> <span class=nv>KUBECONFIG</span><span class=o>=</span>/etc/kubernetes/admin.conf
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>You should now deploy a pod network to the cluster.
</span></span><span class=line><span class=cl>Run <span class=s2>&#34;kubectl apply -f [podnetwork].yaml&#34;</span> with one of the options listed at:
</span></span><span class=line><span class=cl>  https://kubernetes.io/docs/concepts/cluster-administration/addons/
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>You can now join any number of the control-plane node running the following <span class=nb>command</span> on each as root:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  kubeadm join k8s-master01.minho.com:6443 --token tkzmlw.406h8d9g8x9sf8z1 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --discovery-token-ca-cert-hash sha256:a32fe9b88096c3c0c22570a486302f58d3c479a8f1ccaf74b8fa4538a1a9d904 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --control-plane --certificate-key 502f1f1c87aea5a99dea3ee197878159f06a1f4178a8e7610ed228e6629a9414 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --cri-socket<span class=o>=</span>unix:///run/cri-dockerd.sock
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Please note that the certificate-key gives access to cluster sensitive data, keep it secret!
</span></span><span class=line><span class=cl>As a safeguard, uploaded-certs will be deleted in two hours<span class=p>;</span> If necessary, you can use
</span></span><span class=line><span class=cl><span class=s2>&#34;kubeadm init phase upload-certs --upload-certs&#34;</span> to reload certs afterward.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Then you can join any number of worker nodes by running the following on each as root:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>kubeadm join k8s-master01.minho.com:6443 --token tkzmlw.406h8d9g8x9sf8z1 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --discovery-token-ca-cert-hash sha256:a32fe9b88096c3c0c22570a486302f58d3c479a8f1ccaf74b8fa4538a1a9d904 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --cri-socket<span class=o>=</span>unix:///run/cri-dockerd.sock
</span></span></code></pre></td></tr></table></div></div><ul><li><code>kubeadm init</code>命令完整参考指南请移步<a class=link href=https://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm-init/ target=_blank rel=noopener>官方文档</a></li></ul><h5 id=设定kubectl>设定kubectl</h5><ul><li>kubectl是kube-apiserver的命令行客户端程序 实现了除系统部署之外的几乎全部的管理操作 是kubernetes管理员使用最多的命令之一</li><li>kubectl需经由API server认证及授权后方能执行相应的管理操作 kubeadm部署的集群为其生成了一个具有管理员权限的认证配置文件/etc/kubernetes/admin.conf</li><li>它可由kubectl通过默认的<code>$HOME/.kube/config</code>的路径进行加载 当然 用户也可在kubectl命令上使用&ndash;kubeconfig选项指定一个别的位置</li><li>下面复制认证为Kubernetes系统管理员的配置文件至目标用户(例如当前用户root)的家目录下<ul><li><code>mkdir ~/.kube</code> && <code>cp /etc/kubernetes/admin.conf ~/.kube/config</code></li></ul></li></ul><h5 id=部署网络插件>部署网络插件</h5><ul><li>Kubernetes系统上Pod网络的实现依赖于第三方插件进行 这类插件有近数十种之多 较为著名的有flannel、calico、canal和kube-router等 简单易用的实现为CoreOS提供的flannel项目</li><li>下面的命令用于在线部署flannel至Kubernetes系统之上 我们需要在初始化的第一个master节点k8s-master01上运行如下命令 以完成部署</li><li><code>kubectl apply -f https://github.com/flannel-io/flannel/releases/latest/download/kube-flannel.yml</code></li><li>而后使用如下命令确认其输出结果中Pod的状态为<code>Running</code> 类似如下命令及其输入的结果所示</li><li><code>kubectl get pods -n kube-flannel</code></li></ul><h5 id=验证master节点已经就绪>验证master节点已经就绪</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl get nodes
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 上述命令应该会得到类似如下输出 这表示k8s-master01节点已经就绪</span>
</span></span><span class=line><span class=cl>NAME                     STATUS   ROLES           AGE     VERSION
</span></span><span class=line><span class=cl>k8s-master01.minho.com   Ready    control-plane   5d22h   v1.29.12
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 若准备有其它的master节点 以构建高可用的控制平面</span>
</span></span><span class=line><span class=cl><span class=c1># 可按照初始化控制平面第一个节点时输出的信息 在额外的master节点上运行添加命令 以完成控制平面其它节点的添加</span>
</span></span><span class=line><span class=cl><span class=c1># 相关的命令是形如下在的相关信息</span>
</span></span><span class=line><span class=cl>kubeadm join k8s-master01.minho.com:6443 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --token tkzmlw.406h8d9g8x9sf8z1 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --discovery-token-ca-cert-hash sha256:a32fe9b88096c3c0c22570a486302f58d3c479a8f1ccaf74b8fa4538a1a9d904 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --control-plane --certificate-key 502f1f1c87aea5a99dea3ee197878159f06a1f4178a8e7610ed228e6629a9414 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --cri-socket<span class=o>=</span>unix:///run/cri-dockerd.sock
</span></span></code></pre></td></tr></table></div></div><h5 id=添加节点到集群中>添加节点到集群中</h5><ul><li><p>下面的两个步骤 需要分别在k8s-node01、k8s-node02和k8s-node03上各自完成</p><ul><li>若未禁用Swap设备 编辑kubelet的配置文件/etc/default/kubelet 设置其忽略Swap启用的状态错误<ul><li>内容如下：KUBELET_EXTRA_ARGS="&ndash;fail-swap-on=false"</li></ul></li><li>将节点加入第二步中创建的master的集群中 要使用主节点初始化过程中记录的kubeadm join命令<ul><li>再次提示 若使用docker-ce和cri-dockerd运行时环境 则需要在如下命令中额外添加<code>--cri-socket=unix:///run/cri-dockerd.sock</code>选项</li></ul></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubeadm join k8s-master01.minho.com:6443 --token tkzmlw.406h8d9g8x9sf8z1 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --discovery-token-ca-cert-hash sha256:a32fe9b88096c3c0c22570a486302f58d3c479a8f1ccaf74b8fa4538a1a9d904 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --cri-socket<span class=o>=</span>unix:///run/cri-dockerd.sock
</span></span></code></pre></td></tr></table></div></div></li></ul><h5 id=验证节点添加结果>验证节点添加结果</h5><ul><li>在每个节点添加完成后 即可通过kubectl验证添加结果</li><li>下面的命令及其输出是在所有的三个节点均添加完成后运行的 其输出结果表明三个Worker Node已经准备就绪</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>root@k8s-master01:~# kubectl get nodes
</span></span><span class=line><span class=cl>NAME                     STATUS   ROLES           AGE     VERSION
</span></span><span class=line><span class=cl>k8s-master01.minho.com   Ready    control-plane   5d22h   v1.29.12
</span></span><span class=line><span class=cl>k8s-node01.minho.com     Ready    &lt;none&gt;          5d22h   v1.29.12
</span></span><span class=line><span class=cl>k8s-node02.minho.com     Ready    &lt;none&gt;          5d22h   v1.29.12
</span></span><span class=line><span class=cl>k8s-node03.minho.com     Ready    &lt;none&gt;          5d22h   v1.29.12
</span></span></code></pre></td></tr></table></div></div><h5 id=测试应用编排及服务访问>测试应用编排及服务访问</h5><ul><li>到此为止 一个master/三个worker的kubernetes集群基础设施已经部署完成 用户随后即可测试其核心功能</li><li>例如 下面的命令可将demoapp以Pod的形式编排运行于集群之上 并通过在集群外部进行访问</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl create deployment demoapp --image<span class=o>=</span>ikubernetes/demoapp:v1.0 --replicas<span class=o>=</span><span class=m>3</span>
</span></span><span class=line><span class=cl>kubectl create service nodeport demoapp --tcp<span class=o>=</span>80:80
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 而后 使用如下命令了解Service对象demoapp使用的NodePort 以便于在集群外部进行访问</span>
</span></span><span class=line><span class=cl>root@k8s-master01:~# kubectl get svc -l <span class=nv>app</span><span class=o>=</span>demoapp
</span></span><span class=line><span class=cl>NAME     TYPE       CLUSTER-IP     EXTERNAL-IP   PORT<span class=o>(</span>S<span class=o>)</span>       AGE
</span></span><span class=line><span class=cl>demoapp   NodePort   10.100.84.12   &lt;none&gt;       80:30622/TCP   2s
</span></span></code></pre></td></tr></table></div></div><ul><li>demoapp是一个web应用 因此 用户可以于集群外部通过<code>http://NodeIP:30622</code>这个URL访问demoapp上的应用</li><li>我们也可以在Kubernetes集群上启动一个临时的客户端 对demoapp服务发起访问测试</li><li><code>kubectl run client-$RANDOM --image=ikubernetes/admin-box:v1.2 --rm --restart=Never -it --command -- /bin/bash</code></li><li>而后 在打开的交互式接口中 运行如下命令 对demoapp.default.svc服务发起访问请求 验证其负载均衡的效果</li><li><code>root@client-3021 ~# while true; do curl demoapp.default.svc; sleep 1; done</code></li><li>清理部署的测试应用<ul><li><code>kubectl delete deployments/demoapp services/demoapp</code></li></ul></li></ul><h5 id=部署add-ons可选步骤>部署Add-ons(可选步骤)</h5><ul><li>MetalLB</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 安装metalLB</span>
</span></span><span class=line><span class=cl>kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.14.9/config/manifests/metallb-native.yaml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 配置地址池</span>
</span></span><span class=line><span class=cl><span class=c1># IPAddressPool: 用来定义可分配的IP范围</span>
</span></span><span class=line><span class=cl><span class=c1># L2Advertisement: 在Layer2模式下通过ARP广播来承诺这些IP</span>
</span></span><span class=line><span class=cl>apiVersion: metallb.io/v1beta1
</span></span><span class=line><span class=cl>kind: IPAddressPool
</span></span><span class=line><span class=cl>metadata:
</span></span><span class=line><span class=cl>  name: default-pool
</span></span><span class=line><span class=cl>  namespace: metallb-system
</span></span><span class=line><span class=cl>spec:
</span></span><span class=line><span class=cl>  addresses:
</span></span><span class=line><span class=cl>    - 192.168.1.240-192.168.1.250
</span></span><span class=line><span class=cl>---
</span></span><span class=line><span class=cl>apiVersion: metallb.io/v1beta1
</span></span><span class=line><span class=cl>kind: L2Advertisement
</span></span><span class=line><span class=cl>metadata:
</span></span><span class=line><span class=cl>  name: l2-adv
</span></span><span class=line><span class=cl>  namespace: metallb-system
</span></span><span class=line><span class=cl>spec:
</span></span><span class=line><span class=cl>  ipAddressPools:
</span></span><span class=line><span class=cl>  - default-pool
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 接下来就可以创建LoadBalancer类型的Service使用</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>Ingress Nginx</li><li>Metrics Server</li><li>Kuboard</li></ul><h2 id=配置对多集群的访问>配置对多集群的访问</h2><p><a class=link href=https://kubernetes.io/zh-cn/docs/tasks/access-application-cluster/configure-access-multiple-clusters/ target=_blank rel=noopener>配置对多集群的访问</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 添加集群信息</span>
</span></span><span class=line><span class=cl>kubectl config --kubeconfig<span class=o>=</span>config-demo set-cluster development --server<span class=o>=</span>https://1.2.3.4 --certificate-authority<span class=o>=</span>fake-ca-file
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 添加用户信息</span>
</span></span><span class=line><span class=cl>kubectl config --kubeconfig<span class=o>=</span>config-demo set-credentials developer --client-certificate<span class=o>=</span>fake-cert-file --client-key<span class=o>=</span>fake-key-seefile
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 添加上下文</span>
</span></span><span class=line><span class=cl>kubectl config --kubeconfig<span class=o>=</span>config-demo set-context dev-frontend --cluster<span class=o>=</span>development --namespace<span class=o>=</span>frontend --user<span class=o>=</span>developer
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看配置文件详情</span>
</span></span><span class=line><span class=cl><span class=c1># 直接打开文件或使用如下命令</span>
</span></span><span class=line><span class=cl>kubectl config --kubeconfig<span class=o>=</span>config-demo view
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 设置当前上下文</span>
</span></span><span class=line><span class=cl>kubectl config --kubeconfig<span class=o>=</span>config-demo use-context dev-frontend
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用--minify参数 来查看与当前上下文相关联的配置信息</span>
</span></span><span class=line><span class=cl>kubectl config --kubeconfig<span class=o>=</span>config-demo view --minify
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 设置 KUBECONFIG 环境变量</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>KUBECONFIG</span><span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>KUBECONFIG</span><span class=si>}</span><span class=s2>:config-demo:config-demo-2&#34;</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=资源清单定义>资源清单定义</h2><ul><li><p>创建资源的方法</p><ul><li><p>apiserver仅接收json格式的资源定义</p></li><li><p>yaml格式提供配置清单 apiserver可自动将其转换为json格式 而后再提交</p></li></ul></li><li><p>大部分资源的配置清单 主要都有五个主要的部分组成</p><ul><li><p>apiversion</p><ul><li><code>kubectl api-versions</code> # 所属API群组</li><li>标识方式: <code>group/version</code> 省略组名则为core group</li></ul></li><li><p>kind: 资源类别</p></li><li><p>metadata: 元数据</p><ul><li>name: 同一类别中 name需要唯一</li><li>namespace: 所属k8s的哪个名称空间</li><li>labels</li><li>annotations</li><li>每个资源的引用PATH<ul><li><code>/api/${GROUP/VERSION}/namespace/${NAMESPACE}/${TYPE}/${NAME}</code></li></ul></li></ul></li><li><p>spec(重要): 定义用户期望的状态 disired state</p></li><li><p>status: 当前状态 current state 本字段由Kubernetes集群维护</p></li></ul></li><li><p>字段太多 可以借助<code>kubectl explain --help</code>命令查看详细信息</p><ul><li>kubectl explain pod</li><li>kubectl explain pod.metadata</li></ul></li></ul><h3 id=pod>Pod</h3><p><a class=link href=https://kubernetes.io/zh-cn/docs/concepts/workloads/pods/ target=_blank rel=noopener>pods</a></p><h4 id=自主式pod>自主式Pod</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>pod-demo</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>myapp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>tier</span><span class=p>:</span><span class=w> </span><span class=l>frontend</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>myapp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>nginx:alpine</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>busybox</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>busybox:latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>command</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=s2>&#34;/bin/sh&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=s2>&#34;-c&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=s2>&#34;sleep 3600&#34;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=pod资源>Pod资源</h4><ul><li><p>spec.containers &lt;[]object></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># kubectl explain pod.spec.containers</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>&lt;string&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>&lt;string&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>&lt;string&gt; </span><span class=w> </span><span class=c># Always Never IfNotPresent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=l>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 修改镜像中的默认应用</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>command/args</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>https://kubernetes.io/docs/tasks/inject-data-application/define-command-argument-container/</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></li><li><p>标签</p><ul><li>key = value<ul><li>key: 字母 数字 _ - .</li><li>value: 可以为空 只能字母或数字开头及结尾</li></ul></li></ul></li><li><p>标签选择器</p><ul><li>等值关系: =、==、!=(不等于会筛选出不具有该标签的资源)</li><li>集合关系<ul><li>KEY in (VALUE1,VALUE2,&mldr;)</li><li>KEY notin (VALUE1,VALUE2,&mldr;)</li><li>KEY # 存在这个KEY就行</li><li>!KEY # 不存在此键的资源</li></ul></li></ul></li><li><p>许多资源支持内嵌字段来使用标签选择器</p><ul><li>matchLabels: 直接给定键值</li><li>matchExpressions: 基于给定的表达式来定义使用标签选择器<ul><li>key: &ldquo;KEY&rdquo;, operator: &ldquo;OPERATOR&rdquo;, values: [VAL1,VAL2,VAL3,&mldr;]</li><li>操作符<ul><li>In、NotIn: values字段的值必须为非空列表</li><li>Exists、NotExists: values字段的值必须为空列表</li></ul></li></ul></li></ul></li><li><p>spec.nodeSelector &lt;map[striong]string></p><ul><li>节点标签选择器</li></ul></li><li><p>spec.nodeName <code>&lt;string></code> # 直接指定运行node</p></li><li><p>annotations</p><ul><li>与label不同的地方在于 它不能用于挑选资源对象 仅用于为对象提供<strong>元数据</strong></li><li>没有键长度/值长度限制</li></ul></li><li><p>spec.restartPolicy</p><ul><li>重启策略: One of Always, OnFailure, Never. Default to Always</li></ul></li></ul><h4 id=pod生命周期>Pod生命周期</h4><p><a class=link href=https://kubernetes.io/zh-cn/docs/concepts/workloads/pods/pod-lifecycle/ target=_blank rel=noopener>pod-lifecycle</a></p><ul><li><p>状态</p><ul><li>Pending # 调度尚未完成</li><li>Running # 运行状态</li><li>Failed</li><li>Succeeded</li><li>Unknown</li><li>&mldr;</li></ul></li><li><p>Pod生命周期中的重要行为</p><ul><li>初始化容器<ul><li>按顺序同步执行</li><li>执行成功才会继续执行下一个</li><li>若某一个执行失败 会全部重新执行</li><li>初始化容器具有阻塞的特性 初始化容器不执行完成 则阻塞着主容器的启动</li></ul></li><li>容器探测(自定义命令/TCP套接字发请求/HTTP应用层请求)<ul><li>start probe: 启动探测</li><li>liveness probe: 探测容器是否存活</li><li>readiness probe: 探测容器是否准备就绪 能对外提供服务</li></ul></li><li>钩子<ul><li>post start<ul><li>启动后钩子 在初始化容器执行完成 开始初始化主容器时 就会启动</li><li>所以 并不保证在主容器启动命令执行完成后再执行</li><li>有可能启动命令耗时较久 但是post start钩子已经执行完成</li></ul></li><li>pre stop<ul><li>停止前钩子</li></ul></li></ul></li></ul></li><li><p>preStop钩子延伸</p><ul><li>在k8s中 理想的状态是pod优雅释放 但并不是每一个pod都会如此顺利<ul><li>pod卡死 处理不了优雅退出的命令或操作</li><li>优雅退出的逻辑有bug 陷入死循环</li><li>代码问题 导致执行的命令没有效果</li></ul></li><li>对于以上问题 k8s的终止流程中还有一个 最多可以容忍的时间" 即<code>grace period</code></li><li>在<code>pod.spec.termiationGracePeriodSeconds</code>字段定义 默认值为30s</li><li>当我们执行<code>kubelet delete</code>的时候 也可以加上<code>--grace-period</code>参数显示指定一个优雅退出时间来覆盖pod中的配置</li><li>如果我们配置的<code>grace period</code>超过时间之后 k8s就只能强制kill pod</li><li>值得注意的是 这与preStop hook和SIGTERM信号并行发生 k8s不会等待preStop hook的完成 如果你的应用程序完成关闭并在<code>terminationGracePeriod</code>完成之前退出 k8s会立即进入下一步</li></ul><p><img src=/p/kubernetes/icons/pod-lifecycle.png width=1699 height=1081 srcset="/p/kubernetes/icons/pod-lifecycle_hu2bfece0da84b3c986dc09776ada24d78_200404_480x0_resize_box_3.png 480w, /p/kubernetes/icons/pod-lifecycle_hu2bfece0da84b3c986dc09776ada24d78_200404_1024x0_resize_box_3.png 1024w" loading=lazy alt=pod-lifecycle class=gallery-image data-flex-grow=157 data-flex-basis=377px></p></li></ul><h4 id=初始化容器>初始化容器</h4><p><a class=link href=https://kubernetes.io/zh-cn/docs/concepts/workloads/pods/init-containers/ target=_blank rel=noopener>init-cotainers</a></p><ul><li>init容器与普通容器非常像 除以下2点<ul><li>init容器总是运行到成功完成为止</li><li>每个init容器都必须在下一个init容器启动之前成功完成</li></ul></li><li>如果Pod的init容器失败 Kubernetes会不断的重启该Pod知道init容器成功为止</li><li>然后 如果Pod对应的<code>restartPolicy</code>为Never 它不会重新启动</li><li>initC与应用容器具备不同的镜像 可以把一些危险的工具放置在initC中 进行使用</li><li>initC多个之间时线形启动的 所以可以做一些延迟性的操作</li><li>initC不支持<code>lifeycle</code> <code>探针</code> 其他与应用容器无异</li></ul><h5 id=实验>实验</h5><ul><li>下面的例子定义了一个具有2个Init容器的简单Pod<ul><li>第一个等待myservice启动</li><li>第二个等待mydb启动</li><li>一旦这两个Init容器都启动完成 Pod将启动spec节中的应用容器</li></ul></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>initc-1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>initc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>myapp-container</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>busybox</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>command</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=s2>&#34;sh&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=s2>&#34;-c&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=s2>&#34;echo The app is running &amp;&amp; sleep 3600&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>initContainers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>init-myservice</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>busybox</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>command</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=s2>&#34;sh&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=s2>&#34;-c&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=s2>&#34;until nslookup myservice; do echo waiting for myservice; sleep 2; done;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>init-mydb</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>wangyanglinux/tools:busybox</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>command</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=s2>&#34;sh&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=s2>&#34;-c&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=s2>&#34;until nslookup mydb; do echo waiting for mydb; sleep2; done;&#34;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># kubectl apply -f initc.yaml</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看容器状态可以看到 目前卡在Init阶段 等待2个初始化容器的成功退出</span>
</span></span><span class=line><span class=cl><span class=c1># kubectl get -f initc.yaml</span>
</span></span><span class=line><span class=cl>NAME      READY   STATUS     RESTARTS   AGE
</span></span><span class=line><span class=cl>initc-1   0/1     Init:0/2   <span class=m>0</span>          35m
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看容器日志看到 应用容器在等待初始化 因为初始化容器阻塞了应用容器</span>
</span></span><span class=line><span class=cl><span class=c1># kubectl logs -f initc-1</span>
</span></span><span class=line><span class=cl>Defaulted container <span class=s2>&#34;myapp-container&#34;</span> out of: myapp-container, init-myservice <span class=o>(</span>init<span class=o>)</span>, init-mydb <span class=o>(</span>init<span class=o>)</span>
</span></span><span class=line><span class=cl>Error from server <span class=o>(</span>BadRequest<span class=o>)</span>: container <span class=s2>&#34;myapp-container&#34;</span> in pod <span class=s2>&#34;initc-1&#34;</span> is waiting to start: PodInitializing
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 也可以单独查看初始化容器的日志</span>
</span></span><span class=line><span class=cl><span class=c1># kubectl logs -f initc-1 -c init-myservice</span>
</span></span><span class=line><span class=cl>Server: 10.96.0.10
</span></span><span class=line><span class=cl>Address: 10.96.0.10:53
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>** server can not find myservice.default.svc.cluster.local: NXDOMAIN
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>waiting <span class=k>for</span> myservice
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 第二个初始化容器也被阻塞</span>
</span></span><span class=line><span class=cl><span class=c1># kubectl logs -f initc-1 -c init-db</span>
</span></span><span class=line><span class=cl>Error from server <span class=o>(</span>BadRequest<span class=o>)</span>: container <span class=s2>&#34;init-mydb&#34;</span> in pod <span class=s2>&#34;initc-1&#34;</span> is waiting to start: PodInitializing
</span></span></code></pre></td></tr></table></div></div><ul><li>增加对应service后 则init容器成功执行 应用容器正常初始化</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>myservice</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>TCP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=m>9376</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mydb</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>TCP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=m>9377</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=pod容器探针类型>Pod容器探针类型</h4><p><a class=link href=https://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/ target=_blank rel=noopener>配置探针</a></p><p><code>kubectl explain pod.spec.containers.livenessProbe</code>
<code>kubectl explain pod.spec.containers.readinessProbe</code></p><ul><li>exec Action</li><li>httpGet Action</li><li>tcpSocket Action</li></ul><h4 id=pod控制器>Pod控制器</h4><p><a class=link href=https://kubernetes.io/zh-cn/docs/concepts/architecture/controller/ target=_blank rel=noopener>控制器</a>
<a class=link href=https://kubernetes.io/zh-cn/docs/concepts/workloads/controllers/ target=_blank rel=noopener>工作负载管理</a></p><ul><li><p>ReplicaSet</p><ul><li>Kubectl explain replicaset</li><li>用户期望副本数 标签选择器 Pod资源模版</li><li>不建议直接使用ReplicaSet</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ReplicaSet</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>myapp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>myapp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>release</span><span class=p>:</span><span class=w> </span><span class=l>canary</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>myapp-pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>myapp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>release</span><span class=p>:</span><span class=w> </span><span class=l>canary</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>environment</span><span class=p>:</span><span class=w> </span><span class=l>qa</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>myapp-container</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>nginx:alpine</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>http</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></li><li><p>Deployment</p><ul><li>构建在ReplicaSet之上 而非Pod<ul><li>实现滚动更新(多出或少于N个副本 控制更新粒度)、回滚</li><li>通常管理10个历史版本(ReplicaSet)</li></ul></li><li>管理无状态应用最好的控制器</li><li>无状态(只关注群体、不关注个体)、持续运行应用</li><li>声明式管理(即可以创建 也可以更新 <code>kubectl apply -f deployment.yaml</code>)</li><li><code>kubectl rollout history</code> 查看滚动历史</li><li><code>kubectl rollout --help</code> 查看rollout所有子命名帮助<ul><li>注意：<code>kubectl rollout restart deployment/abc</code> # 重启Pod 实际是滚动更新 删掉重建新的Pod</li></ul></li></ul></li></ul><p><img src=/p/kubernetes/icons/deployment-update.png width=1728 height=566 srcset="/p/kubernetes/icons/deployment-update_hu1b11393a4a96395d8bc44f2effe78eee_1490645_480x0_resize_box_3.png 480w, /p/kubernetes/icons/deployment-update_hu1b11393a4a96395d8bc44f2effe78eee_1490645_1024x0_resize_box_3.png 1024w" loading=lazy alt=deployment-update class=gallery-image data-flex-grow=305 data-flex-basis=732px></p><ul><li><p>DaemonSet</p><ul><li><code>kubectl explain deployment.spec.strategy.rollingUpdate</code> # 滚动更新策略</li><li>确保集群中的每一个节点(或部分满足条件的节点)精确运行一个Pod副本</li><li>通常用于一些系统级的后台任务</li><li>无状态、持续运行应用</li></ul></li><li><p>Job</p><ul><li>只做一次 只要完成就正常退出 没完成才进行重构</li><li>执行一次性的作业</li><li>不需要持续在后台运行 执行完成就退出</li></ul></li><li><p>Cronjob</p><ul><li>周期性Job</li></ul></li><li><p>StatefulSet</p><ul><li>管理有状态应用</li><li>每一个pod副本单独管理 拥有自己独有的标识和独有的数据集</li></ul></li><li><p>TPR: Third Party Resources 1.2+ - 1.7</p></li><li><p>CDE: Custom Defined Resources 1.8+</p></li><li><p>Operator</p></li></ul><h3 id=service>Service</h3><h4 id=service代理>Service代理</h4><p><a class=link href=https://kubernetes.io/zh-cn/docs/concepts/services-networking/service/ target=_blank rel=noopener>services-networking</a></p><ul><li>userspace<ul><li>kube-proxy会监视Kubernetes控制平面对Service对象和Endpoints对象的添加和移除操作</li><li>对每个Service它会在本地Node上打开一个端口(随机选择) 任何连接到<strong>代理端口</strong>的请求 都会被代理到Service的后端<code>Pods</code>中的某个上面<ul><li>使用哪个后端Pod是 kube-proxy 基于<code>SessionAffinity</code>来确定的</li></ul></li><li>最后 它配置 iptables 规则 捕获到达该 Service 的<code>clusterIP</code>(是虚拟 IP)和<code>Port</code>的请求 并重定向到代理端口 代理端口再代理请求到后端Pod<ul><li>默认情况下 用户空间模式下的kube-proxy通过轮转算法选择后端</li></ul></li><li>流量来回在内核和用户空间切换 效率较低</li></ul></li></ul><p><img src=/p/kubernetes/icons/services-userspace-overview.svg loading=lazy alt=services-userspace-overview></p><ul><li>iptables<ul><li><p><code>kube-proxy</code>会监视Kubernetes控制节点对Service对象和Endpoints对象的添加和移除</p></li><li><p>对每个Service 它会配置iptables规则 从而捕获到达该Service的<code>clusterIP</code>和端口的请求 进而将请求重定向到 Service 的一组后端中的某个Pod上面</p></li><li><p>对于每个Endpoints对象 它也会配置iptables规则 这个规则会选择一个后端组合</p><ul><li>默认的策略是 kube-proxy在iptables模式下随机选择一个后端</li></ul></li><li><p>使用iptables处理流量具有较低的系统开销 因为流量由Linux netfilter处理 而无需在用户空间和内核空间之间切换 这种方法也可能更可靠</p></li><li><p>如果kube-proxy在iptables模式下运行 并且所选的第一个 Pod 没有响应 则连接失败</p><ul><li>这与用户空间模式不同: 在这种情况下 kube-proxy将检测到与第一个Pod的连接已失败 并会自动使用其他后端Pod 重试</li><li>可以使用Pod<a class=link href=https://kubernetes.io/zh-cn/docs/concepts/workloads/pods/pod-lifecycle/#container-probes target=_blank rel=noopener>就绪探测器</a> 验证后端Pod可以正常工作 以便iptables模式下的kube-proxy仅看到测试正常的后端 避免将流量通过kube-proxy发送到已知已失败的 Pod</li></ul></li></ul></li></ul><p><img src=/p/kubernetes/icons/services-iptables-overview.svg loading=lazy alt=services-iptables-overview></p><ul><li>ipvs<ul><li><p>特性状态： Kubernetes v1.11 [stable]</p></li><li><p>在<code>ipvs</code>模式下 kube-proxy监视Kubernetes服务和端点 调用<code>netlink</code>接口创建相应的IPVS规则 并定期将IPVS规则与Kubernetes服务和端点同步 该控制循环可确保 IPVS 状态与所需状态匹配</p></li><li><p>访问服务时 IPVS将流量定向到后端Pod之一</p></li><li><p>IPVS代理模式基于类似于iptables模式的netfilter挂钩函数 但是使用哈希表作为基础数据结构 并且在内核空间中工作</p><ul><li>这意味着 与iptables模式下的kube-proxy相比 IPVS模式下的kube-proxy重定向通信的延迟要短 并且在同步代理规则时具有更好的性能</li><li>与其他代理模式相比 IPVS模式还支持更高的网络流量吞吐量</li></ul></li><li><p>IPVS提供了更多选项来平衡后端Pod的流量</p><ul><li><code>rr</code>: 轮询(Round-Robin)</li><li><code>lc</code>: 最少链接(Least Connection) 即打开链接数量最少者优先</li><li><code>dh</code>: 目标地址哈希(Destination Hashing)</li><li><code>sh</code>: 源地址哈希(Source Hashing)</li><li><code>sed</code>: 最短预期延迟(Shortest Expected Delay)</li><li><code>nq</code>: 从不排队(Never Queue)</li></ul></li><li><p>备注</p><ul><li>要在IPVS模式下运行kube-proxy必须在启动kube-proxy之前使IPVS在节点上可用</li><li>当kube-proxy以IPVS代理模式启动时 它将验证IPVS内核模块是否可用<ul><li>如果未检测到IPVS内核模块 则kube-proxy将退回到以iptables代理模式运行</li></ul></li></ul></li></ul></li></ul><p><img src=/p/kubernetes/icons/services-ipvs-overview.svg loading=lazy alt=services-ipvs-overview></p><h4 id=service类型>Service类型</h4><ul><li>ClusterIP: 通过集群的内部IP暴露服务 选择该值时服务只能够在集群内部访问 这也是默认的<code>ServiceType</code></li><li><a class=link href=https://kubernetes.io/zh-cn/docs/concepts/services-networking/service/#type-nodeport target=_blank rel=noopener>NodePort</a>: 通过每个节点上的IP和静态端口(NodePort)暴露服务 NodePort服务会路由到自动创建的ClusterIP服务<ul><li>通过请求 <code>&lt;节点IP>:&lt;节点端口></code> 你可以从集群的外部访问一个NodePort服务</li><li>Client -> NodeIP:NodePort -> ClusterIP:ServicePort -> PodIP:containerPort</li><li>为避免单Node压力过大 会在外面再加一层负载均衡<ul><li>公有云环境: LBaaS(参考下面LoadBalancer类型)</li></ul></li></ul></li><li><a class=link href=https://kubernetes.io/zh-cn/docs/concepts/services-networking/service/#loadbalancer target=_blank rel=noopener>LoadBalancer</a>: 使用云提供商的负载均衡器向外部暴露服务 外部负载均衡器可以将流量路由到自动创建的NodePort服务和ClusterIP服务上</li><li><a class=link href=https://kubernetes.io/zh-cn/docs/concepts/services-networking/service/#externalname target=_blank rel=noopener>ExternalName</a>: 通过返回CNAME和对应值 可以将服务映射到externalName字段的内容(例如<code>foo.bar.example.com</code>) 无需创建任何类型代理<ul><li>FQDN(CoreDNS 内部解析)<ul><li>CNAME -> FQDN(外部真正的FQDN )</li></ul></li></ul></li></ul><h4 id=headless-services无头service>Headless Services(无头Service)</h4><ul><li>有时不需要或不想要负载均衡 以及单独的Service IP 遇到这种情况 可以通过指定Cluster IP(<code>spec.clusterIP</code>)的值为 <code>"None"</code>来创建 <code>Headless</code> Service</li><li>你可以使用一个无头Service与其他服务发现机制进行接口 而不必与Kubernetes的实现捆绑在一起</li><li>对于无头<code>Services</code>并不会分配Cluster IP kube-proxy不会处理它们 而且平台也不会为它们进行负载均衡和路由 DNS如何实现自动配置 依赖于Service是否定义了选择算符</li><li>无头Service允许客户端直接连接到它所偏好的任一Pod 无头Service不使用虚拟IP地址和代理配置路由和数据包转发 相反 无头Service通过内部DNS记录报告各个Pod的端点IP地址 这些DNS记录是由集群的DNS服务所提供 要定义无头 Service 你需要将<code>.spec.type</code>设置为ClusterIP(这也是type的默认值) 并进一步将<code>.spec.clusterIP</code>设置为 None</li></ul><h4 id=流量策略>流量策略</h4><p><a class=link href=https://kubernetes.io/zh-cn/docs/reference/networking/virtual-ips/#traffic-policies target=_blank rel=noopener>traffic-policies</a></p><ul><li><p>你可以设置<code>.spec.internalTrafficPolicy</code>和<code>.spec.externalTrafficPolicy</code>字段来控制kubernetes如何将流量路由到健康(&ldquo;就绪&rdquo;)的后端</p></li><li><p>内部流量策略</p><ul><li>特性状态： Kubernetes v1.26 [stable]</li><li>你可以设置<code>.spec.internalTrafficPolicy</code>字段来控制来自内部源的流量如何被路由 有效值为<code>Cluster</code>和<code>Local</code></li><li>将字段设置为<code>Cluster</code>会将内部流量路由到所有准备就绪的端点</li><li>将字段设置为<code>Local</code>仅会将流量路由到本地节点准备就绪的端点</li><li>如果流量策略为<code>Local</code>但没有本地节点端点 那么kube-proxy会<strong>丢弃</strong>该流量</li></ul></li><li><p>外部流量策略</p><ul><li>你可以设置<code>.spec.externalTrafficPolicy</code>字段来控制从外部源路由的流量 有效值为<code>Cluster</code>和<code>Local</code></li><li>将字段设置为<code>Cluster</code>会将外部流量路由到所有准备就绪的端点</li><li>将字段设置为<code>Local</code>仅会将流量路由到本地节点上准备就绪的端点</li><li>如果流量策略为<code>Local</code>并且没有本地节点端点 那么kube-proxy不会转发与相关Service相关的任何流量</li></ul></li></ul><h4 id=会话亲和性>会话亲和性</h4><p><a class=link href=https://kubernetes.io/zh-cn/docs/reference/networking/virtual-ips/#session-affinity target=_blank rel=noopener>session-affinity</a></p><ul><li>在这些代理模型中 绑定到<code>Service IP:Port</code>的流量被代理到合适的后端 客户端不需要知道任何关于Kubernetes、Service或Pod的信息</li><li>如果要确保来自特定客户端的连接每次都传递给同一个Pod 你可以通过设置Service的 <code>.spec.sessionAffinity</code>为<code>ClientIP</code>来设置基于客户端IP地址的会话亲和性</li><li>默认为<code>None</code></li></ul><h5 id=会话粘性超时>会话粘性超时</h5><ul><li>你还可以通过设置Service的<code>.spec.sessionAffinityConfig.clientIP.timeoutSeconds</code>来设置最大会话粘性时间</li><li>默认值为10800 即3小时</li><li>说明：在Windows上不支持为Service设置最大会话粘性时间</li></ul><h3 id=ingress>Ingress</h3><p><img src=/p/kubernetes/icons/ingress-flow.png width=1182 height=886 srcset="/p/kubernetes/icons/ingress-flow_hu9c99a0266fa357bab5ac86316de97a76_1018969_480x0_resize_box_3.png 480w, /p/kubernetes/icons/ingress-flow_hu9c99a0266fa357bab5ac86316de97a76_1018969_1024x0_resize_box_3.png 1024w" loading=lazy alt=ingress-flow class=gallery-image data-flex-grow=133 data-flex-basis=320px></p><p><a class=link href=https://kubernetes.io/zh-cn/docs/concepts/services-networking/ingress/ target=_blank rel=noopener>ingress</a></p><ul><li>Service对后端特定类型Pod分类(label selector)</li><li>Ingress基于上面的分类识别后端Pod 并生成配置信息注入到nginx(需要重载配置)/envoy/traefik等</li></ul><p><a class=link href=https://kubernetes.io/zh-cn/docs/concepts/services-networking/ingress-controllers/ target=_blank rel=noopener>ingress-controllers</a></p><h3 id=存储>存储</h3><p><a class=link href=https://kubernetes.io/zh-cn/docs/concepts/storage/ target=_blank rel=noopener>kubernetes-storage</a></p><p><code>kubectl explain pods.spec.volumes</code></p><ul><li>emptyDir # 临时目录 随pod删除而消失(生命周期同pod)<ul><li>gitRepo(clone到机器 修改不会同步 需要同步可以自己再做一个sidecar)</li></ul></li><li>hostPath # 宿主机路径</li><li>SAN(iSCSI&mldr;)、NAS(nfs、cifs&mldr;)</li><li>分布式存储<ul><li>glusterfs、rdb、cephfs</li></ul></li><li>云存储<ul><li>EBS、Azure Disk&mldr;</li></ul></li></ul><hr><ul><li>存储各类特性<ul><li>元数据<ul><li>configMap: 用于保存配置数据(明文)</li><li>secret: 用于保存敏感数据(编码)</li><li>downwardAPI: 容器在运行时从KubernetesAPI服务器获取有关它们自身的信息</li></ul></li><li>真实数据<ul><li>volume: 用于存储临时或者持久性数据</li><li>persistentVolume: 申请制的持久化存储</li></ul></li></ul></li></ul><h4 id=configmap>configMap</h4><ul><li>configMap是一种 API 对象 用来将非机密性的数据保存到键值对中</li><li>使用时<a class=link href=https://kubernetes.io/docs/concepts/workloads/pods/pod-overview/ target=_blank rel=noopener>Pods</a>可以将其用作环境变量、命令行参数或者存储卷中的配置文件</li><li>configMap将你的环境配置信息和<a class=link href="https://kubernetes.io/zh-cn/docs/reference/glossary/?all=true#term-image" target=_blank rel=noopener>容器镜像</a>解耦 便于应用配置的修改</li></ul><h5 id=容器化配置应用方式>容器化配置应用方式</h5><ul><li>自定义命令行参数<ul><li>args: []</li></ul></li><li>把配置文件直接打包至镜像</li><li>环境变量<ul><li>CloudNative的应用程序一般可直接通过环境变量加载配置</li><li>通过entrypoint脚本来预处理变量为配置文件中的配置信息</li></ul></li><li>存储卷</li></ul><h5 id=基于目录创建>基于目录创建</h5><ul><li>文件准备 都放到同一个目录下</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># game.properties</span>
</span></span><span class=line><span class=cl><span class=nv>enemies</span><span class=o>=</span>aliens
</span></span><span class=line><span class=cl><span class=nv>lives</span><span class=o>=</span><span class=m>3</span>
</span></span><span class=line><span class=cl>enemies.cheat<span class=o>=</span><span class=nb>true</span>
</span></span><span class=line><span class=cl>enemies.cheat.level<span class=o>=</span>noGoodRotten
</span></span><span class=line><span class=cl>secret.code.passphrase<span class=o>=</span>UUDDLRLRBABAS
</span></span><span class=line><span class=cl>secret.code.allowed<span class=o>=</span><span class=nb>true</span>
</span></span><span class=line><span class=cl>secret.code.lives<span class=o>=</span><span class=m>30</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ui.properties</span>
</span></span><span class=line><span class=cl>color.good<span class=o>=</span>purple
</span></span><span class=line><span class=cl>color.bad<span class=o>=</span>yellow
</span></span><span class=line><span class=cl>allow.textmode<span class=o>=</span><span class=nb>true</span>
</span></span><span class=line><span class=cl>how.nice.to.look<span class=o>=</span>fairlyNice
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># game-env-file.properties</span>
</span></span><span class=line><span class=cl><span class=nv>enemies</span><span class=o>=</span>aliens
</span></span><span class=line><span class=cl><span class=nv>lives</span><span class=o>=</span><span class=m>3</span>
</span></span><span class=line><span class=cl><span class=nv>allowed</span><span class=o>=</span><span class=s2>&#34;true&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># This comment and the empty line above it are ignored</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>从目录创建</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 从configMap目录创建</span>
</span></span><span class=line><span class=cl>kubectl create configmap game-config --from-file<span class=o>=</span>configMap/
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看内容</span>
</span></span><span class=line><span class=cl>kubectl describe  configmaps game-config
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># kubectl get configmaps game-config -o yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>game.properties</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    enemies=aliens
</span></span></span><span class=line><span class=cl><span class=sd>    lives=3
</span></span></span><span class=line><span class=cl><span class=sd>    enemies.cheat=true
</span></span></span><span class=line><span class=cl><span class=sd>    enemies.cheat.level=noGoodRotten
</span></span></span><span class=line><span class=cl><span class=sd>    secret.code.passphrase=UUDDLRLRBABAS
</span></span></span><span class=line><span class=cl><span class=sd>    secret.code.allowed=true
</span></span></span><span class=line><span class=cl><span class=sd>    secret.code.lives=30</span><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ui.properties</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    color.good=purple
</span></span></span><span class=line><span class=cl><span class=sd>    color.bad=yellow
</span></span></span><span class=line><span class=cl><span class=sd>    allow.textmode=true
</span></span></span><span class=line><span class=cl><span class=sd>    how.nice.to.look=fairlyNice</span><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ConfigMap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>creationTimestamp</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;2025-05-06T11:17:42Z&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>game-config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resourceVersion</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;15745032&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>uid</span><span class=p>:</span><span class=w> </span><span class=l>339da6be-8725-4c71-895d-33b6b29937c1</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=基于文件创建>基于文件创建</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 你可以使用 kubectl create configmap 基于单个文件或多个文件创建 ConfigMap</span>
</span></span><span class=line><span class=cl>kubectl create configmap game-config-2 --from-file<span class=o>=</span>configMap/game.properties
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 你可以多次使用 --from-file 参数 从多个数据源创建 ConfigMap</span>
</span></span><span class=line><span class=cl>kubectl create  configmap game-config-2 --from-file<span class=o>=</span>configMap/game.properties --from-file<span class=o>=</span>configMap/ui.properties
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># 使用 --from-env-file 选项基于 env 文件创建 ConfigMap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># Env 文件包含环境变量列表 其中适用以下语法规则:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#   Env 文件中的每一行必须为 VAR=VAL 格式</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#   以＃开头的行(即注释)将被忽略</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#   空行将被忽略</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#   引号不会被特殊处理(即它们将成为 ConfigMap 值的一部分)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># kubectl create configmap game-config-env-file --from-env-file=configMap/game-env-file.properties</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>allowed</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;&#34;true&#34;&#39;</span><span class=w>  </span><span class=c># 引号不会被特殊处理</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>enemies</span><span class=p>:</span><span class=w> </span><span class=l>aliens</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>lives</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;3&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ConfigMap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>creationTimestamp</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;2025-05-06T11:31:12Z&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>game-config-env-file</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resourceVersion</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;15746741&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>uid</span><span class=p>:</span><span class=w> </span><span class=l>a01e6c70-2f32-4e3f-814b-72bbf45d79d2</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># 从 Kubernetes 1.23 版本开始 kubectl 支持多次指定 --from-env-file 参数来从多个数据源创建 ConfigMap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># kubectl create configmap config-multi-env-files --from-env-file=configMap/game-env-file.properties --from-env-file=configMap/ui-env-file.properties</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>allowed</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;&#34;true&#34;&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>color</span><span class=p>:</span><span class=w> </span><span class=l>purple</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>enemies</span><span class=p>:</span><span class=w> </span><span class=l>aliens</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>how</span><span class=p>:</span><span class=w> </span><span class=l>fairlyNice</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>lives</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;3&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>textmode</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;true&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ConfigMap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>creationTimestamp</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;2025-05-06T11:36:40Z&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>config-multi-env-files</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resourceVersion</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;15747431&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>uid</span><span class=p>:</span><span class=w> </span><span class=l>194d9181-713a-4cc8-8218-ad4c5900f77b</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=定义从文件创建时要使用的键>定义从文件创建时要使用的键</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl create configmap game-config-3 --from-file<span class=o>=</span>&lt;我的键名&gt;<span class=o>=</span>&lt;文件路径&gt;
</span></span></code></pre></td></tr></table></div></div><h5 id=根据字面值创建>根据字面值创建</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># 你可以将 kubectl create configmap 与 --from-literal 参数一起使用 通过命令行定义文字值</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 你可以传入多个键值对 命令行中提供的每对键值在 ConfigMap 的 data 部分中均表示为单独的条目</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># kubectl create configmap special-config --from-literal=special.how=very --from-literal=special.type=charm</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>special.how</span><span class=p>:</span><span class=w> </span><span class=l>very</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>special.type</span><span class=p>:</span><span class=w> </span><span class=l>charm</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ConfigMap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>creationTimestamp</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;2025-05-06T11:44:19Z&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>special-config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resourceVersion</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;15748397&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>uid</span><span class=p>:</span><span class=w> </span><span class=l>6952c791-32e6-4905-a45c-c6a1433779ff</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=在pod中使用configmap定义的环境变量>在Pod中使用ConfigMap定义的环境变量</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># configmap.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ConfigMap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>special-config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>special.how</span><span class=p>:</span><span class=w> </span><span class=l>very</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ConfigMap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>env-config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>log_level</span><span class=p>:</span><span class=w> </span><span class=l>INFO</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># pod-configmap-env-variable.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>dapi-test-pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>test-container</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>ilolicon/demoapp:v1.0.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=w> </span><span class=s2>&#34;/bin/sh&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;-c&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;env&#34;</span><span class=w> </span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>SPECIAL_LEVEL_KEY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>configMapKeyRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>special-config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>special.how</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>LOG_LEVEL</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>configMapKeyRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>env-config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>log_level</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>restartPolicy</span><span class=p>:</span><span class=w> </span><span class=l>Never</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=将configmap中的所有键值对配置为容器环境变量>将ConfigMap中的所有键值对配置为容器环境变量</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># configmap.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 包含多个键值对</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ConfigMap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>special-config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>SPECIAL_LEVEL</span><span class=p>:</span><span class=w> </span><span class=l>very</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>SPECIAL_TYPE</span><span class=p>:</span><span class=w> </span><span class=l>charm</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># pod.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>dapi-test-pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>test-container</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>ilolicon/demoapp:v1.0.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=w> </span><span class=s2>&#34;/bin/sh&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;-c&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;env&#34;</span><span class=w> </span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>envFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>configMapRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>special-config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>restartPolicy</span><span class=p>:</span><span class=w> </span><span class=l>Never</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=在pod命令中使用configmap定义的环境变量>在Pod命令中使用ConfigMap定义的环境变量</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># pod.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>dapi-test-pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>test-container</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>ilolicon/demoapp:v1.0.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=w> </span><span class=s2>&#34;/bin/echo&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;$(SPECIAL_LEVEL_KEY) $(SPECIAL_TYPE_KEY)&#34;</span><span class=w> </span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>SPECIAL_LEVEL_KEY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>configMapKeyRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>special-config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>SPECIAL_LEVEL</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>SPECIAL_TYPE_KEY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>configMapKeyRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>special-config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>SPECIAL_TYPE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>restartPolicy</span><span class=p>:</span><span class=w> </span><span class=l>Never</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=将configmap数据添加到一个卷中>将ConfigMap数据添加到一个卷中</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c>#  pod.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>dapi-test-pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>test-container</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>ilolicon/demoapp:v1.0.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=w> </span><span class=s2>&#34;/bin/sh&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;-c&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;ls /etc/config/ &amp;&amp; sleep 3600&#34;</span><span class=w> </span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># 如果该容器镜像的 /etc/config 目录中有一些文件 卷挂载将使该镜像中的这些文件无法访问</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>config-volume</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/etc/config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>config-volume</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>configMap</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c># 提供包含要添加到容器中的文件的 ConfigMap 的名称</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>special-config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>restartPolicy</span><span class=p>:</span><span class=w> </span><span class=l>Never</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=热更新>热更新</h5><ul><li>当已挂载的 ConfigMap 被更新时 所投射的内容最终也会被更新 这适用于 Pod 启动后可选引用的 ConfigMap 重新出现的情况</li><li>更新 ConfigMap 目前并不会触发相关Pod的滚动更新(对于不能自动热更新的应用程序来说 则需要重新部署获取最新配置) 可以通过修改Pod的annotations 的方式强制触发滚动更新<ul><li><code>kubectl patch deployment &lt;your's deployment> --patch '{"spec":{"template":{"metadata":{"annotations":{"version/config":"6666666"}}}}}'</code></li></ul></li><li>更新 ConfigMap 后<ul><li>使用该ConfigMap挂载的Env不会同步更新</li><li>使用该ConfigMap挂载的volume中的数据需要一段时间才能同步更新<ul><li>从ConfigMap更新到新键映射到Pod的总延迟可能与 kubelet 同步周期(默认为1分钟) + kubelet 中 ConfigMap 缓存的 TTL (默认为1分钟)一样长 你可以通过更新 Pod 的一个注解来触发立即刷新</li></ul></li></ul></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># demoapp-configmap.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># configmap更新后 </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#   1. 如果demoapp不支持自动更新配置 则需要重新重新触发滚动更新 重新触发方式：更新pod注解实现</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#   2. 如果demoapp支持自动更新配置 则实时生效 无需重新发布应用</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>config.yaml</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    log_level: debug</span><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ConfigMap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>demoapp-config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># demoapp-hot-update-deployment.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>demoapp-hot-update</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>demoapp-hot-update</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>demoapp-hot-update</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>demoapp-hot-update</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>ilolicon/demoapp:v1.0.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>Always</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>demoapp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>config-volume</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/opt/demoapp/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>config-volume</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>configMap</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>demoapp-config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>demoapp-hot-update</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>demoapp-hot-update</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>TCP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=不可改变>不可改变</h5><ul><li>特性状态：<code>Kubernetes v1.21 [stable]</code></li><li>Kubernetes特性<code>Immutable</code> Secret和ConfigMap提供了一种将各个Secret和ConfigMap设置为不可变更的选项</li><li>对于大量使用ConfigMap的集群(至少有数万个各不相同的ConfigMap给Pod挂载)而言 禁止更改ConfigMap的数据有以下好处<ul><li>保护应用 使之免受意外(不想要的)更新所带来的负面影响</li><li>通过大幅降低对kube-apiserver的压力提升集群性能 这是因为系统会关闭对已标记为不可变更的ConfigMap的监视操作</li></ul></li><li>你可以通过将<code>immutable</code>字段设置为<code>true</code>创建不可变更的ConfigMap</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ConfigMap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=l>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=l>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>immutable</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>一旦某ConfigMap被标记为不可变更 则<strong>无法</strong>逆转这一变化 也无法更改data或binaryData字段的内容</li><li>你只能删除并重建ConfigMap 因为现有的Pod会维护一个已被删除的ConfigMap的挂载点 建议重新创建这些Pods</li></ul><h5 id=限制>限制</h5><ul><li>在<code>Pod</code>规约中引用某个<code>ConfigMap</code>之前 必须先创建这个对象 或者在<code>Pod</code>规约中将<code>ConfigMap</code>标记为<code>optional</code> 如果所引用的<code>ConfigMap</code>不存在 并且没有将应用标记为<code>optional</code> 则<code>Pod</code>将无法启动 同样 引用<code>ConfigMap</code>中不存在的主键也会令<code>Pod</code>无法启动 除非你将<code>Configmap</code>标记为<code>optional</code></li><li>如果你使用<code>envFrom</code>来基于<code>ConfigMap</code>定义环境变量 那么无效的键将被忽略 <code>Pod</code>可以被启动 但无效名称将被记录在事件日志中<code>InvalidVariableNames</code> 日志消息列出了每个被跳过的键</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># kubectl get events</span>
</span></span><span class=line><span class=cl>LASTSEEN FIRSTSEEN COUNT NAME          KIND  SUBOBJECT  TYPE      REASON                            SOURCE                MESSAGE
</span></span><span class=line><span class=cl>0s       0s        <span class=m>1</span>     dapi-test-pod Pod              Warning   InvalidEnvironmentVariableNames   <span class=o>{</span>kubelet, 127.0.0.1<span class=o>}</span>  Keys <span class=o>[</span>1badkey, 2alsobad<span class=o>]</span> from the EnvFrom configMap default/myconfig were skipped since they are considered invalid environment variable names.
</span></span></code></pre></td></tr></table></div></div><ul><li>ConfigMap位于确定的名字空间中 每个<code>ConfigMap</code>只能被同一名字空间中的<code>Pod</code>引用</li><li>你不能将<code>ConfigMap</code>用于静态<code>Pod</code> 因为<code>Kubernetes</code>不支持这种用法</li></ul><h4 id=secret>Secret</h4><ul><li>Secret是一种包含少量敏感信息例如密码、OAUTH令牌或SSH密钥的对象 这样的信息可能会被放在<a class=link href=https://kubernetes.io/docs/concepts/workloads/pods/pod-overview/ target=_blank rel=noopener>Pod</a>规约中或者镜像中</li><li>使用Secret意味着你不需要在应用程序代码中包含机密数据</li><li>Secret类似于<a class=link href=https://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/configure-pod-configmap/ target=_blank rel=noopener>ConfigMap</a>但专门用于保存敏感数据</li></ul><h5 id=特性>特性</h5><ul><li>Kubernetes通过仅仅将Secret分发到需要访问Secret的Pod所在机器节点来保障其安全性</li><li>Secret只会存储在几点的内存中 永不写入物理存储 这样从节点删除secret时就不需要擦除磁盘数据</li><li>从Kunernetes1.7版本开始 etcd会以加密形式存储Secret 一定程度的保证了Secret的安全性</li></ul><h5 id=类型>类型</h5><ul><li>创建Secret时 你可以使用Secret资源的<code>type</code>字段或者与其等价的kubectl命令行参数(如果有的话)为其设置类型</li><li>Secret类型有助于对Secret数据进行编程处理</li><li>Kubernetes提供若干种内置的类型 用于一些常见的使用场景 针对这些类型 Kubernetes所执行的合法性检查操作以及对其所实施的限制各不相同</li></ul><div class=table-wrapper><table><thead><tr><th>内置类型</th><th>用法</th></tr></thead><tbody><tr><td>Opaque</td><td>用户定义的任意数据</td></tr><tr><td>kubernetes.io/service-account-token</td><td>服务账号令牌</td></tr><tr><td>kubernetes.io/dockercfg</td><td>~/.dockercfg 文件的序列化形式</td></tr><tr><td>kubernetes.io/dockerconfigjson</td><td>~/.docker/config.json 文件的序列化形式</td></tr><tr><td>kubernetes.io/basic-auth</td><td>用于基本身份认证的凭据</td></tr><tr><td>kubernetes.io/ssh-auth</td><td>用于 SSH 身份认证的凭据</td></tr><tr><td>kubernetes.io/tls</td><td>用于 TLS 客户端或者服务器端的数据</td></tr><tr><td>bootstrap.kubernetes.io/token</td><td>启动引导令牌数据</td></tr></tbody></table></div><h5 id=opaque>Opaque</h5><ul><li>当你未在Secret清单中显式指定类型时 默认的Secret类型是Opaque</li><li>当你使用kubectl来创建一个Secret时 你必须使用generic子命令来标明要创建的是一个Opaque类型的Secret</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl create secret generic empty-secret
</span></span><span class=line><span class=cl>kubectl get secret empty-secret
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 输出</span>
</span></span><span class=line><span class=cl><span class=c1># DATA列显示Secret中保存的数据条目个数 在这个例子中 0意味着你刚刚创建了一个空的Secret</span>
</span></span><span class=line><span class=cl>NAME           TYPE     DATA   AGE
</span></span><span class=line><span class=cl>empty-secret   Opaque   <span class=m>0</span>      22h
</span></span></code></pre></td></tr></table></div></div><ul><li>Yaml资源清单创建</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Secret</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mysecret</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Opaque</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 值经过base64编码</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>username</span><span class=p>:</span><span class=w> </span><span class=l>dXNlcm5hbWU=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=l>cGFzc3dvcmQ=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># kubectl get secret mysecret -o yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=l>cGFzc3dvcmQ=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>username</span><span class=p>:</span><span class=w> </span><span class=l>dXNlcm5hbWU=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Secret</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>annotations</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>kubectl.kubernetes.io/last-applied-configuration</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>      {&#34;apiVersion&#34;:&#34;v1&#34;,&#34;data&#34;:{&#34;password&#34;:&#34;cGFzc3dvcmQ=&#34;,&#34;username&#34;:&#34;dXNlcm5hbWU=&#34;},&#34;kind&#34;:&#34;Secret&#34;,&#34;metadata&#34;:{&#34;annotations&#34;:{},&#34;name&#34;:&#34;mysecret&#34;,&#34;namespace&#34;:&#34;default&#34;}}</span><span class=w>      
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>creationTimestamp</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;2025-05-10T11:39:15Z&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mysecret</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resourceVersion</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;16477137&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>uid</span><span class=p>:</span><span class=w> </span><span class=l>6b70696f-dcd4-4b7d-a37e-8d1891b75077</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Opaque</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=pod中使用secret的数据定义环境变量>Pod中使用Secret的数据定义环境变量</h5><ul><li>如果容器已经使用了在环境变量中的Secret 除非容器重新启动 否则容器将无法感知到Secret的更新</li><li>有第三方解决方案可以在Secret改变时触发容器重启</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># pod.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>envvars-multiple-secrets</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>envars-test-container</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>ilolicon/demoapp:v1.0.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>APP_USERNAME</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>secretKeyRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mysecret</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>username</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>APP_PASSWORD</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>secretKeyRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mysecret</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>password</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># kubectl exec -it pods/envvars-multiple-secrets -- printenv | grep ^APP_</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 根据结果发现 secret使用时会自动解码</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>APP_USERNAME=username</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>APP_PASSWORD=password</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=secret-volume>Secret volume</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>secret-volume</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>secret-volume-pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>volumes-secret</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>secret</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>secretName</span><span class=p>:</span><span class=w> </span><span class=l>mysecret</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>ilolicon/demoapp:v1.0.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>demoapp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>volumes-secret</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/data&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># kubectl exec -it pods/secret-volume-pod -- cat -n /data/{username,password}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># /data 下面有2个文件 username和password</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=m>1</span><span class=w> </span><span class=l>username</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=m>2</span><span class=w> </span><span class=l>password</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 挂载指定key及指定目录</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>volumes-secret</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>secret</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>secretName</span><span class=p>:</span><span class=w> </span><span class=l>mysecret</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>items</span><span class=p>:</span><span class=w>  </span><span class=c># 未做软连接 无法热更新</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>username</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>my-group/my-username</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 进容器查看内容 cat /data/my-group/my-username</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>username</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=为secret键设置posix权限>为Secret键设置POSIX权限</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>volumes-secret</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>secret</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>secretName</span><span class=p>:</span><span class=w> </span><span class=l>mysecret</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>defaultMode</span><span class=p>:</span><span class=w> </span><span class=m>0644</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>说明<ul><li>如果使用JSON定义Pod或Pod模板 请注意JSON规范不支持数字的八进制形式</li><li>因为JSON将0400视为十进制的值400 在JSON中 要改为使用十进制的defaultMode</li><li>如果你正在编写YAML 则可以用八进制编写defaultMode</li></ul></li></ul><h5 id=热更新-1>热更新</h5><ul><li>ENV/挂载子路径 都不能自动更新<ul><li>除非容器重启 第三方方案可以监视Secret改变时 自动触发容器重启</li></ul></li><li>当卷中包含来自Secret的数据 而对应的Secret被更新 Kubernetes会跟踪到这一操作并更新卷中的数据 更新的方式是保证最终一致性</li></ul><h5 id=不可改变-1>不可改变</h5><ul><li>特性状态：<code>Kubernetes v1.21 [stable]</code></li><li>Kubernetes允许你将特定的Secret(和ConfigMap)标记为不可更改<code>Immutable</code> 禁止更改现有Secret的数据有下列好处<ul><li>防止意外(或非预期的)更新导致应用程序中断</li><li>(对于大量使用Secret的集群而言 至少数万个不同的Secret供Pod挂载) 通过将Secret标记为不可变 可以极大降低kube-apiserver的负载 提升集群性能 kubelet不需要监视那些被标记为不可更改的Secret</li></ul></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># 你也可以更改现有的Secret 令其不可更改</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Secret</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=l>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=l>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>immutable</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=downwardapi>downwardAPI</h4><ul><li><code>downwardAPI</code>卷用于为应用提供<strong>downwardAPI数据</strong> 在这类卷中 所公开的数据以纯文本格式的只读文件形式存在<ul><li>downwardAPI数据: 将Pod和容器字段值暴露给容器中运行的代码的机制</li></ul></li><li>downwardAPI是kubernetes中的一个功能 它允许容器在运行时从kubernetesAPI服务器获取有关它们自身的信息</li><li>这些信息可以作为容器内部的环境变量或文件注入到容器中 以便容器可以获取有关其运行环境的各种信息 如Pod名称/命名空间/标签等<ul><li>提供容器元数据</li><li>动态配置</li><li>与Kubernetes环境集成</li></ul></li><li>也可以注入env 或使用volume挂载<ul><li>volume优势<ul><li>会保持热更新特性</li><li>传递一个容器的资源到另一个容器中</li></ul></li></ul></li></ul><h5 id=扩展>扩展</h5><ul><li>downwardAPI提供了一种简单的方式 将pod和容器的元数据传递给它们内部运行的进程</li><li>但这种方式其实仅仅可以暴露一个pod自身的元数据传递给在它们内部运行的进程</li><li>这种方式仅仅可以暴露一个pod自身的元数据 而且只可以暴露部分元数据</li><li>还有另一种方式 从API服务器获取</li></ul><p><img src=/icons/downwardAPI-ext.png loading=lazy alt=downwardAPI-ext></p><ul><li>Kubetneres API文档</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># kubectl proxy --port=8080</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 获取swagger-ui配置</span>
</span></span><span class=line><span class=cl>curl http://127.0.0.1:8080/openapi/v2 &gt; k8s-swagger.json
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 粘贴至swagger在线UI</span>
</span></span><span class=line><span class=cl>https://editor.swagger.io/
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 或run本地swagger-ui服务器</span>
</span></span><span class=line><span class=cl>docker run --rm -d -p 80:8080 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -e <span class=nv>SWAGGER_JSON</span><span class=o>=</span>/k8s-swagger.json <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -v <span class=k>$(</span><span class=nb>pwd</span><span class=k>)</span>/k8s-swagger.json <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  swaggerapi/swagger-ui
</span></span></code></pre></td></tr></table></div></div><h4 id=volume>Volume</h4><ul><li><a class=link href=https://kubernetes.io/zh-cn/docs/concepts/storage/volumes/ target=_blank rel=noopener>数据的持久化方案</a></li><li>容器磁盘上的文件的生命周期是短暂的 这就使得在容器中运行重要应用时会出现一些问题<ul><li>首先 当容器崩溃时 kubelet会重启它 但是容器中的文件将丢失 容器以干净的状态(镜像最初的状态)重新启动</li><li>其次 在Pod中同时运行多个容器时 这些容器之间通常需要共享文件</li></ul></li><li>Kubernetes中的<code>Volume</code>抽象 就很好的解决了这些问题 部分最新版已启用 参考最新官方文档描述<ul><li>awsElasticBlockStore</li><li>azureDisk</li><li>cephfs</li><li>configMap</li><li>downwardAPI</li><li>emptyDir</li><li>gitRepo</li><li>glusterfs</li><li>hostPath</li><li>nfs</li><li>persistentVolumeClaim</li><li>secret</li><li>&mldr;</li></ul></li></ul><h5 id=emptydir>emptyDir</h5><ul><li>对于定义了emptyDir卷的Pod 在Pod被指派到某节点时此卷会被创建</li><li>就像其名称所表示的那样emptyDir卷最初是空的</li><li>尽管Pod中的容器挂载emptyDir卷的路径可能相同也可能不同 但这些容器都可以读写emptyDir卷中相同的文件</li><li>当Pod因为某些原因被从节点上删除时 emptyDir卷中的数据也会被永久删除</li></ul><blockquote><p><strong>说明:</strong>
容器崩溃并不会导致Pod被从节点上移除 因此容器崩溃期间emptyDir卷中的数据是安全的</p></blockquote><ul><li>emptyDir的一些用途：<ul><li>缓存空间 例如基于磁盘的归并排序</li><li>为耗时较长的计算任务提供检查点 以便任务能方便地从崩溃前状态恢复执行</li><li>在Web服务器容器服务数据时 保存内容管理器容器获取的文件</li></ul></li></ul><h5 id=hostpath>hostPath</h5><ul><li><code>hostPath</code>卷能将主机节点文件系统上的文件或目录挂载到你的Pod中 虽然这不是大多数Pod需要的 但是它为一些应用提供了强大的逃生舱</li><li>用途<ul><li>运行一个需要访问节点级系统组件的容器<ul><li>运行需要你访问Docker内部的容器 使用<code>/var/lib/docker</code>的<code>hostPath</code></li><li>在容器中运行cAdvisor 使用<code>/dev/cgroups</code>的<code>hostPath</code></li><li>例如一个将系统日志传输到集中位置的容器 使用只读挂载<code>/var/log</code>来访问这些日志</li></ul></li><li>让存储在主机系统上的配置文件可以被静态Pod以只读方式访问 与普通Pod不同 静态Pod无法访问ConfigMap<ul><li>静态Pod(Static Pod): 是由特定节点上的kubelet守护进程直接管理的Pod(/etc/kubernetes/manifests)</li><li>它并不经过常规的 APIServer -> ControllerManager -> kubelet的控制链路</li></ul></li></ul></li></ul><blockquote><p>警告：
使用<code>hostPath</code>类型的卷存在许多安全风险 如果可以 你应该尽量避免使用<code>hostPath</code>卷 例如 你可以改为定义并使用 local PersistentVolume</p><p>如果你通过准入时的验证来限制对节点上特定目录的访问 这种限制只有在你额外要求所有<code>hostPath</code>卷的挂载都是只读的情况下才有效 如果你允许不受信任的<code>Pod</code>以读写方式挂载任意主机路径 则该<code>Pod</code>中的容器可能会破坏可读写主机挂载卷的安全性</p><p>无论<code>hostPath</code>卷是以只读还是读写方式挂载 使用时都需要小心 这是因为：</p><ul><li>访问主机文件系统可能会暴露特权系统凭证(例如kubelet的凭证)或特权API(例如容器运行时套接字) 这些可以被用于容器逃逸或攻击集群的其他部分</li><li>具有相同配置的Pod(例如基于PodTemplate创建的Pod)可能会由于节点上的文件不同而在不同节点上表现出不同的行为</li><li><code>hostPath</code>卷的用量不会被视为临时存储用量 你需要自己监控磁盘使用情况 因为过多的<code>hostPath</code>磁盘使用量会导致节点上的磁盘压力</li></ul></blockquote><h6 id=hostpath卷类型>hostPath卷类型</h6><div class=table-wrapper><table><thead><tr><th>取值</th><th>行为</th></tr></thead><tbody><tr><td>""</td><td>空字符串(默认)用于向后兼容 这意味着在安装<code>hostPath</code>卷之前不会执行任何检查</td></tr><tr><td>DirectoryOrCreate</td><td>如果在给定路径上什么都不存在 那么将根据需要创建空目录 权限设置为0755 具有与kubelet相同的组和属主信息</td></tr><tr><td>Directory</td><td>在给定路径上必须存在的目录</td></tr><tr><td>FileOrCreate</td><td>如果在给定路径上什么都不存在 那么将在那里根据需要创建空文件 权限设置为0644 具有与kubelet相同的组和所有权</td></tr><tr><td>File</td><td>在给定路径上必须存在的文件</td></tr><tr><td>Socket</td><td>在给定路径上必须存在的UNIX套接字</td></tr><tr><td>CharDevice</td><td><strong>(仅Linux节点)</strong> 在给定路径上必须存在的字符设备</td></tr><tr><td>BlockDevice</td><td><strong>(仅Linux节点)</strong> 在给定路径上必须存在的块设备</td></tr></tbody></table></div><h6 id=注意>注意</h6><ul><li><code>FileOrCreate</code>模式不会创建文件的父目录 如果挂载文件的父目录不存在 Pod将启动失败 为了确保这种模式正常工作 你可以尝试分别挂载目录和文件</li><li>当Kubernetes按照计划添加资源感知调度时 将无法考虑<code>hostPath</code>使用的资源</li><li>底层主机上创建的某些文件或目录只能由<code>root</code>用户访问 此时 你需要在特权容器中以<code>root</code>身份运行进程 或者修改主机上的文件权限 以便能够从<code>hostPath</code>卷读取数据(或将数据写入到<code>hostPath</code>卷)</li></ul><h4 id=pvpvc>PV/PVC</h4><p><img src=/p/kubernetes/icons/pvc.png width=2308 height=1179 srcset="/p/kubernetes/icons/pvc_hu6506faa16d4cf2c7f542f2e52c106e00_156879_480x0_resize_box_3.png 480w, /p/kubernetes/icons/pvc_hu6506faa16d4cf2c7f542f2e52c106e00_156879_1024x0_resize_box_3.png 1024w" loading=lazy alt=pvc class=gallery-image data-flex-grow=195 data-flex-basis=469px></p><ul><li>存储的管理是一个与计算实例的管理完全不同的问题 PersistentVolume子系统为用户和管理员提供了一组API 将存储如何制备的细节从其如何被使用中抽象出来</li><li>为了实现这点 Kubernetes引入了两个心的API资源<ul><li>PersistentVolume</li><li>PersistentVolumeClaim</li></ul></li><li><strong>持久卷(PersistentVolume PV)</strong><ul><li>是集群中的一块存储 可以由管理员事先制备 或者使用存储类(Storage Class)来动态制备</li><li>持久卷是集群级别的资源 就像节点也是集群资源一样</li><li>PV持久卷和普通的Volume一样 也是使用卷插件来实现的 只是它们拥有独立于任何使用PV的Pod的生命周期</li><li>此API对象中记述了存储的实现细节 无论其背后是NFS、iSCSI还是特定于云平台的存储系统</li></ul></li><li><strong>持久卷声明(PersistentVolumeClaim PVC)</strong><ul><li>表达的是用户对存储的请求 概念上与Pod类似</li><li>Pod会耗用节点资源 而PVC申领会耗用PV资源</li><li>Pod可以请求特定数量的资源(CPU和内存) 同样PVC申领也可以请求特定的大小和访问模式<ul><li>例如 可以挂载为ReadWriteOnce、ReadOnlyMany、ReadWriteMany或ReadWriteOncePod</li></ul></li></ul></li></ul><h5 id=关联条件>关联条件</h5><ul><li>容量: PV的值不小于PVC要求 可以大于 最好一致</li><li>读写策略(访问模式)：完全匹配<ul><li>单节点读写：ReadWriteOnce / RWO</li><li>多节点只读：ReadOnlyMany / ROX</li><li>多节点读写：ReadWriteMany / RWX</li><li>ReadWriteOncePod / RWOP: v1.29[stable]<ul><li>卷可以被单个Pod以读写方式挂载</li><li>如果你想确保整个集群中只有一个Pod可以读取或写入该PVC 使用该方式</li></ul></li></ul></li><li>存储类：PV的类与PVC的类必须一致 不存在包容降级关系</li></ul><h5 id=回收策略reclaiming>回收策略(Reclaiming)</h5><ul><li>当用户不再使用其存储卷时 他们可以从API中将PVC对象删除 从而允许该资源被回收再利用</li><li>PersistentVolume对象的回收策略告诉集群 当其被从申领中释放时如何处理该数据卷</li><li>目前 数据卷可以被Retained(保留) Recycled(回收) Deleted(删除)</li></ul><hr><ul><li><p><strong>保留(Retain)</strong></p><ul><li>回收策略<code>Retain</code>使得用户可以手动回收资源</li><li>当PersistentVolumeClaim对象被删除时 PersistentVolume卷仍然存在 对应的数据卷被视为"已释放(released)"</li><li>由于卷上仍然存在这前一申领人的数据 该卷还不能用于其他申领 管理员可以通过下面的步骤来手动回收该卷：<ul><li>删除PersistentVolume对象 与之相关的、位于外部基础设施中的存储资产在PV删除之后仍然存在</li><li>根据情况 手动清除所关联的存储资产上的数据</li><li>手动删除所关联的存储资产</li></ul></li><li>如果你希望重用该存储资产 可以基于存储资产的定义创建新的PersistentVolume卷对象</li></ul></li><li><p><strong>删除(Delete)</strong></p><ul><li>对于支持<code>Delete</code>回收策略的卷插件 删除动作会将PersistentVolume对象从Kubernetes中移除 同时也会从外部基础设施中移除所关联的存储资产</li><li>动态制备的卷会继承<a class=link href=https://kubernetes.io/zh-cn/docs/concepts/storage/persistent-volumes/#reclaim-policy target=_blank rel=noopener>其StorageClass中设置的回收策略</a> 该策略默认为Delete</li><li>管理员需要根据用户的期望来配置StorageClass 否则PV卷被创建之后必须要被编辑或者修补 参阅<a class=link href=https://kubernetes.io/zh-cn/docs/tasks/administer-cluster/change-pv-reclaim-policy/ target=_blank rel=noopener>更改PV卷的回收策略</a></li></ul></li><li><p><strong>回收(Recyle)</strong></p><ul><li><strong>警告</strong>: 回收策略<code>Recycle</code>已被废弃 取而代之的建议方案是使用动态制备</li><li>如果底层的卷插件支持 回收策略<code>Recycle</code>会在卷上执行一些基本的擦除(<code>rm -rf /thevolume/*</code>)操作 之后允许该卷用于新PVC申领</li></ul></li></ul><h5 id=卷阶段状态>卷阶段(状态)</h5><p>每个持久卷会处于以下阶段(Phase)之一：</p><ul><li><strong>Available</strong> 卷是一个空闲资源 尚未绑定到任何申领</li><li><strong>Bound</strong> 该卷已经绑定到某申领</li><li><strong>Released</strong> 所绑定的申领已被删除 但是关联存储资源尚未被集群回收</li><li><strong>Failed</strong> 卷的自动回收操作失败</li></ul><p>你可以使用<code>kubectl describe persistentvolume &lt;name></code>查看已绑定到PV的PVC的名称</p><h5 id=pvc保护>PVC保护</h5><ul><li>PVC保护的目的是确保由Pod正在使用的PVC不会从系统中移除 因为如果被移除的话可能导致数据丢失</li><li>注意：当Pod状态为<code>Pending</code>并且Pod已经分配给节点 或Pod为<code>Running</code>状态时 PVC处于活动状态</li><li>当启用PVC保护功能时 如果用户删除了一个Pod正在使用的PVC 则该PVC不会被立即删除 PVC的删除将被推迟 直到PVC不再被任何的Pod使用</li></ul><h4 id=示例>示例</h4><p><a class=link href=https://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/configure-persistent-volume-storage/ target=_blank rel=noopener>配置Pod以使用PersistentVolume作为存储</a></p><h4 id=storageclass>StorageClass</h4><ul><li><p>存储设备需支持RESTful风格的创建请求</p></li><li><p>根据请求动态创建PV</p></li><li><p><a class=link href=https://github.com/kubernetes-sigs/nfs-subdir-external-provisioner target=_blank rel=noopener>nfs-subdir-external-provisioner</a></p></li><li><p>部署NFS服务器</p></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>apt-get upate
</span></span><span class=line><span class=cl>apt install -y nfs-kernerl-server
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>mkdir /nfs/data
</span></span><span class=line><span class=cl>chown nobody -R /nfs
</span></span><span class=line><span class=cl>/etc/exports
</span></span><span class=line><span class=cl>  /nfs/data *<span class=o>(</span>rw,sync,no_subtree_check<span class=o>)</span>
</span></span><span class=line><span class=cl>systemctl restart nfs-server
</span></span><span class=line><span class=cl>showmount -e 192.168.56.75
</span></span></code></pre></td></tr></table></div></div><ul><li>部署nfs-client-provisioner</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nfs-client-provisioner</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>nfs-storageclass</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>nfs-client-provisioner</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>strategy</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Recreate</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>nfs-client-provisioner</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>serviceAccountName</span><span class=p>:</span><span class=w> </span><span class=l>nfs-client-provisioner</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nfs-client-provisioner</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>eipwork/nfs-subdir-external-provisioner:v4.0.2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nfs-client-root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/persistentvolumes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>PROVISIONER_NAME</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=l>k8s-sigs.io/nfs-subdir-external-provisioner</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>NFS_SERVER</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=m>192.168.56.75</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>NFS_PATH</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=l>/nfs/data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nfs-client-root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>nfs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c># server: &lt;YOUR NFS SERVER HOSTNAME&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>server</span><span class=p>:</span><span class=w> </span><span class=m>192.168.56.75</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c># share nfs path</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/nfs/data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ServiceAccount</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nfs-client-provisioner</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>nfs-storageclass</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRole</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nfs-client-provisioner-runner</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>apiGroups</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;&#39;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;nodes&#39;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>verbs</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;get&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;list&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;watch&#39;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>apiGroups</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;&#39;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;persistentvolumes&#39;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>verbs</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;get&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;list&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;watch&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;create&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;delete&#39;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>apiGroups</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;&#39;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;persistentvolumeclaims&#39;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>verbs</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;get&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;list&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;watch&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;update&#39;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>apiGroups</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;storage.k8s.io&#39;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;storageclasses&#39;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>verbs</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;get&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;list&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;watch&#39;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>apiGroups</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;&#39;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;events&#39;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>verbs</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;create&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;update&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;patch&#39;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRoleBinding</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>run-nfs-client-provisioner</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>subjects</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ServiceAccount</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nfs-client-provisioner</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># replace with namespace where provisioner is deployed</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>nfs-storageclass</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>roleRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRole</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nfs-client-provisioner-runner</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Role</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>leader-locking-nfs-client-provisioner</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># replace with namespace where provisioner is deployed</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>nfs-storageclass</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>apiGroups</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;&#39;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;endpoints&#39;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>verbs</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;get&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;list&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;watch&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;create&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;update&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;patch&#39;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>RoleBinding</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>leader-locking-nfs-client-provisioner</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># replace with namespace where provisioner is deployed</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>nfs-storageclass</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>subjects</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ServiceAccount</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nfs-client-provisioner</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># replace with namespace where provisioner is deployed</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>nfs-storageclass</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>roleRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Role</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>leader-locking-nfs-client-provisioner</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>storage.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>StorageClass</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nfs-client</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>nfs-storageclass</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>provisioner</span><span class=p>:</span><span class=w> </span><span class=l>k8s-sigs.io/nfs-subdir-external-provisioner</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>parameters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>pathPattern</span><span class=p>:</span><span class=w> </span><span class=l>${.PVC.namespace}/${.PVC.name}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>onDelete</span><span class=p>:</span><span class=w> </span><span class=l>delete</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>测试</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># test-pod.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>PersistentVolumeClaim</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>test-claim</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>accessModes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>ReadWriteMany</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>storage</span><span class=p>:</span><span class=w> </span><span class=l>1Mi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>storageClassName</span><span class=p>:</span><span class=w> </span><span class=l>nfs-client</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>test-pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>test-pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>ilolicon/demoapp:v1.0.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nfs-pvc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/opt/demoapp/nfsdata</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>restartPolicy</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;Never&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nfs-pvc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>persistentVolumeClaim</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>claimName</span><span class=p>:</span><span class=w> </span><span class=l>test-claim</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=statefulset控制器>StatefulSet控制器</h2><ul><li><p>CoreOS Operator</p></li><li><p>cattle/pet # 一个关注群体 一个关注个体(和无状态应用的区别)</p></li><li><p>PetSet(1.3) -> StatefulSet(1.5+)</p></li><li><p>StatefulSet主要用于管理有以下特性的应用程序</p><ul><li>稳定且唯一的网络标识符</li><li>稳定且持久的存储</li><li>有序、平滑的部署和扩展</li><li>有序、平滑的终止和删除</li><li>有序的滚动更新</li></ul></li><li><p>一般来说 一个典型的StatefulSet由三个组件组成</p><ul><li>handless service # 无头服务 确保名称唯一</li><li>StatefulSet # 控制器</li><li>volumeClaimTemplate # 存储卷申请模版(不能使用同一存储卷 pod模版创建的存储卷都是一样的 所以需要卷申请模版)</li></ul></li><li><p><code>kubelet explain sts.spec.updateStrategy.rollingUpdate</code></p><ul><li>partition &lt;inter> # 控制更新的Pod</li><li>partition: N # 大于等于编号N的Pod将被更新 默认值: 0</li></ul></li><li><p>示例</p></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># 创建PV</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>PersistentVolume</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nfspv1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>capacity</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>storage</span><span class=p>:</span><span class=w> </span><span class=l>1Gi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>accessModes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>ReadWriteOnce</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>persistentVolumeReclaimPolicy</span><span class=p>:</span><span class=w> </span><span class=l>Recycle</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>storageClassName</span><span class=p>:</span><span class=w> </span><span class=l>nfs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>nfs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/nfs/pv1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>server</span><span class=p>:</span><span class=w> </span><span class=m>192.168.56.75</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># statefulset</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>myapp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>myapp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>web</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 无头服务 访问: &lt;podName&gt;.&lt;svcName&gt;.default.svc.cluster.local 可访问到具体pod地址</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>clusterIP</span><span class=p>:</span><span class=w> </span><span class=l>None</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>myapp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>StatefulSet</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>web</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>myapp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>serviceName</span><span class=p>:</span><span class=w> </span><span class=l>myapp</span><span class=w> </span><span class=c># kubectl explain statefulsets.apps.spec.serviceName</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>myapp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>myapp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>ilolicon/demoapp:v1.0.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>web</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/opt/demoapp/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>volumeClaimTemplates</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>accessModes</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;ReadWriteOnce&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>storageClassName</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;nfs&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>storage</span><span class=p>:</span><span class=w> </span><span class=l>1Gi</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=调度器>调度器</h2><h3 id=概念>概念</h3><p><a class=link href=https://kubernetes.io/zh-cn/docs/concepts/scheduling-eviction/kube-scheduler/ target=_blank rel=noopener>kubernetes调度器</a></p><p><a class=link href=https://kubernetes.io/zh-cn/docs/concepts/workloads/pods/pod-qos/ target=_blank rel=noopener>Pod QoS类</a></p><p><a class=link href=https://kubernetes.io/zh-cn/docs/concepts/configuration/manage-resources-containers/ target=_blank rel=noopener>为Pod和容器管理资源</a></p><ul><li>kube-scheduler是kubernetes的调度器 主要任务是把定义的Pod分配到集群的节点上</li></ul><p><img src=/icons/kube-scheduler.png loading=lazy alt=kube-scheduler></p><ul><li>scheduler是作为单独的程序运行的 启动之后会一致监听API Server 获取<code>PodSpec.NodeName</code>为空的pod 对每个Pod都会创建一个binding 表明该pod应该放到哪个节点上</li><li>需要考虑的问题<ul><li>公平：如何保证每个节点都能被分配资源</li><li>资源高效利用：集群所有资源最大化被使用</li><li>效率：调度的性能要好 能够尽快地对大批量的pod完成调度工作</li><li>灵活：允许用户根据自己的需求控制调度的逻辑</li></ul></li><li>除来kuberneres自带的调度器 你也可以编写自己的调度器 通过<code>spec.schedulerName</code>参数指定调度器的名字 可以为pod选择某个调度器进行调度</li></ul><h4 id=自定义调度器示例>自定义调度器示例</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>demoapp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>demoapp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>schedulerName</span><span class=p>:</span><span class=w> </span><span class=l>my-scheduler </span><span class=w> </span><span class=c># 指定自定义调度器</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>pod-with-custom-scheduler</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>iamge</span><span class=p>:</span><span class=w> </span><span class=l>ilolicon/demoapp:v1.0.0</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 在 kubernetes Master 节点开启 apiServer 的代理</span>
</span></span><span class=line><span class=cl>kubectl proxy --port<span class=o>=</span><span class=m>8001</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#!/bin/bash</span>
</span></span><span class=line><span class=cl><span class=c1># my-scheduler.sh</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>SERVER</span><span class=o>=</span><span class=s1>&#39;localhost:8001&#39;</span>
</span></span><span class=line><span class=cl><span class=k>while</span> true<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>do</span>
</span></span><span class=line><span class=cl>    for PODNAME in <span class=k>$(</span>kubectl --server <span class=nv>$SERVER</span> get pods -o json <span class=p>|</span> jq <span class=s1>&#39;.items[] | 
</span></span></span><span class=line><span class=cl><span class=s1>select(.spec.schedulerName ==&#34;my-scheduler&#34;) | select(.spec.nodeName == null) | 
</span></span></span><span class=line><span class=cl><span class=s1>.metadata.name&#39;</span> <span class=p>|</span> tr -d <span class=s1>&#39;&#34;&#39;</span><span class=k>)</span>
</span></span><span class=line><span class=cl>    do
</span></span><span class=line><span class=cl>        NODES<span class=o>=(</span><span class=k>$(</span>kubectl --server <span class=nv>$SERVER</span> get nodes -o json <span class=p>|</span> jq 
</span></span><span class=line><span class=cl><span class=s1>&#39;.items[].metadata.name&#39;</span> <span class=p>|</span> tr -d <span class=s1>&#39;&#34;&#39;</span><span class=k>)</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        NUMNODES<span class=o>=</span><span class=si>${#</span><span class=nv>NODES</span><span class=p>[@]</span><span class=si>}</span>
</span></span><span class=line><span class=cl>        CHOSEN<span class=o>=</span><span class=si>${</span><span class=nv>NODES</span><span class=p>[</span>$<span class=p>[ </span><span class=nv>$RANDOM</span><span class=p> % </span><span class=nv>$NUMNODES</span><span class=p>]]</span><span class=si>}</span>
</span></span><span class=line><span class=cl>        curl --header <span class=s2>&#34;Content-Type:application/json&#34;</span> --request POST --data
</span></span><span class=line><span class=cl><span class=s1>&#39;{&#34;apiVersion&#34;:&#34;v1&#34;,&#34;kind&#34;:&#34;Binding&#34;,&#34;metadata&#34;: {&#34;name&#34;:&#34;&#39;</span><span class=nv>$PODNAME</span><span class=s1>&#39;&#34;},&#34;target&#34;: 
</span></span></span><span class=line><span class=cl><span class=s1>{&#34;apiVersion&#34;:&#34;v1&#34;,&#34;kind&#34;: &#34;Node&#34;, &#34;name&#34;: &#34;&#39;</span><span class=nv>$CHOSEN</span><span class=s1>&#39;&#34;}}&#39;</span>
</span></span><span class=line><span class=cl>http://<span class=nv>$SERVER</span>/api/v1/namespaces/default/pods/<span class=nv>$PODNAME</span>/binding/
</span></span><span class=line><span class=cl>        echo <span class=s2>&#34;Assigned </span><span class=nv>$PODNAME</span><span class=s2> to </span><span class=nv>$CHOSEN</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    done
</span></span><span class=line><span class=cl>    sleep <span class=m>1</span>
</span></span><span class=line><span class=cl><span class=k>done</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=调度过程>调度过程</h4><ul><li>调度器分为几个部分<ul><li>首先是过滤掉不满足条件的节点 这个过程称为<strong>预选</strong>(过滤)</li><li>然后通过对节点按照优先级排序 这个是<strong>优选</strong>(打分)</li><li>最后从中选择优先级最高的节点 如果中间任何一步骤有错误 就直接返回错误</li></ul></li><li>预选<ul><li>PodFitsResources: 节点上剩余的资源是否大于pod请求的资源</li><li>PodFitsHost: 如果pod指定来NodeName 检查节点名称是否和NodeName匹配</li><li>PodFitsHostPorts: 节点上已经使用的port是否和pod申请的port冲突</li><li>PodSelectorMatches: 过滤掉和pod指定的label不匹配的节点</li><li>NoDiskConflict: 已经mount的volume和pod指定的volume不冲突 除非它们都是只读</li></ul></li><li>优选<ul><li>如果在<code>预选</code>过程中没有合适的节点 pod会一直在<code>pending</code>状态 不断重试调度 直到有节点满足条件</li><li>经过这个步骤 如果有多个节点满足条件 就继续<code>优先</code>过程 按照优先级大小对节点排序</li><li>优先级由一系列键值对组成 键是该优先级项的名称 值是它的权重 这先优先级选项包括<ul><li>LeastRequestedPriority: 通过计算CPU和Memory的使用率来决定权重 使用率越低权重越高 换句话说 这个优先级指标倾向于资源使用比例更低的节点</li><li>BalancedResourceAllocation: 节点上CPU和Memory使用率越接近 权重越高 这个应该和上面的一起使用 不应该单独使用</li><li>ImageLocalityPriority: 倾向于已经有要使用镜像的节点 镜像总大小值越大 权重越高</li></ul></li></ul></li></ul><h3 id=亲和性>亲和性</h3><h4 id=节点亲和性>节点亲和性</h4><ul><li>节点亲和性概念上类似于<code>nodeSelector</code> 它使你可以根据节点上的标签来约束Pod可以调度到哪些节点上 节点亲和性有两种<ul><li><code>requiredDuringSchedulingIgnoredDuringExecution</code>：调度器只有在规则被满足的时候才能执行调度 此功能类似于<code>nodeSelector</code> 但其语法表达能力更强</li><li><code>preferredDuringSchedulingIgnoredDuringExecution</code>：调度器会尝试寻找满足对应规则的节点 如果找不到匹配的节点 调度器仍然会调度该Pod</li></ul></li></ul><blockquote><p>说明：在上述类型中 <code>IgnoredDuringExecution</code>意味着如果节点标签在Kubernetes调度Pod后发生了变更 Pod 仍将继续运行</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>with-node-affinity</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>affinity</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>nodeAffinity</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>requiredDuringSchedulingIgnoredDuringExecution</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>nodeSelectorTerms</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>matchExpressions</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>topology.kubernetes.io/zone</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=l>In</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>values</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=l>antarctica-east1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=l>antarctica-west1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>preferredDuringSchedulingIgnoredDuringExecution</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>weight</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>preference</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>matchExpressions</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>another-node-label-key</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=l>In</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>values</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=l>another-node-label-value</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>with-node-affinity</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>registry.k8s.io/pause:2.0</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>上述示例含义：<ul><li>节点<strong>必须</strong>包含一个键名为<code>topology.kubernetes.io/zone</code>的标签 并且该标签的取值<strong>必须</strong>为 <code>antarctica-east1</code> 或 <code>antarctica-west1</code></li><li>节点<strong>最好</strong>具有一个键名为<code>another-node-label-key</code>且取值为<code>another-node-label-value</code>的标签</li></ul></li><li><code>operator</code>字段<a class=link href=https://kubernetes.io/zh-cn/docs/concepts/scheduling-eviction/assign-pod-node/#operators target=_blank rel=noopener>操作符</a><ul><li>In</li><li>NotIn</li><li>Exists</li><li>DoesNotExist</li><li>Gt</li><li>Lt</li></ul></li><li><code>NotIn</code>和<code>DoesNotExist</code>可用来实现节点反亲和性行为 你也可以使用节点污点将Pod从特定节点驱逐</li></ul><h4 id=pod间亲和性与反亲和性>Pod间亲和性与反亲和性</h4><ul><li>Pod间亲和性与反亲和性使你可以基于已经在节点上运行的Pod的标签来约束Pod可以调度到的节点 而不是基于节点上的标签</li><li>Pod间亲和性与反亲和性的规则格式为"如果X上已经运行了一个或多个满足规则Y的Pod 则这个Pod应该(或者在反亲和性的情况下不应该)运行在X上"<ul><li>这里的X可以是节点、机架、云提供商可用区或地理区域或类似的拓扑域</li><li>Y则是Kubernetes尝试满足的规则</li></ul></li><li>你通过标签选择算符的形式来表达规则(Y) 并可根据需要指定选关联的名字空间列表 Pod在Kubernetes中是名字空间作用域的对象 因此Pod的标签也隐式地具有名字空间属性 针对Pod标签的所有标签选择算符都要指定名字空间 Kubernetes会在指定的名字空间内寻找标签</li><li>你会通过<code>topologyKey</code>来表达拓扑域(X)的概念 其取值是系统用来标示域的节点标签键 相关示例可参见常用标签、注解和污点</li></ul><blockquote><p>说明：
Pod间亲和性和反亲和性都需要相当的计算量 因此会在大规模集群中显著降低调度速度 我们不建议在包含数百个节点的集群中使用这类设置</p><p>说明：
Pod反亲和性需要节点上存在一致性的标签 换言之 集群中每个节点都必须拥有与<code>topologyKey</code>匹配的标签 如果某些或者所有节点上不存在所指定的<code>topologyKey</code>标签 调度行为可能与预期的不同</p></blockquote><h4 id=总结>总结</h4><div class=table-wrapper><table><thead><tr><th>调度策略</th><th>匹配标签</th><th>操作符</th><th>拓扑域支持</th><th>调度目标</th></tr></thead><tbody><tr><td>nodeAffinity</td><td>主机</td><td>In/NotIn/Exists/DoesNotExist/Gt/Lt</td><td>否</td><td>指定主机</td></tr><tr><td>podAffinity</td><td>POD</td><td>In/NotIn/Exists/DoesNotExist</td><td>是</td><td>POD与指定POD同一拓扑域</td></tr><tr><td>podAnitAffinity</td><td>POD</td><td>In/NotIn/Exists/DoesNotExist</td><td>是</td><td>POD与指定POD不在同一拓扑域</td></tr></tbody></table></div><h3 id=容忍与污点>容忍与污点</h3><ul><li><a class=link href=https://kubernetes.io/zh-cn/docs/concepts/scheduling-eviction/assign-pod-node/#affinity-and-anti-affinity target=_blank rel=noopener>节点亲和性</a>是Pod的一种属性 它使Pod被吸引到一类特定的节点(这可能出于一种偏好 也可能是硬性要求) **污点(Taint)**则相反——它使节点能够排斥一类特定的Pod</li><li><strong>容忍度Toleration</strong> 是应用于Pod上的 容忍度允许调度器调度带有对应污点的Pod 容忍度允许调度但并不保证调度：作为其功能的一部分 调度器也会评估其他参数</li><li>污点和容忍度(Toleration)相互配合 可以用来避免Pod被分配到不合适的节点上 每个节点上都可以应用一个或多个污点 这表示对于那些不能容忍这些污点的Pod 是不会被该节点接受的</li></ul><h4 id=组成>组成</h4><p><code>key=value:effect</code></p><ul><li>每个污点有一个key和value作为污点的标签 其中value可以为空 effect描述污点的作用</li><li>当前的taint effect支持如下三个选项<ul><li>NoSchedule: 表示k8s将<strong>不会</strong>将Pod调度到具有该污点的Node上</li><li>PreferNoSchedule: 表示k8s将<strong>尽量避免</strong>将Pod调度到具有该污点的Node上</li><li>NoExecute: 表示k8s将不会将Pod调度到具有该污点的Node上 同时会将Node上已经存在的Pod<strong>驱逐</strong>出去</li></ul></li></ul><h4 id=设置和去除>设置和去除</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 给节点增加一个污点</span>
</span></span><span class=line><span class=cl>kubectl taint nodes node1 <span class=nv>key1</span><span class=o>=</span>value1:NoSchedule
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 节点说明中 查找Taints字段</span>
</span></span><span class=line><span class=cl>kubectl describe pod pod-name
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 移除上述污点</span>
</span></span><span class=line><span class=cl>kubectl taint nodes node1 <span class=nv>key1</span><span class=o>=</span>value1:NoSchedule-
</span></span></code></pre></td></tr></table></div></div><h4 id=容忍>容忍</h4><ul><li>设置里污点的Node 将根据taint的effect: <code>NoSchedule</code> <code>PreferNoSchedule</code> <code>NoExecute</code>和Pod之间产生互斥的关系 Pod将在一定程度上不会被调度到Node上</li><li>但我们可以在Pod上设置容忍(Toleration) 意思是设置里容忍的Pod将可以容忍污点的存在 可以被调度到存在污点的Node上</li></ul><h5 id=容忍设置方式>容忍设置方式</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>tolerations</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;key1&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Equal&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;value1&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>effect</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;NoSchedule&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>tolerations</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;key1&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Equal&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;value1&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>effect</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;NoExecute&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tolerationSeconds</span><span class=p>:</span><span class=w> </span><span class=m>3600</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># tolerationSeconds: 这表示如果这个Pod正在运行 同时一个匹配的污点被添加到其所在的节点</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 那么Pod还将继续在节点上运行3600秒 然后被驱逐 </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 如果在此之前上述污点被删除了 则Pod不会被驱逐</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=容忍的特殊类型>容忍的特殊类型</h5><ul><li><code>operator</code>的默认是<code>Equal</code></li><li>一个容忍度和一个污点相<strong>匹配</strong>是指它们有一样的键名和效果 并且<ul><li>如果<code>operator</code>是<code>Exists</code> 此时容忍度不能指定<code>value</code> 或者</li><li>如果<code>operator</code>是<code>Equal</code> 则它们的值应该相等</li></ul></li></ul><hr><ul><li><p>特殊类型</p><ul><li>当不指定value时 表示容忍所有的污点value</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;key2&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Exists&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>effect</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;NoSchedule&#34;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>当不指定key值时 表示容忍所有的污点key</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>tolerations</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Exists&#34;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>当不指定effect值时 表示容忍所有的污点作用</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>tolerations</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;key&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Exists&#34;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>有多个master存在时 防止资源浪费 可以如下设置</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl taint nodes Node-Name node-role.kubernetes.io/master<span class=o>=</span>:PreferNoSchedule
</span></span></code></pre></td></tr></table></div></div></li></ul><h5 id=基于污点的驱逐>基于污点的驱逐</h5><ul><li>当某种条件为真时 节点控制器会自动给节点添加一个污点 当前内置的污点包括：<ul><li><code>node.kubernetes.io/not-ready</code>：节点未准备好 这相当于节点状况<code>Ready</code>的值为"<code>False</code>"</li><li><code>node.kubernetes.io/unreachable</code>：节点控制器访问不到节点 这相当于节点状况<code>Ready</code>的值为 &ldquo;<code>Unknown</code>&rdquo;</li><li><code>node.kubernetes.io/memory-pressure</code>：节点存在内存压力</li><li><code>node.kubernetes.io/disk-pressure</code>：节点存在磁盘压力</li><li><code>node.kubernetes.io/pid-pressure</code>：节点的<code>PID</code>压力</li><li><code>node.kubernetes.io/network-unavailable</code>：节点网络不可用</li><li><code>node.kubernetes.io/unschedulable</code>：节点不可调度</li><li><code>node.cloudprovider.kubernetes.io/uninitialized</code>：如果<code>kubelet</code>启动时指定了一个"外部"云平台驱动 它将给当前节点添加一个污点将其标志为不可用 在<code>cloud-controller-manager</code>的一个控制器初始化这个节点后 kubelet将删除这个污点</li></ul></li><li>在节点被排空时 节点控制器或者kubelet会添加带有<code>NoExecute</code>效果的相关污点 此效果被默认添加到<code>node.kubernetes.io/not-ready</code>和<code>node.kubernetes.io/unreachable</code>污点中 如果异常状态恢复正常 kubelet或节点控制器能够移除相关的污点</li><li>在某些情况下 当节点不可达时 API服务器无法与节点上的<code>kubelet</code>进行通信 在与API服务器的通信被重新建立之前 删除Pod的决定无法传递到kubelet 同时 被调度进行删除的那些Pod可能会继续运行在分区后的节点上</li></ul><h3 id=固定节点调度>固定节点调度</h3><h4 id=指定节点调度>指定节点调度</h4><ul><li><code>pod.spec.nodeName</code>将Pod直接调度到指定的Node节点上 会跳过Scheduler的调度策略 该匹配规则时强制匹配<ul><li>如果<code>nodeName</code>字段不为空 调度器会忽略该Pod 而指定节点上的kubelet会尝试将Pod放到该节点上</li><li>使用<code>nodeName</code>规则的优先级会高于使用<code>nodeSelector</code>或亲和性与非亲和性的规则</li><li>局限性<ul><li>如果所指代的节点不存在 则Pod无法运行 而且在某些情况下可能会被自动删除</li><li>如果所指代的节点无法提供用来运行Pod所需的资源 Pod会失败 而其失败原因中会给出是否因为内存或CPU不足而造成无法运行</li><li>在云环境中的节点名称并不总是可预测的 也不总是稳定的</li></ul></li></ul></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>nodeName</span><span class=p>:</span><span class=w> </span><span class=l>kube-01</span><span class=w> </span><span class=c># 该Pod只能运行在节点kube-01上</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=指定节点标签调度>指定节点标签调度</h4><p><a class=link href=https://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/assign-pods-nodes/ target=_blank rel=noopener>将Pod分配给节点</a></p><p><a class=link href=https://kubernetes.io/zh-cn/docs/concepts/overview/working-with-objects/labels/ target=_blank rel=noopener>标签和选择运算符</a></p><ul><li><code>po.spec.nodeSelector</code>通过kubernetes的label-selector机制选择节点 由调度器策略匹配label 而后调度Pod到目标节点 该匹配规则属于<strong>强制约束</strong></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 列出集群节点及标签</span>
</span></span><span class=line><span class=cl>kubectl get nodes --show-labels
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 给节点添加标签</span>
</span></span><span class=line><span class=cl>kubectl label nodes &lt;node-name&gt; <span class=nv>disktype</span><span class=o>=</span>ssd
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查找对应标签node</span>
</span></span><span class=line><span class=cl>kubectl get nodes -l <span class=nv>disktype</span><span class=o>=</span>ssd
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>env</span><span class=p>:</span><span class=w> </span><span class=l>test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>IfNotPresent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>nodeSelector</span><span class=p>:</span><span class=w>  </span><span class=c># 该Pod会调度到具有下面标签的节点上</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>disktype</span><span class=p>:</span><span class=w> </span><span class=l>ssd</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=认证及serviceaccount>认证及ServiceAccount</h2><h3 id=认证授权>认证授权</h3><ul><li>认证(支持多种认证方式) # 认证插件<ul><li>令牌认证 bearer token</li><li>ssl认证(确认服务端/客户端身份) 双向证书认证(https)</li><li>&mldr;</li></ul></li><li>授权检查(权限) # 授权插件<ul><li>RBAC # kubeadm部署的集群强制开启RBAC</li><li>&mldr;</li></ul></li><li>准入控制(关联的其他资源或操作 是否有权限 进一步补充授权机制)</li><li>API Server需要信息去识别客户端的操作<ul><li>user: username + uid</li><li>group</li><li>extra</li><li>API(请求的Kubernetes API)<ul><li>Request Path<ul><li><code>kubectl proxy --port=8080</code></li><li><code>curl http://localhost:8080/api/v1/namespaces</code></li><li><code>curl http://localhost:8080/apis/apps/v1/namespaces/default/deployments/myapp-deploy/</code></li></ul></li><li>HTTP request verb<ul><li>GET POST PUT DELETE</li><li>get list create update patch watch proxy redirect delete deletecollection</li></ul></li><li>Resources</li><li>SubResources</li><li>Namespace</li><li>API Group</li></ul></li></ul></li></ul><h3 id=serviceaccount>ServiceAccount</h3><ul><li>访问APIServer的两种客户端<ul><li>kubectl/dashborad 集群外部客户端(userAccount)</li><li>pod 集群内部客户端(serviceAccount)<ul><li><code>kubectl explain pods.spec.serviceAccountName</code></li></ul></li></ul></li><li>kubeconfig<ul><li><code>kubectl config view</code></li></ul></li></ul><h3 id=rbac授权>RBAC授权</h3><ul><li>授权插件<ul><li>Node</li><li>ABAC(<em>Attribute-based access control</em>)</li><li>RBAC(<em>Role-based access contro</em>)</li><li>Webhook</li></ul></li></ul><p><img src=/p/kubernetes/icons/k8s-RBAC.png width=1364 height=768 srcset="/p/kubernetes/icons/k8s-RBAC_hu93382d84de46ca6bdd4d6c35df8f4890_1483186_480x0_resize_box_3.png 480w, /p/kubernetes/icons/k8s-RBAC_hu93382d84de46ca6bdd4d6c35df8f4890_1483186_1024x0_resize_box_3.png 1024w" loading=lazy alt=k8s-RBAC class=gallery-image data-flex-grow=177 data-flex-basis=426px></p><ul><li>K8S-RBAC<ul><li>role<ul><li>operations</li><li>objects</li></ul></li><li>rolebinding<ul><li>user account OR service account</li><li>role</li></ul></li><li><code>kubectl create role pods-reader --verb=get,list,watch --resource=pods --dry-run -o yaml</code></li></ul></li></ul><p><img src=/p/kubernetes/icons/role-binding.png width=1498 height=1096 srcset="/p/kubernetes/icons/role-binding_hue49744d6898b8c4106d004f8692e3f91_1070895_480x0_resize_box_3.png 480w, /p/kubernetes/icons/role-binding_hue49744d6898b8c4106d004f8692e3f91_1070895_1024x0_resize_box_3.png 1024w" loading=lazy alt=role-binding class=gallery-image data-flex-grow=136 data-flex-basis=328px></p><h2 id=配置管理>配置管理</h2><h3 id=kustomize>Kustomize</h3><p><a class=link href=https://kustomize.io/ target=_blank rel=noopener>kustomize</a></p><h3 id=helm>Helm</h3><p><a class=link href=https://helm.sh/zh/docs/ target=_blank rel=noopener>helm</a></p><h4 id=模版debug>模版debug</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=p>{{</span><span class=o>-</span> <span class=err>$</span><span class=nx>commonValues</span> <span class=o>:=</span> <span class=nx>mustDeepCopy</span> <span class=p>.</span><span class=nx>Values</span><span class=p>.</span><span class=nx>common</span> <span class=o>-</span><span class=p>}}</span>
</span></span><span class=line><span class=cl><span class=p>{{</span> <span class=nf>fail</span> <span class=p>(</span><span class=nx>printf</span> <span class=s>&#34;commonValues:%v\n&#34;</span> <span class=p>(</span><span class=nx>toYaml</span> <span class=p>.</span><span class=nx>Values</span> <span class=p>|</span> <span class=nx>nindent</span> <span class=mi>2</span> <span class=p>))</span> <span class=p>}}</span>  <span class=c1>// 格式化打印对应值 方便debug
</span></span></span></code></pre></td></tr></table></div></div><h2 id=集群监控>集群监控</h2><ul><li>书籍推荐 了解Google运维的秘密 <a class=link href=https://lewlh.github.io/2020/07/18/SRE-Google%E8%BF%90%E7%BB%B4%E8%A7%A3%E5%AF%86/ target=_blank rel=noopener>SRE: Google运维解密</a></li><li>资源监控方案 Prometheus 无可挑剔的选择 需前置Prometheus相关知识</li><li>Kubernetes集群的监控方案主要有以下几种方案<ul><li>Heapster: 已废弃 使用metrics-server代替</li><li>cAdvisor: <a class=link href=https://github.com/google/cadvisor target=_blank rel=noopener>cAdvisor</a>是Google开源的容器资源监控和性能分析工具<ul><li>它是专门为容器而生的 本身也支持Docker</li><li>在Kubernetes中 我们不需要单独去安装 cAdvisor作为kubectl内置的一部分程序 可以直接使用</li></ul></li><li>kube-state-metrics: <a class=link href=https://github.com/kubernetes/kube-state-metrics target=_blank rel=noopener>kube-state-metrics</a>通过监听API Server生成有关资源对象的状态指标<ul><li>比如: Deployment、Node、Pod 需要注意的是 kube-state-metrics只是简单提供一个metrics数据 并不会存储这些指标数据</li><li>我们可以使用Prometheus来抓取这些数据然后存储</li></ul></li><li>metrics-server: metrics-server也是一个集群范围内的资源数据聚合工具 是Headster的替代<ul><li>同样的 metrics-server也只是显示数据 并不提供数据存储服务</li></ul></li></ul></li><li>kube-state-metrics 和 metrics-server的区别：<ul><li>kube-state-metrics主要关注的是业务相关的一些元数据 比如 Deployment、Pod、副本状态等</li><li>metrics-server主要关注的是<a class=link href=https://github.com/kubernetes/design-proposals-archive/blob/main/instrumentation/resource-metrics-api.md target=_blank rel=noopener>资源度量API</a>的实现 比如 CPU、内存、文件描述符、请求延时等指标</li></ul></li></ul><h3 id=手动安装prometheus>手动安装Prometheus</h3><ul><li>资源清单文件</li><li><code>kubectl apply -f prometheus.yaml</code></li><li>因为是以NodePort暴露的服务 直接访问 <code>http://任意节点IP:&lt;NodePort></code> 就能看到熟悉的Prometheus UI</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># kubectl create ns kube-ops</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 暂时只配置对proemtheus的监控</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ConfigMap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>prometheus-config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>kube-ops</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>prometheus.yaml</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    global:
</span></span></span><span class=line><span class=cl><span class=sd>      scrape_interval: 15s
</span></span></span><span class=line><span class=cl><span class=sd>      evaluation_interval: 15s
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    scrape_configs:
</span></span></span><span class=line><span class=cl><span class=sd>      - job_name: &#39;prometheus&#39;
</span></span></span><span class=line><span class=cl><span class=sd>        static_configs:
</span></span></span><span class=line><span class=cl><span class=sd>          - targets: [&#39;localhost:9090&#39;]</span><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># PVC for prometheus 使用NFS演示</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>PersistentVolumeClaim</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>kube-ops</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>storageClassName</span><span class=p>:</span><span class=w> </span><span class=l>nfs-client</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>accessModes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>ReadWriteMany</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>storage</span><span class=p>:</span><span class=w> </span><span class=l>10Gi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 创建ServiceAccount</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ServiceAccount</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>kube-ops</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 创建CllusterRole</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRole</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>apiGroups</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=s2>&#34;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>nodes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>services</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>endpoints</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>pods</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>nodes/proxy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>verbs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>get</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>list</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>watch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>apiGroups</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=s2>&#34;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>configmaps</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>nodes/metrics</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>verbs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>get</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>nonResourceURLs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>/metrics</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>verbs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>get</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 创建ClusterRoleBinding</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRoleBinding</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>roleRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRole</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>subjects</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ServiceAccount</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>kube-ops</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 创建Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>kube-ops</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>serviceAccountName</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>prom/prometheus:v2.46.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>command</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>/bin/prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- --<span class=l>config.file=/etc/prometheus/prometheus.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- --<span class=l>storage.tsdb.path=/prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- --<span class=l>storage.tsdb.retention.time=24h</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- --<span class=l>web.enable-admin-api</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- --<span class=l>web.enable-lifecycle</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>9090</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>TCP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>http</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>prometheus-config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/etc/prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>prometheus-storage</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=c># 只挂载卷中的一个子目录或子路径到容器中 而不是挂载整个卷</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=c># 1. 避免数据污染</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=c># 2. 多容器共享同一个PVC</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=c># 3. 数据隔离</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>subPath</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>100m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>512Mi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>limits</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>100m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>512Mi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>securityContext</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>runAsUser</span><span class=p>:</span><span class=w> </span><span class=m>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>prometheus-config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>configMap</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>prometheus-config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>prometheus-storage</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>persistentVolumeClaim</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>claimName</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 创建Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>kube-ops</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>NodePort</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>http</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>9090</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=m>9090</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>nodePort</span><span class=p>:</span><span class=w> </span><span class=m>30000</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=监控集群应用>监控集群应用</h3><ul><li>内置指标接口 直接配置静态配置service地址的内置指标接口</li><li>未内置指标接口 直接配置对应exporter的service地址的指标接口</li></ul><h3 id=监控集群节点>监控集群节点</h3><ul><li>监控节点已有非常多的成熟方案 比如：Nagios Zabbix 甚至自己收集数据也可以</li><li>Kubernetes中 我们通过<a class=link href=https://github.com/prometheus/node_exporter target=_blank rel=noopener>node_exporter</a>来获取节点指标<ul><li>node_exporter用于采集服务器节点的各种运行指标 包括：conntrack cpu diskstats filesystem loadavg memeinfo netstat等</li><li>详细内容参考官方repo文档</li></ul></li></ul><h4 id=部署node-exporter>部署node-exporter</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># 部署node-exporter的资源清单文件</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 注意事项：由于我们要获取到的数据是主机的监控指标数据 而node-exporter是运行在容器中的 所有在Pod中需要配置一些Pod的安全策略</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#   hostPID: true 允许容器访问主机的PID命名空间</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#   hostIPC: true 允许容器访问主机的IPC命名空间</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#   hostNetwork: true 允许容器使用主机的网络命名空间</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 另外 我们还将主机的/dev、/proc、/sys目录挂载到容器中 因为我们采集的很多节点数据都是通过这些目录下面的文件来获取的</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#   /proc/stat /proc/meminfo /proc/cpuinfo /proc/diskstats /proc/net/dev ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>DaemonSet</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>node-exporter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>kube-ops</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>node-exporter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>node-exporter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>node-exporter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>hostPID</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>hostIPC</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>hostNetwork</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>node-exporter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>prom/node-exporter:v1.9.1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>9100</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>200m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>securityContext</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>privileged</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- --<span class=l>path.procfs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>/host/proc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- --<span class=l>path.sysfs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>/host/sys</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- --<span class=l>collector.filesystem.ignored-mount-points</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=s2>&#34;^/(sys|proc|dev|host|etc)($|/)&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>dev</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/host/dev</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>proc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/host/proc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>sys</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/host/sys</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>rootfs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/rootfs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>tolerations</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>node-role.kubernetes.io/control-plane</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=l>Exists</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>effect</span><span class=p>:</span><span class=w> </span><span class=l>NoSchedule</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>dev</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>hostPath</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/dev</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>proc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>hostPath</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/proc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>sys</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>hostPath</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/sys</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>rootfs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>hostPath</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=配置基于kubernetes的自动发现>配置基于Kubernetes的自动发现</h4><p><a class=link href=https://prometheus.io/docs/prometheus/2.51/configuration/configuration/#kubernetes_sd_config target=_blank rel=noopener>kubernetes_sd_config</a></p><ul><li>在Kubernetes中 Prometheus通过与Kubernetes API集成 目前主要支持5种服务发现模式<ul><li>node</li><li>service</li><li>pod</li><li>endpoints / endpointslice</li><li>ingress</li></ul></li><li>通过制定<code>kubernetes_sd_config</code>的模式为<code>node</code> Prometheus就会自动从Kubernetes中发现所有的node节点并作为当前job监控的目标实例 发现的节点<code>/metrics</code>接口时默认的kubelet的HTTP接口</li><li>Promethehs去发现Node模式的服务的时候 访问的默认端口是10250(kubelet服务端口) 而现在该端口下面已经没有/metrics指标数据</li><li>因为上面配置指定了<code>hostNetwork: true</code> 所以每个节点都会监听9100端口 我们应该将这里的10250替换为9100</li><li>如何实现：使用Prometheus提供的<code>relabel_configs</code>中的<code>replace</code>能力<ul><li>relabel可以在Prometheus采集数据之前 通过Target实例的metadata信息 动态重新写入Label的值</li><li>除此之外 还能根据Target实例的metadata信息 选择是否采集或忽略该Target实例/指标</li><li>添加一个action为<code>labelmap</code> 正则表达式<code>__metadata_kubernetes_node_label_(.+)</code>的配置 这里的意思是表达式中匹配的数据也添加到指标数据的Label标签中去</li><li>对于kubernetes_sd_config下面可用的标签如下：<ul><li><code>__metadata_kubernetes_node_name</code>: 节点对象的名称</li><li><code>__metadata_kubernetes_node_label</code>: 节点对象中的每个标签</li><li><code>__metadata_kubernetes_node_annitation</code>: 来自节点对象的每个注解</li><li><code>__metadata_kubernetes_node_address</code>: 每个节点地址类型的第一个地址(如果存在)</li><li>更多类型参考Prometheus官方文档</li></ul></li></ul></li><li>修改后的configmap如下</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ConfigMap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>prometheus-config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>kube-ops</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>prometheus.yaml</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    global:
</span></span></span><span class=line><span class=cl><span class=sd>      scrape_interval: 15s
</span></span></span><span class=line><span class=cl><span class=sd>      evaluation_interval: 15s
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    scrape_configs:
</span></span></span><span class=line><span class=cl><span class=sd>    - job_name: &#39;prometheus&#39;
</span></span></span><span class=line><span class=cl><span class=sd>      static_configs:
</span></span></span><span class=line><span class=cl><span class=sd>      - targets: [&#39;localhost:9090&#39;]
</span></span></span><span class=line><span class=cl><span class=sd>      
</span></span></span><span class=line><span class=cl><span class=sd>    - job_name: &#39;kubernetes-nodes&#39;
</span></span></span><span class=line><span class=cl><span class=sd>      kubernetes_sd_configs:
</span></span></span><span class=line><span class=cl><span class=sd>      - role: node
</span></span></span><span class=line><span class=cl><span class=sd>      relabel_configs:
</span></span></span><span class=line><span class=cl><span class=sd>      - source_labels: [__address__]
</span></span></span><span class=line><span class=cl><span class=sd>        regex: &#39;(.+):10250&#39;
</span></span></span><span class=line><span class=cl><span class=sd>        replacement: &#39;${1}:9100&#39;
</span></span></span><span class=line><span class=cl><span class=sd>        target_label: __address__
</span></span></span><span class=line><span class=cl><span class=sd>        action: replace
</span></span></span><span class=line><span class=cl><span class=sd>      - action: labelmap
</span></span></span><span class=line><span class=cl><span class=sd>        regex: __meta_kubernetes_node_label_(.+)
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    # 1.11+版本后 metrics端口为10250 需要使用https协议获取指标
</span></span></span><span class=line><span class=cl><span class=sd>    - job_name: &#39;kubernetes-kubelet&#39;
</span></span></span><span class=line><span class=cl><span class=sd>      kubernetes_sd_configs:
</span></span></span><span class=line><span class=cl><span class=sd>      - role: node
</span></span></span><span class=line><span class=cl><span class=sd>      scheme: https
</span></span></span><span class=line><span class=cl><span class=sd>      tls_config:
</span></span></span><span class=line><span class=cl><span class=sd>        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
</span></span></span><span class=line><span class=cl><span class=sd>        insecure_skip_verify: true
</span></span></span><span class=line><span class=cl><span class=sd>      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
</span></span></span><span class=line><span class=cl><span class=sd>      relabel_configs:
</span></span></span><span class=line><span class=cl><span class=sd>      - action: labelmap
</span></span></span><span class=line><span class=cl><span class=sd>        regex: __meta_kubernetes_node_label_(.+)</span><span class=w>    
</span></span></span></code></pre></td></tr></table></div></div><h3 id=监控集群常用资源对象>监控集群常用资源对象</h3><h4 id=容器监控>容器监控</h4><ul><li>说到容器监控我们自然会想到cAdisor 我们前面说过cAdvisor已经内置在了kubelet组件中 所以我们不需要单独安装</li><li>cAdvisor的数据路径为<code>/api/v1/nodes/&lt;node>/proxy/metrics</code></li><li>同样 我们使用node的服务发现模式 因为每一个节点下面都有kubelet 自然都有cAdvisor采集到的数据指标</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># prometheus configmap配置参考</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>job_name</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;kubernetes-cadvisor&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>kubernetes_sd_configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>role</span><span class=p>:</span><span class=w> </span><span class=l>node</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>scheme</span><span class=p>:</span><span class=w> </span><span class=l>https</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tls_config</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ca_file</span><span class=p>:</span><span class=w> </span><span class=l>/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>bearer_token_file</span><span class=p>:</span><span class=w> </span><span class=l>/var/run/secrets/kubernetes.io/serviceaccount/token</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>relabel_configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>labelmap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>regex</span><span class=p>:</span><span class=w> </span><span class=l>__meta_kubernetes_node_label_(.+)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>target_label</span><span class=p>:</span><span class=w> </span><span class=l>__address__</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>replacement</span><span class=p>:</span><span class=w> </span><span class=l>kubernetes.default.svc:443</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>source_labels</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>__meta_kubernetes_node_name]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>regex</span><span class=p>:</span><span class=w> </span><span class=l>(.+)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>target_label</span><span class=p>:</span><span class=w> </span><span class=l>__metrics_path__</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>replacement</span><span class=p>:</span><span class=w> </span><span class=l>/api/v1/nodes/${1}/proxy/metrics/cadvisor</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=apiserver监控>apiserver监控</h4><ul><li>apiserver作为Kubernetes的最核心组件 对它的监控是非常必要的</li><li>对于apiserver的监控我们可以直接通过kubernetes的Service来获取<ul><li><code>kubectl get svc kubernetes -n default</code></li></ul></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl>- <span class=nt>job_name</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;kubernetes-apiservers&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>kubernetes_sd_configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>role</span><span class=p>:</span><span class=w> </span><span class=l>endpoints</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>scheme</span><span class=p>:</span><span class=w> </span><span class=l>https </span><span class=w> </span><span class=c># https协议</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tls_config</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ca_file</span><span class=p>:</span><span class=w> </span><span class=l>/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>bearer_token_file</span><span class=p>:</span><span class=w> </span><span class=l>/var/run/secrets/kubernetes.io/serviceaccount/token</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>relabel_configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>source_labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>__meta_kubernetes_namespace</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>__meta_kubernetes_service_name</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>__meta_kubernetes_endpoint_port_name</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>keep </span><span class=w> </span><span class=c># 使用endpoints的自动发现 会发现所有的endpoitns端点 我们只需要匹配kubernetes-apiserver 其余全部DROP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>regex</span><span class=p>:</span><span class=w> </span><span class=l>default;kubernetes;https</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li><a class=link href=https://kubernetes.io/zh-cn/docs/concepts/cluster-administration/system-metrics/ target=_blank rel=noopener>Kubernetes系统组件指标</a></li><li>应用上面配置 就完成了对Kubernetes APIServer的监控</li><li>如果需要监控其他系统组件 比如：kube-controller-manager、kube-scheduler的话 需要注意<ul><li>apiserver的service在default的namespace下</li><li>而其余组件服务在kube-system这个namespace下 如果我们想要监控这些组件 需要手动创建单独的Service 其中<ul><li>kube-schedule的指标数据端口为10251</li><li>kube-controller-manager对应的指标数据端口为10252</li></ul></li></ul></li></ul><h4 id=service监控>Service监控</h4><ul><li>上面的apiservice实际上是一种特殊的Service 我们可以配置一个任务来专门发现普通类型的Service</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl>- <span class=nt>job_name</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;kubernetes-service-endpoints&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>kubernetes_sd_configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>role</span><span class=p>:</span><span class=w> </span><span class=l>endpoints</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>relabel_configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>source_labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>__meta_kubernetes_service_annotation_prometheus_io_scrape</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>keep</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>regex</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>source_labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>__meta_kubernetes_service_annotation_prometheus_io_scheme</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>replace</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>target_label</span><span class=p>:</span><span class=w> </span><span class=l>__scheme__</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>regex</span><span class=p>:</span><span class=w> </span><span class=l>(https?)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>source_labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>__meta_kubernetes_service_annotation_prometheus_io_path</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>replace</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>target_label</span><span class=p>:</span><span class=w> </span><span class=l>__metrics_path__</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>regex</span><span class=p>:</span><span class=w> </span><span class=l>(.+)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>source_labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>__address__</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>__meta_kubernetes_service_annotation_prometheus_io_port</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>replace</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>target_label</span><span class=p>:</span><span class=w> </span><span class=l>__address__</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>regex</span><span class=p>:</span><span class=w> </span><span class=l>([^:]+)(?::\d+)?;(\d+)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>replacement</span><span class=p>:</span><span class=w> </span><span class=l>$1:$2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>labelmap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>regex</span><span class=p>:</span><span class=w> </span><span class=l>__meta_kubernetes_service_label_(.+)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>source_labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>__meta_kubernetes_namespace</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>replace</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>target_label</span><span class=p>:</span><span class=w> </span><span class=l>kubernetes_namespace</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>source_labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>__meta_kubernetes_service_name</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>replace</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>target_label</span><span class=p>:</span><span class=w> </span><span class=l>kubernetes_name</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>需要被监控的服务 如果本身实现了<code>/metrics</code>接口 则可以按照下面配置修改下Service配置即可进行自动发现</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>demoapp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>annotations</span><span class=p>:</span><span class=w>  </span><span class=c># 加上下面的annotations 则可以进行该服务的自动发现</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>prometheus.io/scrape</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;true&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>prometheus.io/port</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;80&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>demoapp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>TCP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=kube-state-metrics>kube-state-metrics</h4><ul><li><p>上面我们配置了自动发现Service(Pod也一样)的监控 但是这些监控数据都是应用内部的监控 需要应用本身内置<code>/metrics</code>接口 或者对应的<code>exporter</code>来暴露对应的指标数据</p></li><li><p>但是 在Kubernetes集群上的Pod、DaemonSet、Deployment、Job、Crontab等各种资源对象的状态也需要监控 这也反应了使用这些资源部署的应用状态</p></li><li><p>前面从集群拉取的指标(来自apiserver和kubelet中集成的cAdvisor) 并没有具体的各种资源对象的状态指标</p></li><li><p>对于Prometheus来说 当然是需要引入新的exporter来暴露这些指标 Kubernetes提供了<a class=link href=https://github.com/kubernetes/kube-state-metrics target=_blank rel=noopener>kube-state-metrics</a>则可以实现该监控需求</p></li><li><p>安装kube-state-metrics</p></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>git clone git@github.com:kubernetes/kube-state-metrics.git
</span></span><span class=line><span class=cl>kubectl apply -k examples/standard
</span></span></code></pre></td></tr></table></div></div><ul><li>修改service配置 自动监控指标</li><li>监控指标的相关文档 参考<a class=link href="https://github.com/kubernetes/kube-state-metrics?tab=readme-ov-file#metrics-documentation" target=_blank rel=noopener>metics-documentation</a></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app.kubernetes.io/component</span><span class=p>:</span><span class=w> </span><span class=l>exporter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app.kubernetes.io/name</span><span class=p>:</span><span class=w> </span><span class=l>kube-state-metrics</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app.kubernetes.io/version</span><span class=p>:</span><span class=w> </span><span class=m>2.15.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>kube-state-metrics</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>kube-system</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 修改service 加上该配置</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>annotations</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>prometheus.io/scrape</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;true&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>prometheus.io/port</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;8080&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>clusterIP</span><span class=p>:</span><span class=w> </span><span class=l>None</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>http-metrics</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=l>http-metrics</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>telemetry</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>8081</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=l>telemetry</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app.kubernetes.io/name</span><span class=p>:</span><span class=w> </span><span class=l>kube-state-metrics</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=grafana的安装使用>Grafana的安装使用</h3><ul><li>Prometheus官方Dashboard展示能力较弱 展示推荐接Grafana</li><li>安装</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span><span class=lnt>90
</span><span class=lnt>91
</span><span class=lnt>92
</span><span class=lnt>93
</span><span class=lnt>94
</span><span class=lnt>95
</span><span class=lnt>96
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>grafana</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>kube-ops</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>grafana</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>revisionHistoryLimit</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>grafana</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>grafana</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>grafana</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>grafana/grafana:12.0.1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>IfNotPresent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>3000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>grafana</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>GF_SECURITY_ADMIN_USER</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=l>admin</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>GF_SECURITY_ADMIN_PASSWORD</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=l>admin9527</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>readinessProbe</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>failureThreshold</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>httpGet</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/api/health</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>3000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>scheme</span><span class=p>:</span><span class=w> </span><span class=l>HTTP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>initialDelaySeconds</span><span class=p>:</span><span class=w> </span><span class=m>60</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>periodSeconds</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>successThreshold</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>timeoutSeconds</span><span class=p>:</span><span class=w> </span><span class=m>30</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>livenessProbe</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>failureThreshold</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>httpGet</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/api/health</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>3000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>scheme</span><span class=p>:</span><span class=w> </span><span class=l>HTTP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>periodSeconds</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>successThreshold</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>timeoutSeconds</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>limits</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>100m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>256Mi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>100m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>256Mi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/var/lib/grafana</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>subPath</span><span class=p>:</span><span class=w> </span><span class=l>grafana</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>storage</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>securityContext</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>fsGroup</span><span class=p>:</span><span class=w> </span><span class=m>472</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>runAsUser</span><span class=p>:</span><span class=w> </span><span class=m>472</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>storage</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>persistentVolumeClaim</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>claimName</span><span class=p>:</span><span class=w> </span><span class=l>grafana</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>PersistentVolumeClaim</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>grafana</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>kube-ops</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>storageClassName</span><span class=p>:</span><span class=w> </span><span class=l>nfs-client</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>accessModes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>ReadWriteOnce</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>storage</span><span class=p>:</span><span class=w> </span><span class=l>1Gi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>grafana</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>kube-ops</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>grafana</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>NodePort</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>http</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>3000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=m>3000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>nodePort</span><span class=p>:</span><span class=w> </span><span class=m>30001</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>grafana</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>如果由于卷权限问题 执行下面Job修改权限即可</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>batch/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Job</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>grafana-chown</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>kube-ops</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>restartPolicy</span><span class=p>:</span><span class=w> </span><span class=l>Never</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>grafana-chown</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;chown&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;-R&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;472:472&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;/var/lib/grafana&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>busybox</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>IfNotPresent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>storage</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>subPath</span><span class=p>:</span><span class=w> </span><span class=l>grafana</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/var/lib/grafana</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>storage</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>persistentVolumeClaim</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>claimName</span><span class=p>:</span><span class=w> </span><span class=l>grafana</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>后续就是进行Grafana的数据源及模版配置等工作</li></ul><h3 id=alertmanger>Alertmanger</h3><ul><li>准备告警媒介 这里以dingding-webhoo为例</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=l>git clone git@github.com:timonwong/prometheus-webhook-dingtalk.git</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>cd contrib/k8s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>kubectl apply -k .</span><span class=w> </span><span class=c># 执行前修改为自己的测试配置</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>准备alertmanager配置文件</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ConfigMap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>alertmanager-config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>kube-ops</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>config.yaml</span><span class=p>:</span><span class=w> </span><span class=p>|-</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    route:
</span></span></span><span class=line><span class=cl><span class=sd>      receiver: &#39;default&#39;
</span></span></span><span class=line><span class=cl><span class=sd>      group_wait: 30s
</span></span></span><span class=line><span class=cl><span class=sd>      group_interval: 5m
</span></span></span><span class=line><span class=cl><span class=sd>      repeat_interval: 30m
</span></span></span><span class=line><span class=cl><span class=sd>      group_by:
</span></span></span><span class=line><span class=cl><span class=sd>      - &#39;cluster&#39;
</span></span></span><span class=line><span class=cl><span class=sd>      - &#39;alertname&#39;
</span></span></span><span class=line><span class=cl><span class=sd>      routes:
</span></span></span><span class=line><span class=cl><span class=sd>      - receiver: &#39;test&#39;
</span></span></span><span class=line><span class=cl><span class=sd>        group_wait: 30s
</span></span></span><span class=line><span class=cl><span class=sd>        group_interval: 10m
</span></span></span><span class=line><span class=cl><span class=sd>        repeat_interval: 30m
</span></span></span><span class=line><span class=cl><span class=sd>        matchers:
</span></span></span><span class=line><span class=cl><span class=sd>        - severity=&#34;P0&#34;
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    receivers:
</span></span></span><span class=line><span class=cl><span class=sd>    - name: &#39;default&#39;
</span></span></span><span class=line><span class=cl><span class=sd>      webhook_configs:
</span></span></span><span class=line><span class=cl><span class=sd>      - url: &#39;http://alertmanager-webhook-dingtalk/dingtalk/webhook_mention_test/send&#39;
</span></span></span><span class=line><span class=cl><span class=sd>        send_resolved: false
</span></span></span><span class=line><span class=cl><span class=sd>    - name: &#39;test&#39;
</span></span></span><span class=line><span class=cl><span class=sd>      webhook_configs:
</span></span></span><span class=line><span class=cl><span class=sd>      - url: &#39;http://alertmanager-webhook-dingtalk/dingtalk/webhook_mention_test/send&#39;
</span></span></span><span class=line><span class=cl><span class=sd>        send_resolved: false
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    inhibit_rules:
</span></span></span><span class=line><span class=cl><span class=sd>    - source_matchers:
</span></span></span><span class=line><span class=cl><span class=sd>      - severity = &#39;P0&#39;
</span></span></span><span class=line><span class=cl><span class=sd>      target_matchers:
</span></span></span><span class=line><span class=cl><span class=sd>      - severity =~ &#39;P1|P2|P3|P4|P5&#39;
</span></span></span><span class=line><span class=cl><span class=sd>      equal:
</span></span></span><span class=line><span class=cl><span class=sd>      - &#39;alertname&#39;
</span></span></span><span class=line><span class=cl><span class=sd>      - &#39;instance&#39;
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    - source_matchers:
</span></span></span><span class=line><span class=cl><span class=sd>      - alertname = InstanceDown
</span></span></span><span class=line><span class=cl><span class=sd>      target_matchers:
</span></span></span><span class=line><span class=cl><span class=sd>      - job = node_exporter
</span></span></span><span class=line><span class=cl><span class=sd>      equal:
</span></span></span><span class=line><span class=cl><span class=sd>      - &#39;instance&#39;</span><span class=w>    
</span></span></span></code></pre></td></tr></table></div></div><ul><li>配置alertmanager容器并启动</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># 为了方便 我这里直接把alertmanager和prometheus部署在一起</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>alertmanager</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>prom/alertmanager:v0.28.1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>IfNotPresent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- --<span class=l>config.file=/etc/alertmanager/config.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>9093</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>TCP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>http</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>alertmanager-config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/etc/alertmanager</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>100m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>512Mi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>limits</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>100m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>512Mi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>alertmanager-config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>configMap</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>alertmanager-config</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>在prometheus中配置alertmanager地址</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># 更新promtehus配置的configmap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>alerting</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>alertmanagers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>static_configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>targets</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>localhost:9093 </span><span class=w> </span><span class=c># 同一个Pod 直接使用localhost</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>告警测试</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>rule_files</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>/etc/prometheus/rules.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># configmap 新增一个配置项</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>rules.yaml</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>  groups:
</span></span></span><span class=line><span class=cl><span class=sd>  - name: test-rules
</span></span></span><span class=line><span class=cl><span class=sd>    rules:
</span></span></span><span class=line><span class=cl><span class=sd>    - alert: NodeMemoryUsage
</span></span></span><span class=line><span class=cl><span class=sd>      expr: (node_memory_MemTotal_bytes - (node_memory_MemFree_bytes + node_memory_Buffers_bytes + node_memory_Cached_bytes)) / node_memory_MemTotal_bytes * 100 &gt; 20
</span></span></span><span class=line><span class=cl><span class=sd>      for: 2m
</span></span></span><span class=line><span class=cl><span class=sd>      labels:
</span></span></span><span class=line><span class=cl><span class=sd>        severity: P0
</span></span></span><span class=line><span class=cl><span class=sd>      annotations:
</span></span></span><span class=line><span class=cl><span class=sd>        summary: &#34;{{ $labels.instance }}: High Memory usage detected&#34;
</span></span></span><span class=line><span class=cl><span class=sd>        description: &#34;{{$labels.instance}}: Memory usage is above 20% (current value is: {{ $value }}&#34;</span><span class=w>  
</span></span></span></code></pre></td></tr></table></div></div><h3 id=prometheus-operator>Prometheus Operator</h3><ul><li>经过上面手动编写Prometheus资源清单 我们完成了对Kubernetes相关资源的监控 但是还是有一些缺陷</li><li>比如：Promtheus、Alertmanager等组件服务本身的高可用；当然我们可以自己实现这些需求 我们也知道Prometheus在代码上就原生支持Kubernetes 我们可以通过服务发现的形式来自动监控集群</li><li>因此 我们可以使用另外一种更加高级的方式来部署Prometheus: <a class=link href=https://github.com/prometheus-operator/prometheus-operator target=_blank rel=noopener>prometheus-operator</a></li></ul><h4 id=operator模式>Operator模式</h4><p>Operator参考：<a class=link href=https://kubernetes.io/zh-cn/docs/concepts/extend-kubernetes/operator/ target=_blank rel=noopener>Operator模式</a></p><h4 id=介绍>介绍</h4><p><img src=/p/kubernetes/icons/prometheus-operator.png width=1796 height=1046 srcset="/p/kubernetes/icons/prometheus-operator_hu52b81c9c1fbc13426c3a36dcc5039201_151171_480x0_resize_box_3.png 480w, /p/kubernetes/icons/prometheus-operator_hu52b81c9c1fbc13426c3a36dcc5039201_151171_1024x0_resize_box_3.png 1024w" loading=lazy alt=prometheus-operator-arch class=gallery-image data-flex-grow=171 data-flex-basis=412px></p><ul><li>上图是<code>Prometheus-Operator</code>官方提供的架构图 其中<code>Operator</code>是最核心的部分</li><li>作为一个控制器 它回去创建<code>Prometheus</code>、<code>ServiceMonitor</code>、<code>Alertmanager</code>以及<code>PrometheusRule</code>4个CRD资源对象 然后会一直监控并维持这4个资源对象的状态<ul><li><code>prometheus</code>资源对象就是作为<code>Prometheus Server</code>存在</li><li><code>ServiceMonitor</code>就是<code>exporter</code>的各种抽象 <code>Prometheus</code>就是通过<code>ServiceMonitor</code>提供的<code>metrics</code>数据接口去pull数据</li><li><code>alertmanager</code>资源对应<code>Alertmanager</code>的抽象</li><li><code>PrometheusRule</code>是用来被<code>Prometheus</code>实例使用的报警规则文件</li></ul></li><li>这样 我们要在集群中监控什么数据 就变成了直接去操作Kubernetes集群资源的对象</li><li>上图中的Service和ServiceMonitor都是Kubernetes的资源 一个ServiceMonitror可以通过labelSelector的方式去匹配一类Service</li><li>Prometheus也可以通过labelSelector的发方式去匹配多个ServiceMonitor</li></ul><h4 id=通过prometheus-operator安装>通过prometheus-operator安装</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>git clone git@github.com:prometheus-operator/prometheus-operator.git
</span></span><span class=line><span class=cl>kubectl create namespace monitoring
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 在指定namespace安装</span>
</span></span><span class=line><span class=cl>$ <span class=nv>NAMESPACE</span><span class=o>=</span>monitoring kustomize edit <span class=nb>set</span> namespace <span class=nv>$NAMESPACE</span> <span class=o>&amp;&amp;</span> kubectl create -k .
</span></span><span class=line><span class=cl>customresourcedefinition.apiextensions.k8s.io/alertmanagerconfigs.monitoring.coreos.com created
</span></span><span class=line><span class=cl>customresourcedefinition.apiextensions.k8s.io/alertmanagers.monitoring.coreos.com created
</span></span><span class=line><span class=cl>customresourcedefinition.apiextensions.k8s.io/podmonitors.monitoring.coreos.com created
</span></span><span class=line><span class=cl>customresourcedefinition.apiextensions.k8s.io/probes.monitoring.coreos.com created
</span></span><span class=line><span class=cl>customresourcedefinition.apiextensions.k8s.io/prometheusagents.monitoring.coreos.com created
</span></span><span class=line><span class=cl>customresourcedefinition.apiextensions.k8s.io/prometheuses.monitoring.coreos.com created
</span></span><span class=line><span class=cl>customresourcedefinition.apiextensions.k8s.io/prometheusrules.monitoring.coreos.com created
</span></span><span class=line><span class=cl>customresourcedefinition.apiextensions.k8s.io/scrapeconfigs.monitoring.coreos.com created
</span></span><span class=line><span class=cl>customresourcedefinition.apiextensions.k8s.io/servicemonitors.monitoring.coreos.com created
</span></span><span class=line><span class=cl>customresourcedefinition.apiextensions.k8s.io/thanosrulers.monitoring.coreos.com created
</span></span><span class=line><span class=cl>serviceaccount/prometheus-operator created
</span></span><span class=line><span class=cl>clusterrole.rbac.authorization.k8s.io/prometheus-operator created
</span></span><span class=line><span class=cl>clusterrolebinding.rbac.authorization.k8s.io/prometheus-operator created
</span></span><span class=line><span class=cl>service/prometheus-operator created
</span></span><span class=line><span class=cl>deployment.apps/prometheus-operator created
</span></span></code></pre></td></tr></table></div></div><ul><li>PrometheusOperator通过Deployment的形式进行部署</li><li>为了能够让PrometheusOperator能够监听和管理Kubernetes资源 同时也创建了单独的ServiceAccount以及相关授权</li></ul><h5 id=使用operator管理prometheus>使用Operator管理Prometheus</h5><h6 id=部署prometheus实例>部署Prometheus实例</h6><ul><li>当集群中已经安装ProemtheusOperator之后 对于部署PromtheusServer实例变成了声明一个Prometheus资源</li><li>如下所示 我们在monitoring名称空间下创建了一个Prometheus实例</li><li>访问: <code>kubectl port-forward statefulsets.apps/prometheus-inst 9090:9090</code></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>monitoring.coreos.com/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>inst</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>monitoring</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>400Mi</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h6 id=部署servicemonitor实例>部署ServiceMonitor实例</h6><ul><li>让部署的Prometheus能够采集部署在Kubernetes下应用的监控数据<ul><li>在原生的Prometheus配置方式中 我们在Prometheus配置文件中定义单独的Job 同时使用<code>kubernetes_sd</code>定义服务的自动发现</li><li>在PrometheusOperator中 则可以直接声明一个<code>ServiceMonitor</code>对象</li></ul></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>monitoring.coreos.com/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ServiceMonitor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>demoapp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>monitoring</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>env</span><span class=p>:</span><span class=w> </span><span class=l>testing</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespaceSelector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchNames</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLables</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>demoapp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>endpoints</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=l>web  </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># 如果target启用了监控BasicAuth认证 定义ServiceMonitor对象时 需要在endpoints配置中定义basicAuth</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>basicAuth</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>password</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>basic-auth</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>password</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>username</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>basic-auth</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>user</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 其中 basicAuth 中关联名为 basic-auth为Secret对象 需要用户手动将认证信息保存到Secret中</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>APIVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Secret</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>basic-auth</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># base64编码后的值</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=l>alsdhabdn==</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>user</span><span class=p>:</span><span class=w> </span><span class=l>Jadquhwe==</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Opaque</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h6 id=关联prometheus与servicemonitor>关联Prometheus与ServiceMonitor</h6><ul><li>Promtheus与ServiceMonitor之间的关联关系使用<code>servicMonitorSelector</code>定义 在Prometheus中通过标签选择当前需要监控的ServiceMonitor对象</li><li>为了能够让Prometheus关联到ServiceMonitor 需要在Promehteus定义中使用serviceMonitorSelector 我们可以通过标签选择当前Prometheus需要监控的ServiceMonitor对象</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># 更新promteheus crd资源清单</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>monitoring.coreos.com/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>inst</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>monitoring</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>serviceMonitorSelector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>env</span><span class=p>:</span><span class=w> </span><span class=l>testing</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>400Mi</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>更新上面配置配置后 web界面可以看到Job配置 但是Prometheus的Target中并没有包含任何的监控对象 此时Promtheus Pod有报错日志</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>time</span><span class=o>=</span>2025-06-09T16:29:10.559Z <span class=nv>level</span><span class=o>=</span>ERROR <span class=nv>source</span><span class=o>=</span>reflector.go:166 <span class=nv>msg</span><span class=o>=</span><span class=s2>&#34;Unhandled Error&#34;</span> <span class=nv>component</span><span class=o>=</span>k8s_client_runtime <span class=nv>logger</span><span class=o>=</span>UnhandledError <span class=nv>err</span><span class=o>=</span><span class=s2>&#34;pkg/mod/k8s.io/client-go@v0.32.3/tools/cache/reflector.go:251: Failed to watch *v1.Service: failed to list *v1.Service: services is forbidden: User \&#34;system:serviceaccount:monitoring:default\&#34; cannot list resource \&#34;services\&#34; in API group \&#34;\&#34; in the namespace \&#34;default\&#34;&#34;</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>这是因为我们默认创建的实例使用的是monitoring命名空间下的default账号 该账号并没有权限能够获取default命名空间下的任何资源信息</li><li>修复该问题 我们需要在monitoring的命名空间常见一个新的ServiceAccount账号 并且为该账号赋予相应的集群访问权限</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl get pods prometheus-inst-0 -o yaml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 默认使用的serviceAccount</span>
</span></span><span class=line><span class=cl>serviceAccount: default
</span></span><span class=line><span class=cl>serviceAccountName: default
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># 创建新的具有相关权限的ServiceAccount</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ServiceAccount</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>monitoring</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRole</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>apiGroups</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>nodes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>services</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>endpoints</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>pods</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>verbs</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;get&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;list&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;watch&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>apiGroups</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>configmaps</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>verbs</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;get&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>nonResourceURLs</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;/metrics&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>verbs</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;get&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRoleBinding</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>roleRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRole</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>subjects</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ServiceAccount</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>monitoring</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 应用上面资源清单之后 修改prometheus实例的资源清单 使用新的ServiceAccount</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>monitoring.coreos.com/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>inst</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>monitoring</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>serviceAccountName</span><span class=p>:</span><span class=w> </span><span class=l>prometheus </span><span class=w> </span><span class=c># 更新serviceAccount</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>serviceMonitorSelector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>env</span><span class=p>:</span><span class=w> </span><span class=l>testing</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>400Mi</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=使用operator管理监控配置>使用Operator管理监控配置</h5><h6 id=使用prometheusrule定义告警规则>使用PrometheusRule定义告警规则</h6><ul><li>对于Prometheus而言 在原生的管理方式上 我们需要手动创建Prometheus的告警文件 并且通过在Prometheus配置中声明式加载</li><li>而在PrometheusOperator的模式中 告警规则通过定义声明式配置创建一个<code>PrometheusRule</code>资源</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>monitoring.coreos.com/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>PrometheusRule</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>prometheus</span><span class=p>:</span><span class=w> </span><span class=l>demoapp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>role</span><span class=p>:</span><span class=w> </span><span class=l>alert-rules</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>prometheus-demoapp-rules</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>groups</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>./demoapp.rules</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>alert</span><span class=p>:</span><span class=w> </span><span class=l>DemoappAlert</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>expr</span><span class=p>:</span><span class=w> </span><span class=l>demoapp_http_requests_total{handler=&#34;/metrics&#34;} &gt; 1</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>创建<code>PrometheusRule</code>资源后 通过在Promtheus中使用<code>ruleSelector</code>通过标签选择需要关联的PrometheusRule即可</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>monitoring.coreos.com/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>inst</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>monitoring</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>serviceAccountName</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>serviceMonitorSelector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>env</span><span class=p>:</span><span class=w> </span><span class=l>testing</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ruleSelector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>role</span><span class=p>:</span><span class=w> </span><span class=l>alert-rules</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>prometheus</span><span class=p>:</span><span class=w> </span><span class=l>demoapp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>400Mi</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h6 id=使用operator管理alertmanger实例>使用Operator管理Alertmanger实例</h6><ul><li>到目前为止 我们已经通过PrometheusOperator的自定义资源类型管理了Prometheus实例 监控配置以及告警规则等资源</li><li>通过PrometheusOperator将原本手动管理的工作 全部变成了声明式的管理模式 极大简化了Kubernetes下Prometheus运维管理的复杂度</li><li>我们继续使用Operator定义和管理Alertmanager相关的内容</li><li>创建Alertmanger资源清单<ul><li>通过replicas可以控制Alertmanager的实例数</li><li>当replicas大于1时 PrometheusOperator会自动通过<strong>集群</strong>的方式创建Alertmaager</li></ul></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>monitoring.coreos.com/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Alertmanager</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>inst</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>monitoring</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>修改Prometheus资源定义 配置<code>alerting</code>指定使用的Alertmanager资源即可</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>monitoring.coreos.com/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>inst</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>monitoring</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>serviceAccountName</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>serviceMonitorSelector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>env</span><span class=p>:</span><span class=w> </span><span class=l>testing</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ruleSelector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>role</span><span class=p>:</span><span class=w> </span><span class=l>alert-rules</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>prometheus</span><span class=p>:</span><span class=w> </span><span class=l>demoapp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>alerting</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>alertmanagers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>alertmanager-example</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>monitoring</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=l>web</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>400Mi</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>等待Prometheus重新加载后 我们可以看到PrometheusOperator在配置文件中添加了如下配置 通过服务发现规则 将Prometheus与Alertmanager自动关联</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>alerting</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>alert_relabel_configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>separator</span><span class=p>:</span><span class=w> </span><span class=l>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>regex</span><span class=p>:</span><span class=w> </span><span class=l>prometheus_replica</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>replacement</span><span class=p>:</span><span class=w> </span><span class=l>$1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>labeldrop</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>alertmanagers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>follow_redirects</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>enable_http2</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>scheme</span><span class=p>:</span><span class=w> </span><span class=l>http</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>path_prefix</span><span class=p>:</span><span class=w> </span><span class=l>/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>timeout</span><span class=p>:</span><span class=w> </span><span class=l>10s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>api_version</span><span class=p>:</span><span class=w> </span><span class=l>v2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>relabel_configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>source_labels</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>__meta_kubernetes_service_name]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>separator</span><span class=p>:</span><span class=w> </span><span class=l>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>regex</span><span class=p>:</span><span class=w> </span><span class=l>alertmanager-example</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>replacement</span><span class=p>:</span><span class=w> </span><span class=l>$1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>keep</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>source_labels</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>__meta_kubernetes_endpoint_port_name]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>separator</span><span class=p>:</span><span class=w> </span><span class=l>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>regex</span><span class=p>:</span><span class=w> </span><span class=l>web</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>replacement</span><span class=p>:</span><span class=w> </span><span class=l>$1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>keep</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>kubernetes_sd_configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>role</span><span class=p>:</span><span class=w> </span><span class=l>endpoints</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>kubeconfig_file</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>follow_redirects</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>enable_http2</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>namespaces</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>own_namespace</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>names</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>monitoring</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=在prometheusoperator中使用自定义配置>在PrometheusOperator中使用自定义配置</h5><ul><li>在PrometheusOperator中 我们通过声明式创建Prometheus、ServiceMonitor等自定义的资源类型来自动化部署和管理Promtehues的相关组件及配置</li><li>而在一些特殊的情况下 可能还是希望能够手动管理Prometheus配置文件 而非通过PrometheusOperator自动完成</li><li>为什么? 实际上PrometheusOperator对于Job的配置只适用于在Kubernetes中部署和管理的应用程序 如果你希望使用Prometheus监控一些其他的资源 例如 AWS或其他平台中的基础设施或应用 这些并不在PrometheusOperator的能力范围之内</li><li>为了能够在通过PrometheusOperator创建的Prometheus实例中使用自定义配置文件 我们只能创建一个不包含任何与配置文件内容相关的Prometheus实例</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>monitoring.coreos.com/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>inst-cc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>monitoring</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>serviceAccountName</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>400Mi</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>如果查看新建的Prometheus的Pod实例的YAML定义 我们可以看到Pod中会包含一个volume配置</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=w>  </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>secret</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>defaultMode</span><span class=p>:</span><span class=w> </span><span class=m>420</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>secretName</span><span class=p>:</span><span class=w> </span><span class=l>prometheus-inst-cc</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>Prometheus的配置文件实例上是保存在名为<code>prometheus-&lt;name-of-prometheus-object></code>的Secret中</li><li>当用户创建的Prometheus中关联ServiceMonitor这类会影响配置文件内容的定义时 PromtheusOperator会自动管理</li><li>而如果Prometheus定义中不包含任何与配置有关的定义 那么Secret的管理权限就落到用户自己手中</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># 使用该配置更新secret观察新建Prometheus实例的配置变化</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># kubectl edit secret prometheus-inst-cc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>global</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>scrape_interval</span><span class=p>:</span><span class=w> </span><span class=l>10s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>scrape_timeout</span><span class=p>:</span><span class=w> </span><span class=l>10s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>evaluation_interval</span><span class=p>:</span><span class=w> </span><span class=l>10s</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=通过kube-prometheus安装>通过kube-prometheus安装</h4><p><a class=link href=https://prometheus-operator.dev/docs/getting-started/installation/ target=_blank rel=noopener>Install using Kube-Prometheus</a></p><h5 id=安装>安装</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>git clone git@github.com:prometheus-operator/kube-prometheus.git
</span></span><span class=line><span class=cl>kubectl create -f manifests/setup -f manifest  <span class=c1># 不止包含我们上面手动创建的相关资源</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看部署的Pod</span>
</span></span><span class=line><span class=cl><span class=c1># kubectl get pods -n monitoring</span>
</span></span><span class=line><span class=cl>NAME                                   READY   STATUS    RESTARTS   AGE
</span></span><span class=line><span class=cl>alertmanager-main-0                    2/2     Running   <span class=m>0</span>          2d23h
</span></span><span class=line><span class=cl>alertmanager-main-1                    2/2     Running   <span class=m>0</span>          2d23h
</span></span><span class=line><span class=cl>alertmanager-main-2                    2/2     Running   <span class=m>0</span>          2d23h
</span></span><span class=line><span class=cl>blackbox-exporter-75c7985cb8-dq9vp     3/3     Running   <span class=m>0</span>          2d23h
</span></span><span class=line><span class=cl>grafana-664dd67585-wxrsp               1/1     Running   <span class=m>0</span>          2d23h
</span></span><span class=line><span class=cl>kube-state-metrics-75df9b9544-j9l7t    3/3     Running   <span class=m>0</span>          2d23h
</span></span><span class=line><span class=cl>node-exporter-9cflz                    2/2     Running   <span class=m>0</span>          2d23h
</span></span><span class=line><span class=cl>node-exporter-d9zkn                    2/2     Running   <span class=m>0</span>          2d23h
</span></span><span class=line><span class=cl>node-exporter-fh7sx                    2/2     Running   <span class=m>0</span>          2d23h
</span></span><span class=line><span class=cl>node-exporter-zxswn                    2/2     Running   <span class=m>0</span>          2d23h
</span></span><span class=line><span class=cl>prometheus-adapter-84c549f6b4-mwj8h    1/1     Running   <span class=m>0</span>          2d23h
</span></span><span class=line><span class=cl>prometheus-adapter-84c549f6b4-tg2sv    1/1     Running   <span class=m>0</span>          2d23h
</span></span><span class=line><span class=cl>prometheus-k8s-0                       2/2     Running   <span class=m>0</span>          2d23h
</span></span><span class=line><span class=cl>prometheus-k8s-1                       2/2     Running   <span class=m>0</span>          2d23h
</span></span><span class=line><span class=cl>prometheus-operator-6f9479b5f5-8r6sn   2/2     Running   <span class=m>0</span>          2d23h
</span></span></code></pre></td></tr></table></div></div><ul><li>仔细观察我们发现<code>kube-scheduler</code> <code>kube-controller-manager</code>两个服务定义了ServiceMonior 但是没有管理到对应的监控目标</li><li>阅读ServiceMonitor的定义 我们发现原因是我们系统中根本就没有对应的Service 我们手动创建即可</li><li>服务端口参考: <a class=link href=https://kubernetes.io/zh-cn/docs/reference/networking/ports-and-protocols/ target=_blank rel=noopener>ports-and-protocols</a></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># serviceMonitor定义</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># kube-controller-manager</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>monitoring.coreos.com/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ServiceMonitor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app.kubernetes.io/name</span><span class=p>:</span><span class=w> </span><span class=l>kube-controller-manager</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app.kubernetes.io/part-of</span><span class=p>:</span><span class=w> </span><span class=l>kube-prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>kube-controller-manager</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>monitoring</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>endpoints</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>jobLabel</span><span class=p>:</span><span class=w> </span><span class=l>app.kubernetes.io/name</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespaceSelector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchNames</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>kube-system</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app.kubernetes.io/name</span><span class=p>:</span><span class=w> </span><span class=l>kube-controller-manager</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># kube-scheduler</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>monitoring.coreos.com/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ServiceMonitor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app.kubernetes.io/name</span><span class=p>:</span><span class=w> </span><span class=l>kube-scheduler</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app.kubernetes.io/part-of</span><span class=p>:</span><span class=w> </span><span class=l>kube-prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>kube-scheduler</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>monitoring</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>endpoints</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>jobLabel</span><span class=p>:</span><span class=w> </span><span class=l>app.kubernetes.io/name</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespaceSelector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchNames</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>kube-system</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app.kubernetes.io/name</span><span class=p>:</span><span class=w> </span><span class=l>kube-scheduler</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>根据serviceMonitor定义 创建具有对应标签的Service资源</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># 除了创建Service 还需要修改服务的默认监听地址 默认绑定127.0.0.1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 修改: --address=127.0.0.1 -&gt; --address=0.0.0.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># kube-controller-manager</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>kube-system</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>kube-controller-manager</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app.kubernetes.io/name</span><span class=p>:</span><span class=w> </span><span class=l>kube-controller-manager</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>component</span><span class=p>:</span><span class=w> </span><span class=l>kube-controller-manager</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>https-metrics</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>10257</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=m>10257</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>TCP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># kube-scheduler</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>kube-system</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>kube-scheduler</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app.kubernetes.io/name</span><span class=p>:</span><span class=w> </span><span class=l>kube-scheduler</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>component</span><span class=p>:</span><span class=w> </span><span class=l>kube-scheduler</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>https-metrics</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>10259</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=m>10259</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>TCP</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=prometheusoperator高级配置>PrometheusOperator高级配置</h5><ul><li>经常上面操作之后 自带组件的相关监控都全部配置完成 但是 如果我们集群中有很多的Service/Pod 我们就需要一个个创建对应的ServiceMonitor对象么</li><li>为了解决这个问题 PrometheusOperator为我们提供了一个额外的抓取配置来解决这个问题 我们可以通过添加额外的配置来进行服务发现进行自动监控</li><li>和之前自定义的方式呢一样 我们想要在PrometheusOperator中去自动发现具有<code>prometheus.io/scrape=true</code>这个annotations的Service 之前我们定义的Prometheus配置如下</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl>- <span class=nt>job_name</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;kubernetes-service-endpoints&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>kubernetes_sd_configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>role</span><span class=p>:</span><span class=w> </span><span class=l>endpoints</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>relabel_configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>source_labels</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>__meta_kubernetes_service_annotation_prometheus_io_scrape]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>keep</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>regex</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>source_labels</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>__meta_kubernetes_service_annotation_prometheus_io_scheme]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>replace</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>target_label</span><span class=p>:</span><span class=w> </span><span class=l>__scheme__</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>regex</span><span class=p>:</span><span class=w> </span><span class=l>(https?)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>source_labels</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>__meta_kubernetes_service_annotation_prometheus_io_path]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>replace</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>target_label</span><span class=p>:</span><span class=w> </span><span class=l>__metrics_path__</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>regex</span><span class=p>:</span><span class=w> </span><span class=l>(.+)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>source_labels</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>__address__, __meta_kubernetes_service_annotation_prometheus_io_port]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>replace</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>target_label</span><span class=p>:</span><span class=w> </span><span class=l>__address__</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>regex</span><span class=p>:</span><span class=w> </span><span class=l>([^:]+)(?::\d+)?;(\d+)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>replacement</span><span class=p>:</span><span class=w> </span><span class=l>$1:$2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>labelmap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>regex</span><span class=p>:</span><span class=w> </span><span class=l>__meta_kubernetes_service_label_(.+)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>source_labels</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>__meta_kubernetes_namespace]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>replace</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>target_label</span><span class=p>:</span><span class=w> </span><span class=l>namespace</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>source_labels</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>__meta_kubernetes_service_name]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>replace</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>target_label</span><span class=p>:</span><span class=w> </span><span class=l>service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 已由ServiceMonitor监控</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>source_labels</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>__meta_kubernetes_service_name]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>drop</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>regex</span><span class=p>:</span><span class=w> </span><span class=l>kube-dns</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span></code></pre></td></tr></table></div></div><ul><li>要想自动发现集群中的Service 就需要我们在Service的annotation区域添加<code>prometheus.io/scrape=true</code>的声明</li><li>将上面的文件保存为prometheus-additional.yaml 然后通过这个文件创建一个对应的Secret对象</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl create secret generic additional-configs --from-file<span class=o>=</span>manifests/prometheus-additional.yaml
</span></span><span class=line><span class=cl>secret/additional-configs created
</span></span></code></pre></td></tr></table></div></div><ul><li>创建完成后 会将上面配置信息进行base64编码后作为prometheus-additional.yaml这个key对应的值存在</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl get secrets additional-configs -o yaml
</span></span><span class=line><span class=cl>data:
</span></span><span class=line><span class=cl>  prometheus-additional.yaml: LSBqb2JfbmFtZTogJ2t1YmVybmV0ZXMtc2VydmljZS1lbmRwb2ludHMnCiAga3ViZXJuZXRlc19zZF9jb25maWdzOgogIC0gcm9sZTogZW5kcG9pbnRzCiAgcmVsYWJlbF9jb25maWdzOgogIC0gc291cmNlX2xhYmVsczogW19fbWV0YV9rdWJlcm5ldGVzX3NlcnZpY2VfYW5ub3RhdGlvbl9wcm9tZXRoZXVzX2lvX3NjcmFwZV0KICAgIGFjdGlvbjoga2VlcAogICAgcmVnZXg6IHRydWUKICAtIHNvdXJjZV9sYWJlbHM6IFtfX21ldGFfa3ViZXJuZXRlc19zZXJ2aWNlX2Fubm90YXRpb25fcHJvbWV0aGV1c19pb19zY2hlbWVdCiAgICBhY3Rpb246IHJlcGxhY2UKICAgIHRhcmdldF9sYWJlbDogX19zY2hlbWVfXwogICAgcmVnZXg6IChodHRwcz8pCiAgLSBzb3VyY2VfbGFiZWxzOiBbX19tZXRhX2t1YmVybmV0ZXNfc2VydmljZV9hbm5vdGF0aW9uX3Byb21ldGhldXNfaW9fcGF0aF0KICAgIGFjdGlvbjogcmVwbGFjZQogICAgdGFyZ2V0X2xhYmVsOiBfX21ldHJpY3NfcGF0aF9fCiAgICByZWdleDogKC4rKQogIC0gc291cmNlX2xhYmVsczogW19fYWRkcmVzc19fLCBfX21ldGFfa3ViZXJuZXRlc19zZXJ2aWNlX2Fubm90YXRpb25fcHJvbWV0aGV1c19pb19wb3J0XQogICAgYWN0aW9uOiByZXBsYWNlCiAgICB0YXJnZXRfbGFiZWw6IF9fYWRkcmVzc19fCiAgICByZWdleDogKFteOl0rKSg/OjpcZCspPzsoXGQrKQogICAgcmVwbGFjZW1lbnQ6ICQxOiQyCiAgLSBhY3Rpb246IGxhYmVsbWFwCiAgICByZWdleDogX19tZXRhX2t1YmVybmV0ZXNfc2VydmljZV9sYWJlbF8oLispCiAgLSBzb3VyY2VfbGFiZWxzOiBbX19tZXRhX2t1YmVybmV0ZXNfbmFtZXNwYWNlXQogICAgYWN0aW9uOiByZXBsYWNlCiAgICB0YXJnZXRfbGFiZWw6IGt1YmVybmV0ZXNfbmFtZXNwYWNlCiAgLSBzb3VyY2VfbGFiZWxzOiBbX19tZXRhX2t1YmVybmV0ZXNfc2VydmljZV9uYW1lXQogICAgYWN0aW9uOiByZXBsYWNlCiAgICB0YXJnZXRfbGFiZWw6IGt1YmVybmV0ZXNfbmFtZQo<span class=o>=</span>
</span></span><span class=line><span class=cl>kind: Secret
</span></span><span class=line><span class=cl>metadata:
</span></span><span class=line><span class=cl>  creationTimestamp: <span class=s2>&#34;2025-06-18T07:50:33Z&#34;</span>
</span></span><span class=line><span class=cl>  name: additional-configs
</span></span><span class=line><span class=cl>  namespace: monitoring
</span></span><span class=line><span class=cl>  resourceVersion: <span class=s2>&#34;26440898&#34;</span>
</span></span><span class=line><span class=cl>  uid: 97ae179c-6516-4050-9b0a-c95596cf387e
</span></span><span class=line><span class=cl>type: Opaque
</span></span></code></pre></td></tr></table></div></div><ul><li>然后我们只需要在声明prometheus的资源对象文件中添加这个额外的配置即可</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>monitoring.coreos.com/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app.kubernetes.io/component</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app.kubernetes.io/instance</span><span class=p>:</span><span class=w> </span><span class=l>k8s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app.kubernetes.io/name</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app.kubernetes.io/part-of</span><span class=p>:</span><span class=w> </span><span class=l>kube-prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app.kubernetes.io/version</span><span class=p>:</span><span class=w> </span><span class=m>2.54.1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>k8s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>monitoring</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>alerting</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>alertmanagers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>alertmanager-main</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>monitoring</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=l>web</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>enableFeatures</span><span class=p>:</span><span class=w> </span><span class=p>[]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>externalLabels</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>quay.io/prometheus/prometheus:v2.54.1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>nodeSelector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>kubernetes.io/os</span><span class=p>:</span><span class=w> </span><span class=l>linux</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>podMetadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app.kubernetes.io/component</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app.kubernetes.io/instance</span><span class=p>:</span><span class=w> </span><span class=l>k8s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app.kubernetes.io/name</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app.kubernetes.io/part-of</span><span class=p>:</span><span class=w> </span><span class=l>kube-prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app.kubernetes.io/version</span><span class=p>:</span><span class=w> </span><span class=m>2.54.1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>podMonitorNamespaceSelector</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>podMonitorSelector</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>probeNamespaceSelector</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>probeSelector</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>400Mi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ruleNamespaceSelector</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ruleSelector</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>scrapeConfigNamespaceSelector</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>scrapeConfigSelector</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>securityContext</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>fsGroup</span><span class=p>:</span><span class=w> </span><span class=m>2000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>runAsNonRoot</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>runAsUser</span><span class=p>:</span><span class=w> </span><span class=m>1000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>serviceAccountName</span><span class=p>:</span><span class=w> </span><span class=l>prometheus-k8s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>serviceMonitorNamespaceSelector</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>serviceMonitorSelector</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=m>2.54.1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>additionalScrapeConfigs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>additional-configs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>prometheus-additional.yaml</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>在Prometheus UI的配置页面 已经看到有对应的配置信息 但是targets页面下却没有对应的监控任务 查看Prometheus的Pod日志</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>ts</span><span class=o>=</span>2025-06-18T08:03:27.801Z <span class=nv>caller</span><span class=o>=</span>klog.go:116 <span class=nv>level</span><span class=o>=</span>error <span class=nv>component</span><span class=o>=</span>k8s_client_runtime <span class=nv>func</span><span class=o>=</span>ErrorDepth <span class=nv>msg</span><span class=o>=</span><span class=s2>&#34;pkg/mod/k8s.io/client-go@v0.29.3/tools/cache/reflector.go:229: Failed to watch *v1.Service: failed to list *v1.Service: services is forbidden: User \&#34;system:serviceaccount:monitoring:prometheus-k8s\&#34; cannot list resource \&#34;services\&#34; in API group \&#34;\&#34; at the cluster scope&#34;</span>
</span></span><span class=line><span class=cl>...
</span></span></code></pre></td></tr></table></div></div><ul><li>可以看到有很多错误日志出现 都是 <code>xxx is forbidden</code> 这说明是RBAC权限的问题 通过Prometheus资源对象的陪着你可以值得 Promtheus绑定了一个名为<code>prometheus-k8s</code>的ServiceAccount对象 而这个对象绑定的是一个名为promtheus-k8s的ClusterRole</li><li>查看ClusterRole的内容 我们可以看到明显没有对Service或者Pod的list权限 我们添加上对象的权限即可</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRole</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>creationTimestamp</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;2025-06-13T12:48:39Z&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app.kubernetes.io/component</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app.kubernetes.io/instance</span><span class=p>:</span><span class=w> </span><span class=l>k8s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app.kubernetes.io/name</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app.kubernetes.io/part-of</span><span class=p>:</span><span class=w> </span><span class=l>kube-prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app.kubernetes.io/version</span><span class=p>:</span><span class=w> </span><span class=m>2.54.1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>prometheus-k8s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resourceVersion</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;25082977&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>uid</span><span class=p>:</span><span class=w> </span><span class=l>4cc3523b-1a2d-4682-bd6e-f23a11e661e7</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>apiGroups</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=s2>&#34;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>nodes/metrics</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>verbs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>get</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>nonResourceURLs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>/metrics</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>/metrics/slis</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>verbs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>get</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>更新<code>prometheus-k8s</code> ClusterRole权限</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>- apiGroups:
</span></span><span class=line><span class=cl>  - <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>  resources:
</span></span><span class=line><span class=cl>  - nodes
</span></span><span class=line><span class=cl>  - services
</span></span><span class=line><span class=cl>  - endpoints
</span></span><span class=line><span class=cl>  - pods
</span></span><span class=line><span class=cl>  - nodes/proxy
</span></span><span class=line><span class=cl>  verbs:
</span></span><span class=line><span class=cl>  - get
</span></span><span class=line><span class=cl>  - list
</span></span><span class=line><span class=cl>  - watch
</span></span><span class=line><span class=cl>- apiGroups:
</span></span><span class=line><span class=cl>  - <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>  resources:
</span></span><span class=line><span class=cl>  - configmaps
</span></span><span class=line><span class=cl>  - nodes/metrics
</span></span><span class=line><span class=cl>  verbs:
</span></span><span class=line><span class=cl>  - get
</span></span><span class=line><span class=cl>- nonResourceURLs:
</span></span><span class=line><span class=cl>  - /metrics
</span></span><span class=line><span class=cl>  verbs:
</span></span><span class=line><span class=cl>  - get
</span></span></code></pre></td></tr></table></div></div><h5 id=数据持久化>数据持久化</h5><ul><li>目前的Promtheus 如裹我们重启Pod 则会丢失之前采集的数据 这是因为promeehteus这个CRD创建的Prometheus并没有做数据的持久化</li><li>直接查看生成的Prometheus Pod的挂载详情 我们发现Prometheus的数据目录/promtheus实际上是通过<code>emptyDir</code>进行挂载的</li><li>我们知道<code>emptyDir</code>挂载的数据的声明周期和Pod生命周期是一致的 如果Pod挂掉 数据也跟着丢失</li><li>线上的监控数据我们肯定需要做持久化 prometheus CRD资源也为我们提供了数据持久化的配置方法 由于我们的Prometheus最终是通过Statefulset控制器进行部署的 所以我们这里需要通过<code>storageclass</code>来做数据持久化</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=l>$ kubectl get pod prometheus-k8s-0 -o yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>...</span><span class=l>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>prometheus-k8s-db</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>...</span><span class=l>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>emptyDir</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>prometheus-k8s-db</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>这里使用我本地的nfs stroageclass 在prometheus CRD资源对象中添加如下配置</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>storage</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>volumeClaimTemplate</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>storageClassName</span><span class=p>:</span><span class=w> </span><span class=l>nfs-client</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>storage</span><span class=p>:</span><span class=w> </span><span class=l>10Gi</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>更新服务之后 我们查看对应的pv/pvc/promtehus 可以看到已经进行了持久化</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># POD</span>
</span></span><span class=line><span class=cl>volumes:
</span></span><span class=line><span class=cl>- name: prometheus-k8s-db
</span></span><span class=line><span class=cl>  persistentVolumeClaim:
</span></span><span class=line><span class=cl>    claimName: prometheus-k8s-db-prometheus-k8s-1
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>volumeMounts:
</span></span><span class=line><span class=cl>- mountPath: /prometheus
</span></span><span class=line><span class=cl>  name: prometheus-k8s-db
</span></span><span class=line><span class=cl>  subPath: prometheus-db
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># pv / pvc</span>
</span></span><span class=line><span class=cl>$ kubectl get pv
</span></span><span class=line><span class=cl>NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                                           STORAGECLASS   VOLUMEATTRIBUTESCLASS   REASON   AGE
</span></span><span class=line><span class=cl>pvc-c2cd37f7-9299-4c47-97a7-b841e4c28e9b   10Gi       RWO            Delete           Bound    monitoring/prometheus-k8s-db-prometheus-k8s-1   nfs-client     &lt;unset&gt;                          10m
</span></span><span class=line><span class=cl>pvc-c6177fc6-74d5-4e1f-9213-86f90757b3d2   10Gi       RWO            Delete           Bound    monitoring/prometheus-k8s-db-prometheus-k8s-0   nfs-client     &lt;unset&gt;                          10m
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ kubectl get pvc
</span></span><span class=line><span class=cl>NAME                                 STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   VOLUMEATTRIBUTESCLASS   AGE
</span></span><span class=line><span class=cl>prometheus-k8s-db-prometheus-k8s-0   Bound    pvc-c6177fc6-74d5-4e1f-9213-86f90757b3d2   10Gi       RWO            nfs-client     &lt;unset&gt;                 10m
</span></span><span class=line><span class=cl>prometheus-k8s-db-prometheus-k8s-1   Bound    pvc-c2cd37f7-9299-4c47-97a7-b841e4c28e9b   10Gi       RWO            nfs-client     &lt;unset&gt;                 10m
</span></span></code></pre></td></tr></table></div></div><h5 id=副本与分片>副本与分片</h5><ul><li>kube-prometheus 默认安装是高可用的2副本 如果需要修改为分片 需要修改prometheus crd定义</li><li><a class=link href=https://prometheus-operator.dev/docs/platform/high-availability/ target=_blank rel=noopener>high-availability</a></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># 启动的Pod数量为 replicas * shards</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>shards</span><span class=p>:</span><span class=w> </span><span class=m>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>400Mi</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=reference>Reference</h2><ul><li>ubuntu</li></ul><p><a class=link href="https://askubuntu.com/questions/428772/how-to-install-specific-version-of-some-package/428778#428778?newreg=d056242a7a0340598dd1d2d4fad63e81" target=_blank rel=noopener>apt install speciffic version</a>
<a class=link href=https://www.serverlab.ca/tutorials/containers/docker/how-to-set-the-proxy-for-docker-on-ubuntu/ target=_blank rel=noopener>set-proxy-on-ubuntu-docker</a>
<a class=link href=https://askubuntu.com/questions/2493/apt-get-or-aptitude-equivalent-to-yum-whatprovides target=_blank rel=noopener>apt-get-like-yum-whatprovides</a></p><ul><li>kubetnetes</li></ul><p><a class=link href=https://stackoverflow.com/questions/63136175/kubectl-get-componentstatus-shows-unhealthy target=_blank rel=noopener>kubectl-get-commponentstatus-shows-unhealthy</a></p></section><footer class=article-footer><section class=article-tags><a href=/tags/cloud-native/>Cloud Native</a>
<a href=/tags/kubernetes/>Kubernetes</a>
<a href=/tags/pod/>Pod</a>
<a href=/tags/service/>Service</a>
<a href=/tags/kubeadm/>Kubeadm</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>相关文章</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/p/coredns/><div class=article-details><h2 class=article-title>CoreDNS</h2></div></a></article><article><a href=/p/tekton/><div class=article-details><h2 class=article-title>Tekton</h2></div></a></article><article><a href=/p/prometheus/><div class=article-details><h2 class=article-title>Prometheus</h2></div></a></article><article><a href=/p/docker/><div class=article-details><h2 class=article-title>Docker</h2></div></a></article></div></div></aside><script src=https://utteranc.es/client.js repo=ilolicon/ilolicon.github.io issue-term=pathname crossorigin=anonymous async></script><style>.utterances{max-width:unset}</style><script>let utterancesLoaded=!1;function setUtterancesTheme(e){let t=document.querySelector(".utterances iframe");t&&t.contentWindow.postMessage({type:"set-theme",theme:`github-${e}`},"https://utteranc.es")}addEventListener("message",e=>{if(e.origin!=="https://utteranc.es")return;utterancesLoaded=!0,setUtterancesTheme(document.documentElement.dataset.scheme)}),window.addEventListener("onColorSchemeChange",e=>{if(!utterancesLoaded)return;setUtterancesTheme(e.detail)})</script><footer class=site-footer><section class=copyright>&copy;
2017 -
2025 ilolicon's Blog</section><section class=powerby>Vicissitude🐳<br>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>主题 <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.21.0>Stack</a></b> 由 <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> 设计</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>